<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHXM4GYP5W"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-EHXM4GYP5W');
</script>
<!-- End Google Analytics -->



<!-- Baidu Analytics -->
<script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0a6515fb9c839d6a56d4cfd8b7d243d4";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>
<!-- End Baidu Analytics -->


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="hqqich">


  <meta name="subtitle" content="å¿™ç¢ŒæŠŠæ—¶å…‰ç¼©çŸ­, è‹¦éš¾æŠŠå²æœˆæ‹‰é•¿">




<title>ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£ | Hexo-blog</title>



<link rel="icon" href="/hexo-blog/public/favicon.ico">



<link rel="stylesheet" href="/hexo-blog/public/css/main.css">


<link rel="stylesheet" href="/hexo-blog/public/lib/nprogress/nprogress.css">



<script src="/hexo-blog/public/lib/jquery.min.js"></script>


<script src="/hexo-blog/public/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>


<script src="/hexo-blog/public/lib/nprogress/nprogress.js"></script>

<script>
  $(document).ready(() => {
    NProgress.configure({
      showSpinner: false,
    });
    NProgress.start();
    $("#nprogress .bar").css({
      background: "#de7441",
    });
    $("#nprogress .peg").css({
      "box-shadow": "0 0 2px #de7441, 0 0 4px #de7441",
    });
    $("#nprogress .spinner-icon").css({
      "border-top-color": "#de7441",
      "border-left-color": "#de7441",
    });
    setTimeout(function () {
      NProgress.done();
      $(".fade").removeClass("out");
    }, 800);
  });
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }

    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ri:moon-line" : "ri:sun-line"
          );
          toggleGiscusTheme();
        }
      });

    $("#toggle-dark").click((event) => {
      const isAppearanceTransition = document.startViewTransition && !window.matchMedia('(prefers-reduced-motion: reduce)').matches
      if (!isAppearanceTransition) {
        toggleDark()
        return
      }
      const x = event.clientX
      const y = event.clientY
      const endRadius = Math.hypot(
        Math.max(x, innerWidth - x),
        Math.max(y, innerHeight - y),
      )
      const transition = document.startViewTransition(async () => {
        toggleDark()
      })

      transition.ready
        .then(() => {
          const isDark = document.documentElement.classList.contains("dark")
          const clipPath = [
            `circle(0px at ${x}px ${y}px)`,
            `circle(${endRadius}px at ${x}px ${y}px)`,
          ]
          document.documentElement.animate(
            {
              clipPath: isDark
                ? [...clipPath].reverse()
                : clipPath,
            },
            {
              duration: 400,
              easing: 'ease-out',
              pseudoElement: isDark
                ? '::view-transition-old(root)'
                : '::view-transition-new(root)',
            },
          )
        })
    });
  });
</script>




<meta name="generator" content="Hexo 7.3.0"></head>
<body class="font-sans bg-white dark:bg-zinc-900 text-gray-700 dark:text-gray-200 relative">
  <header class="fixed w-full px-5 py-1 z-10 backdrop-blur-xl backdrop-saturate-150 border-b border-black/5">
  <div class="max-auto">
    <nav class="flex items-center text-base">
      <a href="/hexo-blog/public/" class="group">
        <h2 class="font-medium tracking-tighterp text-l p-2">
          <img class="w-5 mr-2 inline-block transition-transform group-hover:rotate-[30deg]" id="logo" src="https://moe-counter-vercel-gamma.vercel.app/a?theme=rule34" alt="Hexo-blog" />
          Hexo-blog
        </h2>
      </a>
      <div id="header-title" class="opacity-0 md:ml-2 md:mt-[0.1rem] text-xs font-medium whitespace-nowrap overflow-hidden overflow-ellipsis">
        ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        
          <a class="hidden sm:flex" href="/hexo-blog/public/archives">Posts</a>
        
          <a class="hidden sm:flex" href="/hexo-blog/public/category">Categories</a>
        
          <a class="hidden sm:flex" href="/hexo-blog/public/tag">Tags</a>
        
        
          
            <a class="w-5 h-5 hidden sm:flex" title="Github" target="_blank" rel="noopener" href="https://github.com/hqqich">
              <iconify-icon width="20" icon="ri:github-line"></iconify-icon>
            </a>
          
        
        <a class="w-5 h-5 hidden sm:flex" title="Github" href="rss2.xml">
          <iconify-icon width="20" icon="ri:rss-line"></iconify-icon>
        </a>
        <a class="w-5 h-5" title="toggle theme" id="toggle-dark">
          <iconify-icon width="20" icon="" id="theme-icon"></iconify-icon>
        </a>
      </div>
      <div class="flex items-center justify-center gap-3 ml-3 sm:hidden">
        <span class="w-5 h-5" aria-hidden="true" role="img" id="open-menu">
          <iconify-icon width="20" icon="carbon:menu" ></iconify-icon>
        </span>
        <span class="w-5 h-5 hidden" aria-hidden="true" role="img" id="close-menu">
          <iconify-icon  width="20" icon="carbon:close" ></iconify-icon>
        </span>
      </div>
    </nav>
  </div>
</header>
<div id="menu-panel" class="h-0 overflow-hidden sm:hidden fixed left-0 right-0 top-12 bottom-0 z-10">
  <div id="menu-content" class="relative z-20 bg-white/80 px-6 sm:px-8 py-2 backdrop-blur-xl -translate-y-full transition-transform duration-300">
    <ul class="nav flex flex-col sm:flex-row text-sm font-medium">
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/archives" class="flex h-12 sm:h-auto items-center">Posts</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/category" class="flex h-12 sm:h-auto items-center">Categories</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/tag" class="flex h-12 sm:h-auto items-center">Tags</a>
        </li>
      
    </ul>
  </div>
  <div class="mask bg-black/20 absolute inset-0"></div>
</div>

  <main class="pt-14">
    <!-- css -->

<link rel="stylesheet" href="/hexo-blog/public/lib/fancybox/fancybox.min.css">


<link rel="stylesheet" href="/hexo-blog/public/lib/tocbot/tocbot.min.css">

<!-- toc -->

  <!-- tocbot -->
<nav class="post-toc toc text-sm w-48 relative top-32 right-0 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- header -->
  <header class="overflow-hidden pt-6 pb-6 md:pt-12">
    <div class="pt-4 md:pt-6">
      <h1 id="article-title" class="text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
        ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£
      </h1>
      <div>
        <section class="flex items-center gap-3 text-sm">
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="carbon-calendar" ></iconify-icon>
            <time>2025-03-02</time>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="ic:round-access-alarm" ></iconify-icon>
            <span>30 min</span>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="icon-park-outline:font-search" ></iconify-icon>
            <span>7k words</span>
          </span>
          
            <span class="text-gray-400">Â·</span>
            <span class="flex items-center gap-1">
              <iconify-icon width="16" icon="icon-park-outline:box" class="mr-2"></iconify-icon>
              <a class="article-category-link" href="/hexo-blog/public/categories/kotlin/">kotlin</a>
            </span>
          
        </section>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto slide-enter-content dark:prose-invert">
    <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">                        \\           <span class="comment">//</span></span><br><span class="line">                         \\  .ooo.  <span class="comment">//</span></span><br><span class="line">                          .@@@@@@@@@.</span><br><span class="line">                        :@@@@@@@@@@@@@:</span><br><span class="line">                       :@@. <span class="string">&#x27;@@@@@&#x27;</span> .@@:</span><br><span class="line">                       @@@@@@@@@@@@@@@@@</span><br><span class="line">                       @@@@@@@@@@@@@@@@@</span><br><span class="line"></span><br><span class="line">                  :@@ :@@@@@@@@@@@@@@@@@. @@:</span><br><span class="line">                  @@@ <span class="string">&#x27;@@@@@@@@@@@@@@@@@, @@@</span></span><br><span class="line"><span class="string">                  @@@ &#x27;</span>@@@@@@@@@@@@@@@@@, @@@</span><br><span class="line">                  @@@ <span class="string">&#x27;@@@@@@@@@@@@@@@@@, @@@</span></span><br><span class="line"><span class="string">                  @@@ &#x27;</span>@@@@@@@@@@@@@@@@@, @@@</span><br><span class="line">                  @@@ <span class="string">&#x27;@@@@@@@@@@@@@@@@@, @@@</span></span><br><span class="line"><span class="string">                  @@@ &#x27;</span>@@@@@@@@@@@@@@@@@, @@@</span><br><span class="line">                       @@@@@@@@@@@@@@@@@</span><br><span class="line">                       <span class="string">&#x27;@@@@@@@@@@@@@@@&#x27;</span></span><br><span class="line">                          @@@@   @@@@</span><br><span class="line">                          @@@@   @@@@</span><br><span class="line">                          @@@@   @@@@</span><br><span class="line">                          <span class="string">&#x27;@@&#x27;</span>   <span class="string">&#x27;@@&#x27;</span></span><br><span class="line"></span><br><span class="line">    :@@@.</span><br><span class="line">  .@@@@@@@:   +@@       `@@      @@`   @@     @@</span><br><span class="line"> .@@@@<span class="string">&#x27;@@@@:  +@@       `@@      @@`   @@     @@</span></span><br><span class="line"><span class="string"> @@@     @@@  +@@       `@@      @@`   @@     @@</span></span><br><span class="line"><span class="string">.@@       @@: +@@   @@@ `@@      @@` @@@@@@ @@@@@@  @@;@@@@@</span></span><br><span class="line"><span class="string">@@@       @@@ +@@  @@@  `@@      @@` @@@@@@ @@@@@@  @@@@@@@@@</span></span><br><span class="line"><span class="string">@@@       @@@ +@@ @@@   `@@@@@@@@@@`   @@     @@    @@@   :@@</span></span><br><span class="line"><span class="string">@@@       @@@ +@@@@@    `@@@@@@@@@@`   @@     @@    @@#    @@+</span></span><br><span class="line"><span class="string">@@@       @@@ +@@@@@+   `@@      @@`   @@     @@    @@:    @@#</span></span><br><span class="line"><span class="string"> @@:     .@@` +@@@+@@   `@@      @@`   @@     @@    @@#    @@+</span></span><br><span class="line"><span class="string"> @@@.   .@@@  +@@  @@@  `@@      @@`   @@     @@    @@@   ,@@</span></span><br><span class="line"><span class="string">  @@@@@@@@@   +@@   @@@ `@@      @@`   @@@@   @@@@  @@@@#@@@@</span></span><br><span class="line"><span class="string">   @@@@@@@    +@@   #@@ `@@      @@`   @@@@:  @@@@: @@&#x27;</span>@@@@@</span><br><span class="line">                                                    @@:</span><br><span class="line">                                                    @@:</span><br><span class="line">                                                    @@:</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å…¬ä¼—å·ï¼š<a target="_blank" rel="noopener" href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image">å­—èŠ‚æ•°ç»„</a></p>
<p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p>
</blockquote>
<blockquote>
<p>å¯¹äº Android Developer æ¥è¯´ï¼Œå¾ˆå¤šå¼€æºåº“éƒ½æ˜¯å±äº<strong>å¼€å‘å¿…å¤‡</strong>çš„çŸ¥è¯†ç‚¹ï¼Œä»ä½¿ç”¨æ–¹å¼åˆ°å®ç°åŸç†å†åˆ°æºç è§£æï¼Œè¿™äº›éƒ½éœ€è¦æˆ‘ä»¬æœ‰ä¸€å®šç¨‹åº¦çš„äº†è§£å’Œè¿ç”¨èƒ½åŠ›ã€‚æ‰€ä»¥æˆ‘æ‰“ç®—æ¥å†™ä¸€ç³»åˆ—å…³äºå¼€æºåº“<strong>æºç è§£æ</strong>å’Œ<strong>å®æˆ˜æ¼”ç»ƒ</strong>çš„æ–‡ç« ï¼Œåˆå®šçš„ç›®æ ‡æ˜¯ <strong>EventBusã€ARouterã€LeakCanaryã€Retrofitã€Glideã€OkHttpã€Coil</strong> ç­‰ä¸ƒä¸ªçŸ¥åå¼€æºåº“ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p>
</blockquote>
<p>æœ¬æ–‡åŸºäº OkHttp çš„ä»¥ä¸‹ç‰ˆæœ¬è¿›è¡Œè®²è§£ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒOkHttp å’Œ OkIO ç›®å‰å·²ç»è¢«å®˜æ–¹ç”¨ Kotlin è¯­è¨€é‡å†™äº†ä¸€éï¼Œæ‰€ä»¥è¿˜æ²¡å­¦ Kotlin çš„åŒå­¦å¯èƒ½è¿æºç éƒ½æ¯”è¾ƒéš¾çœ‹æ‡‚äº†ï¼ŒKotlin å…¥é—¨å¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://juejin.im/post/6880602489297895438">ä¸¤ä¸‡å…­åƒå­—å¸¦ä½  Kotlin å…¥é—¨</a></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&#x27;com.squareup.okhttp3:okhttp:4.9.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆæ¥çœ‹ä¸€ä¸ªå°ä¾‹å­ï¼Œåé¢çš„è®²è§£éƒ½ä¼šåŸºäºè¿™ä¸ªä¾‹å­æ¶‰åŠåˆ°çš„æ¨¡å—æ¥å±•å¼€</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: leavesCZY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Github</span>ï¼šhttps://github.com/leavesCZY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> URL = <span class="string">&quot;https://publicobject.com/helloworld.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> okHttClient = OkHttpClient.Builder()</span><br><span class="line">        .connectTimeout(Duration.ofSeconds(<span class="number">10</span>))</span><br><span class="line">        .readTimeout(Duration.ofSeconds(<span class="number">10</span>))</span><br><span class="line">        .writeTimeout(Duration.ofSeconds(<span class="number">10</span>))</span><br><span class="line">        .retryOnConnectionFailure(<span class="literal">true</span>)</span><br><span class="line">        .build()</span><br><span class="line">    <span class="keyword">val</span> request = Request.Builder().url(URL).build()</span><br><span class="line">    <span class="keyword">val</span> call = okHttClient.newCall(request)</span><br><span class="line">    <span class="keyword">val</span> response = call.execute()</span><br><span class="line">    println(response.body?.string())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç å°±å®Œæˆäº†ä¸€æ¬¡ Get è¯·æ±‚ï¼Œå…¶åŒ…å«çš„æ“ä½œæœ‰ï¼š</p>
<ol>
<li>é€šè¿‡ Builder æ¨¡å¼å¾—åˆ° OkHttpClientï¼ŒOkHttpClient åŒ…å«äº†å¯¹ç½‘ç»œè¯·æ±‚çš„å…¨å±€é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ <strong>é“¾æ¥è¶…æ—¶æ—¶é—´ã€è¯»å†™è¶…æ—¶æ—¶é—´ã€é“¾æ¥å¤±è´¥é‡è¯•</strong> ç­‰å„ç§é…ç½®</li>
<li>é€šè¿‡ Builder æ¨¡å¼å¾—åˆ° Requestï¼ŒRequest åŒ…å«äº†æœ¬æ¬¡ç½‘ç»œè¯·æ±‚çš„æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼ŒåŒ…æ‹¬ <strong>urlã€methodã€headersã€body</strong> ç­‰</li>
<li>é€šè¿‡ newCall æ–¹æ³•å¾—åˆ° Callï¼ŒCall å°±ç”¨äºå‘èµ·è¯·æ±‚ï¼Œå¯ç”¨äºæ‰§è¡Œ <strong>åŒæ­¥è¯·æ±‚ï¼ˆexecuteï¼‰ã€å¼‚æ­¥è¯·æ±‚ï¼ˆenqueueï¼‰ã€å–æ¶ˆè¯·æ±‚ï¼ˆcancelï¼‰</strong> ç­‰å„ç§æ“ä½œ</li>
<li>è°ƒç”¨ execute æ–¹æ³•å‘èµ·åŒæ­¥è¯·æ±‚å¹¶è¿”å›ä¸€ä¸ª Response å¯¹è±¡ï¼ŒResponse å°±åŒ…å«äº†æ­¤æ¬¡ç½‘ç»œè¯·æ±‚çš„æ‰€æœ‰è¿”å›ä¿¡æ¯ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥çš„è¯æ­¤æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸</li>
<li>æ‹¿åˆ° Response å¯¹è±¡çš„ body å¹¶ä»¥å­—ç¬¦ä¸²æµçš„æ–¹å¼è¿›è¡Œè¯»å–ï¼Œæ‰“å°ç»“æœå³æ–‡ç« å¼€å¤´çš„ Android æœºå™¨äººå½©è›‹</li>
</ol>
<h1 id="ä¸€ã€OkHttpClient"><a href="#ä¸€ã€OkHttpClient" class="headerlink" title="ä¸€ã€OkHttpClient"></a>ä¸€ã€OkHttpClient</h1><p>OkHttpClient ä½¿ç”¨äº† Builder æ¨¡å¼æ¥å®Œæˆåˆå§‹åŒ–ï¼Œå…¶æä¾›äº†å¾ˆå¤šçš„é…ç½®å‚æ•°ï¼Œæ¯ä¸ªé€‰é¡¹éƒ½æœ‰é»˜è®¤å€¼ï¼Œä½†å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ¥è¿›è¡Œè‡ªå®šä¹‰ï¼Œæ‰€ä»¥ä¹Ÿæœ‰å¿…è¦æ¥äº†è§£ä¸‹å…¶åŒ…å«çš„æ‰€æœ‰å‚æ•°</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Builder</span> <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="comment">//è°ƒåº¦å™¨</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> dispatcher: Dispatcher = Dispatcher()</span><br><span class="line">    <span class="comment">//è¿æ¥æ± </span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> connectionPool: ConnectionPool = ConnectionPool()</span><br><span class="line">    <span class="comment">//æ‹¦æˆªå™¨åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">val</span> interceptors: MutableList&lt;Interceptor&gt; = mutableListOf()</span><br><span class="line">    <span class="comment">//ç½‘ç»œæ‹¦æˆªå™¨åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">val</span> networkInterceptors: MutableList&lt;Interceptor&gt; = mutableListOf()</span><br><span class="line">    <span class="comment">//äº‹ä»¶ç›‘å¬</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> eventListenerFactory: EventListener.Factory = EventListener.NONE.asFactory()</span><br><span class="line">    <span class="comment">//è¿æ¥å¤±è´¥çš„æ—¶å€™æ˜¯å¦é‡è¯•</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> retryOnConnectionFailure = <span class="literal">true</span> </span><br><span class="line">    <span class="comment">//æºæœåŠ¡å™¨èº«ä»½éªŒè¯</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> authenticator: Authenticator = Authenticator.NONE</span><br><span class="line">    <span class="comment">//æ˜¯å¦å…è®¸é‡å®šå‘</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> followRedirects = <span class="literal">true</span></span><br><span class="line">    <span class="comment">//æ˜¯å¦å…è®¸sslé‡å®šå‘</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> followSslRedirects = <span class="literal">true</span></span><br><span class="line">    <span class="comment">//Cookie</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> cookieJar: CookieJar = CookieJar.NO_COOKIES</span><br><span class="line">    <span class="comment">//ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> cache: Cache? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">//DNS</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> dns: Dns = Dns.SYSTEM</span><br><span class="line">    <span class="comment">//ä»£ç†</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> proxy: Proxy? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">//ä»£ç†é€‰æ‹©å™¨</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> proxySelector: ProxySelector? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">//ä»£ç†èº«ä»½éªŒè¯</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> proxyAuthenticator: Authenticator = Authenticator.NONE</span><br><span class="line">    <span class="comment">//Socketå·¥å‚</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> socketFactory: SocketFactory = SocketFactory.getDefault()</span><br><span class="line">    <span class="comment">//å®‰å…¨å¥—æ¥å±‚</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> sslSocketFactoryOrNull: SSLSocketFactory? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> x509TrustManagerOrNull: X509TrustManager? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> connectionSpecs: List&lt;ConnectionSpec&gt; = DEFAULT_CONNECTION_SPECS</span><br><span class="line">    <span class="comment">//HTTP åè®®</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> protocols: List&lt;Protocol&gt; = DEFAULT_PROTOCOLS</span><br><span class="line">    <span class="comment">//ä¸»æœºåå­—ç¡®è®¤</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> hostnameVerifier: HostnameVerifier = OkHostnameVerifier</span><br><span class="line">    <span class="comment">//è¯ä¹¦é“¾</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> certificatePinner: CertificatePinner = CertificatePinner.DEFAULT</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> certificateChainCleaner: CertificateChainCleaner? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> callTimeout = <span class="number">0</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> connectTimeout = <span class="number">10_000</span></span><br><span class="line">    <span class="comment">//è¯»è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> readTimeout = <span class="number">10_000</span></span><br><span class="line">    <span class="comment">//å†™è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> writeTimeout = <span class="number">10_000</span></span><br><span class="line">    <span class="comment">//ping ä¹‹é—´çš„æ—¶é—´é—´éš”</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> pingInterval = <span class="number">0</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> minWebSocketMessageToCompress = RealWebSocket.DEFAULT_MINIMUM_DEFLATE_SIZE</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> routeDatabase: RouteDatabase? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="äºŒã€Request"><a href="#äºŒã€Request" class="headerlink" title="äºŒã€Request"></a>äºŒã€Request</h1><p>Request åŒ…å«äº†ç½‘ç»œè¯·æ±‚æ—¶çš„æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼Œä¸€å…±åŒ…å«ä»¥ä¸‹äº”ä¸ªï¼š</p>
<ol>
<li>urlã€‚å³æœ¬æ¬¡çš„ç½‘ç»œè¯·æ±‚åœ°å€ä»¥åŠå¯èƒ½åŒ…å«çš„ query é”®å€¼å¯¹</li>
<li>methodã€‚å³è¯·æ±‚æ–¹å¼ï¼Œå¯é€‰å‚æ•°æœ‰ GETã€HEADã€POSTã€DELETEã€PUTã€PATCH</li>
<li>headersã€‚å³è¯·æ±‚å¤´ï¼Œå¯ç”¨æ¥å­˜ tokenã€æ—¶é—´æˆ³ç­‰</li>
<li>bodyã€‚å³è¯·æ±‚ä½“</li>
<li>tagsã€‚å¯ç”¨æ¥å”¯ä¸€æ ‡è¯†æœ¬æ¬¡è¯·æ±‚</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">var</span> url: HttpUrl? = <span class="literal">null</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">var</span> method: String</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">var</span> headers: Headers.Builder</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">var</span> body: RequestBody? = <span class="literal">null</span></span><br><span class="line"><span class="comment">/** A mutable map of tags, or an immutable empty map if we don&#x27;t have any. */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">var</span> tags: MutableMap&lt;Class&lt;*&gt;, Any&gt; = mutableMapOf()</span><br></pre></td></tr></table></figure>

<h1 id="ä¸‰ã€Call"><a href="#ä¸‰ã€Call" class="headerlink" title="ä¸‰ã€Call"></a>ä¸‰ã€Call</h1><p>å½“è°ƒç”¨ <code>okHttClient.newCall(request)</code>æ—¶å°±ä¼šå¾—åˆ°ä¸€ä¸ª Call å¯¹è±¡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Prepares the [request] to be executed at some point in the future. */</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newCall</span><span class="params">(request: <span class="type">Request</span>)</span></span>: Call = RealCall(<span class="keyword">this</span>, request, forWebSocket = <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>

<p>Call æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶çœ‹åšæ˜¯ç½‘ç»œè¯·æ±‚çš„å¯åŠ¨å™¨ï¼Œå¯ç”¨äºå‘èµ·åŒæ­¥è¯·æ±‚æˆ–å¼‚æ­¥è¯·æ±‚ï¼Œ<strong>ä½†é‡å¤å‘èµ·å¤šæ¬¡è¯·æ±‚çš„è¯ä¼šæŠ›å‡ºå¼‚å¸¸</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Call</span> : <span class="type">Cloneable</span> &#123;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//è¿”å›æœ¬æ¬¡ç½‘ç»œè¯·æ±‚çš„ Request å¯¹è±¡</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">request</span><span class="params">()</span></span>: Request</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//å‘èµ·åŒæ­¥è¯·æ±‚ï¼Œå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">  <span class="meta">@Throws(IOException::class)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">execute</span><span class="params">()</span></span>: Response</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//å‘èµ·å¼‚æ­¥è¯·æ±‚ï¼Œé€šè¿‡ Callback æ¥å›è°ƒæœ€ç»ˆç»“æœ </span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">enqueue</span><span class="params">(responseCallback: <span class="type">Callback</span>)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//å–æ¶ˆç½‘ç»œè¯·æ±‚</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ˜¯å¦å·²ç»å‘èµ·è¿‡è¯·æ±‚</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">isExecuted</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ˜¯å¦å·²ç»å–æ¶ˆè¯·æ±‚</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">isCanceled</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è¶…æ—¶è®¡ç®—</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">timeout</span><span class="params">()</span></span>: Timeout</span><br><span class="line"></span><br><span class="line">  <span class="comment">//åŒä¸ª Call ä¸å…è®¸é‡å¤å‘èµ·è¯·æ±‚ï¼Œæƒ³è¦å†æ¬¡å‘èµ·è¯·æ±‚å¯ä»¥é€šè¿‡æ­¤æ–¹æ³•å¾—åˆ°ä¸€ä¸ªæ–°çš„ Call å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">clone</span><span class="params">()</span></span>: Call</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> Factory &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">newCall</span><span class="params">(request: <span class="type">Request</span>)</span></span>: Call</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>newCall</code> æ–¹æ³•è¿”å›çš„å®é™…ç±»å‹æ˜¯ RealCallï¼Œå®ƒæ˜¯ Call æ¥å£çš„å”¯ä¸€å®ç°ç±»</p>
<p>å½“æˆ‘ä»¬è°ƒç”¨ <code>execute</code> æ–¹æ³•å‘èµ·åŒæ­¥è¯·æ±‚æ—¶ï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼š</p>
<ol>
<li>åˆ¤è¯»æ˜¯å¦é‡å¤è¯·æ±‚</li>
<li>äº‹ä»¶è®°å½•</li>
<li>å°†è‡ªèº«åŠ å…¥åˆ° dispatcher ä¸­ï¼Œå¹¶åœ¨è¯·æ±‚ç»“æŸæ—¶ä» dispatcher ä¸­ç§»é™¤è‡ªèº«</li>
<li>é€šè¿‡ <code>getResponseWithInterceptorChain</code> æ–¹æ³•å¾—åˆ° Response å¯¹è±¡</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealCall</span>(</span><br><span class="line">  <span class="keyword">val</span> client: OkHttpClient,</span><br><span class="line">  <span class="comment">/** The application&#x27;s original request unadulterated by redirects or auth headers. */</span></span><br><span class="line">  <span class="keyword">val</span> originalRequest: Request,</span><br><span class="line">  <span class="keyword">val</span> forWebSocket: <span class="built_in">Boolean</span></span><br><span class="line">) : Call &#123;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">execute</span><span class="params">()</span></span>: Response &#123;</span><br><span class="line">    check(executed.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123; <span class="string">&quot;Already Executed&quot;</span> &#125;</span><br><span class="line">    timeout.enter()</span><br><span class="line">    callStart()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      client.dispatcher.executed(<span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">return</span> getResponseWithInterceptorChain()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      client.dispatcher.finished(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å››ã€Dispatcher"><a href="#å››ã€Dispatcher" class="headerlink" title="å››ã€Dispatcher"></a>å››ã€Dispatcher</h1><p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>getResponseWithInterceptorChain</code> æ–¹æ³•å°±æ˜¯é‡å¤´æˆäº†ï¼Œå…¶è¿”å›äº†æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„ Responseã€‚ä½†è¿™é‡Œå…ˆä¸ä»‹ç»è¯¥æ–¹æ³•ï¼Œå…ˆæ¥çœ‹çœ‹ Dispatcher çš„é€»è¾‘</p>
<p>Dispatcher æ˜¯ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œç”¨äºå¯¹å…¨å±€çš„ç½‘ç»œè¯·æ±‚è¿›è¡Œç¼“å­˜è°ƒåº¦ï¼Œå…¶åŒ…å«ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> maxRequests = <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> maxRequestsPerHost = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Ready async calls in the order they&#x27;ll be run. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> readyAsyncCalls = ArrayDeque&lt;AsyncCall&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Running asynchronous calls. Includes canceled calls that haven&#x27;t finished yet. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> runningAsyncCalls = ArrayDeque&lt;AsyncCall&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Running synchronous calls. Includes canceled calls that haven&#x27;t finished yet. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> runningSyncCalls = ArrayDeque&lt;RealCall&gt;()</span><br></pre></td></tr></table></figure>

<ul>
<li>maxRequestsã€‚åŒä¸€æ—¶é—´å…è®¸å¹¶å‘æ‰§è¡Œç½‘ç»œè¯·æ±‚çš„æœ€å¤§çº¿ç¨‹æ•°</li>
<li>maxRequestsPerHostã€‚åŒä¸€ host ä¸‹çš„æœ€å¤§åŒæ—¶è¯·æ±‚æ•°</li>
<li>readyAsyncCallsã€‚ä¿å­˜å½“å‰ç­‰å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡</li>
<li>runningAsyncCallsã€‚ä¿å­˜å½“å‰æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡</li>
<li>runningSyncCallsã€‚ä¿å­˜å½“å‰æ­£åœ¨æ‰§è¡Œçš„åŒæ­¥ä»»åŠ¡</li>
</ul>
<p>å®¢æˆ·ç«¯ä¸åº”è¯¥æ— é™åˆ¶åœ°åŒæ—¶å‘èµ·å¤šä¸ªç½‘ç»œè¯·æ±‚ï¼Œå› ä¸ºé™¤äº†ç½‘ç»œèµ„æºæ‰€é™å¤–ï¼Œç³»ç»Ÿèµ„æºä¹Ÿæ˜¯æœ‰é™çš„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ç”±ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œï¼Œè€Œç³»ç»Ÿæ”¯æŒå¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥ OkHttp å†…éƒ¨å°±ä½¿ç”¨ maxRequests æ¥æ§åˆ¶åŒæ—¶æ‰§è¡Œå¼‚æ­¥è¯·æ±‚çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚æ­¤å¤–ï¼ŒOkHttp ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå…è®¸å¤šä¸ªæŒ‡å‘åŒä¸€ host çš„ç½‘ç»œè¯·æ±‚å…±äº«åŒä¸€ä¸ª Socketï¼Œè€Œæœ€å¤§å…±äº«æ•°é‡å³ maxRequestsPerHost</p>
<p>ä¸ºäº†ç»Ÿè®¡ä»¥ä¸Šä¸¤ä¸ªè¿è¡Œå‚æ•°ï¼Œå°±éœ€è¦ä½¿ç”¨ readyAsyncCallsã€runningAsyncCalls å’Œ runningSyncCalls æ¥ä¿å­˜å½“å‰æ­£åœ¨æ‰§è¡Œæˆ–è€…å‡†å¤‡æ‰§è¡Œçš„ç½‘ç»œè¯·æ±‚ã€‚runningSyncCalls ç”¨äºä¿å­˜<strong>å½“å‰æ­£åœ¨æ‰§è¡Œçš„åŒæ­¥ä»»åŠ¡</strong>ï¼Œå…¶å­˜å‚¨çš„æ˜¯ RealCallã€‚readyAsyncCalls å’Œ runningAsyncCalls ç”¨äºä¿å­˜<strong>å¼‚æ­¥ä»»åŠ¡</strong>ï¼Œå…¶å­˜å‚¨çš„æ˜¯ AsyncCall</p>
<h2 id="1ã€åŒæ­¥è¯·æ±‚"><a href="#1ã€åŒæ­¥è¯·æ±‚" class="headerlink" title="1ã€åŒæ­¥è¯·æ±‚"></a>1ã€åŒæ­¥è¯·æ±‚</h2><p>RealCall çš„ <code>execute()</code> æ–¹æ³•åœ¨å¼€å§‹è¯·æ±‚å‰ï¼Œä¼šå…ˆå°†è‡ªèº«ä¼ ç»™ dispatcherï¼Œåœ¨è¯·æ±‚ç»“æŸååˆä¼šä» dispatcher ä¸­ç§»é™¤</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealCall</span>(</span><br><span class="line">  <span class="keyword">val</span> client: OkHttpClient,</span><br><span class="line">  <span class="comment">/** The application&#x27;s original request unadulterated by redirects or auth headers. */</span></span><br><span class="line">  <span class="keyword">val</span> originalRequest: Request,</span><br><span class="line">  <span class="keyword">val</span> forWebSocket: <span class="built_in">Boolean</span></span><br><span class="line">) : Call &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">execute</span><span class="params">()</span></span>: Response &#123;</span><br><span class="line">    check(executed.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123; <span class="string">&quot;Already Executed&quot;</span> &#125;</span><br><span class="line">    timeout.enter()</span><br><span class="line">    callStart()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æ·»åŠ åˆ° dispatcher</span></span><br><span class="line">      client.dispatcher.executed(<span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">return</span> getResponseWithInterceptorChain()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//ä» dispatcher ä¸­ç§»é™¤</span></span><br><span class="line">      client.dispatcher.finished(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dispatcher å†…éƒ¨ä¹Ÿåªæ˜¯ç›¸åº”çš„å°† RealCall æ·»åŠ åˆ° runningSyncCalls ä¸­æˆ–è€…æ˜¯å°†å…¶ä» runningSyncCalls ä¸­ç§»é™¤ï¼Œä¿å­˜åˆ° runningSyncCalls çš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿<strong>ç»Ÿè®¡å½“å‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚æ€»æ•°</strong>ä»¥åŠ<strong>èƒ½å¤Ÿå–æ¶ˆæ‰€æœ‰è¯·æ±‚</strong>ã€‚æ­¤å¤–ï¼Œç”±äºåŒæ­¥è¯·æ±‚ä¼šç›´æ¥è¿è¡Œåœ¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹ä¸Šï¼Œæ‰€ä»¥åŒæ­¥è¯·æ±‚å¹¶ä¸ä¼šå— maxRequests çš„é™åˆ¶</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dispatcher</span> <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/** Used by [Call.execute] to signal it is in-flight. */</span></span><br><span class="line">  	  <span class="meta">@Synchronized</span> </span><br><span class="line">      <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">executed</span><span class="params">(call: <span class="type">RealCall</span>)</span></span> &#123;</span><br><span class="line">    	runningSyncCalls.add(call)</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/** Used by [Call.execute] to signal completion. */</span></span><br><span class="line">  	  <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">finished</span><span class="params">(call: <span class="type">RealCall</span>)</span></span> &#123;</span><br><span class="line">    	finished(runningSyncCalls, call)</span><br><span class="line">  	  &#125;</span><br><span class="line"></span><br><span class="line">  	  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">finished</span><span class="params">(calls: <span class="type">Deque</span>&lt;<span class="type">T</span>&gt;, call: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">    	<span class="keyword">val</span> idleCallback: Runnable?</span><br><span class="line">    	synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">      		<span class="keyword">if</span> (!calls.remove(call)) <span class="keyword">throw</span> AssertionError(<span class="string">&quot;Call wasn&#x27;t in-flight!&quot;</span>)</span><br><span class="line">      		idleCallback = <span class="keyword">this</span>.idleCallback</span><br><span class="line">    	&#125;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„ç½‘ç»œè¯·æ±‚</span></span><br><span class="line">    	<span class="keyword">val</span> isRunning = promoteAndExecute()</span><br><span class="line">    	<span class="keyword">if</span> (!isRunning &amp;&amp; idleCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">      		idleCallback.run()</span><br><span class="line">    	&#125;</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2ã€å¼‚æ­¥è¯·æ±‚"><a href="#2ã€å¼‚æ­¥è¯·æ±‚" class="headerlink" title="2ã€å¼‚æ­¥è¯·æ±‚"></a>2ã€å¼‚æ­¥è¯·æ±‚</h2><p>RealCall çš„ <code>enqueue</code>æ–¹æ³•ä¼šå°†å¤–éƒ¨ä¼ å…¥çš„ Callback åŒ…è£…ä¸ºä¸€ä¸ª AsyncCall å¯¹è±¡åä¼ ç»™ dispatcher</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealCall</span>(</span><br><span class="line">  <span class="keyword">val</span> client: OkHttpClient,</span><br><span class="line">  <span class="comment">/** The application&#x27;s original request unadulterated by redirects or auth headers. */</span></span><br><span class="line">  <span class="keyword">val</span> originalRequest: Request,</span><br><span class="line">  <span class="keyword">val</span> forWebSocket: <span class="built_in">Boolean</span></span><br><span class="line">) : Call &#123;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">enqueue</span><span class="params">(responseCallback: <span class="type">Callback</span>)</span></span> &#123;</span><br><span class="line">    check(executed.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123; <span class="string">&quot;Already Executed&quot;</span> &#125;</span><br><span class="line">    callStart()</span><br><span class="line">    client.dispatcher.enqueue(AsyncCall(responseCallback))</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº <code>enqueue</code>å¯¹åº”çš„æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ‰€ä»¥ OkHttp å†…éƒ¨å°±éœ€è¦è‡ªå·±æ„é€ ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¯·æ±‚ï¼Œåœ¨è¯·æ±‚ç»“æŸåå†é€šè¿‡ Callback æ¥å°†ç»“æœå€¼å›è°ƒç»™å¤–éƒ¨ï¼Œå¼‚æ­¥è¯·æ±‚é€»è¾‘å¯¹åº”çš„è½½ä½“å°±æ˜¯ AsyncCall è¿™ä¸ªç±»</p>
<p>AsyncCall æ˜¯ RealCall çš„éé™æ€å†…éƒ¨ç±»ï¼Œæ‰€ä»¥ AsyncCall å¯ä»¥è®¿é—®åˆ° RealCall çš„æ‰€æœ‰å˜é‡å’Œæ–¹æ³•ã€‚æ­¤å¤–ï¼ŒAsyncCall ç»§æ‰¿äº† Runnable æ¥å£ï¼Œå…¶ <code>executeOn</code> æ–¹æ³•å°±ç”¨äºä¼ å…¥ä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡æ¥æ‰§è¡Œ<code>run</code> æ–¹æ³•ã€‚<code>run</code> æ–¹æ³•å†…è¿˜æ˜¯è°ƒç”¨äº† <code>getResponseWithInterceptorChain()</code>æ–¹æ³•æ¥è·å– responseï¼Œå¹¶é€šè¿‡ Callback æ¥å°†æ‰§è¡Œç»“æœï¼ˆä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰å›è°ƒå‡ºå»ï¼Œåœ¨è¯·æ±‚ç»“æŸåä¹Ÿä¼šå°†è‡ªèº«ä» dispatcher ä¸­ç§»é™¤</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">inner</span> <span class="keyword">class</span> <span class="title class_">AsyncCall</span>(<span class="keyword">private</span> <span class="keyword">val</span> responseCallback: Callback) : Runnable &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Volatile</span> <span class="keyword">var</span> callsPerHost = AtomicInteger(<span class="number">0</span>)</span><br><span class="line">  		<span class="keyword">private</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">fun</span> <span class="title">reuseCallsPerHostFrom</span><span class="params">(other: <span class="type">AsyncCall</span>)</span></span> &#123;</span><br><span class="line">  		<span class="keyword">this</span>.callsPerHost = other.callsPerHost</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">fun</span> <span class="title">executeOn</span><span class="params">(executorService: <span class="type">ExecutorService</span>)</span></span> &#123;</span><br><span class="line">        client.dispatcher.assertThreadDoesntHoldLock()</span><br><span class="line">        <span class="keyword">var</span> success = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">this</span>)</span><br><span class="line">            success = <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: RejectedExecutionException) &#123;</span><br><span class="line">            <span class="keyword">val</span> ioException = InterruptedIOException(<span class="string">&quot;executor rejected&quot;</span>)</span><br><span class="line">            ioException.initCause(e)</span><br><span class="line">            noMoreExchanges(ioException)</span><br><span class="line">            responseCallback.onFailure(<span class="keyword">this</span><span class="symbol">@RealCall</span>, ioException)</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                client.dispatcher.finished(<span class="keyword">this</span>) <span class="comment">// This call is no longer running!</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        threadName(<span class="string">&quot;OkHttp <span class="subst">$&#123;redactedUrl()&#125;</span>&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> signalledCallback = <span class="literal">false</span></span><br><span class="line">            timeout.enter()</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> response = getResponseWithInterceptorChain()</span><br><span class="line">                signalledCallback = <span class="literal">true</span></span><br><span class="line">                responseCallback.onResponse(<span class="keyword">this</span><span class="symbol">@RealCall</span>, response)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">                <span class="keyword">if</span> (signalledCallback) &#123;</span><br><span class="line">                    <span class="comment">// Do not signal the callback twice!</span></span><br><span class="line">                    Platform.<span class="keyword">get</span>().log(<span class="string">&quot;Callback failure for <span class="subst">$&#123;toLoggableString()&#125;</span>&quot;</span>, Platform.INFO, e)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    responseCallback.onFailure(<span class="keyword">this</span><span class="symbol">@RealCall</span>, e)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (t: Throwable) &#123;</span><br><span class="line">                cancel()</span><br><span class="line">                <span class="keyword">if</span> (!signalledCallback) &#123;</span><br><span class="line">                    <span class="keyword">val</span> canceledException = IOException(<span class="string">&quot;canceled due to <span class="variable">$t</span>&quot;</span>)</span><br><span class="line">                    canceledException.addSuppressed(t)</span><br><span class="line">                    responseCallback.onFailure(<span class="keyword">this</span><span class="symbol">@RealCall</span>, canceledException)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> t</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                client.dispatcher.finished(<span class="keyword">this</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dispatcher åœ¨æ‹¿åˆ° AsyncCall å¯¹è±¡åï¼Œä¼šå…ˆå°†å…¶å­˜åˆ° readyAsyncCalls ä¸­ï¼Œç„¶åé€šè¿‡ <code>findExistingCallWithHost</code>æ–¹æ³•æ¥æŸ¥æ‰¾å½“å‰æ˜¯å¦æœ‰æŒ‡å‘åŒä¸€ Host çš„å¼‚æ­¥è¯·æ±‚ï¼Œæœ‰çš„è¯åˆ™äº¤æ¢ callsPerHost å˜é‡ï¼Œè¯¥å˜é‡å°±ç”¨äºæ ‡è®°å½“å‰æŒ‡å‘åŒä¸€ Host çš„è¯·æ±‚æ•°é‡ï¼Œæœ€åè°ƒç”¨ <code>promoteAndExecute</code> æ–¹æ³•æ¥åˆ¤æ–­å½“å‰æ˜¯å¦å…è®¸å‘èµ·è¯·æ±‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dispatcher</span> <span class="keyword">constructor</span>() &#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">enqueue</span><span class="params">(call: <span class="type">AsyncCall</span>)</span></span> &#123;</span><br><span class="line">    synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">      readyAsyncCalls.add(call)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Mutate the AsyncCall so that it shares the AtomicInteger of an existing running call to</span></span><br><span class="line">      <span class="comment">// the same host.</span></span><br><span class="line">      <span class="keyword">if</span> (!call.call.forWebSocket) &#123;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾å½“å‰æ˜¯å¦æœ‰æŒ‡å‘åŒä¸€ Host çš„å¼‚æ­¥è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">val</span> existingCall = findExistingCallWithHost(call.host)</span><br><span class="line">        <span class="keyword">if</span> (existingCall != <span class="literal">null</span>) call.reuseCallsPerHostFrom(existingCall)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    promoteAndExecute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">findExistingCallWithHost</span><span class="params">(host: <span class="type">String</span>)</span></span>: AsyncCall? &#123;</span><br><span class="line">    <span class="keyword">for</span> (existingCall <span class="keyword">in</span> runningAsyncCalls) &#123;</span><br><span class="line">      <span class="keyword">if</span> (existingCall.host == host) <span class="keyword">return</span> existingCall</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (existingCall <span class="keyword">in</span> readyAsyncCalls) &#123;</span><br><span class="line">      <span class="keyword">if</span> (existingCall.host == host) <span class="keyword">return</span> existingCall</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ç½‘ç»œè¯·æ±‚æ€»æ•°å¯èƒ½å·²ç»è¾¾åˆ°é™åˆ¶ï¼Œæˆ–è€…æ˜¯æŒ‡å‘åŒä¸€ Host çš„è¯·æ±‚ä¹Ÿè¾¾åˆ°é™åˆ¶äº†ï¼Œæ‰€ä»¥ <code>promoteAndExecute()</code>æ–¹æ³•å°±ç”¨äºä»å¾…æ‰§è¡Œåˆ—è¡¨ readyAsyncCalls ä¸­è·å–å½“å‰ç¬¦åˆè¿è¡Œæ¡ä»¶çš„æ‰€æœ‰è¯·æ±‚ï¼Œå°†è¯·æ±‚å­˜åˆ° runningAsyncCalls ä¸­ï¼Œå¹¶è°ƒç”¨çº¿ç¨‹æ± æ¥æ‰§è¡Œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">promoteAndExecute</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.assertThreadDoesntHoldLock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> executableCalls = mutableListOf&lt;AsyncCall&gt;()</span><br><span class="line">    <span class="keyword">val</span> isRunning: <span class="built_in">Boolean</span></span><br><span class="line">    synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> i = readyAsyncCalls.iterator()</span><br><span class="line">      <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">val</span> asyncCall = i.next()</span><br><span class="line">	    <span class="comment">//å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚æ€»æ•°å·²ç»è¶…å‡ºé™åˆ¶ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (runningAsyncCalls.size &gt;= <span class="keyword">this</span>.maxRequests) <span class="keyword">break</span> <span class="comment">// Max capacity.</span></span><br><span class="line">        <span class="comment">//å¦‚æœæŒ‡å‘åŒä¸ª Host çš„è¯·æ±‚æ€»æ•°å·²ç»è¶…å‡ºé™åˆ¶ï¼Œåˆ™å–ä¸‹ä¸€ä¸ªè¯·æ±‚</span></span><br><span class="line">        <span class="keyword">if</span> (asyncCall.callsPerHost.<span class="keyword">get</span>() &gt;= <span class="keyword">this</span>.maxRequestsPerHost) <span class="keyword">continue</span> <span class="comment">// Host max capacity.</span></span><br><span class="line"></span><br><span class="line">        i.remove()</span><br><span class="line">        <span class="comment">//å°† callsPerHost é€’å¢åŠ ä¸€ï¼Œè¡¨ç¤ºæŒ‡å‘è¯¥ Host çš„é“¾æ¥æ•°åŠ ä¸€äº†</span></span><br><span class="line">        asyncCall.callsPerHost.incrementAndGet()</span><br><span class="line">        <span class="comment">//å°† asyncCall å­˜åˆ°å¯æ‰§è¡Œåˆ—è¡¨ä¸­</span></span><br><span class="line">        executableCalls.add(asyncCall)</span><br><span class="line">        <span class="comment">//å°† asyncCall å­˜åˆ°æ­£åœ¨æ‰§è¡Œåˆ—è¡¨ä¸­</span></span><br><span class="line">        runningAsyncCalls.add(asyncCall)</span><br><span class="line">      &#125;</span><br><span class="line">      isRunning = runningCallsCount() &gt; <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰§è¡Œæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until executableCalls.size) &#123;</span><br><span class="line">      <span class="keyword">val</span> asyncCall = executableCalls[i]</span><br><span class="line">      asyncCall.executeOn(executorService)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isRunning</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3ã€ArrayDeque"><a href="#3ã€ArrayDeque" class="headerlink" title="3ã€ArrayDeque"></a>3ã€ArrayDeque</h2><p>ä¸Šé¢æœ‰è®²åˆ°ï¼Œä¸‰ç§è¯·æ±‚çš„å­˜å‚¨å®¹å™¨æ˜¯ ArrayDequeã€‚ArrayDeque å±äºéçº¿ç¨‹å®‰å…¨çš„åŒç«¯é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ¶‰åŠåˆ°å¤šçº¿ç¨‹æ“ä½œæ—¶éƒ½éœ€è¦å¤–éƒ¨ä¸»åŠ¨çº¿ç¨‹åŒæ­¥ã€‚é‚£ä¹ˆè®©æˆ‘ä»¬æƒ³ä¸€æƒ³ï¼ŒOkHttp é€‰æ‹© ArrayDeque ä½œä¸ºä»»åŠ¡å®¹å™¨çš„ç†ç”±æ˜¯ä»€ä¹ˆï¼Ÿä»¥æˆ‘ç²—æµ…çš„çœ¼å…‰æ¥çœ‹ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>ArrayDeque å†…éƒ¨ä½¿ç”¨æ•°ç»„ç»“æ„æ¥å­˜å‚¨æ•°æ®ï¼Œå…ƒç´ å…·æœ‰æ˜ç¡®çš„å…ˆåé¡ºåºï¼Œè¿™ç¬¦åˆæˆ‘ä»¬å¯¹ç½‘ç»œè¯·æ±‚<strong>å…ˆåˆ°å…ˆæ‰§è¡Œ</strong>çš„åŸºæœ¬é¢„æœŸ</li>
<li>åœ¨é€‰æ‹©ç¬¦åˆè¿è¡Œæ¡ä»¶çš„å¼‚æ­¥è¯·æ±‚æ—¶ï¼Œéœ€è¦å¯¹ readyAsyncCalls è¿›è¡Œéå†ï¼Œæ•°ç»„åœ¨éå†æ•ˆç‡ä¸Šä¼šæ¯”è¾ƒé«˜</li>
<li>åœ¨éå†åˆ°ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚åï¼Œéœ€è¦å°†è¯·æ±‚ä» readyAsyncCalls ä¸­ç§»é™¤å¹¶è½¬ç§»åˆ° runningAsyncCalls ä¸­ï¼Œè€Œ ArrayDeque ä½œä¸ºåŒç«¯é˜Ÿåˆ—ï¼Œåœ¨å†…å­˜ç©ºé—´åˆ©ç”¨ç‡ä¸Šæ¯”è¾ƒé«˜</li>
<li>Dispatcher é¢å¯¹çš„å°±æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒï¼Œæœ¬èº«å°±éœ€è¦è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼Œé€‰æ‹© ArrayDeque è¿™ä¸ªéçº¿ç¨‹å®‰å…¨çš„å®¹å™¨å¯ä»¥çœå»å¤šä½™çš„çº¿ç¨‹åŒæ­¥æ¶ˆè€—</li>
</ul>
<h2 id="4ã€çº¿ç¨‹æ± "><a href="#4ã€çº¿ç¨‹æ± " class="headerlink" title="4ã€çº¿ç¨‹æ± "></a>4ã€çº¿ç¨‹æ± </h2><p>OkHttp çš„å¼‚æ­¥è¯·æ±‚æ˜¯äº¤ç”±å…¶å†…éƒ¨çš„çº¿ç¨‹æ± æ¥å®Œæˆçš„ï¼Œè¯¥çº¿ç¨‹æ± å°±é•¿è¿™æ ·ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> executorServiceOrNull: ExecutorService? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@get:Synchronized</span></span><br><span class="line"><span class="meta">@get:JvmName</span>(<span class="string">&quot;executorService&quot;</span>) <span class="keyword">val</span> executorService: ExecutorService</span><br><span class="line"><span class="keyword">get</span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> (executorServiceOrNull == <span class="literal">null</span>) &#123;</span><br><span class="line">    executorServiceOrNull = ThreadPoolExecutor(<span class="number">0</span>, <span class="built_in">Int</span>.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS,</span><br><span class="line">        SynchronousQueue(), threadFactory(<span class="string">&quot;<span class="variable">$okHttpName</span> Dispatcher&quot;</span>, <span class="literal">false</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> executorServiceOrNull!!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥çº¿ç¨‹æ± çš„å‚æ•°è®¾ç½®æœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿä»¥æˆ‘ç²—æµ…çš„çœ¼å…‰æ¥çœ‹ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ol>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 0ï¼Œçº¿ç¨‹è¶…æ—¶æ—¶é—´æ˜¯ 60 ç§’ã€‚è¯´æ˜åœ¨æ²¡æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœçº¿ç¨‹é—²ç½®äº† 60 ç§’ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±ä¼šè¢«å›æ”¶ï¼Œè¿™å¯ä»¥é¿å…ç©ºé—²çº¿ç¨‹ç™½ç™½æµªè´¹ç³»ç»Ÿèµ„æºï¼Œé€‚åˆäºç§»åŠ¨è®¾å¤‡èµ„æºç´§ç¼ºçš„æƒ…æ™¯</li>
<li>å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ä¸º Int.MAX_VALUEï¼Œå¯ä»¥çœ‹åšæ˜¯å®Œå…¨æ²¡æœ‰é™åˆ¶çš„ï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—æ˜¯ SynchronousQueueã€‚SynchronousQueue çš„ç‰¹ç‚¹æ˜¯å½“æœ‰ä»»åŠ¡å…¥é˜Ÿæ—¶ï¼Œå¿…é¡»ç­‰å¾…è¯¥ä»»åŠ¡è¢«æ¶ˆè´¹å¦åˆ™å…¥é˜Ÿæ“ä½œå°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œè€Œç”±äºçº¿ç¨‹æ± å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°é‡æ˜¯æ— é™çš„ï¼Œæ‰€ä»¥æ¯ä¸ªå…¥é˜Ÿçš„ä»»åŠ¡éƒ½èƒ½é©¬ä¸Šäº¤ç”±çº¿ç¨‹å¤„ç†ï¼ˆäº¤ä»˜ç»™ç©ºé—²çº¿ç¨‹æˆ–è€…æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼‰ï¼Œè¿™å°±ä¿è¯äº†ä»»åŠ¡çš„å¤„ç†åŠæ—¶æ€§ï¼Œç¬¦åˆæˆ‘ä»¬å¯¹ç½‘ç»œè¯·æ±‚åº”è¯¥å°½å¿«å‘èµ·å¹¶å®Œæˆçš„æœŸæœ›</li>
</ol>
<p>è™½ç„¶çº¿ç¨‹æ± æœ¬èº«å¯¹äºæœ€å¤§çº¿ç¨‹æ•°å‡ ä¹æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯ç”±äºæäº¤ä»»åŠ¡çš„æ“ä½œè¿˜å— maxRequests çš„æ§åˆ¶ï¼Œæ‰€ä»¥å®é™…ä¸Šè¯¥çº¿ç¨‹æ± æœ€å¤šåŒæ—¶è¿è¡Œ maxRequests ä¸ªçº¿ç¨‹</p>
<h2 id="5ã€æ¨åŠ¨è¯·æ±‚æ‰§è¡Œ"><a href="#5ã€æ¨åŠ¨è¯·æ±‚æ‰§è¡Œ" class="headerlink" title="5ã€æ¨åŠ¨è¯·æ±‚æ‰§è¡Œ"></a>5ã€æ¨åŠ¨è¯·æ±‚æ‰§è¡Œ</h2><p>æ—¢ç„¶ OkHttp å†…éƒ¨çš„çº¿ç¨‹æ± æ˜¯ä¸å¯èƒ½æ— é™åˆ¶åœ°æ–°å»ºçº¿ç¨‹æ¥æ‰§è¡Œè¯·æ±‚çš„ï¼Œé‚£ä¹ˆå½“è¯·æ±‚æ€»æ•°å·²è¾¾åˆ° maxRequests åï¼Œåç»­çš„è¯·æ±‚åªèƒ½æ˜¯å…ˆå¤„äºç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™äº›ç­‰å¾…çŠ¶æ€çš„è¯·æ±‚ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¢«å¯åŠ¨å‘¢ï¼Ÿ</p>
<p>åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ç»“æŸåéƒ½ä¼šè°ƒç”¨åˆ° Dispatcher çš„ä¸¤ä¸ª <code>finished</code> æ–¹æ³•ï¼Œåœ¨è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œåˆä¼šè§¦å‘åˆ° <code>promoteAndExecute()</code>æ–¹æ³•å»éå†ä»»åŠ¡åˆ—è¡¨æ¥æ‰§è¡Œï¼Œæ­¤æ—¶å°±æ¨åŠ¨äº†å¾…å¤„ç†åˆ—è¡¨çš„ä»»åŠ¡æ‰§è¡Œæ“ä½œã€‚æ‰€ä»¥è¯´ï¼ŒDispatcher ä¸­çš„è¯·æ±‚éƒ½å¯ä»¥çœ‹åšæ˜¯åœ¨è‡ªå‘æ€§åœ°å¯åŠ¨ï¼Œæ¯ä¸ªè¯·æ±‚ç»“æŸéƒ½ä¼šè‡ªåŠ¨è§¦å‘ä¸‹ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œçœå»äº†å¤šä½™çš„å®šæ—¶æ£€æŸ¥è¿™ç±»æ“ä½œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Used by [AsyncCall.run] to signal completion. */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">finished</span><span class="params">(call: <span class="type">AsyncCall</span>)</span></span> &#123;</span><br><span class="line">	call.callsPerHost.decrementAndGet()</span><br><span class="line">	finished(runningAsyncCalls, call)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Used by [Call.execute] to signal completion. */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">finished</span><span class="params">(call: <span class="type">RealCall</span>)</span></span> &#123;</span><br><span class="line">	finished(runningSyncCalls, call)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">finished</span><span class="params">(calls: <span class="type">Deque</span>&lt;<span class="type">T</span>&gt;, call: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">val</span> idleCallback: Runnable?</span><br><span class="line">	synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">  		<span class="keyword">if</span> (!calls.remove(call)) <span class="keyword">throw</span> AssertionError(<span class="string">&quot;Call wasn&#x27;t in-flight!&quot;</span>)</span><br><span class="line">  		idleCallback = <span class="keyword">this</span>.idleCallback</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å¯ä»¥å¯åŠ¨çš„å¾…æ‰§è¡Œä»»åŠ¡ï¼Œæœ‰çš„è¯åˆ™å¯åŠ¨</span></span><br><span class="line">	<span class="keyword">val</span> isRunning = promoteAndExecute()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!isRunning &amp;&amp; idleCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">  		idleCallback.run()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6ã€æ€»ç»“"><a href="#6ã€æ€»ç»“" class="headerlink" title="6ã€æ€»ç»“"></a>6ã€æ€»ç»“</h2><ul>
<li>å¦‚æœæ˜¯åŒæ­¥è¯·æ±‚ï¼Œé‚£ä¹ˆç½‘ç»œè¯·æ±‚è¿‡ç¨‹å°±ä¼šç›´æ¥åœ¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹ä¸Šå®Œæˆï¼Œä¸å— Dispatcher çš„æ§åˆ¶</li>
<li>å¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¼šå…ˆå­˜åˆ°å¾…æ‰§è¡Œåˆ—è¡¨ readyAsyncCalls ä¸­ï¼Œè¯¥è¯·æ±‚æ˜¯å¦å¯ä»¥ç«‹å³å‘èµ·å— maxRequests å’Œ maxRequestsPerHost ä¸¤ä¸ªæ¡ä»¶çš„é™åˆ¶ã€‚å¦‚æœç¬¦åˆæ¡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šä» readyAsyncCalls å–å‡ºå¹¶å­˜åˆ° runningAsyncCalls ä¸­ï¼Œç„¶åäº¤ç”± OkHttp å†…éƒ¨çš„çº¿ç¨‹æ± æ¥æ‰§è¡Œ</li>
<li>ä¸ç®¡å¤–éƒ¨æ˜¯åŒæ­¥è¯·æ±‚è¿˜æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡è°ƒç”¨<code>getResponseWithInterceptorChain()</code>æ–¹æ³•æ¥æ‹¿åˆ° Response çš„</li>
<li>Dispatcher å†…éƒ¨çš„çº¿ç¨‹æ± æœ¬èº«å…è®¸åŒæ—¶è¿è¡Œ Int.MAX_VALUE ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å®é™…ä¸Šçš„çº¿ç¨‹æ•°é‡è¿˜æ˜¯å— maxRequests çš„æ§åˆ¶</li>
</ul>
<h1 id="äº”ã€RealInterceptorChain"><a href="#äº”ã€RealInterceptorChain" class="headerlink" title="äº”ã€RealInterceptorChain"></a>äº”ã€RealInterceptorChain</h1><p>é‡ç‚¹å†æ¥çœ‹ <code>getResponseWithInterceptorChain()</code>æ–¹æ³•ï¼Œå…¶ä¸»è¦é€»è¾‘å°±æ˜¯é€šè¿‡æ‹¦æˆªå™¨æ¥å®Œæˆæ•´ä¸ªç½‘ç»œè¯·æ±‚è¿‡ç¨‹ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œé™¤äº†ä¼šè·å–å¤–éƒ¨ä¸»åŠ¨è®¾ç½®çš„æ‹¦æˆªå™¨å¤–ï¼Œä¹Ÿä¼šé»˜è®¤æ·»åŠ ä»¥ä¸‹å‡ ä¸ªæ‹¦æˆªå™¨</p>
<ol>
<li>RetryAndFollowUpInterceptorã€‚è´Ÿè´£å¤±è´¥é‡è¯•ä»¥åŠé‡å®šå‘</li>
<li>BridgeInterceptorã€‚è´Ÿè´£å¯¹ç”¨æˆ·æ„é€ çš„ Request è¿›è¡Œè½¬æ¢ï¼Œæ·»åŠ å¿…è¦çš„ header å’Œ cookieï¼Œåœ¨å¾—åˆ° response åå¦‚æœæœ‰éœ€è¦çš„ä¼šè¿›è¡Œ gzip è§£å‹</li>
<li>CacheInterceptorã€‚ç”¨äºå¤„ç†ç¼“å­˜</li>
<li>ConnectInterceptorã€‚è´Ÿè´£å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥</li>
<li>CallServerInterceptorã€‚è´Ÿè´£å‘æœåŠ¡å™¨å‘é€è¯·æ±‚å’Œä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®</li>
</ol>
<p>æœ€åï¼Œrequest å’Œ interceptors ä¼šç”¨æ¥ç”Ÿæˆä¸€ä¸ª RealInterceptorChain å¯¹è±¡ï¼Œç”±å…¶æ¥æœ€ç»ˆè¿”å› response</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span></span>: Response &#123;</span><br><span class="line">    <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">    <span class="keyword">val</span> interceptors = mutableListOf&lt;Interceptor&gt;()</span><br><span class="line">    <span class="comment">//æ·»åŠ å¼€å‘è€…è®¾ç½®çš„æ‹¦æˆªå™¨</span></span><br><span class="line">    interceptors += client.interceptors</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ·»åŠ é»˜è®¤çš„æ‹¦æˆªå™¨</span></span><br><span class="line">    interceptors += RetryAndFollowUpInterceptor(client)</span><br><span class="line">    interceptors += BridgeInterceptor(client.cookieJar)</span><br><span class="line">    interceptors += CacheInterceptor(client.cache)</span><br><span class="line">    interceptors += ConnectInterceptor</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">      <span class="comment">//å¦‚æœä¸æ˜¯ WebSocket çš„è¯ï¼Œé‚£å°±å†æ·»åŠ å¼€å‘è€…è®¾ç½®çš„ NetworkInterceptors</span></span><br><span class="line">      interceptors += client.networkInterceptors</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">//CallServerInterceptor æ˜¯å®é™…ä¸Šå‘èµ·ç½‘ç»œè¯·æ±‚çš„åœ°æ–¹</span></span><br><span class="line">    interceptors += CallServerInterceptor(forWebSocket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> chain = RealInterceptorChain(</span><br><span class="line">        call = <span class="keyword">this</span>,</span><br><span class="line">        interceptors = interceptors,</span><br><span class="line">        index = <span class="number">0</span>,</span><br><span class="line">        exchange = <span class="literal">null</span>,</span><br><span class="line">        request = originalRequest,</span><br><span class="line">        connectTimeoutMillis = client.connectTimeoutMillis,</span><br><span class="line">        readTimeoutMillis = client.readTimeoutMillis,</span><br><span class="line">        writeTimeoutMillis = client.writeTimeoutMillis</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> calledNoMoreExchanges = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">val</span> response = chain.proceed(originalRequest)</span><br><span class="line">      <span class="keyword">if</span> (isCanceled()) &#123;</span><br><span class="line">        response.closeQuietly()</span><br><span class="line">        <span class="keyword">throw</span> IOException(<span class="string">&quot;Canceled&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> response</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">      calledNoMoreExchanges = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">throw</span> noMoreExchanges(e) <span class="keyword">as</span> Throwable</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!calledNoMoreExchanges) &#123;</span><br><span class="line">        noMoreExchanges(<span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p><strong>Interceptor æ˜¯ OkHttp é‡Œå¾ˆé‡è¦çš„ä¸€ç¯ï¼ŒOkHttp ä¹Ÿæ˜¯é æ­¤ä¸ºå¼€å‘è€…æä¾›äº†å¾ˆé«˜çš„è‡ªç”±åº¦</strong>ã€‚Interceptor æ¥å£æœ¬èº«åªåŒ…å«ä¸€ä¸ª <code>intercept</code> æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•å†…å¯æ‹¿åˆ°åŸå§‹çš„ Request å¯¹è±¡ä»¥åŠæœ€ç»ˆçš„ Response</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> Interceptor &#123;</span></span><br><span class="line">   <span class="meta">@Throws(IOException::class)</span></span><br><span class="line">   <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Chain</span>)</span></span>: Response   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª LogInterceptor æ¥æ‰“å°ç½‘ç»œè¯·æ±‚çš„è¯·æ±‚å‚æ•°ä»¥åŠæœ€ç»ˆçš„è¿”å›å€¼</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LogInterceptor</span> : <span class="type">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Interceptor</span>.<span class="type">Chain</span>)</span></span>: Response &#123;</span><br><span class="line">        <span class="keyword">val</span> request = chain.request()</span><br><span class="line">        println(request)</span><br><span class="line">        <span class="keyword">val</span> response = chain.proceed(request)</span><br><span class="line">        println(response)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Interceptor çš„å®ç°åˆè¡·æ˜¯ä¸ºäº†ç»™å¼€å‘è€…æä¾›ä¸€ä¸ªå¯ä»¥æ§åˆ¶ç½‘ç»œè¯·æ±‚çš„<strong>å‘èµ·è¿‡ç¨‹</strong>åŠ<strong>æ”¶å°¾å·¥ä½œ</strong>çš„å…¥å£ï¼Œä¾‹å¦‚**æ·»åŠ  headerã€æ—¥å¿—è®°å½•ã€è¯·æ±‚æ‹¦æˆªã€ResponseBodyä¿®æ”¹ **ç­‰ï¼Œæ¯ä¸ª Interceptor åªè´Ÿè´£è‡ªå·±å…³å¿ƒçš„æ“ä½œï¼Œé‚£ä¹ˆåŠ¿å¿…å°±ä¼šæœ‰æ·»åŠ å¤šä¸ª Interceptor çš„éœ€æ±‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåªæœ‰è®©æ¯ä¸ª Interceptor éƒ½ä¾æ¬¡å¤„ç†å®Œ request ä¹‹åï¼ŒOkHttp æ‰èƒ½æ ¹æ®æœ€ç»ˆçš„ request å¯¹è±¡å»è”ç½‘è¯·æ±‚å¾—åˆ° responseï¼Œæ‰€ä»¥æ¯ä¸ª Interceptor éœ€è¦ä¾æ¬¡æ‹¿åˆ° request è¿›è¡Œè‡ªå®šä¹‰å¤„ç†ã€‚è¯·æ±‚åˆ° response åï¼ŒInterceptor å¯èƒ½è¿˜éœ€è¦å¯¹ response è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå°±è¿˜éœ€è¦å°† response å†ä¾æ¬¡ä¼ é€’ç»™æ¯ä¸ª Interceptorã€‚é‚£ä¹ˆï¼Œæ€ä¹ˆå®ç°å°†å¤šä¸ª Interceptor ç»™ä¸²è”èµ·æ¥å‘¢ï¼Ÿ</p>
<p><strong>è¿™é‡Œæ¥çœ‹ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„ Interceptor å®ç°æ€è·¯</strong></p>
<p>å‡è®¾æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ Interceptor å®ç°ç±»æœ‰ä¸¤ä¸ªï¼šLogInterceptor å’Œ HeaderInterceptorï¼Œè¿™é‡Œåªæ˜¯ç®€å•åœ°å°†è·å–åˆ° request å’Œ response çš„æ—¶æœºç»™æ‰“å°å‡ºæ¥ï¼Œé‡ç‚¹æ˜¯è¦çœ‹æ¯ä¸ª Interceptor çš„å…ˆåè°ƒç”¨é¡ºåºã€‚ä¸ºäº†å°†ä¸¤ä¸ª Interceptor ç»™ä¸²è”èµ·æ¥ï¼ŒRealInterceptorChain ä¼šå¾ªç¯è·å– index æŒ‡å‘çš„ä¸‹ä¸€ä¸ª Interceptor å¯¹è±¡ï¼Œæ¯æ¬¡æ„å»ºä¸€ä¸ªæ–°çš„ RealInterceptorChain å¯¹è±¡ä½œä¸ºå‚æ•°æ¥è°ƒç”¨ <code>intercept</code> æ–¹æ³•ï¼Œè¿™æ ·å¤–éƒ¨åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ <code>realInterceptorChain.proceed</code> å°±å¯ä»¥æ‹¿åˆ°æœ€ç»ˆçš„ response å¯¹è±¡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Request</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Response</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Chain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">request</span><span class="params">()</span></span>: Request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">proceed</span><span class="params">(request: <span class="type">Request</span>)</span></span>: Response</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Chain</span>)</span></span>: Response</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealInterceptorChain</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> request: Request,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> interceptors: List&lt;Interceptor&gt;,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> index: <span class="built_in">Int</span></span><br><span class="line">) : Chain &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">copy</span><span class="params">(index: <span class="type">Int</span>)</span></span>: RealInterceptorChain &#123;</span><br><span class="line">        <span class="keyword">return</span> RealInterceptorChain(request, interceptors, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">request</span><span class="params">()</span></span>: Request &#123;</span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">proceed</span><span class="params">(request: <span class="type">Request</span>)</span></span>: Response &#123;</span><br><span class="line">        <span class="keyword">val</span> next = copy(index = index + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">val</span> interceptor = interceptors[index]</span><br><span class="line">        <span class="keyword">val</span> response = interceptor.intercept(next)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LogInterceptor</span> : <span class="type">Interceptor</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Chain</span>)</span></span>: Response &#123;</span><br><span class="line">        <span class="keyword">val</span> request = chain.request()</span><br><span class="line">        println(<span class="string">&quot;LogInterceptor -- getRequest&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> response = chain.proceed(request)</span><br><span class="line">        println(<span class="string">&quot;LogInterceptor ---- getResponse&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HeaderInterceptor</span> : <span class="type">Interceptor</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Chain</span>)</span></span>: Response &#123;</span><br><span class="line">        <span class="keyword">val</span> request = chain.request()</span><br><span class="line">        println(<span class="string">&quot;HeaderInterceptor -- getRequest&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> response = chain.proceed(request)</span><br><span class="line">        println(<span class="string">&quot;HeaderInterceptor ---- getResponse&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> interceptorList = mutableListOf&lt;Interceptor&gt;()</span><br><span class="line">    interceptorList.add(LogInterceptor())</span><br><span class="line">    interceptorList.add(HeaderInterceptor())</span><br><span class="line">    <span class="keyword">val</span> request = Request()</span><br><span class="line">    <span class="keyword">val</span> realInterceptorChain = RealInterceptorChain(request, interceptorList, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> response = realInterceptorChain.proceed(request)</span><br><span class="line">    println(<span class="string">&quot;main response&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç çœ‹ç€æ€è·¯è¿˜å¯ä»¥ï¼Œå¯æ˜¯å½“è¿è¡Œåå°±ä¼šå‘ç°æŠ›å‡ºäº† IndexOutOfBoundsExceptionï¼Œå› ä¸ºä»£ç é‡Œå¹¶æ²¡æœ‰å¯¹ index è¿›è¡Œè¶Šç•Œåˆ¤æ–­ã€‚è€Œä¸”ï¼Œä¸Šé¢çš„ä»£ç ä¹Ÿç¼ºå°‘äº†ä¸€ä¸ªçœŸæ­£çš„ç”Ÿæˆ Response å¯¹è±¡çš„åœ°æ–¹ï¼Œæ¯ä¸ª Interceptor åªæ˜¯åœ¨è¿›è¡Œä¸­è½¬è°ƒç”¨è€Œå·²ï¼Œå› æ­¤è¿˜éœ€è¦ä¸€ä¸ªæ¥çœŸæ­£åœ°å®Œæˆç½‘ç»œè¯·æ±‚å¹¶è¿”å› Response å¯¹è±¡çš„åœ°æ–¹ï¼Œå³ CallServerInterceptor</p>
<p>æ‰€ä»¥ï¼ŒCallServerInterceptor çš„<code>intercept</code> æ–¹æ³•å°±ç”¨æ¥çœŸæ­£åœ°æ‰§è¡Œç½‘ç»œè¯·æ±‚å¹¶ç”Ÿæˆ Response å¯¹è±¡ï¼Œåœ¨è¿™é‡Œå°±ä¸èƒ½å†è°ƒç”¨ <code>proceed</code> æ–¹æ³•äº†ï¼Œä¸” CallServerInterceptor éœ€è¦æ”¾åœ¨ interceptorList çš„æœ€åä¸€ä½</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CallServerInterceptor</span> : <span class="type">Interceptor</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Chain</span>)</span></span>: Response &#123;</span><br><span class="line">        <span class="keyword">val</span> request = chain.request()</span><br><span class="line">        println(<span class="string">&quot;CallServerInterceptor -- getRequest&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> response = Response()</span><br><span class="line">        println(<span class="string">&quot;CallServerInterceptor ---- getResponse&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> interceptorList = mutableListOf&lt;Interceptor&gt;()</span><br><span class="line">    interceptorList.add(LogInterceptor())</span><br><span class="line">    interceptorList.add(HeaderInterceptor())</span><br><span class="line">    interceptorList.add(CallServerInterceptor())</span><br><span class="line">    <span class="keyword">val</span> request = Request()</span><br><span class="line">    <span class="keyword">val</span> realInterceptorChain = RealInterceptorChain(request, interceptorList, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> response = realInterceptorChain.proceed(request)</span><br><span class="line">    println(<span class="string">&quot;main response&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆçš„è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>intercept</code> æ–¹æ³•æ˜¯æ ¹æ®æ·»åŠ é¡ºåºæ¥è°ƒç”¨ï¼Œè€Œ response æ˜¯æŒ‰ç…§åæ–¹å‘æ¥ä¼ é€’</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LogInterceptor -- getRequest</span><br><span class="line">HeaderInterceptor -- getRequest</span><br><span class="line">CallServerInterceptor -- getRequest</span><br><span class="line">CallServerInterceptor ---- getResponse</span><br><span class="line">HeaderInterceptor ---- getResponse</span><br><span class="line">LogInterceptor ---- getResponse</span><br><span class="line">main response</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç æˆ‘ç®€åŒ–äº† OkHttp åœ¨å®ç° RealInterceptorChain æ—¶çš„æ€è·¯ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡å°†å¤šä¸ªæ‹¦æˆªå™¨ä»¥è´£ä»»é“¾çš„æ–¹å¼æ¥ä¸€å±‚å±‚è°ƒç”¨ï¼Œä¸Šä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†å®Œåå°†å°±å°†ç»“æœä¼ ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼ˆå³ CallServerInterceptor ï¼‰å¤„ç†å®Œåå°† Response å†ä¸€å±‚å±‚å¾€ä¸Šä¼ é€’</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealInterceptorChain</span>(</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">val</span> call: RealCall,</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> interceptors: List&lt;Interceptor&gt;,</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> index: <span class="built_in">Int</span>,</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">val</span> exchange: Exchange?,</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">val</span> request: Request,</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">val</span> connectTimeoutMillis: <span class="built_in">Int</span>,</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">val</span> readTimeoutMillis: <span class="built_in">Int</span>,</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">val</span> writeTimeoutMillis: <span class="built_in">Int</span></span><br><span class="line">) : Interceptor.Chain &#123;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">copy</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    index: <span class="type">Int</span> = this.index,</span></span></span><br><span class="line"><span class="params"><span class="function">    exchange: <span class="type">Exchange</span>? = this.exchange,</span></span></span><br><span class="line"><span class="params"><span class="function">    request: <span class="type">Request</span> = this.request,</span></span></span><br><span class="line"><span class="params"><span class="function">    connectTimeoutMillis: <span class="type">Int</span> = this.connectTimeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">    readTimeoutMillis: <span class="type">Int</span> = this.readTimeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">    writeTimeoutMillis: <span class="type">Int</span> = this.writeTimeoutMillis</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span> = RealInterceptorChain(call, interceptors, index, exchange, request, connectTimeoutMillis,</span><br><span class="line">      readTimeoutMillis, writeTimeoutMillis)</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@Throws(IOException::class)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">proceed</span><span class="params">(request: <span class="type">Request</span>)</span></span>: Response &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">val</span> next = copy(index = index + <span class="number">1</span>, request = request)</span><br><span class="line">    <span class="keyword">val</span> interceptor = interceptors[index]</span><br><span class="line">    <span class="meta">@Suppress(<span class="string">&quot;USELESS_ELVIS&quot;</span>)</span></span><br><span class="line">    <span class="keyword">val</span> response = interceptor.intercept(next) ?: <span class="keyword">throw</span> NullPointerException(</span><br><span class="line">        <span class="string">&quot;interceptor <span class="variable">$interceptor</span> returned null&quot;</span>)</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å…­ã€Interceptor"><a href="#å…­ã€Interceptor" class="headerlink" title="å…­ã€Interceptor"></a>å…­ã€Interceptor</h1><p>æˆ‘ä»¬åœ¨æ„å»º OkHttpClient çš„æ—¶å€™ï¼Œæ·»åŠ æ‹¦æˆªå™¨çš„æ–¹æ³•åˆ†ä¸ºä¸¤ç±»ï¼š<code>addInterceptor</code>å’Œ<code>addNetworkInterceptor</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> okHttClient = OkHttpClient.Builder()</span><br><span class="line">    .addInterceptor &#123; chain -&gt;</span><br><span class="line">        chain.proceed(chain.request())</span><br><span class="line">    &#125;</span><br><span class="line">    .addNetworkInterceptor &#123; chain -&gt;</span><br><span class="line">        chain.proceed(chain.request())</span><br><span class="line">    &#125;</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>

<p>Interceptor å’Œ NetworkInterceptor åˆ†åˆ«è¢«ç§°ä¸º<strong>åº”ç”¨æ‹¦æˆªå™¨</strong>å’Œ<strong>ç½‘ç»œæ‹¦æˆªå™¨</strong>ï¼Œé‚£ä¹ˆå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>
<p>å‰é¢æœ‰è®²åˆ°ï¼ŒOkHttp åœ¨æ‰§è¡Œæ‹¦æˆªå™¨çš„æ—¶å€™ï¼Œæ˜¯æŒ‰ç…§å¦‚ä¸‹é¡ºåºçš„ï¼Œè¿™ä¸ªé¡ºåºå°±å·²ç»å†³å®šäº†ä¸åŒæ‹¦æˆªå™¨çš„è°ƒç”¨æ—¶æœºå·®å¼‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> interceptors = mutableListOf&lt;Interceptor&gt;()</span><br><span class="line">interceptors += client.interceptors</span><br><span class="line">interceptors += RetryAndFollowUpInterceptor(client)</span><br><span class="line">interceptors += BridgeInterceptor(client.cookieJar)</span><br><span class="line">interceptors += CacheInterceptor(client.cache)</span><br><span class="line">interceptors += ConnectInterceptor</span><br><span class="line"><span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">  	interceptors += client.networkInterceptors</span><br><span class="line">&#125;</span><br><span class="line">interceptors += CallServerInterceptor(forWebSocket)</span><br></pre></td></tr></table></figure>

<ul>
<li>ç”±äºåº”ç”¨æ‹¦æˆªå™¨å¤„äºåˆ—è¡¨å¤´éƒ¨ï¼Œæ‰€ä»¥åœ¨æ•´ä¸ªè´£ä»»é“¾è·¯ä¸­åº”ç”¨æ‹¦æˆªå™¨ä¼šé¦–å…ˆè¢«æ‰§è¡Œï¼Œå³ä½¿ä¹‹ååœ¨ RetryAndFollowUpInterceptor ä¸­å‘ç”Ÿäº†<strong>è¯·æ±‚å¤±è´¥é‡è¯•æˆ–è€…ç½‘ç»œé‡å®šå‘</strong>ç­‰æƒ…å†µï¼Œåº”ç”¨æ‹¦æˆªå™¨ä¹Ÿåªä¼šè¢«è§¦å‘ä¸€æ¬¡ï¼Œä½†ç½‘ç»œæ‹¦æˆªå™¨ä¼šè¢«è°ƒç”¨å¤šæ¬¡</li>
<li>ç½‘ç»œæ‹¦æˆªå™¨ä½äº CacheInterceptor ä¹‹åï¼Œé‚£ä¹ˆå½“ CacheInterceptor  å‘½ä¸­ç¼“å­˜çš„æ—¶å€™å°±ä¸ä¼šå»æ‰§è¡Œç½‘ç»œè¯·æ±‚äº†ï¼Œæ­¤æ—¶ç½‘ç»œæ‹¦æˆªå™¨å°±ä¸ä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤ç½‘ç»œæ‹¦æˆªå™¨æ˜¯å­˜åœ¨çŸ­è·¯çš„å¯èƒ½ã€‚æ­¤å¤–ï¼Œç½‘ç»œæ‹¦æˆªå™¨ä½äº ConnectInterceptor ä¹‹åï¼Œåœ¨è°ƒç”¨ç½‘ç»œæ‹¦æˆªå™¨ä¹‹å‰å°±å·²ç»å‡†å¤‡å¥½ç½‘ç»œé“¾æ¥äº†ï¼Œè¯´æ˜ç½‘ç»œæ‹¦æˆªå™¨æœ¬èº«å°±å…³è”ç€å®é™…çš„ç½‘ç»œè¯·æ±‚é€»è¾‘</li>
<li>ä»å•æ¬¡è¯·æ±‚æµç¨‹ä¸Šæ¥çœ‹ï¼Œåº”ç”¨æ‹¦æˆªå™¨è¢«è°ƒç”¨å¹¶ä¸æ„å‘³ç€çœŸæ­£æœ‰å‘èµ·äº†ç½‘ç»œè¯·æ±‚ï¼Œè€Œç½‘ç»œæ‹¦æˆªå™¨è¢«è°ƒç”¨å°±è¯´æ˜çš„ç¡®å‘èµ·äº†ä¸€æ¬¡ç½‘ç»œè¯·æ±‚ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬å¸Œæœ›é€šè¿‡æ‹¦æˆªå™¨æ¥è®°å½•ç½‘ç»œè¯·æ±‚è¯¦æƒ…çš„è¯ï¼Œå°±éœ€è¦è€ƒè™‘ä¸¤è€…çš„è°ƒç”¨æ—¶æœºå·®å¼‚ï¼šåº”ç”¨æ‹¦æˆªå™¨æ— æ³•æ„ŸçŸ¥åˆ° OkHttp è‡ªåŠ¨æ·»åŠ çš„ä¸€äº› headerï¼Œä½†æ˜¯ç½‘ç»œæ‹¦æˆªå™¨å¯ä»¥ï¼›åº”ç”¨æ‹¦æˆªå™¨é™¤éä¸»åŠ¨ä¸­æ–­è¯·æ±‚ï¼Œå¦åˆ™æ¯æ¬¡è¯·æ±‚ä¸€å®šéƒ½ä¼šè¢«æ‰§è¡Œï¼Œä½†ç½‘ç»œæ‹¦æˆªå™¨å¯èƒ½å­˜åœ¨è¢«çŸ­è·¯çš„å¯èƒ½</li>
</ul>
<p>å€Ÿç”¨å®˜æ–¹çš„ä¸€å¼ å›¾ç‰‡æ¥è¡¨ç¤º</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46eebdde38824c5491cdb54450dadc7e~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>è¿™é‡Œå¯ä»¥æ ¹æ® <a target="_blank" rel="noopener" href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/Progress.java">square</a> å®˜æ–¹æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼Œæ¥å®ç°åœ¨ä¸‹è½½ä¸€å¼  10 MB å›¾ç‰‡çš„æ—¶å€™é€šè¿‡æ‹¦æˆªå™¨å¯¹ä¸‹è½½è¿›åº¦è¿›è¡Œç›‘å¬ï¼Œå¹¶åŒæ—¶æŠŠå›¾ç‰‡ä¸‹è½½åˆ°ç³»ç»Ÿçš„æ¡Œé¢</p>
<p>å®ç°æ€è·¯å°±æ˜¯å¯¹åŸå§‹çš„ ResponseBody è¿›è¡Œå¤šä¸€å±‚ä»£ç†ï¼Œè®¡ç®—å·²ç»ä»ç½‘ç»œä¸­è¯»å–åˆ°çš„å­—èŠ‚æ•°å’Œèµ„æºçš„ contentLength ä¹‹é—´çš„ç™¾åˆ†æ¯”ï¼Œä»è€Œå¾—åˆ°ä¸‹è½½è¿›åº¦ã€‚æ­¤å¤–ï¼Œå› ä¸ºè¯¥æ‹¦æˆªå™¨æ˜¯å’Œç¡®åˆ‡çš„ç½‘ç»œè¯·æ±‚ç›¸å…³ï¼Œæ‰€ä»¥åº”è¯¥è¦è®¾ä¸ºç½‘ç»œæ‹¦æˆªå™¨æ‰æ¯”è¾ƒåˆç†</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: leavesCZY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Github</span>ï¼šhttps://github.com/leavesCZY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ProgressListener</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(bytesRead: <span class="type">Long</span>, contentLength: <span class="type">Long</span>, done: <span class="type">Boolean</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">        .url(<span class="string">&quot;https://images.pexels.com/photos/5177790/pexels-photo-5177790.jpeg&quot;</span>)</span><br><span class="line">        .build()</span><br><span class="line">    <span class="keyword">val</span> progressListener: ProgressListener = <span class="keyword">object</span> : ProgressListener &#123;</span><br><span class="line">        <span class="keyword">var</span> firstUpdate = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(bytesRead: <span class="type">Long</span>, contentLength: <span class="type">Long</span>, done: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                println(<span class="string">&quot;completed&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (firstUpdate) &#123;</span><br><span class="line">                    firstUpdate = <span class="literal">false</span></span><br><span class="line">                    <span class="keyword">if</span> (contentLength == -<span class="number">1L</span>) &#123;</span><br><span class="line">                        println(<span class="string">&quot;content-length: unknown&quot;</span>)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.<span class="keyword">out</span>.format(<span class="string">&quot;content-length: %d\n&quot;</span>, contentLength)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                println(bytesRead)</span><br><span class="line">                <span class="keyword">if</span> (contentLength != -<span class="number">1L</span>) &#123;</span><br><span class="line">                    System.<span class="keyword">out</span>.format(<span class="string">&quot;%d%% done\n&quot;</span>, <span class="number">100</span> * bytesRead / contentLength)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> client = OkHttpClient.Builder()</span><br><span class="line">        .addNetworkInterceptor &#123; chain: Interceptor.Chain -&gt;</span><br><span class="line">            <span class="keyword">val</span> originalResponse = chain.proceed(chain.request())</span><br><span class="line">            originalResponse.newBuilder()</span><br><span class="line">                .body(ProgressResponseBody(originalResponse.body!!, progressListener))</span><br><span class="line">                .build()</span><br><span class="line">        &#125;</span><br><span class="line">        .build()</span><br><span class="line">    client.newCall(request).execute().use &#123; response -&gt;</span><br><span class="line">        <span class="keyword">if</span> (!response.isSuccessful) &#123;</span><br><span class="line">            <span class="keyword">throw</span> IOException(<span class="string">&quot;Unexpected code <span class="variable">$response</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> desktopDir = FileSystemView.getFileSystemView().homeDirectory</span><br><span class="line">        <span class="keyword">val</span> imageFile = File(desktopDir, <span class="string">&quot;<span class="subst">$&#123;System.currentTimeMillis()&#125;</span>.jpeg&quot;</span>)</span><br><span class="line">        imageFile.createNewFile()</span><br><span class="line">        <span class="comment">//è¯»å– InputStream å†™å…¥åˆ°å›¾ç‰‡æ–‡ä»¶ä¸­</span></span><br><span class="line">        response.body!!.byteStream().copyTo(imageFile.outputStream())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ProgressResponseBody</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> responseBody: ResponseBody,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> progressListener: ProgressListener</span><br><span class="line">) : ResponseBody() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> bufferedSource: BufferedSource? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">contentType</span><span class="params">()</span></span>: MediaType? &#123;</span><br><span class="line">        <span class="keyword">return</span> responseBody.contentType()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">contentLength</span><span class="params">()</span></span>: <span class="built_in">Long</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> responseBody.contentLength()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">source</span><span class="params">()</span></span>: BufferedSource &#123;</span><br><span class="line">        <span class="keyword">if</span> (bufferedSource == <span class="literal">null</span>) &#123;</span><br><span class="line">            bufferedSource = source(responseBody.source()).buffer()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bufferedSource!!</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">source</span><span class="params">(source: <span class="type">Source</span>)</span></span>: Source &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">object</span> : ForwardingSource(source) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> totalBytesRead = <span class="number">0L</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Throws(IOException::class)</span></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">read</span><span class="params">(sink: <span class="type">Buffer</span>, byteCount: <span class="type">Long</span>)</span></span>: <span class="built_in">Long</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> bytesRead = <span class="keyword">super</span>.read(sink, byteCount)</span><br><span class="line">                <span class="comment">// read() returns the number of bytes read, or -1 if this source is exhausted.</span></span><br><span class="line">                totalBytesRead += <span class="keyword">if</span> (bytesRead != -<span class="number">1L</span>) bytesRead <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">                progressListener.update(totalBytesRead, responseBody.contentLength(), bytesRead == -<span class="number">1L</span>)</span><br><span class="line">                <span class="keyword">return</span> bytesRead</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›åº¦è¾“å‡ºå°±ç±»ä¼¼äºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">content-length: <span class="number">11448857</span></span><br><span class="line"><span class="number">467</span></span><br><span class="line"><span class="number">0</span>% done</span><br><span class="line"><span class="number">1836</span></span><br><span class="line"><span class="number">0</span>% done</span><br><span class="line"><span class="number">3205</span></span><br><span class="line"></span><br><span class="line">Â·Â·Â·</span><br><span class="line"></span><br><span class="line"><span class="number">99</span>% done</span><br><span class="line"><span class="number">11442570</span></span><br><span class="line"><span class="number">99</span>% done</span><br><span class="line"><span class="number">11448857</span></span><br><span class="line"><span class="number">100</span>% done</span><br><span class="line">completed</span><br></pre></td></tr></table></figure>

<h1 id="ä¸ƒã€ç»“å°¾"><a href="#ä¸ƒã€ç»“å°¾" class="headerlink" title="ä¸ƒã€ç»“å°¾"></a>ä¸ƒã€ç»“å°¾</h1><p>å…³äº OkHttp çš„æºç è®²è§£åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä½†æœ¬æ–‡è¿˜ç¼ºå°‘äº†å¯¹ ConnectInterceptor å’Œ CallServerInterceptor çš„è®²è§£ï¼Œè¿™ä¸¤è€…æ˜¯ OkHttp å®Œæˆå®é™…ç½‘ç»œè¯·æ±‚çš„åœ°æ–¹ï¼Œæ¶‰åŠåˆ°äº† Connection å’Œ Socket è¿™äº›æ¯”è¾ƒåº•å±‚çš„é¢†åŸŸï¼Œæˆ‘æ²¡æ³•è®²å¾—å¤šæ¸…æ™°ï¼Œå°±ç›´æ¥ç•¥è¿‡è¿™å—å†…å®¹äº†~~</p>
<p>OkHttp çš„è¿è¡Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†åœ¨ä½¿ç”¨ä¸Šè¿˜æ˜¯æ¯”è¾ƒåŸå§‹ï¼Œä¸€èˆ¬æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åœ¨ OkHttp ä¹‹ä¸Šè¿›è¡Œä¸€å±‚å°è£…ï¼ŒRetrofit å°±æ˜¯ä¸€ä¸ªå¯¹ OkHttp çš„ä¼˜ç§€å°è£…åº“ï¼Œå¯¹ Retrofit çš„æºç è®²è§£å¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://juejin.im/post/6886121327845965838">ä¸‰æ–¹åº“æºç ç¬”è®°ï¼ˆ7ï¼‰-Retrofit æºç è¯¦è§£</a></p>
<p>ä¸‹ç¯‡æ–‡ç« å°±æ¥å†™å…³äº OkHttp æ‹¦æˆªå™¨çš„å®æˆ˜å†…å®¹å§</p>

  </article>
  <!-- tag -->
  <div class="mt-12 pt-6 border-t border-gray-200">
    
  </div>
  <!-- prev and next -->
  <div class="flex justify-between mt-12 pt-6 border-t border-gray-200">
    <div>
      
        <a href="/hexo-blog/public/2025/03/02/md/mysql/mysql%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          <iconify-icon width="20" icon="ri:arrow-left-s-line" data-inline="false"></iconify-icon>
          
        </a>
      
    </div>
    <div>
      
        <a href="/hexo-blog/public/2025/03/02/md/kotlin/%E4%B8%BB%E6%B5%81%E5%BC%80%E6%BA%90%E5%BA%93%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%8812%EF%BC%89OkHttp%20&%20Retrofit%20%E5%BC%80%E5%8F%91%E8%B0%83%E8%AF%95%E5%88%A9%E5%99%A8/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ12ï¼‰OkHttp & Retrofit å¼€å‘è°ƒè¯•åˆ©å™¨
          <iconify-icon width="20" icon="ri:arrow-right-s-line" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>
  <!-- comment -->
  <div class="article-comments mt-12">
    
<script
  src="https://giscus.app/client.js"
  data-repo="hqqich/giscus"
  data-repo-id="R_kgDOOCZUBA"
  data-category="General"
  data-category-id="DIC_kwDOOCZUBM4Cng1l"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="preferred_color_scheme"
  data-lang="zh-CN"
  crossorigin="anonymous"
  async
></script>
<script>
  window.onload = function () {
    console.log("giscus loaded");
    const isDark = document.documentElement.classList.contains("dark");
    const giscusFrame = document.querySelector("iframe.giscus-frame");
    giscusFrame.contentWindow.postMessage(
      {
        giscus: {
          setConfig: {
            theme: isDark ? "dark" : "light",
          },
        },
      },
      "https://giscus.app"
    );
  };
</script>


  </div>
</section>
<!-- js inspect -->

<script src="/hexo-blog/public/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/hexo-blog/public/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + alt + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/hexo-blog/public/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->


  </main>
  <footer class="flex flex-col h-40 items-center justify-center text-gray-400 text-sm">
  <!-- busuanzi -->
  
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex items-center gap-2">
  <span>Visitors</span>
  <span id="busuanzi_value_site_uv"></span>
  <span>Page Views</span>
  <span id="busuanzi_value_site_pv"></span>
</div>
<!-- End Busuanzi Analytics -->


  <!-- copyright -->
  <div class="flex items-center gap-2">
    <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: inherit;">CC BY-NC-SA 4.0</a>
    <span>Â© 2022</span>
    <iconify-icon width="18" icon="emojione-monotone:maple-leaf" ></iconify-icon>
    <a href="https://github.com/xbmlz" target="_blank" rel="noopener noreferrer">xbmlz</a>
  </div>
  <!-- powered by -->
  <div class="flex items-center gap-2">
    <span>Powered by</span>
    <a href="https://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a>
    <span>&</span>
    <a href="https://github.com/xbmlz/hexo-theme-maple" target="_blank" rel="noopener noreferrer">Maple</a>
  </div>

</footer>

  <div class="back-to-top box-border fixed right-6 z-1024 -bottom-20 rounded py-1 px-1 bg-slate-900 opacity-60 text-white cursor-pointer text-center dark:bg-slate-600">
    <span class="flex justify-center items-center text-sm">
      <iconify-icon width="18" icon="ion:arrow-up-c" id="go-top"></iconify-icon>
      <span id="scrollpercent"><span>0</span> %</span>
    </span>
  </div>
  
<script src="/hexo-blog/public/js/main.js"></script>


  <script>
    $(document).ready(function () {
      const mapleCount = "10";
      const speed = "0.5";
      const mapleEl = document.getElementById("maple");
      const maples = Array.from({ length: mapleCount }).map(() => {
        const maple = document.createElement("div");
        const scale = Math.random() * 0.5 + 0.5;
        const offset = Math.random() * 2 - 1;
        const x = Math.random() * mapleEl.clientWidth;
        const y = -Math.random() * mapleEl.clientHeight;
        const duration = 10 / speed;
        const delay = -duration;
        maple.className = "maple";
        maple.style.width = `${24 * scale}px`;
        maple.style.height = `${24 * scale}px`;
        maple.style.left = `${x}px`;
        maple.style.top = `${y}px`;
        maple.style.setProperty("--maple-fall-offset", offset);
        maple.style.setProperty("--maple-fall-height", `${Math.abs(y) + mapleEl.clientHeight}px`);
        maple.style.animation = `fall ${duration}s linear infinite`;
        maple.style.animationDelay = `${delay}s`;
        mapleEl.appendChild(maple)
        return maple
      })
    });
  </script>
  


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
