<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHXM4GYP5W"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-EHXM4GYP5W');
</script>
<!-- End Google Analytics -->



<!-- Baidu Analytics -->
<script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0a6515fb9c839d6a56d4cfd8b7d243d4";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>
<!-- End Baidu Analytics -->


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="hqqich">


  <meta name="subtitle" content="å¿™ç¢ŒæŠŠæ—¶å…‰ç¼©çŸ­, è‹¦éš¾æŠŠå²æœˆæ‹‰é•¿">




<title>ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶ | Hexo-blog</title>



<link rel="icon" href="/hexo-blog/public/favicon.ico">



<link rel="stylesheet" href="/hexo-blog/public/css/main.css">


<link rel="stylesheet" href="/hexo-blog/public/lib/nprogress/nprogress.css">



<script src="/hexo-blog/public/lib/jquery.min.js"></script>


<script src="/hexo-blog/public/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>


<script src="/hexo-blog/public/lib/nprogress/nprogress.js"></script>

<script>
  $(document).ready(() => {
    NProgress.configure({
      showSpinner: false,
    });
    NProgress.start();
    $("#nprogress .bar").css({
      background: "#de7441",
    });
    $("#nprogress .peg").css({
      "box-shadow": "0 0 2px #de7441, 0 0 4px #de7441",
    });
    $("#nprogress .spinner-icon").css({
      "border-top-color": "#de7441",
      "border-left-color": "#de7441",
    });
    setTimeout(function () {
      NProgress.done();
      $(".fade").removeClass("out");
    }, 800);
  });
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }

    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ri:moon-line" : "ri:sun-line"
          );
          toggleGiscusTheme();
        }
      });

    $("#toggle-dark").click((event) => {
      const isAppearanceTransition = document.startViewTransition && !window.matchMedia('(prefers-reduced-motion: reduce)').matches
      if (!isAppearanceTransition) {
        toggleDark()
        return
      }
      const x = event.clientX
      const y = event.clientY
      const endRadius = Math.hypot(
        Math.max(x, innerWidth - x),
        Math.max(y, innerHeight - y),
      )
      const transition = document.startViewTransition(async () => {
        toggleDark()
      })

      transition.ready
        .then(() => {
          const isDark = document.documentElement.classList.contains("dark")
          const clipPath = [
            `circle(0px at ${x}px ${y}px)`,
            `circle(${endRadius}px at ${x}px ${y}px)`,
          ]
          document.documentElement.animate(
            {
              clipPath: isDark
                ? [...clipPath].reverse()
                : clipPath,
            },
            {
              duration: 400,
              easing: 'ease-out',
              pseudoElement: isDark
                ? '::view-transition-old(root)'
                : '::view-transition-new(root)',
            },
          )
        })
    });
  });
</script>




<meta name="generator" content="Hexo 7.3.0"></head>
<body class="font-sans bg-white dark:bg-zinc-900 text-gray-700 dark:text-gray-200 relative">
  <header class="fixed w-full px-5 py-1 z-10 backdrop-blur-xl backdrop-saturate-150 border-b border-black/5">
  <div class="max-auto">
    <nav class="flex items-center text-base">
      <a href="/hexo-blog/public/" class="group">
        <h2 class="font-medium tracking-tighterp text-l p-2">
          <img class="w-5 mr-2 inline-block transition-transform group-hover:rotate-[30deg]" id="logo" src="https://moe-counter-vercel-gamma.vercel.app/a?theme=rule34" alt="Hexo-blog" />
          Hexo-blog
        </h2>
      </a>
      <div id="header-title" class="opacity-0 md:ml-2 md:mt-[0.1rem] text-xs font-medium whitespace-nowrap overflow-hidden overflow-ellipsis">
        ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        
          <a class="hidden sm:flex" href="/hexo-blog/public/archives">Posts</a>
        
          <a class="hidden sm:flex" href="/hexo-blog/public/category">Categories</a>
        
          <a class="hidden sm:flex" href="/hexo-blog/public/tag">Tags</a>
        
        
          
            <a class="w-5 h-5 hidden sm:flex" title="Github" target="_blank" rel="noopener" href="https://github.com/hqqich">
              <iconify-icon width="20" icon="ri:github-line"></iconify-icon>
            </a>
          
        
        <a class="w-5 h-5 hidden sm:flex" title="Github" href="rss2.xml">
          <iconify-icon width="20" icon="ri:rss-line"></iconify-icon>
        </a>
        <a class="w-5 h-5" title="toggle theme" id="toggle-dark">
          <iconify-icon width="20" icon="" id="theme-icon"></iconify-icon>
        </a>
      </div>
      <div class="flex items-center justify-center gap-3 ml-3 sm:hidden">
        <span class="w-5 h-5" aria-hidden="true" role="img" id="open-menu">
          <iconify-icon width="20" icon="carbon:menu" ></iconify-icon>
        </span>
        <span class="w-5 h-5 hidden" aria-hidden="true" role="img" id="close-menu">
          <iconify-icon  width="20" icon="carbon:close" ></iconify-icon>
        </span>
      </div>
    </nav>
  </div>
</header>
<div id="menu-panel" class="h-0 overflow-hidden sm:hidden fixed left-0 right-0 top-12 bottom-0 z-10">
  <div id="menu-content" class="relative z-20 bg-white/80 px-6 sm:px-8 py-2 backdrop-blur-xl -translate-y-full transition-transform duration-300">
    <ul class="nav flex flex-col sm:flex-row text-sm font-medium">
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/archives" class="flex h-12 sm:h-auto items-center">Posts</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/category" class="flex h-12 sm:h-auto items-center">Categories</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/tag" class="flex h-12 sm:h-auto items-center">Tags</a>
        </li>
      
    </ul>
  </div>
  <div class="mask bg-black/20 absolute inset-0"></div>
</div>

  <main class="pt-14">
    <!-- css -->

<link rel="stylesheet" href="/hexo-blog/public/lib/fancybox/fancybox.min.css">


<link rel="stylesheet" href="/hexo-blog/public/lib/tocbot/tocbot.min.css">

<!-- toc -->

  <!-- tocbot -->
<nav class="post-toc toc text-sm w-48 relative top-32 right-0 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- header -->
  <header class="overflow-hidden pt-6 pb-6 md:pt-12">
    <div class="pt-4 md:pt-6">
      <h1 id="article-title" class="text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
        ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶
      </h1>
      <div>
        <section class="flex items-center gap-3 text-sm">
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="carbon-calendar" ></iconify-icon>
            <time>2025-03-02</time>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="ic:round-access-alarm" ></iconify-icon>
            <span>60 min</span>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="icon-park-outline:font-search" ></iconify-icon>
            <span>14.1k words</span>
          </span>
          
            <span class="text-gray-400">Â·</span>
            <span class="flex items-center gap-1">
              <iconify-icon width="16" icon="icon-park-outline:box" class="mr-2"></iconify-icon>
              <a class="article-category-link" href="/hexo-blog/public/categories/kotlin/">kotlin</a>
            </span>
          
        </section>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto slide-enter-content dark:prose-invert">
    <blockquote>
<p>å…¬ä¼—å·ï¼š<a target="_blank" rel="noopener" href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image">å­—èŠ‚æ•°ç»„</a></p>
<p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p>
</blockquote>
<p>Handler åœ¨æ•´ä¸ª Android å¼€å‘ä½“ç³»ä¸­å æ®ç€å¾ˆé‡è¦çš„åœ°ä½ï¼Œæ˜¯ä¸€ç§æ ‡å‡†çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œå¯¹å¼€å‘è€…æ¥è¯´èµ·åˆ°çš„ä½œç”¨å¾ˆæ˜ç¡®ï¼Œå°±æ˜¯ä¸ºäº†å®ç°çº¿ç¨‹åˆ‡æ¢æˆ–è€…æ˜¯æ‰§è¡Œå»¶æ—¶ä»»åŠ¡ï¼Œç¨å¾®æ›´é«˜çº§ä¸€ç‚¹çš„ç”¨æ³•å¯èƒ½æ˜¯ä¸ºäº†ä¿è¯å¤šä¸ªä»»åŠ¡åœ¨æ‰§è¡Œæ—¶çš„æœ‰åºæ€§ã€‚ç”±äº Android ç³»ç»Ÿä¸­çš„ä¸»çº¿ç¨‹æœ‰ç‰¹æ®Šåœ°ä½ï¼Œæ‰€ä»¥åƒ EventBus å’Œ Retrofit è¿™ç±»å¹¶é Android ç‹¬æœ‰çš„ä¸‰æ–¹åº“ï¼Œéƒ½æ˜¯é€šè¿‡ Handler æ¥å®ç°å¯¹ Android ç³»ç»Ÿçš„ç‰¹æ®Šå¹³å°æ”¯æŒã€‚å¤§éƒ¨åˆ†å¼€å‘è€…éƒ½å·²ç»å¯¹å¦‚ä½•ä½¿ç”¨ Handler å¾ˆç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œå°±å†æ¥äº†è§£ä¸‹å…¶å†…éƒ¨å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p>
<p><strong>æœ¬æ–‡åŸºäº Android API 30ï¼ˆå³ Android 11ï¼‰çš„ç³»ç»Ÿæºç è¿›è¡Œè®²è§£</strong></p>
<h1 id="ä¸€ã€åŠ¨æ‰‹å®ç°-Handler"><a href="#ä¸€ã€åŠ¨æ‰‹å®ç°-Handler" class="headerlink" title="ä¸€ã€åŠ¨æ‰‹å®ç° Handler"></a>ä¸€ã€åŠ¨æ‰‹å®ç° Handler</h1><p>æœ¬æ–‡ä¸ä¼šä¸€ä¸Šæ¥å°±ç›´æ¥ä»‹ç»æºç ï¼Œè€Œæ˜¯ä¼šå…ˆæ ¹æ®æˆ‘ä»¬æƒ³è¦å®ç°çš„æ•ˆæœæ¥åæ¨æºç ï¼Œä¸€æ­¥æ­¥æ¥è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªç®€å•çš„ Handler</p>
<h2 id="1ã€Message"><a href="#1ã€Message" class="headerlink" title="1ã€Message"></a>1ã€Message</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸ªè½½ä½“æ¥è¡¨ç¤ºè¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå°±å«å®ƒ Message å§ï¼ŒMessage åº”è¯¥æœ‰ä»€ä¹ˆå‚æ•°å‘¢ï¼Ÿ</p>
<ul>
<li>éœ€è¦æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œå› ä¸ºè¦æ‰§è¡Œçš„ä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªï¼Œæˆ‘ä»¬è¦åˆ†å¾—æ¸…å“ªä¸ªæ˜¯å“ªä¸ªï¼Œç”¨ä¸ª Int ç±»å‹å˜é‡å°±è¶³å¤Ÿè¡¨ç¤ºäº†</li>
<li>éœ€è¦èƒ½å¤Ÿæ‰¿è½½æ•°æ®ï¼Œéœ€è¦å‘é€çš„æ•°æ®ç±»å‹ä¼šæœ‰å¾ˆå¤šç§å¯èƒ½ï¼Œé‚£å°±ç›´æ¥ç”¨ä¸€ä¸ª Object ç±»å‹å˜é‡æ¥è¡¨ç¤ºå§ï¼Œç”±å¼€å‘è€…è‡ªå·±åœ¨ä½¿ç”¨æ—¶å†æ¥å¼ºè½¬ç±»å‹</li>
<li>éœ€è¦æœ‰ä¸€ä¸ª long ç±»å‹å˜é‡æ¥è¡¨ç¤ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æˆ³</li>
</ul>
<p>æ‰€ä»¥ï¼ŒMessage ç±»å°±åº”è¯¥è‡³å°‘åŒ…å«ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: leavesCZY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Desc</span>:</span></span><br><span class="line"><span class="comment"> * @å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="comment">//å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> what;</span><br><span class="line">    <span class="comment">//æ•°æ®</span></span><br><span class="line">    <span class="keyword">public</span> Object obj;</span><br><span class="line">    <span class="comment">//æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="keyword">when</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2ã€MessageQueue"><a href="#2ã€MessageQueue" class="headerlink" title="2ã€MessageQueue"></a>2ã€MessageQueue</h2><p>å› ä¸º Message å¹¶ä¸æ˜¯å‘é€äº†å°±èƒ½å¤Ÿé©¬ä¸Šè¢«æ¶ˆè´¹æ‰ï¼Œæ‰€ä»¥å°±è‚¯å®šè¦æœ‰ä¸ªå¯ä»¥ç”¨æ¥å­˜æ”¾çš„åœ°æ–¹ï¼Œå°±å«å®ƒ MessageQueue å§ï¼Œå³æ¶ˆæ¯é˜Ÿåˆ—ã€‚Message å¯èƒ½éœ€è¦å»¶è¿Ÿå¤„ç†ï¼Œé‚£ä¹ˆ MessageQueue åœ¨ä¿å­˜ Message çš„æ—¶å€™å°±åº”è¯¥æŒ‰ç…§æ—¶é—´æˆ³çš„å¤§å°æ¥é¡ºåºå­˜æ”¾ï¼Œæ—¶é—´æˆ³å°çš„ Message æ”¾åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œåœ¨æ¶ˆè´¹ Message çš„æ—¶å€™å°±ç›´æ¥ä»é˜Ÿåˆ—å¤´å–å€¼å³å¯</p>
<p>é‚£ä¹ˆç”¨ä»€ä¹ˆæ•°æ®ç»“æ„æ¥å­˜æ”¾ Message æ¯”è¾ƒå¥½å‘¢ï¼Ÿ</p>
<ul>
<li>ç”¨æ•°ç»„ï¼Ÿä¸å¤ªåˆé€‚ï¼Œæ•°ç»„è™½ç„¶åœ¨éå†çš„æ—¶å€™ä¼šæ¯”è¾ƒå¿«ï¼Œä½†éœ€è¦é¢„å…ˆå°±ç”³è¯·å›ºå®šçš„å†…å­˜ç©ºé—´ï¼Œå¯¼è‡´åœ¨æ’å…¥æ•°æ®å’Œç§»é™¤æ•°æ®æ—¶å¯èƒ½éœ€è¦ç§»åŠ¨å¤§é‡æ•°æ®ã€‚è€Œ MessageQueue å¯èƒ½éšæ—¶ä¼šæ”¶åˆ°æ•°é‡ä¸å®šã€æ—¶é—´æˆ³å¤§å°ä¸å®šçš„ Messageï¼Œæ¶ˆè´¹å®Œ Message åè¿˜éœ€è¦å°†è¯¥å…¶ç§»å‡ºé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„å¹¶ä¸åˆé€‚</li>
<li>ç”¨é“¾è¡¨ï¼Ÿå¥½åƒå¯ä»¥ï¼Œé“¾è¡¨åœ¨æ’å…¥æ•°æ®å’Œç§»é™¤æ•°æ®æ—¶åªéœ€è¦æ”¹å˜æŒ‡é’ˆçš„å¼•ç”¨å³å¯ï¼Œä¸éœ€è¦ç§»åŠ¨æ•°æ®ï¼Œå†…å­˜ç©ºé—´ä¹Ÿåªéœ€è¦æŒ‰éœ€ç”³è¯·å³å¯ã€‚è™½ç„¶é“¾è¡¨åœ¨éšæœºè®¿é—®çš„æ—¶å€™æ€§èƒ½ä¸é«˜ï¼Œä½†æ˜¯å¯¹äº MessageQueue è€Œè¨€æ— æ‰€è°“ï¼Œå› ä¸ºåœ¨æ¶ˆè´¹ Message çš„æ—¶å€™ä¹Ÿåªéœ€è¦å–é˜Ÿåˆ—å¤´çš„å€¼ï¼Œå¹¶ä¸éœ€è¦éšæœºè®¿é—®</li>
</ul>
<p>å¥½äº†ï¼Œæ—¢ç„¶å†³å®šç”¨é“¾è¡¨ç»“æ„ï¼Œé‚£ä¹ˆ Message å°±éœ€è¦å¢åŠ ä¸€ä¸ªå­—æ®µç”¨äºæŒ‡å‘ä¸‹ä¸€æ¡æ¶ˆæ¯æ‰è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="comment">//å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> what;</span><br><span class="line">    <span class="comment">//æ•°æ®</span></span><br><span class="line">    <span class="keyword">public</span> Object obj;</span><br><span class="line">    <span class="comment">//æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="keyword">when</span>;</span><br><span class="line">	<span class="comment">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">public</span> Message next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MessageQueue éœ€è¦æä¾›ä¸€ä¸ª <code>enqueueMessage</code>æ–¹æ³•ç”¨æ¥å‘é“¾è¡¨æ’å…¥ Messageï¼Œç”±äºå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶å‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯çš„å¯èƒ½ï¼Œæ‰€ä»¥æ–¹æ³•å†…éƒ¨è¿˜éœ€è¦åšä¸‹çº¿ç¨‹åŒæ­¥æ‰è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageQueue</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é“¾è¡¨ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">private</span> Message mMessages;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">enqueueMessage</span><span class="params">(Message msg, <span class="type">long</span> <span class="keyword">when</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">p</span> <span class="operator">=</span> mMessages;</span><br><span class="line">            <span class="comment">//å¦‚æœé“¾è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…å¤„äºé˜Ÿå¤´çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯” msg è¦å¤§ï¼Œåˆ™å°† msg ä½œä¸ºé“¾è¡¨å¤´éƒ¨</span></span><br><span class="line">            <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> == <span class="number">0</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                msg.next = p;</span><br><span class="line">                mMessages = msg;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message prev;</span><br><span class="line">                <span class="comment">//ä»é“¾è¡¨å¤´å‘é“¾è¡¨å°¾éå†ï¼Œå¯»æ‰¾é“¾è¡¨ä¸­ç¬¬ä¸€æ¡æ—¶é—´æˆ³æ¯” msg å¤§çš„æ¶ˆæ¯ï¼Œå°† msg æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</span></span><br><span class="line">                <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                    prev = p;</span><br><span class="line">                    p = p.next;</span><br><span class="line">                    <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                msg.next = p;</span><br><span class="line">                prev.next = msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤–ï¼ŒMessageQueue è¦æœ‰ä¸€ä¸ªå¯ä»¥è·å–é˜Ÿå¤´æ¶ˆæ¯çš„æ–¹æ³•æ‰è¡Œï¼Œå°±å«åš<code>next()</code>å§ã€‚å¤–éƒ¨æœ‰å¯èƒ½ä¼šéšæ—¶å‘ MessageQueue å‘é€ Messageï¼Œ<code>next()</code>æ–¹æ³•å†…éƒ¨å°±ç›´æ¥æ¥å¼€å¯ä¸€ä¸ªæ— é™å¾ªç¯æ¥åå¤å–å€¼å§ã€‚å¦‚æœå½“å‰é˜Ÿå¤´çš„æ¶ˆæ¯å¯ä»¥ç›´æ¥å¤„ç†çš„è¯ï¼ˆå³æ¶ˆæ¯çš„æ—¶é—´æˆ³å°äºæˆ–ç­‰äºå½“å‰æ—¶é—´ï¼‰ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›é˜Ÿå¤´æ¶ˆæ¯ã€‚è€Œå¦‚æœé˜Ÿå¤´æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯”å½“å‰æ—¶é—´è¿˜è¦å¤§ï¼ˆå³é˜Ÿå¤´æ¶ˆæ¯æ˜¯ä¸€ä¸ªå»¶æ—¶æ¶ˆæ¯ï¼‰ï¼Œé‚£ä¹ˆå°±è®¡ç®—å½“å‰æ—¶é—´å’Œé˜Ÿå¤´æ¶ˆæ¯çš„æ—¶é—´æˆ³çš„å·®å€¼ï¼Œè®¡ç®— <code>next()</code> æ–¹æ³•éœ€è¦é˜»å¡ç­‰å¾…çš„æ—¶é—´ï¼Œè°ƒç”¨ <code>nativePollOnce()</code>æ–¹æ³•æ¥ç­‰å¾…ä¸€æ®µæ—¶é—´åå†ç»§ç»­å¾ªç¯éå†</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨æ¥æ ‡è®° next() æ–¹æ³•æ˜¯å¦æ­£å¤„äºé˜»å¡ç­‰å¾…çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> boolean mBlocked = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">Message next() &#123;</span><br><span class="line">    int nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">        nativePollOnce(nextPollTimeoutMillis);</span><br><span class="line">        synchronized (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//å½“å‰æ—¶é—´</span></span><br><span class="line">            <span class="keyword">final</span> long now = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">            Message msg = mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.<span class="keyword">when</span>) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå½“å‰æ—¶é—´è¿˜æœªåˆ°è¾¾æ¶ˆæ¯çš„çš„å¤„ç†æ—¶é—´ï¼Œé‚£ä¹ˆå°±è®¡ç®—è¿˜éœ€è¦ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">                    nextPollTimeoutMillis = (int) Math.min(msg.<span class="keyword">when</span> - now, Integer.MAX_VALUE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//å¯ä»¥å¤„ç†é˜Ÿå¤´çš„æ¶ˆæ¯äº†ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯æˆä¸ºé˜Ÿå¤´</span></span><br><span class="line">                    mMessages = msg.next;</span><br><span class="line">                    msg.next = <span class="literal">null</span>;</span><br><span class="line">                    mBlocked = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mBlocked = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°† next æ–¹æ³•çš„è°ƒç”¨çº¿ç¨‹ä¼‘çœ æŒ‡å®šæ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> void nativePollOnce(long nextPollTimeoutMillis) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å°±éœ€è¦è€ƒè™‘åˆ°ä¸€ç§æƒ…å½¢ï¼š<strong>å½“ <code>next()</code>è¿˜å¤„äºé˜»å¡çŠ¶æ€çš„æ—¶å€™ï¼Œå¤–éƒ¨å‘æ¶ˆæ¯é˜Ÿåˆ—æ’å…¥äº†ä¸€ä¸ªå¯ä»¥ç«‹å³å¤„ç†æˆ–è€…æ˜¯é˜»å¡ç­‰å¾…æ—¶é—´æ¯”è¾ƒçŸ­çš„ Message</strong>ã€‚æ­¤æ—¶å°±éœ€è¦å”¤é†’ä¼‘çœ çš„çº¿ç¨‹ï¼Œå› æ­¤ <code>enqueueMessage</code>è¿˜éœ€è¦å†æ”¹åŠ¨ä¸‹ï¼Œå¢åŠ åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’<code>next()</code>æ–¹æ³•çš„é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">enqueueMessage</span><span class="params">(Message msg, <span class="type">long</span> <span class="keyword">when</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">//ç”¨äºæ ‡è®°æ˜¯å¦éœ€è¦å”¤é†’ next æ–¹æ³•</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">needWake</span> <span class="operator">=</span> <span class="literal">false</span>;         </span><br><span class="line">        <span class="type">Message</span> <span class="variable">p</span> <span class="operator">=</span> mMessages;</span><br><span class="line">        <span class="comment">//å¦‚æœé“¾è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…å¤„äºé˜Ÿå¤´çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯” msg è¦å¤§ï¼Œåˆ™å°† msg ä½œä¸ºé“¾è¡¨å¤´éƒ¨</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> == <span class="number">0</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">            msg.next = p;</span><br><span class="line">            mMessages = msg;     </span><br><span class="line">            <span class="comment">//éœ€è¦å”¤é†’</span></span><br><span class="line">            needWake = mBlocked;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Message prev;</span><br><span class="line">            <span class="comment">//ä»é“¾è¡¨å¤´å‘é“¾è¡¨å°¾éå†ï¼Œå¯»æ‰¾é“¾è¡¨ä¸­ç¬¬ä¸€æ¡æ—¶é—´æˆ³æ¯” msg å¤§çš„æ¶ˆæ¯ï¼Œå°† msg æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</span></span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = p.next;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            msg.next = p;</span><br><span class="line">            prev.next = msg;</span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">            <span class="comment">//å”¤é†’ next() æ–¹æ³•</span></span><br><span class="line">            nativeWake();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å”¤é†’ next() æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">nativeWake</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3ã€Handler"><a href="#3ã€Handler" class="headerlink" title="3ã€Handler"></a>3ã€Handler</h2><p>æ—¢ç„¶å­˜æ”¾æ¶ˆæ¯çš„åœ°æ–¹å·²ç»ç¡®å®šå°±æ˜¯ MessageQueue äº†ï¼Œé‚£ä¹ˆè‡ªç„¶å°±è¿˜éœ€è¦æœ‰ä¸€ä¸ªç±»å¯ä»¥ç”¨æ¥å‘ MessageQueue å‘é€æ¶ˆæ¯äº†ï¼Œå°±å«å®ƒ Handler å§ã€‚Handler å¯ä»¥å®ç°å“ªäº›åŠŸèƒ½å‘¢ï¼Ÿ</p>
<ul>
<li>å¸Œæœ›é™¤äº†å¯ä»¥å‘é€ Message ç±»å‹çš„æ¶ˆæ¯å¤–è¿˜å¯ä»¥å‘é€ Runnable ç±»å‹çš„æ¶ˆæ¯ã€‚è¿™ä¸ªç®€å•ï¼ŒHandler å†…éƒ¨å°† Runnable åŒ…è£…ä¸º Message å³å¯</li>
<li>å¸Œæœ›å¯ä»¥å‘é€å»¶æ—¶æ¶ˆæ¯ï¼Œä»¥æ­¤æ¥æ‰§è¡Œå»¶æ—¶ä»»åŠ¡ã€‚è¿™ä¸ªä¹Ÿç®€å•ï¼Œç”¨ Message å†…éƒ¨çš„ when å­—æ®µæ¥æ ‡è¯†å¸Œæœ›ä»»åŠ¡æ‰§è¡Œæ—¶çš„æ—¶é—´æˆ³å³å¯</li>
<li>å¸Œæœ›å¯ä»¥å®ç°çº¿ç¨‹åˆ‡æ¢ï¼Œå³ä»å­çº¿ç¨‹å‘é€çš„ Message å¯ä»¥åœ¨ä¸»çº¿ç¨‹è¢«æ‰§è¡Œï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚è¿™ä¸ªä¹Ÿä¸éš¾ï¼Œå­çº¿ç¨‹å¯ä»¥å‘ä¸€ä¸ªç‰¹å®šçš„ mainMessageQueue å‘é€æ¶ˆæ¯ï¼Œç„¶åè®©ä¸»çº¿ç¨‹è´Ÿè´£å¾ªç¯ä»è¯¥é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯å¹¶æ‰§è¡Œå³å¯ï¼Œè¿™æ ·ä¸å°±å®ç°äº†çº¿ç¨‹åˆ‡æ¢äº†å—ï¼Ÿ</li>
</ul>
<p><strong>æ‰€ä»¥è¯´ï¼ŒMessage çš„å®šä¹‰å’Œå‘é€æ˜¯ç”± Handler æ¥å®Œæˆçš„ï¼Œä½† Message çš„åˆ†å‘åˆ™å¯ä»¥äº¤ç”±å…¶ä»–çº¿ç¨‹æ¥å®Œæˆ</strong></p>
<p>æ ¹æ®ä»¥ä¸Šéœ€æ±‚ï¼š<strong>Runnable è¦èƒ½å¤ŸåŒ…è£…ä¸º Message ç±»å‹ï¼ŒMessage çš„å¤„ç†é€»è¾‘è¦äº¤ç”± Handler æ¥å®šä¹‰</strong>ï¼Œæ‰€ä»¥ Message å°±è¿˜éœ€è¦å¢åŠ ä¸¤ä¸ªå­—æ®µæ‰è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: leavesCZY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Desc</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Github</span>ï¼šhttps://github.com/leavesCZY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="comment">//å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> what;</span><br><span class="line">    <span class="comment">//æ•°æ®</span></span><br><span class="line">    <span class="keyword">public</span> Object obj;</span><br><span class="line">    <span class="comment">//æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="keyword">when</span>;</span><br><span class="line">	<span class="comment">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">public</span> Message next;</span><br><span class="line">	<span class="comment">//ç”¨äºå°† Runnable åŒ…è£…ä¸º Message</span></span><br><span class="line">    <span class="keyword">public</span> Runnable callback;</span><br><span class="line">    <span class="comment">//æŒ‡å‘ Message çš„å‘é€è€…ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ Message çš„æœ€ç»ˆå¤„ç†è€…</span></span><br><span class="line">    <span class="keyword">public</span> Handler target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Handler è‡³å°‘éœ€è¦åŒ…å«å‡ ä¸ªæ–¹æ³•ï¼šç”¨äºå‘é€ Message å’Œ Runnable çš„æ–¹æ³•ã€ç”¨æ¥å¤„ç†æ¶ˆæ¯çš„ <code>handleMessage</code> æ–¹æ³•ã€ç”¨äºåˆ†å‘æ¶ˆæ¯çš„ <code>dispatchMessage</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: leavesCZY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Desc</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Github</span>ï¼šhttps://github.com/leavesCZY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MessageQueue mQueue;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(MessageQueue mQueue)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mQueue = mQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">post</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        sendMessageDelayed(getPostMessage(r), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">postDelayed</span><span class="params">(Runnable r, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">        sendMessageDelayed(getPostMessage(r), delayMillis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(Message r)</span> &#123;</span><br><span class="line">        sendMessageDelayed(r, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">sendMessageDelayed</span><span class="params">(Message msg, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            delayMillis = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageAtTime</span><span class="params">(Message msg, <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">        msg.target = <span class="built_in">this</span>;</span><br><span class="line">        mQueue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title function_">getPostMessage</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        m.callback = r;</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”±å¤–éƒ¨æ¥é‡å†™è¯¥æ–¹æ³•ï¼Œä»¥æ­¤æ¥æ¶ˆè´¹ Message</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨äºåˆ†å‘æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatchMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            msg.callback.run();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åï¼Œå­çº¿ç¨‹å°±å¯ä»¥åƒè¿™æ ·æ¥ä½¿ç”¨ Handler äº†ï¼š<strong>å°†å­çº¿ç¨‹æŒæœ‰çš„ Handler å¯¹è±¡å’Œä¸»çº¿ç¨‹å…³è”çš„ mainMessageQueue ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸»çº¿ç¨‹è´Ÿè´£å¾ªç¯ä» mainMessageQueue å–å‡º Message åå†æ¥è°ƒç”¨ Handler çš„ <code>dispatchMessage</code> æ–¹æ³•ï¼Œä»¥æ­¤å®ç°çº¿ç¨‹åˆ‡æ¢çš„ç›®çš„</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Handler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>(mainThreadMessageQueue) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">ob</span> <span class="operator">=</span> (String) msg.obj;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">                List&lt;String&gt; ob = (List&lt;String&gt;) msg.obj;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Message</span> <span class="variable">messageA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">messageA.what = <span class="number">1</span>;</span><br><span class="line">messageA.obj = <span class="string">&quot;https://github.com/leavesCZY&quot;</span>;</span><br><span class="line"><span class="type">Message</span> <span class="variable">messageB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">messageB.what = <span class="number">2</span>;</span><br><span class="line">messageB.obj = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">handler.sendMessage(messageA);</span><br><span class="line">handler.sendMessage(messageB);</span><br></pre></td></tr></table></figure>

<h2 id="4ã€Looper"><a href="#4ã€Looper" class="headerlink" title="4ã€Looper"></a>4ã€Looper</h2><p>ç°åœ¨å°±å†æ¥æƒ³æƒ³æ€ä¹ˆè®© Handler æ‹¿åˆ°å’Œä¸»çº¿ç¨‹å…³è”çš„ MessageQueueï¼Œä»¥åŠä¸»çº¿ç¨‹æ€ä¹ˆä» MessageQueue è·å– Message å¹¶å›è°ƒ Handlerã€‚è¿™ä¹‹é—´å°±ä¸€å®šéœ€è¦ä¸€ä¸ªä¸­è½¬å™¨ï¼Œå°±å«å®ƒ Looper å§ã€‚Looper å…·ä½“éœ€è¦å®ç°ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿ</p>
<ul>
<li>æ¯ä¸ª Looper å¯¹è±¡åº”è¯¥éƒ½æ˜¯å¯¹åº”ä¸€ä¸ªç‹¬æœ‰çš„ MessageQueue å®ä¾‹å’Œ Thread å®ä¾‹ï¼Œè¿™æ ·å­çº¿ç¨‹å’Œä¸»çº¿ç¨‹æ‰å¯ä»¥äº’ç›¸å‘é€ Message äº¤ç”±å¯¹æ–¹çº¿ç¨‹å¤„ç†</li>
<li>Looper å†…éƒ¨éœ€è¦å¼€å¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå…¶å…³è”çš„çº¿ç¨‹å°±è´Ÿè´£ä» MessageQueue å¾ªç¯è·å– Message è¿›è¡Œå¤„ç†</li>
<li>å› ä¸ºä¸»çº¿ç¨‹è¾ƒä¸ºç‰¹æ®Šï¼Œæ‰€ä»¥å’Œä¸»çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡è¦èƒ½å¤Ÿè¢«å­çº¿ç¨‹ç›´æ¥è·å–åˆ°ï¼Œå¯ä»¥è€ƒè™‘å°†å…¶ä½œä¸ºé™æ€å˜é‡å­˜ç€</li>
</ul>
<p>è¿™æ ·ï¼ŒLooper çš„å¤§ä½“æ¡†æ¶å°±å‡ºæ¥äº†ã€‚é€šè¿‡ ThreadLocal æ¥ä¸ºä¸åŒçš„çº¿ç¨‹å•ç‹¬ç»´æŠ¤ä¸€ä¸ª Looper å®ä¾‹ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡ <code>prepare()</code>æ–¹æ³•æ¥åˆå§‹åŒ–æœ¬çº¿ç¨‹ç‹¬æœ‰çš„ Looper å®ä¾‹ ï¼Œå†é€šè¿‡ <code>myLooper()</code>æ–¹æ³•æ¥è·å–å’Œå½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå’Œä¸»çº¿ç¨‹å…³è”çš„ <code>sMainLooper</code> ä½œä¸ºé™æ€å˜é‡å­˜åœ¨ï¼Œæ–¹ä¾¿å­çº¿ç¨‹è·å–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: leavesCZY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Desc</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Github</span>ï¼šhttps://github.com/leavesCZY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Looper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Thread mThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Looper sMainLooper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Looper&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Looper</span><span class="params">()</span> &#123;</span><br><span class="line">        mQueue = <span class="keyword">new</span> <span class="title class_">MessageQueue</span>();</span><br><span class="line">        mThread = Thread.currentThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sThreadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sThreadLocal.set(<span class="keyword">new</span> <span class="title class_">Looper</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepareMainLooper</span><span class="params">()</span> &#123;</span><br><span class="line">        prepare();</span><br><span class="line">        <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sMainLooper != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The main Looper has already been prepared.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sMainLooper = myLooper();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title function_">getMainLooper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> sMainLooper;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title function_">myLooper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Looper è¿˜éœ€è¦æœ‰ä¸€ä¸ªç”¨äºå¾ªç¯ä» MessageQueue è·å–æ¶ˆæ¯å¹¶å¤„ç†çš„æ–¹æ³•ï¼Œå°±å«å®ƒ<code>loop()</code>å§ã€‚å…¶ä½œç”¨ä¹Ÿèƒ½ç®€å•ï¼Œå°±æ˜¯å¾ªç¯ä» MessageQueue ä¸­å–å‡º Messageï¼Œç„¶åå°† Message å†åè¿‡æ¥åˆ†å‘ç»™ Handler å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Looper</span> <span class="variable">me</span> <span class="operator">=</span> myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> me.mQueue;</span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next();<span class="comment">//å¯èƒ½ä¼šé˜»å¡</span></span><br><span class="line">        msg.target.dispatchMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œä¸»çº¿ç¨‹å°±å…ˆé€šè¿‡è°ƒç”¨<code>prepareMainLooper()</code>æ¥å®Œæˆ sMainLooper çš„åˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨<code>loop()</code>å¼€å§‹å‘ mainMessageQueue å¾ªç¯å–å€¼å¹¶è¿›è¡Œå¤„ç†ï¼Œæ²¡æœ‰æ¶ˆæ¯çš„è¯ä¸»çº¿ç¨‹å°±æš‚æ—¶ä¼‘çœ ç€ã€‚å­çº¿ç¨‹æ‹¿åˆ° sMainLooper åå°±ä»¥æ­¤æ¥åˆå§‹åŒ– Handlerï¼Œè¿™æ ·å­çº¿ç¨‹å‘ Handler å‘é€çš„æ¶ˆæ¯å°±éƒ½ä¼šè¢«å­˜åˆ° mainMessageQueue ä¸­ï¼Œæœ€ç»ˆåœ¨ä¸»çº¿ç¨‹è¢«æ¶ˆè´¹æ‰</p>
<h2 id="5ã€åšä¸€ä¸ªæ€»ç»“"><a href="#5ã€åšä¸€ä¸ªæ€»ç»“" class="headerlink" title="5ã€åšä¸€ä¸ªæ€»ç»“"></a>5ã€åšä¸€ä¸ªæ€»ç»“</h2><p>è¿™æ ·ä¸€æ­¥æ­¥èµ°ä¸‹æ¥åï¼Œè¯»è€…å¯¹äº Messageã€MessageQueueã€Handlerã€Looper è¿™å››ä¸ªç±»çš„å®šä½å°±åº”è¯¥éƒ½å¾ˆæ¸…æ™°äº†å§ï¼Ÿä¸åŒçº¿ç¨‹ä¹‹é—´å°±å¯ä»¥ä¾é æ‹¿åˆ°å¯¹æ–¹çš„ Looper æ¥å®ç°æ¶ˆæ¯çš„è·¨çº¿ç¨‹å¤„ç†äº†</p>
<p>ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹ä»£ç ï¼Œå³ä½¿ Handler æ˜¯åœ¨ otherThread ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼Œä½† <code>handleMessage</code> æ–¹æ³•æœ€ç»ˆæ˜¯ä¼šåœ¨ mainThread è¢«è°ƒç”¨æ‰§è¡Œçš„ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">mainThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ– mainLooper</span></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        <span class="comment">//å¼€å¯å¾ªç¯</span></span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Thread</span> <span class="variable">otherThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Looper</span> <span class="variable">mainLooper</span> <span class="operator">=</span> Looper.getMainLooper();</span><br><span class="line">        <span class="type">Handler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>(mainLooper.mQueue) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">ob</span> <span class="operator">=</span> (String) msg.obj;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">                        List&lt;String&gt; ob = (List&lt;String&gt;) msg.obj;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">messageA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        messageA.what = <span class="number">1</span>;</span><br><span class="line">        messageA.obj = <span class="string">&quot;https://github.com/leavesCZY&quot;</span>;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">messageB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        messageB.what = <span class="number">2</span>;</span><br><span class="line">        messageB.obj = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        handler.sendMessage(messageA);</span><br><span class="line">        handler.sendMessage(messageB);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å†æ¥åšä¸ªç®€å•çš„æ€»ç»“ï¼š</p>
<ul>
<li>Messageï¼šç”¨æ¥è¡¨ç¤ºè¦æ‰§è¡Œçš„ä»»åŠ¡</li>
<li>Handlerï¼šå­çº¿ç¨‹æŒæœ‰çš„ Handler å¦‚æœç»‘å®šåˆ°çš„æ˜¯ä¸»çº¿ç¨‹çš„ MessageQueue çš„è¯ï¼Œé‚£ä¹ˆå­çº¿ç¨‹å‘é€çš„ Message å°±å¯ä»¥ç”±ä¸»çº¿ç¨‹æ¥æ¶ˆè´¹ï¼Œä»¥æ­¤æ¥å®ç°çº¿ç¨‹åˆ‡æ¢ï¼Œæ‰§è¡Œ UI æ›´æ–°æ“ä½œç­‰ç›®çš„</li>
<li>MessageQueueï¼šå³æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡ Handler å‘é€çš„æ¶ˆæ¯å¹¶ééƒ½æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œéœ€è¦å…ˆæŒ‰ç…§ Message çš„ä¼˜å…ˆçº§é«˜ä½ï¼ˆå»¶æ—¶æ—¶é—´çš„é•¿çŸ­ï¼‰ä¿å­˜åˆ° MessageQueue ä¸­ï¼Œä¹‹åå†æ¥ä¾æ¬¡æ‰§è¡Œ</li>
<li>Looperï¼šLooper ç”¨äºä» MessageQueue ä¸­å¾ªç¯è·å– Message å¹¶å°†ä¹‹ä¼ é€’ç»™æ¶ˆæ¯å¤„ç†è€…ï¼ˆå³æ¶ˆæ¯å‘é€è€… Handler æœ¬èº«ï¼‰æ¥è¿›è¡Œæ¶ˆè´¹ï¼Œæ¯æ¡ Message éƒ½æœ‰ä¸ª target å˜é‡ç”¨æ¥æŒ‡å‘ Handlerï¼Œä»¥æ­¤æŠŠ Message å’Œå…¶å¤„ç†è€…å…³è”èµ·æ¥ã€‚ä¸åŒçº¿ç¨‹ä¹‹é—´é€šè¿‡äº’ç›¸æ‹¿åˆ°å¯¹æ–¹çš„ Looper å¯¹è±¡ï¼Œä»¥æ­¤æ¥å®ç°è·¨çº¿ç¨‹å‘é€æ¶ˆæ¯</li>
</ul>
<p><strong>æœ‰äº†ä»¥ä¸Šçš„è®¤çŸ¥åŸºç¡€åï¼Œä¸‹é¢å°±æ¥çœ‹çœ‹å®é™…çš„æºç å®ç° ~ ~</strong></p>
<h1 id="äºŒã€Handler-æºç "><a href="#äºŒã€Handler-æºç " class="headerlink" title="äºŒã€Handler æºç "></a>äºŒã€Handler æºç </h1><h2 id="1ã€Handler-å¦‚ä½•åˆå§‹åŒ–"><a href="#1ã€Handler-å¦‚ä½•åˆå§‹åŒ–" class="headerlink" title="1ã€Handler  å¦‚ä½•åˆå§‹åŒ–"></a>1ã€Handler  å¦‚ä½•åˆå§‹åŒ–</h2><p>Handler çš„æ„é€ å‡½æ•°ä¸€å…±æœ‰ä¸ƒä¸ªï¼Œé™¤å»<strong>ä¸¤ä¸ªå·²ç»åºŸå¼ƒçš„å’Œä¸‰ä¸ªéšè—çš„</strong>ï¼Œå®é™…ä¸Šå¼€å‘è€…å¯ä»¥ä½¿ç”¨çš„åªæœ‰ä¸¤ä¸ªã€‚è€Œä¸ç®¡æ˜¯ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°ï¼Œæœ€ç»ˆçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†å®Œæˆ <strong>mLooperã€mQueueã€mCallbackã€mAsynchronous</strong> è¿™å››ä¸ªå¸¸é‡çš„åˆå§‹åŒ–ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ MessageQueue æ˜¯ç”± Looper æ¥å®Œæˆåˆå§‹åŒ–çš„ï¼Œè€Œä¸” Handler å¯¹äº Looper å’Œ MessageQueue éƒ½æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¸€æ—¦åˆå§‹åŒ–åå°±ä¸å¯æ”¹å˜</p>
<p><strong>å¤§éƒ¨åˆ†å¼€å‘è€…ä½¿ç”¨çš„åº”è¯¥éƒ½æ˜¯ Handler çš„æ— å‚æ„é€ å‡½æ•°ï¼Œè€Œåœ¨ Android 11 ä¸­ Handler çš„æ— å‚æ„é€ å‡½æ•°å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒçš„äº†</strong>ã€‚Google å®˜æ–¹æ›´æ¨èçš„åšæ³•æ˜¯é€šè¿‡æ˜¾å¼ä¼ å…¥ Looper å¯¹è±¡æ¥å®Œæˆåˆå§‹åŒ–ï¼Œè€Œééšå¼ä½¿ç”¨å½“å‰çº¿ç¨‹å…³è”çš„ Looper</p>
<blockquote>
<p>Handler å¯¹äº Looper å’Œ MessageQueue éƒ½æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä½†æ˜¯ Looper å’Œ MessageQueue å¯¹äº Handler å¯ä»¥æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">final</span> Looper mLooper;</span><br><span class="line"><span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">final</span> Callback mCallback;</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> mAsynchronous;</span><br><span class="line"></span><br><span class="line"><span class="comment">//çœç•¥å…¶å®ƒæ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(<span class="meta">@Nullable</span> Callback callback, <span class="type">boolean</span> async)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Handler</span>&gt; klass = getClass();</span><br><span class="line">        <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</span><br><span class="line">                (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;The following Handler class should be static or leaks might occur: &quot;</span> +</span><br><span class="line">                klass.getCanonicalName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLooper = Looper.myLooper();</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">            <span class="string">&quot;Can&#x27;t create handler inside thread &quot;</span> + Thread.currentThread()</span><br><span class="line">                    + <span class="string">&quot; that has not called Looper.prepare()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mQueue = mLooper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2ã€Looper-å¦‚ä½•åˆå§‹åŒ–"><a href="#2ã€Looper-å¦‚ä½•åˆå§‹åŒ–" class="headerlink" title="2ã€Looper  å¦‚ä½•åˆå§‹åŒ–"></a>2ã€Looper  å¦‚ä½•åˆå§‹åŒ–</h2><p>åœ¨åˆå§‹åŒ– Handler æ—¶ï¼Œå¦‚æœå¤–éƒ¨è°ƒç”¨çš„æ„é€ å‡½æ•°æ²¡æœ‰ä¼ å…¥ Looperï¼Œé‚£å°±ä¼šè°ƒç”¨<code>Looper.myLooper()</code>æ¥è·å–å’Œå½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå†ä» Looper ä¸­å– MessageQueueã€‚å¦‚æœè·å–åˆ°çš„ Looper å¯¹è±¡ä¸º null å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ ¹æ®å¼‚å¸¸ä¿¡æ¯ <code>Can&#39;t create handler inside thread that has not called Looper.prepare()</code> å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨åˆå§‹åŒ– Handler ä¹‹å‰éœ€è¦å…ˆè°ƒç”¨ <code>Looper.prepare()</code>å®Œæˆ Looper çš„åˆå§‹åŒ–</p>
<p>èµ°è¿› <code>Looper</code> ç±»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>myLooper()</code>æ–¹æ³•æ˜¯ Looper ç±»çš„é™æ€æ–¹æ³•ï¼Œå…¶åªæ˜¯å•çº¯åœ°ä» <code>sThreadLocal</code> å˜é‡ä¸­å–å€¼å¹¶è¿”å›è€Œå·²ã€‚<code>sThreadLocal</code> åˆæ˜¯é€šè¿‡ <code>prepare(boolean)</code> æ–¹æ³•æ¥è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼çš„ï¼Œä¸”åªèƒ½èµ‹å€¼ä¸€æ¬¡ï¼Œé‡å¤è°ƒç”¨å°†æŠ›å‡ºå¼‚å¸¸</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒThreadLocal çš„ç‰¹æ€§å°±æ˜¯å¯ä»¥ä¸ºä¸åŒçš„çº¿ç¨‹åˆ†åˆ«ç»´æŠ¤å•ç‹¬çš„ä¸€ä¸ªå˜é‡å®ä¾‹ï¼Œæ‰€ä»¥ï¼Œä¸åŒçš„çº¿ç¨‹å°±ä¼šåˆ†åˆ«å¯¹åº”ç€ä¸åŒçš„ Looper å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Looper&gt;(); </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the Looper object associated with the current thread.  Returns</span></span><br><span class="line"><span class="comment"> * null if the calling thread is not associated with a Looper.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> Looper <span class="title function_">myLooper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Initialize the current thread as a looper.</span></span><br><span class="line"><span class="comment">  * This gives you a chance to create handlers that then reference</span></span><br><span class="line"><span class="comment">  * this looper, before actually starting the loop. Be sure to call</span></span><br><span class="line"><span class="comment">  * &#123;<span class="doctag">@link</span> #loop()&#125; after calling this method, and end it by calling</span></span><br><span class="line"><span class="comment">  * &#123;<span class="doctag">@link</span> #quit()&#125;.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">()</span> &#123;</span><br><span class="line">    prepare(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">//åªå…è®¸èµ‹å€¼ä¸€æ¬¡</span></span><br><span class="line">        <span class="comment">//å¦‚æœé‡å¤èµ‹å€¼åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> <span class="title class_">Looper</span>(quitAllowed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤–ï¼ŒLooper ç±»çš„æ„é€ å‡½æ•°ä¹Ÿæ˜¯ç§æœ‰çš„ï¼Œä¼šåˆå§‹åŒ–ä¸¤ä¸ªå¸¸é‡å€¼ï¼šmQueue å’Œ mThreadï¼Œè¿™è¯´æ˜äº† Looper å¯¹äº MessageQueue å’Œ Thread éƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œå…³è”ä¹‹åä¸èƒ½æ”¹å˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Thread mThread;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">Looper</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åœ¨é€šè¿‡ Handler æ¥æ‰§è¡Œ UI åˆ·æ–°æ“ä½œæ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„æ˜¯ Handler çš„æ— å‚æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆæ­¤æ—¶è‚¯å®šå°±æ˜¯ä½¿ç”¨äº†å’Œä¸»çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå¯¹åº” Looper ç±»ä¸­çš„é™æ€å˜é‡ <code>sMainLooper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Looper sMainLooper;  <span class="comment">// guarded by Looper.class</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¢«æ ‡è®°ä¸ºåºŸå¼ƒçš„åŸå› æ˜¯å› ä¸º sMainLooper ä¼šäº¤ç”± Android ç³»ç»Ÿè‡ªåŠ¨æ¥å®Œæˆåˆå§‹åŒ–ï¼Œå¤–éƒ¨ä¸åº”è¯¥ä¸»åŠ¨æ¥åˆå§‹åŒ–</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepareMainLooper</span><span class="params">()</span> &#123;</span><br><span class="line">    prepare(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sMainLooper != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The main Looper has already been prepared.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sMainLooper = myLooper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the application&#x27;s main looper, which lives in the main thread of the application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title function_">getMainLooper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> sMainLooper;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>prepareMainLooper()</code>å°±ç”¨äºä¸ºä¸»çº¿ç¨‹åˆå§‹åŒ– Looper å¯¹è±¡ï¼Œè¯¥æ–¹æ³•åˆæ˜¯ç”± ActivityThread ç±»çš„ <code>main()</code> æ–¹æ³•æ¥è°ƒç”¨çš„ã€‚è¯¥ <code>main()</code> æ–¹æ³•å³ Java ç¨‹åºçš„è¿è¡Œèµ·å§‹ç‚¹ï¼Œæ‰€ä»¥å½“åº”ç”¨å¯åŠ¨æ—¶ç³»ç»Ÿå°±è‡ªåŠ¨ä¸ºæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹åšå¥½äº† mainLooper çš„åˆå§‹åŒ–ï¼Œè€Œä¸”å·²ç»è°ƒç”¨äº†<code>Looper.loop()</code>æ–¹æ³•å¼€å¯äº†æ¶ˆæ¯çš„å¾ªç¯å¤„ç†ï¼Œåº”ç”¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å„ç§äº¤äº’é€»è¾‘ï¼ˆä¾‹å¦‚ï¼šå±å¹•çš„è§¦æ‘¸äº‹ä»¶ã€åˆ—è¡¨çš„æ»‘åŠ¨ç­‰ï¼‰å°±éƒ½æ˜¯åœ¨è¿™ä¸ªå¾ªç¯é‡Œå®Œæˆåˆ†å‘çš„</p>
<p>æ­£æ˜¯å› ä¸º Android ç³»ç»Ÿå·²ç»è‡ªåŠ¨å®Œæˆäº†ä¸»çº¿ç¨‹ Looper çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­æ‰å¯ä»¥ç›´æ¥ä½¿ç”¨ Handler çš„æ— å‚æ„é€ å‡½æ•°æ¥å®Œæˆ UI ç›¸å…³äº‹ä»¶çš„å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        Looper.loop();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3ã€Handler-å‘é€æ¶ˆæ¯"><a href="#3ã€Handler-å‘é€æ¶ˆæ¯" class="headerlink" title="3ã€Handler å‘é€æ¶ˆæ¯"></a>3ã€Handler å‘é€æ¶ˆæ¯</h2><p>Handler ç”¨äºå‘é€æ¶ˆæ¯çš„æ–¹æ³•éå¸¸å¤šï¼Œæœ‰åå‡ ä¸ªï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æœ€ç»ˆè°ƒç”¨åˆ°çš„éƒ½æ˜¯ <code>sendMessageAtTime()</code> æ–¹æ³•ã€‚uptimeMillis å³ Message å…·ä½“è¦æ‰§è¡Œçš„æ—¶é—´æˆ³ï¼Œå¦‚æœè¯¥æ—¶é—´æˆ³æ¯”å½“å‰æ—¶é—´å¤§ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¦æ‰§è¡Œçš„æ˜¯å»¶è¿Ÿä»»åŠ¡ã€‚å¦‚æœä¸º mQueue ä¸º nullï¼Œå°±ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯å¹¶ç›´æ¥è¿”å›ï¼Œå› ä¸º Message æ˜¯éœ€è¦äº¤ç”± MessageQueue æ¥å¤„ç†çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessageAtTime</span><span class="params">(<span class="meta">@NonNull</span> Message msg, <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">    <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> mQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                <span class="built_in">this</span> + <span class="string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);</span><br><span class="line">        Log.w(<span class="string">&quot;Looper&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„ <code>msg.target = this</code> è¿™å¥ä»£ç ï¼Œtarget æŒ‡å‘äº†<strong>å‘é€æ¶ˆæ¯çš„ä¸»ä½“</strong>ï¼Œå³ Handler å¯¹è±¡æœ¬èº«ï¼Œå³ç”± Handler å¯¹è±¡å‘ç»™ MessageQueue çš„æ¶ˆæ¯æœ€åè¿˜æ˜¯è¦äº¤ç”± Handler å¯¹è±¡æœ¬èº«æ¥å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(<span class="meta">@NonNull</span> MessageQueue queue, <span class="meta">@NonNull</span> Message msg,</span></span><br><span class="line"><span class="params">        <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">    msg.target = <span class="built_in">this</span>;</span><br><span class="line">    msg.workSourceUid = ThreadLocalWorkSource.getUid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†æ¶ˆæ¯äº¤ç”± MessageQueue å¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4ã€MessageQueue"><a href="#4ã€MessageQueue" class="headerlink" title="4ã€MessageQueue"></a>4ã€MessageQueue</h2><p>MessageQueue é€šè¿‡ <code>enqueueMessage</code> æ–¹æ³•æ¥æ¥æ”¶æ¶ˆæ¯</p>
<ul>
<li>å› ä¸ºå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶å¾€ä¸€ä¸ª MessageQueue å‘é€æ¶ˆæ¯çš„å¯èƒ½ï¼Œæ‰€ä»¥ <code>enqueueMessage</code> å†…éƒ¨è‚¯å®šéœ€è¦è¿›è¡Œçº¿ç¨‹åŒæ­¥</li>
<li>å¯ä»¥çœ‹å‡º MessageQueue å†…éƒ¨æ˜¯ä»¥é“¾è¡¨çš„ç»“æ„æ¥å­˜å‚¨ Message çš„ï¼ˆMessage.nextï¼‰ï¼Œæ ¹æ® Message çš„æ—¶é—´æˆ³å¤§å°æ¥å†³å®šå…¶åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä½ç½®</li>
<li>mMessages ä»£è¡¨çš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚å¦‚æœ mMessages ä¸ºç©ºï¼ˆæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼‰ï¼Œæˆ–è€… mMessages çš„æ—¶é—´æˆ³è¦æ¯”æ–°æ¶ˆæ¯çš„æ—¶é—´æˆ³å¤§ï¼Œåˆ™å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´éƒ¨ï¼›å¦‚æœ mMessages ä¸ä¸ºç©ºï¼Œåˆ™å¯»æ‰¾æ¶ˆæ¯åˆ—é˜Ÿä¸­ç¬¬ä¸€æ¡è§¦å‘æ—¶é—´æ¯”æ–°æ¶ˆæ¯æ™šçš„éç©ºæ¶ˆæ¯ï¼Œå°†æ–°æ¶ˆæ¯æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</li>
</ul>
<p>åˆ°æ­¤ï¼Œä¸€ä¸ªæŒ‰ç…§æ—¶é—´æˆ³å¤§å°è¿›è¡Œæ’åºçš„æ¶ˆæ¯é˜Ÿåˆ—å°±å®Œæˆäº†ï¼Œåè¾¹è¦åšçš„å°±æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¾æ¬¡å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(Message msg, <span class="type">long</span> <span class="keyword">when</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Message must have a target.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        msg.markInUse();</span><br><span class="line">        msg.<span class="keyword">when</span> = <span class="keyword">when</span>;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">p</span> <span class="operator">=</span> mMessages;</span><br><span class="line">        <span class="comment">//ç”¨äºæ ‡è®°æ˜¯å¦éœ€è¦å”¤é†’çº¿ç¨‹</span></span><br><span class="line">        <span class="type">boolean</span> needWake;</span><br><span class="line">        <span class="comment">//å¦‚æœé“¾è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…å¤„äºé˜Ÿå¤´çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯” msg è¦å¤§ï¼Œåˆ™å°† msg ä½œä¸ºé“¾è¡¨å¤´éƒ¨</span></span><br><span class="line">        <span class="comment">//when == 0 è¯´æ˜ Handler è°ƒç”¨çš„æ˜¯ sendMessageAtFrontOfQueue æ–¹æ³•ï¼Œç›´æ¥å°† msg æ’åˆ°é˜Ÿåˆ—å¤´éƒ¨ </span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> == <span class="number">0</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">            msg.next = p;</span><br><span class="line">            mMessages = msg;</span><br><span class="line">            needWake = mBlocked;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœå½“å‰çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ + é˜Ÿå¤´æ¶ˆæ¯æ˜¯å±éšœæ¶ˆæ¯ + msg æ˜¯å¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line">            <span class="comment">//é‚£ä¹ˆå°±éœ€è¦å”¤é†’çº¿ç¨‹</span></span><br><span class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="literal">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line"></span><br><span class="line">            Message prev;</span><br><span class="line">            <span class="comment">//ä»é“¾è¡¨å¤´å‘é“¾è¡¨å°¾éå†ï¼Œå¯»æ‰¾é“¾è¡¨ä¸­ç¬¬ä¸€æ¡æ—¶é—´æˆ³æ¯” msg å¤§çš„æ¶ˆæ¯ï¼Œå°† msg æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = p.next;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœåœ¨ msg ä¹‹å‰é˜Ÿåˆ—ä¸­è¿˜æœ‰å¼‚æ­¥æ¶ˆæ¯é‚£ä¹ˆå°±ä¸éœ€è¦ä¸»åŠ¨å”¤é†’</span></span><br><span class="line">                    <span class="comment">//å› ä¸ºå·²ç»è®¾å®šå”¤é†’æ—¶é—´äº†</span></span><br><span class="line">                    needWake = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">            prev.next = msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">        <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çŸ¥é“äº† Message æ˜¯å¦‚ä½•ä¿å­˜çš„äº†ï¼Œå†æ¥çœ‹ä¸‹ MessageQueue æ˜¯å¦‚ä½•å–å‡º Message å¹¶å›è°ƒç»™ Handler çš„ã€‚åœ¨ MessageQueue ä¸­è¯»å–æ¶ˆæ¯çš„æ“ä½œå¯¹åº”çš„æ˜¯<code>next()</code> æ–¹æ³•ã€‚<code>next()</code> æ–¹æ³•å†…éƒ¨å¼€å¯äº†ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æˆ–è€…æ˜¯é˜Ÿå¤´æ¶ˆæ¯è¿˜æ²¡åˆ°å¯ä»¥å¤„ç†çš„æ—¶é—´ï¼Œè¯¥æ–¹æ³•å°±ä¼šå¯¼è‡´ Loop çº¿ç¨‹ä¼‘çœ æŒ‚èµ·ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³åå†é‡æ–°éå†æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">Message <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°† Loop çº¿ç¨‹ä¼‘çœ æŒ‚èµ·</span></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">            <span class="type">Message</span> <span class="variable">prevMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span> &amp;&amp; msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="literal">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.<span class="keyword">when</span>) &#123;</span><br><span class="line">                    <span class="comment">//é˜Ÿå¤´æ¶ˆæ¯è¿˜æœªåˆ°å¤„ç†æ—¶é—´ï¼Œè®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="type">int</span>) Math.min(msg.<span class="keyword">when</span> - now, Integer.MAX_VALUE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="literal">null</span>) &#123;</span><br><span class="line">                        prevMsg.next = msg.next;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mMessages = msg.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Returning message: &quot;</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Â·Â·Â·</span><br><span class="line">        &#125;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        &#125;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>next()</code> æ–¹æ³•åˆæ˜¯é€šè¿‡ Looper ç±»çš„ <code>loop()</code> æ–¹æ³•æ¥å¾ªç¯è°ƒç”¨çš„ï¼Œ<code>loop()</code> æ–¹æ³•å†…ä¹Ÿæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå”¯ä¸€è·³å‡ºå¾ªç¯çš„æ¡ä»¶å°±æ˜¯ <code>queue.next()</code>æ–¹æ³•è¿”å›ä¸º nullã€‚å› ä¸º <code>next()</code> æ–¹æ³•å¯èƒ½ä¼šè§¦å‘é˜»å¡æ“ä½œï¼Œæ‰€ä»¥æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†æ—¶ä¹Ÿä¼šå¯¼è‡´ <code>loop()</code> æ–¹æ³•è¢«é˜»å¡ç€ï¼Œè€Œå½“ MessageQueue æœ‰äº†æ–°çš„æ¶ˆæ¯ï¼ŒLooper å°±ä¼šåŠæ—¶åœ°å¤„ç†è¿™æ¡æ¶ˆæ¯å¹¶è°ƒç”¨ <code>msg.target.dispatchMessage(msg)</code> æ–¹æ³•å°†æ¶ˆæ¯å›ä¼ ç»™ Handler è¿›è¡Œå¤„ç† </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run the message queue in this thread. Be sure to call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Looper</span> <span class="variable">me</span> <span class="operator">=</span> myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Â·Â·Â·	</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        msg.target.dispatchMessage(msg);</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Handler çš„<code>dispatchMessage</code>æ–¹æ³•å°±æ˜¯åœ¨å‘å¤–éƒ¨åˆ†å‘å¤„ç† Message äº†ï¼ŒMessage æœ€ç»ˆæ˜¯æŒ‰å¦‚ä¸‹é¡ºåºè¿›è¡Œå¤„ç†çš„ï¼š</p>
<ul>
<li>å¦‚æœè¯¥ Message æ˜¯é€šè¿‡ <code>post(Runnable)</code>ç­‰æ–¹æ³•è¿›è¡Œå‘é€çš„ï¼Œé‚£ä¹ˆå°±ç›´æ¥å›è°ƒè¯¥ Runnable å¯¹è±¡</li>
<li>å¦‚æœåœ¨åˆå§‹åŒ– Handler æ—¶ä¼ å…¥äº† Callback å¯¹è±¡ï¼Œåˆ™ä¼˜å…ˆäº¤ç”±å…¶å¤„ç†ï¼Œå¦‚æœ Callback çš„ <code>handleMessage</code> æ–¹æ³•è¿”å›äº† trueï¼Œåˆ™ç»“æŸæµç¨‹</li>
<li>è°ƒç”¨ Handler çš„<code>handleMessage</code> æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ï¼Œå¤–éƒ¨é€šè¿‡é‡å†™è¯¥æ–¹æ³•æ¥å®šä¹‰ä¸šåŠ¡é€»è¾‘</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatchMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="literal">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleCallback</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">    message.callback.run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼ŒMessage çš„æ•´ä¸ªåˆ†å‘æµç¨‹å°±ç»“æŸäº†</p>
<h2 id="5ã€æ¶ˆæ¯å±éšœ"><a href="#5ã€æ¶ˆæ¯å±éšœ" class="headerlink" title="5ã€æ¶ˆæ¯å±éšœ"></a>5ã€æ¶ˆæ¯å±éšœ</h2><p>Android ç³»ç»Ÿä¸ºäº†ä¿è¯æŸäº›é«˜ä¼˜å…ˆçº§çš„ Messageï¼ˆå¼‚æ­¥æ¶ˆæ¯ï¼‰ èƒ½å¤Ÿè¢«å°½å¿«æ‰§è¡Œï¼Œé‡‡ç”¨äº†ä¸€ç§æ¶ˆæ¯å±éšœï¼ˆBarrierï¼‰æœºåˆ¶ã€‚å…¶å¤§è‡´æµç¨‹æ˜¯ï¼šå…ˆå‘é€ä¸€ä¸ªå±éšœæ¶ˆæ¯åˆ° MessageQueue ä¸­ï¼Œå½“ MessageQueue éå†åˆ°è¯¥å±éšœæ¶ˆæ¯æ—¶ï¼Œå°±ä¼šåˆ¤æ–­å½“å‰é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨<strong>å¼‚æ­¥æ¶ˆæ¯</strong>ï¼Œæœ‰çš„è¯åˆ™å…ˆè·³è¿‡åŒæ­¥æ¶ˆæ¯ï¼ˆå¼€å‘è€…ä¸»åŠ¨å‘é€çš„éƒ½å±äºåŒæ­¥æ¶ˆæ¯ï¼‰ï¼Œä¼˜å…ˆæ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯ã€‚è¿™ç§æœºåˆ¶å°±ä¼šä½¿å¾—åœ¨å¼‚æ­¥æ¶ˆæ¯è¢«æ‰§è¡Œå®Œä¹‹å‰ï¼ŒåŒæ­¥æ¶ˆæ¯éƒ½ä¸ä¼šå¾—åˆ°å¤„ç†</p>
<p>Handler çš„æ„é€ å‡½æ•°ä¸­çš„<code>async</code>å‚æ•°å°±ç”¨äºæ§åˆ¶å‘é€çš„ Message æ˜¯å¦å±äºå¼‚æ­¥æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> mAsynchronous;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(<span class="meta">@NonNull</span> Looper looper, <span class="meta">@Nullable</span> Callback callback, <span class="type">boolean</span> async)</span> &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        mAsynchronous = async;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(<span class="meta">@NonNull</span> MessageQueue queue, <span class="meta">@NonNull</span> Message msg,</span></span><br><span class="line"><span class="params">            <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">        msg.target = <span class="built_in">this</span>;</span><br><span class="line">        msg.workSourceUid = ThreadLocalWorkSource.getUid();</span><br><span class="line">        <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">            <span class="comment">//è®¾ä¸ºå¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line">            msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MessageQueue åœ¨è·å–é˜Ÿå¤´æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœåˆ¤æ–­åˆ°é˜Ÿå¤´æ¶ˆæ¯çš„ target å¯¹è±¡ä¸º null çš„è¯ï¼Œå°±çŸ¥é“è¯¥ Message å±äºå±éšœæ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ä¼šå†å‘åéå†æ‰¾åˆ°ç¬¬ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯ä¼˜å…ˆè¿›è¡Œå¤„ç†ï¼Œæ¯æ¬¡è°ƒç”¨ <code>next()</code> æ–¹æ³•æ—¶éƒ½ä¼šé‡å¤æ­¤æ­¥éª¤çŸ¥é“æ‰€æœ‰å¼‚æ­¥æ¶ˆæ¯å‡è¢«å¤„ç†å®Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">Message <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">            <span class="type">Message</span> <span class="variable">prevMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span> &amp;&amp; msg.target == <span class="literal">null</span>) &#123; <span class="comment">//target ä¸º null å³å±äºå±éšœæ¶ˆæ¯</span></span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="comment">//å¾ªç¯éå†ï¼Œæ‰¾åˆ°å±éšœæ¶ˆæ¯åé¢çš„ç¬¬ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œå¤„ç†</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="literal">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            &#125;</span><br><span class="line">            Â·Â·Â·</span><br><span class="line">        &#125;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ Message å¯¹è±¡çš„ <code>setAsynchronous(boolean async)</code> æ–¹æ³•æ¥ä¸»åŠ¨å‘é€å¼‚æ­¥æ¶ˆæ¯ã€‚è€Œå¦‚æœæƒ³è¦ä¸»åŠ¨å‘é€å±éšœæ¶ˆæ¯çš„è¯ï¼Œå°±éœ€è¦é€šè¿‡åå°„æ¥è°ƒç”¨ MessageQueue çš„ <code>postSyncBarrier()</code> æ–¹æ³•äº†ï¼Œè¯¥æ–¹æ³•è¢«ç³»ç»Ÿéšè—èµ·æ¥äº†</p>
<p>å±éšœæ¶ˆæ¯çš„ä½œç”¨å°±æ˜¯å¯ä»¥ç¡®ä¿é«˜ä¼˜å…ˆçº§çš„å¼‚æ­¥æ¶ˆæ¯å¯ä»¥ä¼˜å…ˆè¢«å¤„ç†ï¼ŒViewRootImpl å°±é€šè¿‡è¯¥æœºåˆ¶æ¥ä½¿å¾— View çš„ç»˜åˆ¶æµç¨‹å¯ä»¥ä¼˜å…ˆè¢«å¤„ç†</p>
<h2 id="6ã€é€€å‡º-Looper-å¾ªç¯"><a href="#6ã€é€€å‡º-Looper-å¾ªç¯" class="headerlink" title="6ã€é€€å‡º Looper å¾ªç¯"></a>6ã€é€€å‡º Looper å¾ªç¯</h2><p>Looper ç±»æœ¬èº«åšäº†æ–¹æ³•é™åˆ¶ï¼Œé™¤äº†ä¸»çº¿ç¨‹å¤–ï¼Œå­çº¿ç¨‹å…³è”çš„ MessageQueue éƒ½æ”¯æŒé€€å‡º Loop å¾ªç¯ï¼Œå³ quitAllowed åªæœ‰ä¸»çº¿ç¨‹æ‰èƒ½æ˜¯ false</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Looper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Looper</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">        mQueue = <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(quitAllowed);</span><br><span class="line">        mThread = Thread.currentThread();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">()</span> &#123;</span><br><span class="line">        prepare(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sThreadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sThreadLocal.set(<span class="keyword">new</span> <span class="title class_">Looper</span>(quitAllowed));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MessageQueue æ”¯æŒä¸¤ç§æ–¹å¼æ¥é€€å‡º Loopï¼š</p>
<ul>
<li>safe ä¸º trueï¼Œåªç§»é™¤æ‰€æœ‰å°šæœªæ‰§è¡Œçš„æ¶ˆæ¯ï¼Œä¸ç§»é™¤æ—¶é—´æˆ³ç­‰äºå½“å‰æ—¶é—´çš„æ¶ˆæ¯</li>
<li>safe ä¸º falseï¼Œç§»é™¤æ‰€æœ‰æ¶ˆæ¯</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">quit</span><span class="params">(<span class="type">boolean</span> safe)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mQuitAllowed) &#123;</span><br><span class="line">        <span class="comment">//MessageQueue è®¾ç½®äº†ä¸å…è®¸é€€å‡ºå¾ªç¯ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Main thread not allowed to quit.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">            <span class="comment">//é¿å…é‡å¤è°ƒç”¨</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mQuitting = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (safe) &#123;</span><br><span class="line">            <span class="comment">//åªç§»é™¤æ‰€æœ‰å°šæœªæ‰§è¡Œçš„æ¶ˆæ¯ï¼Œä¸ç§»é™¤æ—¶é—´æˆ³ç­‰äºå½“å‰æ—¶é—´çš„æ¶ˆæ¯</span></span><br><span class="line">            removeAllFutureMessagesLocked();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//ç§»é™¤æ‰€æœ‰æ¶ˆæ¯</span></span><br><span class="line">            removeAllMessagesLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting was previously false.</span></span><br><span class="line">        nativeWake(mPtr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7ã€IdleHandler"><a href="#7ã€IdleHandler" class="headerlink" title="7ã€IdleHandler"></a>7ã€IdleHandler</h2><p>IdleHandler æ˜¯ MessageQueue çš„ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œå¯ä»¥ç”¨äºåœ¨ Loop çº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™æ‰§è¡Œä¸€äº›ä¼˜å…ˆçº§ä¸é«˜çš„æ“ä½œï¼Œé€šè¿‡ MessageQueue çš„ <code>addIdleHandler</code> æ–¹æ³•æ¥æäº¤è¦æ‰§è¡Œçš„æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">interface</span> <span class="title class_">IdleHandler</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">queueIdle</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;IdleHandler&gt; mIdleHandlers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;IdleHandler&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addIdleHandler</span><span class="params">(<span class="meta">@NonNull</span> IdleHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Can&#x27;t add a null IdleHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        mIdleHandlers.add(handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeIdleHandler</span><span class="params">(<span class="meta">@NonNull</span> IdleHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        mIdleHandlers.remove(handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MessageQueue åœ¨æ‰§è¡Œ <code>next()</code> æ–¹æ³•æ—¶ï¼Œå¦‚æœå‘ç°å½“å‰é˜Ÿåˆ—æ˜¯ç©ºçš„æˆ–è€…é˜Ÿå¤´æ¶ˆæ¯éœ€è¦å»¶è¿Ÿå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå»å°è¯•éå† <code>mIdleHandlers</code>æ¥ä¾æ¬¡æ‰§è¡Œ IdleHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">Message <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="type">int</span> <span class="variable">pendingIdleHandlerCount</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextPollTimeoutMillis</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            Â·Â·Â·</span><br><span class="line">            <span class="comment">//å¦‚æœé˜Ÿå¤´æ¶ˆæ¯ mMessages ä¸º null æˆ–è€… mMessages éœ€è¦å»¶è¿Ÿå¤„ç†</span></span><br><span class="line">            <span class="comment">//é‚£ä¹ˆå°±æ¥æ‰§è¡Œ IdleHandler</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="literal">null</span> || now &lt; mMessages.<span class="keyword">when</span>)) &#123;</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="literal">null</span>) &#123;</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> <span class="title class_">IdleHandler</span>[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">IdleHandler</span> <span class="variable">idler</span> <span class="operator">=</span> mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="literal">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">keep</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//æ‰§è¡Œ IdleHandler</span></span><br><span class="line">                <span class="comment">//å¦‚æœè¿”å› false çš„è¯è¯´æ˜ä¹‹åä¸å†éœ€è¦æ‰§è¡Œï¼Œé‚£å°±å°†å…¶ç§»é™¤</span></span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;IdleHandler threw exception&quot;</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼ŒActivityThread å°±å‘ä¸»çº¿ç¨‹ MessageQueue æ·»åŠ äº†ä¸€ä¸ª GcIdlerï¼Œç”¨äºåœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶å°è¯•å»æ‰§è¡Œ GC æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">scheduleGcIdler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mGcIdlerScheduled) &#123;</span><br><span class="line">            mGcIdlerScheduled = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//æ·»åŠ  IdleHandler</span></span><br><span class="line">            Looper.myQueue().addIdleHandler(mGcIdler);</span><br><span class="line">        &#125;</span><br><span class="line">        mH.removeMessages(H.GC_WHEN_IDLE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">GcIdler</span> <span class="keyword">implements</span> <span class="title class_">MessageQueue</span>.IdleHandler &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">queueIdle</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//å°è¯• GC</span></span><br><span class="line">            doGcIfNeeded();</span><br><span class="line">            purgePendingResources();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8ã€åšä¸€ä¸ªæ€»ç»“"><a href="#8ã€åšä¸€ä¸ªæ€»ç»“" class="headerlink" title="8ã€åšä¸€ä¸ªæ€»ç»“"></a>8ã€åšä¸€ä¸ªæ€»ç»“</h2><p>å†æ¥æ€»ç»“ä¸‹ä»¥ä¸Šçš„æ‰€æœ‰å†…å®¹</p>
<ol>
<li>æ¯ä¸ª Handler éƒ½ä¼šå’Œä¸€ä¸ª Looper å®ä¾‹å…³è”åœ¨ä¸€èµ·ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ– Handler æ—¶é€šè¿‡æ„é€ å‡½æ•°ä¸»åŠ¨ä¼ å…¥å®ä¾‹ï¼Œå¦åˆ™å°±ä¼šé»˜è®¤ä½¿ç”¨å’Œå½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡</li>
<li>æ¯ä¸ª Looper éƒ½ä¼šå’Œä¸€ä¸ª MessageQueue å®ä¾‹å…³è”åœ¨ä¸€èµ·ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦é€šè¿‡è°ƒç”¨ <code>Looper.prepare()</code>æ–¹æ³•æ¥åˆå§‹åŒ–æœ¬çº¿ç¨‹ç‹¬æœ‰çš„ Looper å®ä¾‹ï¼Œå¹¶é€šè¿‡è°ƒç”¨<code>Looper.loop()</code>æ–¹æ³•æ¥ä½¿å¾—æœ¬çº¿ç¨‹å¾ªç¯å‘ MessageQueue å–å‡ºæ¶ˆæ¯å¹¶æ‰§è¡Œã€‚Android ç³»ç»Ÿé»˜è®¤ä¼šä¸ºæ¯ä¸ªåº”ç”¨åˆå§‹åŒ–å’Œä¸»çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå¹¶ä¸”é»˜è®¤å°±å¼€å¯äº† loop å¾ªç¯æ¥å¤„ç†ä¸»çº¿ç¨‹æ¶ˆæ¯</li>
<li>MessageQueue æŒ‰ç…§é“¾æ¥ç»“æ„æ¥ä¿å­˜ Messageï¼Œæ‰§è¡Œæ—¶é—´æ—©ï¼ˆå³æ—¶é—´æˆ³å°ï¼‰çš„ Message ä¼šæ’åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼ŒLooper ä¼šå¾ªç¯ä»é“¾è¡¨ä¸­å–å‡º Message å¹¶å›è°ƒç»™  Handlerï¼Œå–å€¼çš„è¿‡ç¨‹å¯èƒ½ä¼šåŒ…å«é˜»å¡æ“ä½œ</li>
<li>Messageã€Handlerã€Looperã€MessageQueue è¿™å››è€…å°±æ„æˆäº†ä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ã€‚Message ç›¸å½“äºäº§å“ï¼ŒMessageQueue ç›¸å½“äºä¼ è¾“ç®¡é“ï¼ŒHandler ç›¸å½“äºç”Ÿäº§è€…ï¼ŒLooper ç›¸å½“äºæ¶ˆè´¹è€…</li>
<li>Handler å¯¹äº Looperã€Handler å¯¹äº MessageQueueã€Looper å¯¹äº MessageQueueã€Looper å¯¹äº Thread ï¼Œè¿™å‡ ä¸ªä¹‹é—´éƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œåœ¨å…³è”åæ— æ³•æ›´æ”¹ï¼Œä½† Looper å¯¹äº Handlerã€MessageQueue å¯¹äº Handler å¯ä»¥æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»</li>
<li>Handler èƒ½ç”¨äºæ›´æ–° UI åŒ…å«äº†ä¸€ä¸ªéšæ€§çš„å‰ææ¡ä»¶ï¼šHandler ä¸ä¸»çº¿ç¨‹ Looper å…³è”åœ¨äº†ä¸€èµ·ã€‚åœ¨ä¸»çº¿ç¨‹ä¸­åˆå§‹åŒ–çš„ Handler ä¼šé»˜è®¤ä¸ä¸»çº¿ç¨‹ Looper å…³è”åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥å…¶ <code>handleMessage(Message msg)</code> æ–¹æ³•å°±ä¼šç”±ä¸»çº¿ç¨‹æ¥è°ƒç”¨ã€‚åœ¨å­çº¿ç¨‹åˆå§‹åŒ–çš„ Handler å¦‚æœä¹Ÿæƒ³æ‰§è¡Œ UI æ›´æ–°æ“ä½œçš„è¯ï¼Œåˆ™éœ€è¦ä¸»åŠ¨è·å– mainLooper æ¥åˆå§‹åŒ– Handler</li>
<li>å¯¹äºæˆ‘ä»¬è‡ªå·±åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºçš„ Looperï¼Œå½“ä¸å†éœ€è¦çš„æ—¶å€™æˆ‘ä»¬åº”è¯¥ä¸»åŠ¨é€€å‡ºå¾ªç¯ï¼Œå¦åˆ™å­çº¿ç¨‹å°†ä¸€ç›´æ— æ³•å¾—åˆ°é‡Šæ”¾ã€‚å¯¹äºä¸»çº¿ç¨‹ Loop æˆ‘ä»¬åˆ™ä¸åº”è¯¥å»ä¸»åŠ¨é€€å‡ºï¼Œå¦åˆ™å°†å¯¼è‡´åº”ç”¨å´©æºƒ</li>
<li>æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘ MessageQueue æ·»åŠ  IdleHandler çš„æ–¹å¼ï¼Œæ¥å®ç°åœ¨ Loop çº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™æ‰§è¡Œä¸€äº›ä¼˜å…ˆçº§ä¸é«˜çš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸ªéœ€æ±‚æ˜¯å¸Œæœ›å½“ä¸»çº¿ç¨‹å®Œæˆç•Œé¢ç»˜åˆ¶ç­‰äº‹ä»¶åå†æ‰§è¡Œä¸€äº› UI æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ IdleHandler æ¥å®ç°ï¼Œè¿™å¯ä»¥é¿å…æ‹–æ…¢ç”¨æˆ·çœ‹åˆ°é¦–å±é¡µé¢çš„é€Ÿåº¦</li>
</ol>
<h1 id="ä¸‰ã€Handler-åœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨"><a href="#ä¸‰ã€Handler-åœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨" class="headerlink" title="ä¸‰ã€Handler åœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨"></a>ä¸‰ã€Handler åœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨</h1><h2 id="1ã€HandlerThread"><a href="#1ã€HandlerThread" class="headerlink" title="1ã€HandlerThread"></a>1ã€HandlerThread</h2><p>HandlerThread æ˜¯ Android SDK ä¸­å’Œ Handler åœ¨åŒä¸ªåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä»å…¶åå­—å°±å¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œä¸”ä½¿ç”¨åˆ°äº† Handler</p>
<p>å…¶ç”¨æ³•ç±»ä¼¼äºä»¥ä¸‹ä»£ç ã€‚é€šè¿‡ HandlerThread å†…éƒ¨çš„ Looper å¯¹è±¡æ¥åˆå§‹åŒ– Handlerï¼ŒåŒæ—¶åœ¨ Handler ä¸­å£°æ˜éœ€è¦æ‰§è¡Œçš„è€—æ—¶ä»»åŠ¡ï¼Œä¸»çº¿ç¨‹é€šè¿‡å‘ Handler å‘é€æ¶ˆæ¯æ¥è§¦å‘ HandlerThread å»æ‰§è¡Œè€—æ—¶ä»»åŠ¡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> handlerThread = HandlerThread(<span class="string">&quot;I am HandlerThread&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> handler <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        <span class="keyword">object</span> : Handler(handlerThread.looper) &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>)</span></span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>)</span><br><span class="line">                Log.e(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;è¿™é‡Œæ˜¯å­çº¿ç¨‹ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼š&quot;</span> + Thread.currentThread().name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        btn_test.setOnClickListener &#123;</span><br><span class="line">            handler.sendEmptyMessage(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        handlerThread.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HandlerThread çš„æºç è¿˜æ˜¯æŒºç®€å•çš„ï¼Œåªæœ‰ä¸€ç™¾å¤šè¡Œ</p>
<p>HandlerThread æ˜¯ Thread çš„å­ç±»ï¼Œå…¶ä½œç”¨å°±æ˜¯ä¸ºäº†ç”¨æ¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œå…¶ <code>run()</code>æ–¹æ³•ä¼šè‡ªåŠ¨ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ª Looper å¯¹è±¡å¹¶ä¿å­˜åˆ° <code>mLooper</code>ï¼Œä¹‹åå°±ä¸»åŠ¨å¼€å¯æ¶ˆæ¯å¾ªç¯ï¼Œè¿™æ · HandlerThread å°±ä¼šæ¥å¾ªç¯å¤„ç† Message äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandlerThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//çº¿ç¨‹ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="type">int</span> mPriority;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹ID</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mTid</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">//å½“å‰çº¿ç¨‹æŒæœ‰çš„ Looper å¯¹è±¡</span></span><br><span class="line">    Looper mLooper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="meta">@Nullable</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HandlerThread</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">        mPriority = Process.THREAD_PRIORITY_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HandlerThread</span><span class="params">(String name, <span class="type">int</span> priority)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">        mPriority = priority;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        mTid = Process.myTid();</span><br><span class="line">        <span class="comment">//è§¦å‘å½“å‰çº¿ç¨‹åˆ›å»º Looper å¯¹è±¡</span></span><br><span class="line">        Looper.prepare();</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">//è·å– Looper å¯¹è±¡</span></span><br><span class="line">            mLooper = Looper.myLooper();</span><br><span class="line">            <span class="comment">//å”¤é†’æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹</span></span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§</span></span><br><span class="line">        Process.setThreadPriority(mPriority);</span><br><span class="line">        onLooperPrepared();</span><br><span class="line">        <span class="comment">//å¼€å¯æ¶ˆæ¯å¾ªç¯</span></span><br><span class="line">        Looper.loop();</span><br><span class="line">        mTid = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤–ï¼ŒHandlerThread è¿˜åŒ…å«ä¸€ä¸ª<code>getLooper()</code>æ–¹æ³•ç”¨äºè·å– Looperã€‚å½“æˆ‘ä»¬åœ¨å¤–éƒ¨è°ƒç”¨<code>handlerThread.start()</code>å¯åŠ¨çº¿ç¨‹åï¼Œç”±äºå…¶<code>run()</code>æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºä¾ç„¶æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥ <code>getLooper()</code>æ–¹æ³•å°±å¿…é¡»ç­‰åˆ° Looper åˆå§‹åŒ–å®Œæ¯•åæ‰èƒ½è¿”å›ï¼Œå¦åˆ™å°±ä¼šç”±äº<code>wait()</code>æ–¹æ³•è€Œä¸€ç›´é˜»å¡ç­‰å¾…ã€‚å½“<code>run()</code>æ–¹æ³•åˆå§‹åŒ– Looper å®Œæˆåï¼Œå°±ä¼šè°ƒç”¨<code>notifyAll()</code>æ¥å”¤é†’æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚æ‰€ä»¥å¤–éƒ¨åœ¨ä½¿ç”¨ HandlerThread å‰å°±è®°å¾—å¿…é¡»å…ˆè°ƒç”¨ <code>start()</code> æ–¹æ³•æ¥å¯åŠ¨ HandlerThread </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–ä¸ HandlerThread å…³è”çš„ Looper å¯¹è±¡</span></span><br><span class="line"><span class="comment">//å› ä¸º getLooper() å¯èƒ½å…ˆäº run() è¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥å½“ mLooper ä¸º null æ—¶è°ƒç”¨è€…çº¿ç¨‹å°±éœ€è¦é˜»å¡ç­‰å¾… Looper å¯¹è±¡åˆ›å»ºå®Œæ¯•</span></span><br><span class="line"><span class="keyword">public</span> Looper <span class="title function_">getLooper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isAlive()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the thread has been started, wait until the looper has been created.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive() &amp;&amp; mLooper == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mLooper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HandlerThread èµ·åˆ°çš„ä½œç”¨å°±æ˜¯æ–¹ä¾¿äº†ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ï¼Œä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥é€šè¿‡ Handler æ¥å£°æ˜è€—æ—¶ä»»åŠ¡å¹¶äº¤ç”±å­çº¿ç¨‹æ¥æ‰§è¡Œã€‚ä½¿ç”¨ HandlerThread ä¹Ÿæ–¹ä¾¿åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ï¼Œä¸»çº¿ç¨‹å’Œå…¶å®ƒå­çº¿ç¨‹éƒ½å¯ä»¥å‘ HandlerThread ä¸‹å‘ä»»åŠ¡ï¼Œä¸” HandlerThread å¯ä»¥ä¿è¯å¤šä¸ªä»»åŠ¡æ‰§è¡Œæ—¶çš„æœ‰åºæ€§</p>
<h2 id="2ã€IntentService"><a href="#2ã€IntentService" class="headerlink" title="2ã€IntentService"></a>2ã€IntentService</h2><p>IntentService æ˜¯ç³»ç»Ÿæä¾›çš„ Service å­ç±»ï¼Œç”¨äºåœ¨åå°ä¸²è¡Œæ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œåœ¨å¤„ç†å®Œæ‰€æœ‰ä»»åŠ¡åä¼šè‡ªåŠ¨åœæ­¢ï¼Œä¸å¿…æ¥æ‰‹åŠ¨è°ƒç”¨ <code>stopSelf()</code> æ–¹æ³•ã€‚è€Œä¸”ç”±äºIntentService æ˜¯å››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œæ‹¥æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œä¸æ˜“è¢«ç³»ç»Ÿæ€æ­»ï¼Œå› æ­¤é€‚åˆç”¨äºæ‰§è¡Œä¸€äº›é«˜ä¼˜å…ˆçº§çš„å¼‚æ­¥ä»»åŠ¡</p>
<p><strong>Google å®˜æ–¹ä»¥å‰ä¹Ÿæ¨èå¼€å‘è€…ä½¿ç”¨ IntentServiceï¼Œä½†æ˜¯åœ¨ Android 11 ä¸­å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒçŠ¶æ€äº†ï¼Œä½†è¿™ä¹Ÿä¸å¦¨ç¢æˆ‘ä»¬æ¥äº†è§£ä¸‹å…¶å®ç°åŸç†</strong></p>
<p>IntentService å†…éƒ¨ä¾é  HandlerThread æ¥å®ç°ï¼Œå…¶ <code>onCreate()</code>æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª HandlerThreadï¼Œæ‹¿åˆ° Looper å¯¹è±¡æ¥åˆå§‹åŒ– ServiceHandlerã€‚ServiceHandler ä¼šå°†å…¶æ¥å—åˆ°çš„æ¯ä¸ª Message éƒ½è½¬äº¤ç”±æŠ½è±¡æ–¹æ³• <code>onHandleIntent</code>æ¥å¤„ç†ï¼Œå­ç±»å°±é€šè¿‡å®ç°è¯¥æ–¹æ³•æ¥å£°æ˜è€—æ—¶ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">IntentService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Looper mServiceLooper;</span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServiceHandler mServiceHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ServiceHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ServiceHandler</span><span class="params">(Looper looper)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">            onHandleIntent((Intent)msg.obj);</span><br><span class="line">            stopSelf(msg.arg1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line">        <span class="type">HandlerThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerThread</span>(<span class="string">&quot;IntentService[&quot;</span> + mName + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="comment">//è§¦å‘ HandlerThread åˆ›å»º Looper å¯¹è±¡</span></span><br><span class="line">        thread.start();</span><br><span class="line">		<span class="comment">//è·å– Looper å¯¹è±¡ï¼Œæ„å»ºå¯ä»¥å‘ HandlerThread å‘é€ Message çš„ Handler</span></span><br><span class="line">        mServiceLooper = thread.getLooper();</span><br><span class="line">        mServiceHandler = <span class="keyword">new</span> <span class="title class_">ServiceHandler</span>(mServiceLooper);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">onHandleIntent</span><span class="params">(<span class="meta">@Nullable</span> Intent intent)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡ start IntentService æ—¶ï¼Œ<code>onStart()</code>æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œå°† <code>intent</code> å’Œ <code>startId</code> åŒ…è£…ä¸ºä¸€ä¸ª Message å¯¹è±¡åå‘é€ç»™<code>mServiceHandler</code>ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ <strong>startId</strong> è¿™ä¸ªå‚æ•°ï¼Œå®ƒç”¨äºå”¯ä¸€æ ‡è¯†æ¯æ¬¡å¯¹ IntentService å‘èµ·çš„ä»»åŠ¡è¯·æ±‚ï¼Œæ¯æ¬¡å›è°ƒ <code>onStart()</code> æ–¹æ³•æ—¶ï¼ŒstartId çš„å€¼éƒ½æ˜¯è‡ªåŠ¨é€’å¢çš„ã€‚IntentService ä¸åº”è¯¥åœ¨å¤„ç†å®Œä¸€ä¸ª Message ä¹‹åå°±ç«‹å³åœæ­¢ IntentServiceï¼Œå› ä¸ºæ­¤æ—¶ MessageQueue ä¸­å¯èƒ½è¿˜æœ‰å¾…å¤„ç†çš„ä»»åŠ¡è¿˜æœªå–å‡ºæ¥ï¼Œæ‰€ä»¥å¦‚æœå½“è°ƒç”¨ <code>stopSelf(int)</code>æ–¹æ³•æ—¶ä¼ å…¥çš„å‚æ•°ä¸ç­‰äºå½“å‰æœ€æ–°çš„ startId å€¼çš„è¯ï¼Œé‚£ä¹ˆ<code>stopSelf(int)</code> æ–¹æ³•å°±ä¸ä¼šå¯¼è‡´ IntentService è¢«åœæ­¢ï¼Œä»è€Œé¿å…äº†å°†å°šæœªå¤„ç†çš„ Message ç»™é—æ¼äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mServiceHandler.obtainMessage();</span><br><span class="line">    msg.arg1 = startId;</span><br><span class="line">    msg.obj = intent;</span><br><span class="line">    mServiceHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">    onStart(intent, startId);</span><br><span class="line">    <span class="keyword">return</span> mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å››ã€Handler-åœ¨ä¸‰æ–¹åº“ä¸­çš„åº”ç”¨"><a href="#å››ã€Handler-åœ¨ä¸‰æ–¹åº“ä¸­çš„åº”ç”¨" class="headerlink" title="å››ã€Handler åœ¨ä¸‰æ–¹åº“ä¸­çš„åº”ç”¨"></a>å››ã€Handler åœ¨ä¸‰æ–¹åº“ä¸­çš„åº”ç”¨</h1><h2 id="1ã€EventBus"><a href="#1ã€EventBus" class="headerlink" title="1ã€EventBus"></a>1ã€EventBus</h2><p>EventBus çš„ Github ä¸Šæœ‰è¿™ä¹ˆä¸€å¥ä»‹ç»ï¼š<a target="_blank" rel="noopener" href="https://greenrobot.org/eventbus/">EventBus</a> is a publish&#x2F;subscribe event bus for Android and Java.  è¿™è¯´æ˜äº† EventBus æ˜¯æ™®éé€‚ç”¨äº Java ç¯å¢ƒçš„ï¼Œåªæ˜¯å¯¹ Android ç³»ç»Ÿåšäº†ç‰¹æ®Šçš„å¹³å°æ”¯æŒè€Œå·²ã€‚EventBus çš„å››ç§æ¶ˆæ¯å‘é€ç­–ç•¥åŒ…å«äº†<code>ThreadMode.MAIN</code> ç”¨äºæŒ‡å®šåœ¨ä¸»çº¿ç¨‹è¿›è¡Œæ¶ˆæ¯å›è°ƒï¼Œå…¶å†…éƒ¨å°±æ˜¯é€šè¿‡ Handler æ¥å®ç°çš„</p>
<p>EventBusBuilder ä¼šå»å°è¯•è·å– MainLooperï¼Œå¦‚æœæ‹¿å¾—åˆ°çš„è¯å°±å¯ä»¥ç”¨æ¥åˆå§‹åŒ– HandlerPosterï¼Œä»è€Œå®ç°ä¸»çº¿ç¨‹å›è°ƒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MainThreadSupport <span class="title function_">getMainThreadSupport</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mainThreadSupport != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mainThreadSupport;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AndroidLogger.isAndroidLogAvailable()) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">looperOrNull</span> <span class="operator">=</span> getAndroidMainLooperOrNull();</span><br><span class="line">        <span class="keyword">return</span> looperOrNull == <span class="literal">null</span> ? <span class="literal">null</span> :</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MainThreadSupport</span>.AndroidHandlerMainThreadSupport((Looper) looperOrNull);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Object <span class="title function_">getAndroidMainLooperOrNull</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Looper.getMainLooper();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="comment">// Not really a functional Android (e.g. &quot;Stub!&quot; maven dependencies)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandlerPoster</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> <span class="keyword">implements</span> <span class="title class_">Poster</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">HandlerPoster</span><span class="params">(EventBus eventBus, Looper looper, <span class="type">int</span> maxMillisInsideHandleMessage)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(looper);</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	Â·Â·Â·</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2ã€Retrofit"><a href="#2ã€Retrofit" class="headerlink" title="2ã€Retrofit"></a>2ã€Retrofit</h2><p>å’Œ EventBus ä¸€æ ·ï¼ŒRetrofit çš„å†…éƒ¨å®ç°ä¹Ÿä¸éœ€è¦ä¾èµ–äº Android å¹³å°ï¼Œè€Œæ˜¯å¯ä»¥ç”¨äºä»»æ„çš„ Java å®¢æˆ·ç«¯ï¼ŒRetrofit åªæ˜¯å¯¹ Android å¹³å°è¿›è¡Œäº†ç‰¹æ®Šå®ç°è€Œå·²</p>
<p>åœ¨æ„å»º Retrofit å¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¼ é€’ä¸€ä¸ª Platform å¯¹è±¡ç”¨äºæ ‡è®°è°ƒç”¨æ–¹æ‰€å¤„çš„å¹³å°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Platform platform;</span><br><span class="line">    </span><br><span class="line">    Builder(Platform platform) &#123;</span><br><span class="line">      <span class="built_in">this</span>.platform = platform;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Platform ç±»åªå…·æœ‰ä¸€ä¸ªå”¯ä¸€å­ç±»ï¼Œå³ Android ç±»ã€‚å…¶ä¸»è¦é€»è¾‘å°±æ˜¯é‡å†™äº†çˆ¶ç±»çš„ <code>defaultCallbackExecutor()</code>æ–¹æ³•ï¼Œé€šè¿‡ Handler æ¥å®ç°åœ¨ä¸»çº¿ç¨‹å›è°ƒç½‘ç»œè¯·æ±‚ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Android</span> <span class="keyword">extends</span> <span class="title class_">Platform</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">defaultCallbackExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MainThreadExecutor</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Â·Â·Â·</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MainThreadExecutor</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Handler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        handler.post(r);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="äº”ã€æé—®ç¯èŠ‚"><a href="#äº”ã€æé—®ç¯èŠ‚" class="headerlink" title="äº”ã€æé—®ç¯èŠ‚"></a>äº”ã€æé—®ç¯èŠ‚</h1><h2 id="1ã€Handlerã€Looperã€MessageQueueã€Thread-çš„å¯¹åº”å…³ç³»"><a href="#1ã€Handlerã€Looperã€MessageQueueã€Thread-çš„å¯¹åº”å…³ç³»" class="headerlink" title="1ã€Handlerã€Looperã€MessageQueueã€Thread çš„å¯¹åº”å…³ç³»"></a>1ã€Handlerã€Looperã€MessageQueueã€Thread çš„å¯¹åº”å…³ç³»</h2><p>é¦–å…ˆï¼ŒLooper ä¸­çš„ MessageQueue å’Œ Thread ä¸¤ä¸ªå­—æ®µéƒ½å±äºå¸¸é‡ï¼Œä¸” Looper å®ä¾‹æ˜¯å­˜åœ¨ ThreadLocal ä¸­ï¼Œè¿™è¯´æ˜äº† Looper å’Œ MessageQueue ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€åº”çš„å…³ç³»ï¼Œä¸”ä¸€ä¸ª Thread åœ¨å…¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…éƒ½åªä¼šå…³è”åˆ°åŒä¸€ä¸ª Looper å¯¹è±¡å’ŒåŒä¸€ä¸ª MessageQueue å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Looper</span> &#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line">   <span class="keyword">final</span> Thread mThread;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Looper&gt;();</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">private</span> <span class="title function_">Looper</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">        mQueue = <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(quitAllowed);</span><br><span class="line">        mThread = Thread.currentThread();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Handler ä¸­çš„ Looper å’Œ MessageQueue ä¸¤ä¸ªå­—æ®µä¹Ÿéƒ½å±äºå¸¸é‡ï¼Œè¯´æ˜ Handler å¯¹äº Looper å’Œ MessageQueue éƒ½æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚<strong>ä½†æ˜¯ Looper å’Œ MessageQueue å¯¹äº Handler å´å¯ä»¥æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¾‹å¦‚ï¼Œå¤šä¸ªå­çº¿ç¨‹å†…å£°æ˜çš„ Handler éƒ½å¯ä»¥å…³è”åˆ° mainLooper</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">final</span> Looper mLooper;</span><br><span class="line">    <span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2ã€Handler-çš„åŒæ­¥æœºåˆ¶"><a href="#2ã€Handler-çš„åŒæ­¥æœºåˆ¶" class="headerlink" title="2ã€Handler çš„åŒæ­¥æœºåˆ¶"></a>2ã€Handler çš„åŒæ­¥æœºåˆ¶</h2><p>MessageQueue åœ¨ä¿å­˜ Message çš„æ—¶å€™ï¼Œ<code>enqueueMessage</code>æ–¹æ³•å†…éƒ¨å·²ç»åŠ ä¸Šäº†åŒæ­¥é”ï¼Œä»è€Œé¿å…äº†å¤šä¸ªçº¿ç¨‹åŒæ—¶å‘é€æ¶ˆæ¯å¯¼è‡´ç«æ€é—®é¢˜ã€‚æ­¤å¤–ï¼Œ<code>next()</code>æ–¹æ³•å†…éƒ¨ä¹ŸåŠ ä¸Šäº†åŒæ­¥é”ï¼Œæ‰€ä»¥ä¹Ÿä¿éšœäº† Looper åˆ†å‘ Message çš„æœ‰åºæ€§ã€‚æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼ŒLooper æ€»æ˜¯ç”±ä¸€ä¸ªç‰¹å®šçš„çº¿ç¨‹æ¥æ‰§è¡Œéå†ï¼Œæ‰€ä»¥åœ¨æ¶ˆè´¹ Message çš„æ—¶å€™ä¹Ÿä¸å­˜åœ¨ç«æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(Message msg, <span class="type">long</span> <span class="keyword">when</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Message must have a target.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">Message <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            Â·Â·Â·</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3ã€Handler-å‘é€åŒæ­¥æ¶ˆæ¯"><a href="#3ã€Handler-å‘é€åŒæ­¥æ¶ˆæ¯" class="headerlink" title="3ã€Handler å‘é€åŒæ­¥æ¶ˆæ¯"></a>3ã€Handler å‘é€åŒæ­¥æ¶ˆæ¯</h2><p>å¦‚æœæˆ‘ä»¬åœ¨å­çº¿ç¨‹é€šè¿‡ Handler å‘ä¸»çº¿ç¨‹å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¸Œæœ›ç­‰åˆ°æ¶ˆæ¯æ‰§è¡Œå®Œæ¯•åå­çº¿ç¨‹æ‰ç»§ç»­è¿è¡Œï¼Œè¿™è¯¥å¦‚ä½•å®ç°ï¼Ÿå…¶å®åƒè¿™ç§æ¶‰åŠåˆ°å¤šçº¿ç¨‹åŒæ­¥ç­‰å¾…çš„é—®é¢˜ï¼Œå¾€å¾€éƒ½æ˜¯éœ€è¦ä¾èµ–äº<strong>çº¿ç¨‹ä¼‘çœ +çº¿ç¨‹å”¤é†’</strong>æœºåˆ¶æ¥å®ç°çš„</p>
<p>Handler æœ¬èº«å°±æä¾›äº†ä¸€ä¸ª<code>runWithScissors</code>æ–¹æ³•å¯ä»¥ç”¨äºå®ç°è¿™ç§åŠŸèƒ½ï¼Œåªæ˜¯è¢«éšè—äº†ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è°ƒç”¨åˆ°ã€‚<code>runWithScissors</code>é¦–å…ˆä¼šåˆ¤æ–­ç›®æ ‡çº¿ç¨‹æ˜¯å¦å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œæ˜¯çš„è¯åˆ™ç›´æ¥æ‰§è¡Œ Runnableï¼Œå¦åˆ™å°±éœ€è¦ä½¿ç”¨åˆ° BlockingRunnable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">runWithScissors</span><span class="params">(<span class="meta">@NonNull</span> Runnable r, <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;runnable must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;timeout must be non-negative&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Looper.myLooper() == mLooper) &#123;</span><br><span class="line">        r.run();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">BlockingRunnable</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockingRunnable</span>(r);</span><br><span class="line">    <span class="keyword">return</span> br.postAndWait(<span class="built_in">this</span>, timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BlockingRunnable çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ Runnable æ‰§è¡Œå®Œå‰ä¼šé€šè¿‡è°ƒç”¨ <code>wait()</code>æ–¹æ³•æ¥ä½¿å‘é€è€…çº¿ç¨‹è½¬ä¸ºé˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå†é€šè¿‡<code>notifyAll()</code>æ¥å”¤é†’å‘é€è€…çº¿ç¨‹ï¼Œä»è€Œå®ç°äº†åœ¨ Runnable è¢«æ‰§è¡Œå®Œä¹‹å‰å‘é€è€…çº¿ç¨‹éƒ½ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BlockingRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Runnable mTask;</span><br><span class="line">    	<span class="comment">//ç”¨äºæ ‡è®° mTask æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæ¯• </span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> mDone;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">BlockingRunnable</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">            mTask = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mTask.run();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    mDone = <span class="literal">true</span>;</span><br><span class="line">                    notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">postAndWait</span><span class="params">(Handler handler, <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!handler.post(<span class="built_in">this</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">expirationTime</span> <span class="operator">=</span> SystemClock.uptimeMillis() + timeout;</span><br><span class="line">                    <span class="keyword">while</span> (!mDone) &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> expirationTime - SystemClock.uptimeMillis();</span><br><span class="line">                        <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// timeout</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">//é™æ—¶ç­‰å¾…</span></span><br><span class="line">                            wait(delay);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (!mDone) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">//æ— é™æœŸç­‰å¾…</span></span><br><span class="line">                            wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶ <code>runWithScissors</code> æ–¹æ³•æˆ‘ä»¬æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¾é è¿™æ€è·¯è‡ªå·±æ¥å®ç° BlockingRunnableï¼ŒæŠ˜ä¸­å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ä½†è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¦‚æœ Loop æ„å¤–é€€å‡ºå¾ªç¯å¯¼è‡´è¯¥ Runnable æ— æ³•è¢«æ‰§è¡Œçš„è¯ï¼Œå°±ä¼šå¯¼è‡´è¢«æš‚åœçš„çº¿ç¨‹ä¸€ç›´æ— æ³•è¢«å”¤é†’ï¼Œéœ€è¦è°¨æ…ä½¿ç”¨</p>
<h2 id="4ã€Handler-é¿å…å†…å­˜æ³„æ¼"><a href="#4ã€Handler-é¿å…å†…å­˜æ³„æ¼" class="headerlink" title="4ã€Handler é¿å…å†…å­˜æ³„æ¼"></a>4ã€Handler é¿å…å†…å­˜æ³„æ¼</h2><p>å½“é€€å‡º Activity æ—¶ï¼Œå¦‚æœä½œä¸ºå†…éƒ¨ç±»çš„ Handler ä¸­è¿˜ä¿å­˜ç€å¾…å¤„ç†çš„å»¶æ—¶æ¶ˆæ¯çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨<code>Handler.removeCallbacksAndMessages(null)</code>æ¥ç§»é™¤æ‰€æœ‰å¾…å¤„ç†çš„ Message</p>
<p>è¯¥æ–¹æ³•ä¼šå°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰€æœ‰ <code>Message.obj</code> ç­‰äº token çš„ Message å‡ç»™ç§»é™¤æ‰ï¼Œå¦‚æœ token ä¸º null çš„è¯åˆ™ä¼šç§»é™¤æ‰€æœ‰ Message </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">removeCallbacksAndMessages</span><span class="params">(<span class="meta">@Nullable</span> Object token)</span> &#123;</span><br><span class="line">    mQueue.removeCallbacksAndMessages(<span class="built_in">this</span>, token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5ã€Message-å¦‚ä½•å¤ç”¨"><a href="#5ã€Message-å¦‚ä½•å¤ç”¨" class="headerlink" title="5ã€Message å¦‚ä½•å¤ç”¨"></a>5ã€Message å¦‚ä½•å¤ç”¨</h2><p>å› ä¸º Android ç³»ç»Ÿæœ¬èº«å°±å­˜åœ¨å¾ˆå¤šäº‹ä»¶éœ€è¦äº¤ç”± Message æ¥äº¤ä»˜ç»™ mainLooperï¼Œæ‰€ä»¥ Message çš„åˆ›å»ºæ˜¯å¾ˆé¢‘ç¹çš„ã€‚ä¸ºäº†å‡å°‘ Message é¢‘ç¹é‡å¤åˆ›å»ºçš„æƒ…å†µï¼ŒMessage æä¾›äº† MessagePool ç”¨äºå®ç° Message çš„ç¼“å­˜å¤ç”¨ï¼Œä»¥æ­¤æ¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨</p>
<p>å½“ Looper æ¶ˆè´¹äº† Message åä¼šè°ƒç”¨<code>recycleUnchecked()</code>æ–¹æ³•å°† Message è¿›è¡Œå›æ”¶ï¼Œåœ¨æ¸…é™¤äº†å„é¡¹èµ„æºåä¼šç¼“å­˜åˆ° sPool å˜é‡ä¸Šï¼ŒåŒæ—¶å°†ä¹‹å‰ç¼“å­˜çš„ Message ç½®ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹ nextï¼Œé€šè¿‡è¿™ç§é“¾è¡¨ç»“æ„æ¥ç¼“å­˜æœ€å¤š 50 ä¸ªMessageã€‚è¿™é‡Œä½¿ç”¨åˆ°çš„æ˜¯<strong>äº«å…ƒè®¾è®¡æ¨¡å¼</strong></p>
<p><code>obtain()</code>æ–¹æ³•åˆ™ä¼šåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å¯ç”¨çš„ç¼“å­˜ï¼Œæœ‰çš„è¯åˆ™å°† sPool ä»é“¾è¡¨ä¸­ç§»é™¤åè¿”å›ï¼Œå¦åˆ™å°±è¿”å›ä¸€ä¸ªæ–°çš„ Message å®ä¾‹ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™åº”è¯¥å°½é‡é€šè¿‡è°ƒç”¨<code>Message.obtain()</code>æˆ–è€…<code>Handler.obtainMessage()</code>æ–¹æ³•æ¥è·å– Message å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">sPoolSync</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Message sPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sPoolSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_POOL_SIZE</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title function_">obtain</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sPool != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">m</span> <span class="operator">=</span> sPool;</span><br><span class="line">                sPool = m.next;</span><br><span class="line">                m.next = <span class="literal">null</span>;</span><br><span class="line">                m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></span><br><span class="line">                sPoolSize--;</span><br><span class="line">                <span class="keyword">return</span> m;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">recycleUnchecked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Mark the message as in use while it remains in the recycled object pool.</span></span><br><span class="line">        <span class="comment">// Clear out all other details.</span></span><br><span class="line">        flags = FLAG_IN_USE;</span><br><span class="line">        what = <span class="number">0</span>;</span><br><span class="line">        arg1 = <span class="number">0</span>;</span><br><span class="line">        arg2 = <span class="number">0</span>;</span><br><span class="line">        obj = <span class="literal">null</span>;</span><br><span class="line">        replyTo = <span class="literal">null</span>;</span><br><span class="line">        sendingUid = UID_NONE;</span><br><span class="line">        workSourceUid = UID_NONE;</span><br><span class="line">        <span class="keyword">when</span> = <span class="number">0</span>;</span><br><span class="line">        target = <span class="literal">null</span>;</span><br><span class="line">        callback = <span class="literal">null</span>;</span><br><span class="line">        data = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</span><br><span class="line">                next = sPool;</span><br><span class="line">                sPool = <span class="built_in">this</span>;</span><br><span class="line">                sPoolSize++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6ã€Message-å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜"><a href="#6ã€Message-å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="6ã€Message å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜"></a>6ã€Message å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜</h2><p>ç”±äº Message é‡‡ç”¨äº†ç¼“å­˜å¤ç”¨æœºåˆ¶ï¼Œä»è€Œå¯¼è‡´äº†ä¸€ä¸ª Message å¤±æ•ˆé—®é¢˜ã€‚å½“ <code>handleMessage</code> æ–¹æ³•è¢«å›è°ƒåï¼ŒMessage æºå¸¦çš„æ‰€æœ‰å‚æ•°éƒ½ä¼šè¢«æ¸…ç©ºï¼Œè€Œå¦‚æœå¤–éƒ¨çš„ <code>handleMessage</code>æ–¹æ³•æ˜¯ä½¿ç”¨äº†å¼‚æ­¥çº¿ç¨‹æ¥å¤„ç† Message çš„è¯ï¼Œé‚£ä¹ˆå¼‚æ­¥çº¿ç¨‹åªä¼šå¾—åˆ°ä¸€ä¸ªç©ºç™½çš„ Message</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> handler = <span class="keyword">object</span> : Handler() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>)</span></span> &#123;</span><br><span class="line">        handleMessageAsync(msg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">handleMessageAsync</span><span class="params">(msg: <span class="type">Message</span>)</span></span> &#123;</span><br><span class="line">    thread &#123;</span><br><span class="line">        <span class="comment">//åªä¼šå¾—åˆ°ä¸€ä¸ªç©ºç™½çš„ Message å¯¹è±¡</span></span><br><span class="line">        println(msg.obj)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7ã€Message-å¦‚ä½•æé«˜ä¼˜å…ˆçº§"><a href="#7ã€Message-å¦‚ä½•æé«˜ä¼˜å…ˆçº§" class="headerlink" title="7ã€Message å¦‚ä½•æé«˜ä¼˜å…ˆçº§"></a>7ã€Message å¦‚ä½•æé«˜ä¼˜å…ˆçº§</h2><p>Handler åŒ…å«ä¸€ä¸ª <code>sendMessageAtFrontOfQueue</code>æ–¹æ³•å¯ä»¥ç”¨äºæé«˜ Message çš„å¤„ç†ä¼˜å…ˆçº§ã€‚è¯¥æ–¹æ³•ä¸º Message è®¾å®šçš„æ—¶é—´æˆ³æ˜¯ 0ï¼Œä½¿å¾— Message å¯ä»¥ç›´æ¥æ’å…¥åˆ° MessageQueue çš„å¤´éƒ¨ï¼Œä»è€Œåšåˆ°ä¼˜å…ˆå¤„ç†ã€‚ä½†å®˜æ–¹å¹¶ä¸æ¨èä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºæœ€æç«¯çš„æƒ…å†µä¸‹å¯èƒ½ä¼šä½¿å¾—å…¶å®ƒ Message ä¸€ç›´å¾—ä¸åˆ°å¤„ç†æˆ–è€…å…¶å®ƒæ„æƒ³ä¸åˆ°çš„æƒ…å†µ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">sendMessageAtFrontOfQueue</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">    <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> mQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">            <span class="built_in">this</span> + <span class="string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);</span><br><span class="line">        Log.w(<span class="string">&quot;Looper&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> enqueueMessage(queue, msg, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8ã€æ£€æµ‹-Looper-åˆ†å‘-Message-çš„æ•ˆç‡"><a href="#8ã€æ£€æµ‹-Looper-åˆ†å‘-Message-çš„æ•ˆç‡" class="headerlink" title="8ã€æ£€æµ‹ Looper åˆ†å‘ Message çš„æ•ˆç‡"></a>8ã€æ£€æµ‹ Looper åˆ†å‘ Message çš„æ•ˆç‡</h2><p>Looper åœ¨è¿›è¡Œ Loop å¾ªç¯æ—¶ï¼Œä¼šé€šè¿‡ Observer å‘å¤–å›è°ƒæ¯ä¸ª Message çš„å›è°ƒäº‹ä»¶ã€‚ä¸”å¦‚æœè®¾å®šäº† <code>slowDispatchThresholdMs</code> å’Œ <code>slowDeliveryThresholdMs</code> è¿™ä¸¤ä¸ªé˜ˆå€¼çš„è¯ï¼Œåˆ™ä¼šå¯¹ Message çš„<strong>åˆ†å‘æ—¶æœº</strong>å’Œ<strong>åˆ†å‘è€—æ—¶</strong>è¿›è¡Œç›‘æµ‹ï¼Œå­˜åœ¨å¼‚å¸¸æƒ…å†µçš„è¯å°±ä¼šæ‰“å° Logã€‚è¯¥æœºåˆ¶å¯ä»¥ç”¨äºå®ç°åº”ç”¨æ€§èƒ½ç›‘æµ‹ï¼Œå‘ç°æ½œåœ¨çš„ Message å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œä½†å¯æƒœç›‘æµ‹æ–¹æ³•è¢«ç³»ç»Ÿéšè—äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Looper</span> <span class="variable">me</span> <span class="operator">=</span> myLooper();</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next(); <span class="comment">// might block</span></span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        <span class="comment">//ç”¨äºå‘å¤–å›è°ƒé€šçŸ¥ Message çš„åˆ†å‘äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> sObserver;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">traceTag</span> <span class="operator">=</span> me.mTraceTag;</span><br><span class="line">        <span class="comment">//å¦‚æœLooperåˆ†å‘Messageçš„æ—¶é—´æ™šäºé¢„å®šæ—¶é—´ä¸”è¶…å‡ºè¿™ä¸ªé˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºLooperåˆ†å‘è¿‡æ…¢</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">slowDispatchThresholdMs</span> <span class="operator">=</span> me.mSlowDispatchThresholdMs;</span><br><span class="line">        <span class="comment">//å¦‚æœå‘å¤–åˆ†å‘å‡ºå»çš„Messageçš„å¤„ç†æ—¶é—´è¶…å‡ºè¿™ä¸ªé˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºå¤–éƒ¨å¤„ç†è¿‡æ…¢</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">slowDeliveryThresholdMs</span> <span class="operator">=</span> me.mSlowDeliveryThresholdMs;</span><br><span class="line">        <span class="keyword">if</span> (thresholdOverride &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            slowDispatchThresholdMs = thresholdOverride;</span><br><span class="line">            slowDeliveryThresholdMs = thresholdOverride;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">logSlowDelivery</span> <span class="operator">=</span> (slowDeliveryThresholdMs &gt; <span class="number">0</span>) &amp;&amp; (msg.<span class="keyword">when</span> &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">logSlowDispatch</span> <span class="operator">=</span> (slowDispatchThresholdMs &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">needStartTime</span> <span class="operator">=</span> logSlowDelivery || logSlowDispatch;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">needEndTime</span> <span class="operator">=</span> logSlowDispatch;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">            Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¼€å§‹åˆ†å‘ Message çš„æ—¶é—´</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dispatchStart</span> <span class="operator">=</span> needStartTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//Message åˆ†å‘ç»“æŸçš„æ—¶é—´</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> dispatchEnd;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¼€å§‹åˆ†å‘ Message </span></span><br><span class="line">            token = observer.messageDispatchStarting();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">origWorkSource</span> <span class="operator">=</span> ThreadLocalWorkSource.setUid(msg.workSourceUid);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            msg.target.dispatchMessage(msg);</span><br><span class="line">            <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å®Œæˆ Message çš„åˆ†å‘ï¼Œä¸”æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                observer.messageDispatched(token, msg);</span><br><span class="line">            &#125;</span><br><span class="line">            dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//åˆ†å‘ Message æ—¶æŠ›å‡ºäº†å¼‚å¸¸</span></span><br><span class="line">                observer.dispatchingThrewException(token, msg, exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> exception;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ThreadLocalWorkSource.restore(origWorkSource);</span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                Trace.traceEnd(traceTag);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logSlowDelivery) &#123;</span><br><span class="line">            <span class="keyword">if</span> (slowDeliveryDetected) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((dispatchStart - msg.<span class="keyword">when</span>) &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœ Message çš„åˆ†å‘æ—¶é—´æ™šäºé¢„å®šæ—¶é—´ï¼Œä¸”é—´éš”è¶…å‡º10æ¯«ç§’ï¼Œåˆ™è®¤ä¸ºå±äºå»¶è¿Ÿäº¤ä»˜</span></span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Drained&quot;</span>);</span><br><span class="line">                    slowDeliveryDetected = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (showSlowLog(slowDeliveryThresholdMs, msg.<span class="keyword">when</span>, dispatchStart, <span class="string">&quot;delivery&quot;</span>,</span><br><span class="line">                        msg)) &#123;</span><br><span class="line">                    <span class="comment">// Once we write a slow delivery log, suppress until the queue drains.</span></span><br><span class="line">                    slowDeliveryDetected = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9ã€ä¸»çº¿ç¨‹-Looper-åœ¨å“ªé‡Œåˆ›å»º"><a href="#9ã€ä¸»çº¿ç¨‹-Looper-åœ¨å“ªé‡Œåˆ›å»º" class="headerlink" title="9ã€ä¸»çº¿ç¨‹ Looper åœ¨å“ªé‡Œåˆ›å»º"></a>9ã€ä¸»çº¿ç¨‹ Looper åœ¨å“ªé‡Œåˆ›å»º</h2><p>ç”± ActivityThread ç±»çš„ <code>main()</code> æ–¹æ³•æ¥åˆ›å»ºã€‚è¯¥ <code>main()</code> æ–¹æ³•å³ Java ç¨‹åºçš„è¿è¡Œèµ·å§‹ç‚¹ï¼Œå½“åº”ç”¨å¯åŠ¨æ—¶ç³»ç»Ÿå°±è‡ªåŠ¨ä¸ºæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹åšå¥½äº† mainLooper çš„åˆå§‹åŒ–ï¼Œè€Œä¸”å·²ç»è°ƒç”¨äº†<code>Looper.loop()</code>æ–¹æ³•å¼€å¯äº†æ¶ˆæ¯çš„å¾ªç¯å¤„ç†ï¼Œåº”ç”¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å„ç§äº¤äº’é€»è¾‘ï¼ˆä¾‹å¦‚ï¼šå±å¹•çš„è§¦æ‘¸äº‹ä»¶ã€åˆ—è¡¨çš„æ»‘åŠ¨ç­‰ï¼‰å°±éƒ½æ˜¯åœ¨è¿™ä¸ªå¾ªç¯é‡Œå®Œæˆåˆ†å‘çš„ã€‚æ­£æ˜¯å› ä¸º Android ç³»ç»Ÿå·²ç»è‡ªåŠ¨å®Œæˆäº†ä¸»çº¿ç¨‹ Looper çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­æ‰å¯ä»¥ç›´æ¥ä½¿ç”¨ Handler çš„æ— å‚æ„é€ å‡½æ•°æ¥å®Œæˆ UI ç›¸å…³äº‹ä»¶çš„å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        Looper.loop();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10ã€ä¸»çº¿ç¨‹-Looper-ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯"><a href="#10ã€ä¸»çº¿ç¨‹-Looper-ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯" class="headerlink" title="10ã€ä¸»çº¿ç¨‹ Looper ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯"></a>10ã€ä¸»çº¿ç¨‹ Looper ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯</h2><p>å½“ ActivityThread å†…éƒ¨çš„ Handler æ”¶åˆ°äº† EXIT_APPLICATION æ¶ˆæ¯åï¼Œå°±ä¼šé€€å‡º Looper å¾ªç¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> EXIT_APPLICATION:</span><br><span class="line">            <span class="keyword">if</span> (mInitialApplication != <span class="literal">null</span>) &#123;</span><br><span class="line">                mInitialApplication.onTerminate();</span><br><span class="line">            &#125;</span><br><span class="line">            Looper.myLooper().quit();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11ã€ä¸»çº¿ç¨‹-Looper-loop-ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´-ANR"><a href="#11ã€ä¸»çº¿ç¨‹-Looper-loop-ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´-ANR" class="headerlink" title="11ã€ä¸»çº¿ç¨‹ Looper.loop() ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´ ANR"></a>11ã€ä¸»çº¿ç¨‹ Looper.loop() ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´ ANR</h2><p>è¿™ä¸ªé—®é¢˜åœ¨ç½‘ä¸Šå¾ˆå¸¸è§ï¼Œæˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°æ—¶å°±è§‰å¾—è¿™ç§é—®é¢˜å¾ˆå¥‡æ€ªï¼Œä¸»çº¿ç¨‹å‡­å•¥ä¼š ANRï¼Ÿè¿™ä¸ªé—®é¢˜æ„Ÿè§‰æœ¬èº«å°±æ˜¯ç‰¹æ„ä¸ºäº†æ¥è¯¯å¯¼äºº</p>
<p>çœ‹ä»¥ä¸‹ä¾‹å­ã€‚<code>doSomeThing()</code>æ–¹æ³•æ˜¯æ”¾åœ¨ for å¾ªç¯è¿™ä¸ªæ­»å¾ªç¯çš„åè¾¹ï¼Œå¯¹äºè¯¥æ–¹æ³•æ¥è¯´ï¼Œä¸»çº¿ç¨‹çš„ç¡®æ˜¯è¢«é˜»å¡ä½äº†ï¼Œå¯¼è‡´è¯¥æ–¹æ³•ä¸€ç›´æ— æ³•å¾—åˆ°æ‰§è¡Œã€‚å¯æ˜¯å¯¹äºåº”ç”¨æ¥è¯´ï¼Œåº”ç”¨åœ¨ä¸»çº¿ç¨‹å†…çš„æ‰€æœ‰æ“ä½œå…¶å®éƒ½æ˜¯è¢«æ”¾åœ¨äº† for å¾ªç¯ä¹‹å†…ï¼Œä¸€ç›´æœ‰å¾—åˆ°æ‰§è¡Œï¼Œæ˜¯ä¸ªæ­»å¾ªç¯ä¹Ÿæ— æ‰€è°“ï¼Œæ‰€ä»¥å¯¹äºåº”ç”¨æ¥è¯´ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰è¢«é˜»å¡ï¼Œè‡ªç„¶ä¸ä¼šå¯¼è‡´ ANRã€‚æ­¤å¤–ï¼Œå½“ MessageQueue ä¸­å½“å‰æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†æ—¶ï¼Œä¹Ÿä¼šä¾é  epoll æœºåˆ¶æŒ‚èµ·ä¸»çº¿ç¨‹ï¼Œé¿å…äº†å…¶ä¸€ç›´å ç”¨ CPU èµ„æº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹æ‰§è¡Œ....</span></span><br><span class="line">    &#125;</span><br><span class="line">    doSomeThing();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åœ¨ ActivityThread çš„ main æ–¹æ³•ä¸­ï¼Œåœ¨å¼€å¯äº†æ¶ˆæ¯å¾ªç¯ä¹‹åï¼Œå¹¶æ²¡æœ‰å£°æ˜ä»€ä¹ˆæœ‰æ„ä¹‰çš„ä»£ç ã€‚æ­£å¸¸æ¥è¯´åº”ç”¨æ˜¯ä¸ä¼šé€€å‡º loop å¾ªç¯çš„ï¼Œå¦‚æœèƒ½å¤Ÿè·³å‡ºå¾ªç¯ï¼Œä¹Ÿåªä¼šå¯¼è‡´ç›´æ¥å°±æŠ›å‡ºå¼‚å¸¸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¯´ï¼Œloop å¾ªç¯æœ¬èº«ä¸ä¼šå¯¼è‡´ ANRï¼Œä¼šå‡ºç° ANR æ˜¯å› ä¸ºåœ¨ loop å¾ªç¯ä¹‹å†… Message å¤„ç†æ—¶é—´è¿‡é•¿</p>
<h2 id="12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹-Toast-å—"><a href="#12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹-Toast-å—" class="headerlink" title="12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹ Toast å—"></a>12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹ Toast å—</h2><p>ä¸ä¸€å®šï¼Œåªèƒ½è¯´æ˜¯<strong>åœ¨å­çº¿ç¨‹ä¸­æ— æ³•ç›´æ¥å¼¹å‡º Toastï¼Œä½†å¯ä»¥å®ç°</strong>ã€‚å› ä¸º Toast çš„æ„é€ å‡½æ•°ä¸­ä¼šè¦æ±‚æ‹¿åˆ°ä¸€ä¸ª Looper å¯¹è±¡ï¼Œå¦‚æœæ„é€ å‚æ•°æ²¡æœ‰ä¼ å…¥ä¸ä¸º null çš„ Looper å®ä¾‹çš„è¯ï¼Œåˆ™å°è¯•ä½¿ç”¨è°ƒç”¨è€…çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå¦‚æœéƒ½è·å–ä¸åˆ°çš„è¯åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Toast</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Toast</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> Looper looper)</span> &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mToken = <span class="keyword">new</span> <span class="title class_">Binder</span>();</span><br><span class="line">    looper = getLooper(looper);</span><br><span class="line">    mHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(looper);</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Looper <span class="title function_">getLooper</span><span class="params">(<span class="meta">@Nullable</span> Looper looper)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (looper != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> looper;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Looper.myLooper() ä¸º null çš„è¯å°±ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">return</span> checkNotNull(Looper.myLooper(),</span><br><span class="line">            <span class="string">&quot;Can&#x27;t toast on a thread that has not called Looper.prepare()&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†åœ¨å­çº¿ç¨‹å¼¹ Toastï¼Œå°±éœ€è¦ä¸»åŠ¨ä¸ºå­çº¿ç¨‹åˆ›å»º Looper å¯¹è±¡åŠå¼€å¯ loop å¾ªç¯ã€‚ä½†è¿™ç§æ–¹æ³•ä¼šå¯¼è‡´å­çº¿ç¨‹ä¸€ç›´æ— æ³•é€€å‡ºå¾ªç¯ï¼Œéœ€è¦é€šè¿‡<code>Looper.myLooper().quit()</code>æ¥ä¸»åŠ¨é€€å‡ºå¾ªç¯</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inner</span> <span class="keyword">class</span> <span class="title class_">TestThread</span> : <span class="type">Thread</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Looper.prepare()</span><br><span class="line">        Toast.makeText(</span><br><span class="line">            <span class="keyword">this</span><span class="symbol">@MainActivity</span>,</span><br><span class="line">            <span class="string">&quot;Hello: &quot;</span> + Thread.currentThread().name,</span><br><span class="line">            Toast.LENGTH_SHORT</span><br><span class="line">        ).show()</span><br><span class="line">        Looper.loop()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–°-UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ"><a href="#13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–°-UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ" class="headerlink" title="13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–° UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ"></a>13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–° UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ</h2><p>åœ¨å­çº¿ç¨‹èƒ½å¤Ÿå¼¹å‡º Toast å°±å·²ç»è¯´æ˜äº†å­çº¿ç¨‹ä¹Ÿæ˜¯å¯ä»¥æ›´æ–° UI çš„ï¼Œ<strong>Android ç³»ç»Ÿåªæ˜¯é™åˆ¶äº†å¿…é¡»åœ¨åŒä¸ªçº¿ç¨‹å†…è¿›è¡Œ ViewRootImpl çš„åˆ›å»ºå’Œæ›´æ–°è¿™ä¸¤ä¸ªæ“ä½œ</strong>ï¼Œè€Œä¸æ˜¯è¦æ±‚å¿…é¡»åœ¨ä¸»çº¿ç¨‹è¿›è¡Œ</p>
<p>å¦‚æœä½¿ç”¨ä¸å½“çš„è¯ï¼Œå³ä½¿åœ¨ä¸»çº¿ç¨‹æ›´æ–° UI ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨å´©æºƒã€‚ä¾‹å¦‚ï¼Œåœ¨å­çº¿ç¨‹å…ˆé€šè¿‡ show+hide æ¥è§¦å‘ ViewRootImpl çš„åˆ›å»ºï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹å†æ¥å°è¯•æ˜¾ç¤ºè¯¥ Dialogï¼Œæ­¤æ—¶å°±ä¼šå‘ç°ç¨‹åºç›´æ¥å´©æºƒäº†</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> alertDialog: AlertDialog</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> thread = <span class="keyword">object</span> : Thread(<span class="string">&quot;hello&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">            Looper.prepare()</span><br><span class="line">            Handler().post &#123;</span><br><span class="line">                alertDialog =</span><br><span class="line">                    AlertDialog.Builder(<span class="keyword">this</span><span class="symbol">@MainActivity</span>).setMessage(Thread.currentThread().name)</span><br><span class="line">                        .create()</span><br><span class="line">                alertDialog.show()</span><br><span class="line">                alertDialog.hide()</span><br><span class="line">            &#125;</span><br><span class="line">            Looper.loop()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        btn_test.setOnClickListener &#123;</span><br><span class="line">            alertDialog.show()</span><br><span class="line">        &#125;</span><br><span class="line">        thread.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">E/AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line">Process: github.leavesc.test, PID: <span class="number">5243</span></span><br><span class="line">android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.</span><br><span class="line">    at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:<span class="number">6892</span>)</span><br><span class="line">    at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:<span class="number">1048</span>)</span><br><span class="line">    at android.view.View.requestLayout(View.java:<span class="number">19781</span>)</span><br><span class="line">    at android.view.View.setFlags(View.java:<span class="number">11478</span>)</span><br><span class="line">    at android.view.View.setVisibility(View.java:<span class="number">8069</span>)</span><br><span class="line">    at android.app.Dialog.show(Dialog.java:<span class="number">293</span>)</span><br></pre></td></tr></table></figure>

<p>ViewRootImpl åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå°†å½“å‰çº¿ç¨‹ä¿å­˜åˆ° mThreadï¼Œåœ¨åç»­è¿›è¡Œ UI æ›´æ–°çš„æ—¶å€™å°±ä¼šè°ƒç”¨<code>checkThread()</code>æ–¹æ³•è¿›è¡Œçº¿ç¨‹æ£€æŸ¥ï¼Œå¦‚æœå‘ç°å­˜åœ¨å¤šçº¿ç¨‹è°ƒç”¨åˆ™ç›´æ¥æŠ›å‡ºä»¥ä¸Šçš„å¼‚å¸¸ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title class_">ViewParent</span>,</span><br><span class="line">        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks &#123;</span><br><span class="line">            </span><br><span class="line">     <span class="keyword">final</span> Thread mThread;       </span><br><span class="line">            </span><br><span class="line">     <span class="keyword">public</span> <span class="title function_">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> useSfChoreographer)</span> &#123;</span><br><span class="line">        mThread = Thread.currentThread();</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">    &#125;       </span><br><span class="line">            </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">checkThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CalledFromWrongThreadException</span>(</span><br><span class="line">                    <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="14ã€ä¸ºä»€ä¹ˆ-UI-ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹"><a href="#14ã€ä¸ºä»€ä¹ˆ-UI-ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹" class="headerlink" title="14ã€ä¸ºä»€ä¹ˆ UI ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹"></a>14ã€ä¸ºä»€ä¹ˆ UI ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹</h2><p>å…¶å®è¿™å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä¸ºäº†æé«˜è¿è¡Œæ•ˆç‡å’Œé™ä½å®ç°éš¾åº¦ã€‚å¦‚æœå…è®¸å¤šçº¿ç¨‹å¹¶å‘è®¿é—® UI çš„è¯ï¼Œä¸ºäº†é¿å…ç«æ€ï¼Œå¾ˆå¤šå³ä½¿åªæ˜¯å°èŒƒå›´çš„å±€éƒ¨åˆ·æ–°æ“ä½œï¼ˆä¾‹å¦‚ï¼ŒTextView.setTextï¼‰éƒ½åŠ¿å¿…éœ€è¦åŠ ä¸ŠåŒæ­¥é”ï¼Œè¿™æ— ç–‘ä¼šåŠ å¤§ UI åˆ·æ–°æ“ä½œçš„â€œæˆæœ¬â€ï¼Œé™ä½äº†æ•´ä¸ªåº”ç”¨çš„è¿è¡Œæ•ˆç‡ã€‚è€Œä¸”ä¼šå¯¼è‡´ Android çš„ UI ä½“ç³»åœ¨å®ç°æ—¶å°±è¢«è¿«éœ€è¦å¯¹å¤šçº¿ç¨‹ç¯å¢ƒè¿›è¡Œâ€œé˜²å¾¡â€ï¼Œå³ä½¿å¼€å‘è€…ä¸€ç›´æ˜¯ä½¿ç”¨åŒä¸ªçº¿ç¨‹æ¥æ›´æ–° UIï¼Œè¿™å°±åŠ å¤§äº†ç³»ç»Ÿçš„å®ç°éš¾åº¦</p>
<p>æ‰€ä»¥ï¼Œæœ€ä¸ºç®€å•é«˜æ•ˆçš„æ–¹å¼å°±æ˜¯é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹æ¥è®¿é—® UI</p>
<h2 id="15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡"><a href="#15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡" class="headerlink" title="15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡"></a>15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œéœ€è¦åšå¾ˆå¤šçº¿ç¨‹åŒæ­¥æ“ä½œã€‚è€Œä¾é  Looper çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æ¯”è¾ƒç®€å•çš„æ–¹å¼æ¥å®ç°è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡</p>
<p>çœ‹ä»¥ä¸‹ä»£ç ï¼Œä» TestThread è¿è¡Œåå¼¹å‡ºçš„çº¿ç¨‹åå¯ä»¥çŸ¥é“ï¼Œ Toast æ˜¯åœ¨ Thread_1 è¢«å¼¹å‡ºæ¥çš„ã€‚å¦‚æœå°† Thread_2 æƒ³åƒæˆä¸»çº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆä»¥ä¸‹ä»£ç å°±ç›¸å½“äºä»ä¸»çº¿ç¨‹å‘å­çº¿ç¨‹ä¸‹å‘è€—æ—¶ä»»åŠ¡äº†ï¼Œè¿™ä¸ªå®ç°æ€è·¯å°±ç›¸å½“äº Android æä¾›çš„ HandlerThread ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">inner <span class="keyword">class</span> <span class="title class_">TestThread</span> : Thread(<span class="string">&quot;Thread_1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        Looper.prepare()</span><br><span class="line">        <span class="type">val</span> <span class="variable">looper</span> <span class="operator">=</span> Looper.myLooper()</span><br><span class="line">        object : Thread(<span class="string">&quot;Thread_2&quot;</span>) &#123;</span><br><span class="line">            override fun <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">val</span> <span class="variable">handler</span> <span class="operator">=</span> Handler(looper!!)</span><br><span class="line">                handler.post &#123;</span><br><span class="line">                    <span class="comment">//è¾“å‡ºç»“æœæ˜¯ï¼šThread_1</span></span><br><span class="line">                    Toast.makeText(</span><br><span class="line">                        <span class="built_in">this</span><span class="meta">@MainActivity</span>,</span><br><span class="line">                        Thread.currentThread().name,</span><br><span class="line">                        Toast.LENGTH_SHORT</span><br><span class="line">                    ).show()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start()</span><br><span class="line">        Looper.loop()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹"><a href="#16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹" class="headerlink" title="16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹"></a>16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹</h2><p>é€šè¿‡ Looper æ¥åˆ¤æ–­</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</span><br><span class="line">    <span class="comment">//æ˜¯ä¸»çº¿ç¨‹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Looper.getMainLooper().isCurrentThread)&#123;</span><br><span class="line">    <span class="comment">//æ˜¯ä¸»çº¿ç¨‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸"><a href="#17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸" class="headerlink" title="17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸"></a>17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸</h2><p>æ¯”è¾ƒå§æ§½çš„ä¸€ä¸ªåšæ³•å°±æ˜¯<strong>é€šè¿‡åµŒå¥— Loop å¾ªç¯æ¥å®ç°</strong>ã€‚å‘ä¸»çº¿ç¨‹ Loop å‘é€ ä¸€ä¸ª Runnableï¼Œåœ¨ Runnable é‡Œæ­»å¾ªç¯æ‰§è¡Œ Loop å¾ªç¯ï¼Œè¿™å°±ä¼šä½¿å¾—ä¸»çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè¢«äº¤ç”±è¯¥ Runnable æ¥è°ƒç”¨ï¼Œåªè¦åŠ ä¸Š try catch åå°±å¯ä»¥æ•è·ä¸»çº¿ç¨‹çš„ä»»æ„å¼‚å¸¸äº†ï¼Œåšåˆ°<strong>ä¸»çº¿ç¨‹æ°¸ä¸å´©æºƒ</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Handler(Looper.getMainLooper()).post &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Looper.loop()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">            throwable.printStackTrace()</span><br><span class="line">            Log.e(<span class="string">&quot;TAG&quot;</span>, throwable.message ?: <span class="string">&quot;&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </article>
  <!-- tag -->
  <div class="mt-12 pt-6 border-t border-gray-200">
    
  </div>
  <!-- prev and next -->
  <div class="flex justify-between mt-12 pt-6 border-t border-gray-200">
    <div>
      
        <a href="/hexo-blog/public/2025/03/02/md/kotlin/%E4%B8%80%E6%96%87%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20RxJava%202/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          <iconify-icon width="20" icon="ri:arrow-left-s-line" data-inline="false"></iconify-icon>
          ä¸€æ–‡å¿«é€Ÿå…¥é—¨ RxJava 2
        </a>
      
    </div>
    <div>
      
        <a href="/hexo-blog/public/2025/03/02/md/kotlin/%E4%B8%A4%E4%B8%87%E5%85%AD%E5%8D%83%E5%AD%97%E5%B8%A6%E4%BD%A0%20Kotlin%20%E5%85%A5%E9%97%A8/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          ä¸¤ä¸‡å…­åƒå­—å¸¦ä½  Kotlin å…¥é—¨
          <iconify-icon width="20" icon="ri:arrow-right-s-line" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>
  <!-- comment -->
  <div class="article-comments mt-12">
    
<script
  src="https://giscus.app/client.js"
  data-repo="hqqich/giscus"
  data-repo-id="R_kgDOOCZUBA"
  data-category="General"
  data-category-id="DIC_kwDOOCZUBM4Cng1l"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="preferred_color_scheme"
  data-lang="zh-CN"
  crossorigin="anonymous"
  async
></script>
<script>
  window.onload = function () {
    console.log("giscus loaded");
    const isDark = document.documentElement.classList.contains("dark");
    const giscusFrame = document.querySelector("iframe.giscus-frame");
    giscusFrame.contentWindow.postMessage(
      {
        giscus: {
          setConfig: {
            theme: isDark ? "dark" : "light",
          },
        },
      },
      "https://giscus.app"
    );
  };
</script>


  </div>
</section>
<!-- js inspect -->

<script src="/hexo-blog/public/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/hexo-blog/public/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + alt + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/hexo-blog/public/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->


  </main>
  <footer class="flex flex-col h-40 items-center justify-center text-gray-400 text-sm">
  <!-- busuanzi -->
  
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex items-center gap-2">
  <span>Visitors</span>
  <span id="busuanzi_value_site_uv"></span>
  <span>Page Views</span>
  <span id="busuanzi_value_site_pv"></span>
</div>
<!-- End Busuanzi Analytics -->


  <!-- copyright -->
  <div class="flex items-center gap-2">
    <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: inherit;">CC BY-NC-SA 4.0</a>
    <span>Â© 2022</span>
    <iconify-icon width="18" icon="emojione-monotone:maple-leaf" ></iconify-icon>
    <a href="https://github.com/xbmlz" target="_blank" rel="noopener noreferrer">xbmlz</a>
  </div>
  <!-- powered by -->
  <div class="flex items-center gap-2">
    <span>Powered by</span>
    <a href="https://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a>
    <span>&</span>
    <a href="https://github.com/xbmlz/hexo-theme-maple" target="_blank" rel="noopener noreferrer">Maple</a>
  </div>

</footer>

  <div class="back-to-top box-border fixed right-6 z-1024 -bottom-20 rounded py-1 px-1 bg-slate-900 opacity-60 text-white cursor-pointer text-center dark:bg-slate-600">
    <span class="flex justify-center items-center text-sm">
      <iconify-icon width="18" icon="ion:arrow-up-c" id="go-top"></iconify-icon>
      <span id="scrollpercent"><span>0</span> %</span>
    </span>
  </div>
  
<script src="/hexo-blog/public/js/main.js"></script>


  <script>
    $(document).ready(function () {
      const mapleCount = "10";
      const speed = "0.5";
      const mapleEl = document.getElementById("maple");
      const maples = Array.from({ length: mapleCount }).map(() => {
        const maple = document.createElement("div");
        const scale = Math.random() * 0.5 + 0.5;
        const offset = Math.random() * 2 - 1;
        const x = Math.random() * mapleEl.clientWidth;
        const y = -Math.random() * mapleEl.clientHeight;
        const duration = 10 / speed;
        const delay = -duration;
        maple.className = "maple";
        maple.style.width = `${24 * scale}px`;
        maple.style.height = `${24 * scale}px`;
        maple.style.left = `${x}px`;
        maple.style.top = `${y}px`;
        maple.style.setProperty("--maple-fall-offset", offset);
        maple.style.setProperty("--maple-fall-height", `${Math.abs(y) + mapleEl.clientHeight}px`);
        maple.style.animation = `fall ${duration}s linear infinite`;
        maple.style.animationDelay = `${delay}s`;
        mapleEl.appendChild(maple)
        return maple
      })
    });
  </script>
  


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
