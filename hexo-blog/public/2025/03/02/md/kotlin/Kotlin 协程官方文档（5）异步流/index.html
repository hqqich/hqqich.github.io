<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHXM4GYP5W"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-EHXM4GYP5W');
</script>
<!-- End Google Analytics -->



<!-- Baidu Analytics -->
<script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0a6515fb9c839d6a56d4cfd8b7d243d4";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>
<!-- End Baidu Analytics -->


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="hqqich">


  <meta name="subtitle" content="å¿™ç¢ŒæŠŠæ—¶å…‰ç¼©çŸ­, è‹¦éš¾æŠŠå²æœˆæ‹‰é•¿">




<title>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ | Hexo-blog</title>



<link rel="icon" href="/hexo-blog/public/favicon.ico">



<link rel="stylesheet" href="/hexo-blog/public/css/main.css">


<link rel="stylesheet" href="/hexo-blog/public/lib/nprogress/nprogress.css">



<script src="/hexo-blog/public/lib/jquery.min.js"></script>


<script src="/hexo-blog/public/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>


<script src="/hexo-blog/public/lib/nprogress/nprogress.js"></script>

<script>
  $(document).ready(() => {
    NProgress.configure({
      showSpinner: false,
    });
    NProgress.start();
    $("#nprogress .bar").css({
      background: "#de7441",
    });
    $("#nprogress .peg").css({
      "box-shadow": "0 0 2px #de7441, 0 0 4px #de7441",
    });
    $("#nprogress .spinner-icon").css({
      "border-top-color": "#de7441",
      "border-left-color": "#de7441",
    });
    setTimeout(function () {
      NProgress.done();
      $(".fade").removeClass("out");
    }, 800);
  });
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }

    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ri:moon-line" : "ri:sun-line"
          );
          toggleGiscusTheme();
        }
      });

    $("#toggle-dark").click((event) => {
      const isAppearanceTransition = document.startViewTransition && !window.matchMedia('(prefers-reduced-motion: reduce)').matches
      if (!isAppearanceTransition) {
        toggleDark()
        return
      }
      const x = event.clientX
      const y = event.clientY
      const endRadius = Math.hypot(
        Math.max(x, innerWidth - x),
        Math.max(y, innerHeight - y),
      )
      const transition = document.startViewTransition(async () => {
        toggleDark()
      })

      transition.ready
        .then(() => {
          const isDark = document.documentElement.classList.contains("dark")
          const clipPath = [
            `circle(0px at ${x}px ${y}px)`,
            `circle(${endRadius}px at ${x}px ${y}px)`,
          ]
          document.documentElement.animate(
            {
              clipPath: isDark
                ? [...clipPath].reverse()
                : clipPath,
            },
            {
              duration: 400,
              easing: 'ease-out',
              pseudoElement: isDark
                ? '::view-transition-old(root)'
                : '::view-transition-new(root)',
            },
          )
        })
    });
  });
</script>




<meta name="generator" content="Hexo 7.3.0"></head>
<body class="font-sans bg-white dark:bg-zinc-900 text-gray-700 dark:text-gray-200 relative">
  <header class="fixed w-full px-5 py-1 z-10 backdrop-blur-xl backdrop-saturate-150 border-b border-black/5">
  <div class="max-auto">
    <nav class="flex items-center text-base">
      <a href="/hexo-blog/public/" class="group">
        <h2 class="font-medium tracking-tighterp text-l p-2">
          <img class="w-5 mr-2 inline-block transition-transform group-hover:rotate-[30deg]" id="logo" src="https://moe-counter-vercel-gamma.vercel.app/a?theme=rule34" alt="Hexo-blog" />
          Hexo-blog
        </h2>
      </a>
      <div id="header-title" class="opacity-0 md:ml-2 md:mt-[0.1rem] text-xs font-medium whitespace-nowrap overflow-hidden overflow-ellipsis">
        Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        
          <a class="hidden sm:flex" href="/hexo-blog/public/archives">Posts</a>
        
          <a class="hidden sm:flex" href="/hexo-blog/public/category">Categories</a>
        
          <a class="hidden sm:flex" href="/hexo-blog/public/tag">Tags</a>
        
        
          
            <a class="w-5 h-5 hidden sm:flex" title="Github" target="_blank" rel="noopener" href="https://github.com/hqqich">
              <iconify-icon width="20" icon="ri:github-line"></iconify-icon>
            </a>
          
        
        <a class="w-5 h-5 hidden sm:flex" title="Github" href="rss2.xml">
          <iconify-icon width="20" icon="ri:rss-line"></iconify-icon>
        </a>
        <a class="w-5 h-5" title="toggle theme" id="toggle-dark">
          <iconify-icon width="20" icon="" id="theme-icon"></iconify-icon>
        </a>
      </div>
      <div class="flex items-center justify-center gap-3 ml-3 sm:hidden">
        <span class="w-5 h-5" aria-hidden="true" role="img" id="open-menu">
          <iconify-icon width="20" icon="carbon:menu" ></iconify-icon>
        </span>
        <span class="w-5 h-5 hidden" aria-hidden="true" role="img" id="close-menu">
          <iconify-icon  width="20" icon="carbon:close" ></iconify-icon>
        </span>
      </div>
    </nav>
  </div>
</header>
<div id="menu-panel" class="h-0 overflow-hidden sm:hidden fixed left-0 right-0 top-12 bottom-0 z-10">
  <div id="menu-content" class="relative z-20 bg-white/80 px-6 sm:px-8 py-2 backdrop-blur-xl -translate-y-full transition-transform duration-300">
    <ul class="nav flex flex-col sm:flex-row text-sm font-medium">
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/archives" class="flex h-12 sm:h-auto items-center">Posts</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/category" class="flex h-12 sm:h-auto items-center">Categories</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/hexo-blog/public/tag" class="flex h-12 sm:h-auto items-center">Tags</a>
        </li>
      
    </ul>
  </div>
  <div class="mask bg-black/20 absolute inset-0"></div>
</div>

  <main class="pt-14">
    <!-- css -->

<link rel="stylesheet" href="/hexo-blog/public/lib/fancybox/fancybox.min.css">


<link rel="stylesheet" href="/hexo-blog/public/lib/tocbot/tocbot.min.css">

<!-- toc -->

  <!-- tocbot -->
<nav class="post-toc toc text-sm w-48 relative top-32 right-0 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- header -->
  <header class="overflow-hidden pt-6 pb-6 md:pt-12">
    <div class="pt-4 md:pt-6">
      <h1 id="article-title" class="text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
        Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ
      </h1>
      <div>
        <section class="flex items-center gap-3 text-sm">
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="carbon-calendar" ></iconify-icon>
            <time>2025-03-02</time>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="ic:round-access-alarm" ></iconify-icon>
            <span>37 min</span>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="icon-park-outline:font-search" ></iconify-icon>
            <span>8.4k words</span>
          </span>
          
            <span class="text-gray-400">Â·</span>
            <span class="flex items-center gap-1">
              <iconify-icon width="16" icon="icon-park-outline:box" class="mr-2"></iconify-icon>
              <a class="article-category-link" href="/hexo-blog/public/categories/kotlin/">kotlin</a>
            </span>
          
        </section>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto slide-enter-content dark:prose-invert">
    <blockquote>
<p>å…¬ä¼—å·ï¼š<a target="_blank" rel="noopener" href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image">å­—èŠ‚æ•°ç»„</a></p>
<p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p>
</blockquote>
<blockquote>
<p>æœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº <strong>Kotlinåç¨‹</strong> çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§</p>
<p>åç¨‹å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md">coroutines-guide</a></p>
</blockquote>
<p>æŒ‚èµ·å‡½æ•°å¯ä»¥å¼‚æ­¥è¿”å›å•ä¸ªå€¼ï¼Œä½†å¦‚ä½•è¿”å›å¤šä¸ªå¼‚æ­¥è®¡ç®—å€¼å‘¢ï¼Ÿè¿™å°±æ˜¯ kotlin Flowsï¼ˆæµï¼‰ çš„ç”¨å¤„äº†</p>
<h1 id="ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼"><a href="#ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼" class="headerlink" title="ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼"></a>ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼</h1><p>å¯ä»¥ä½¿ç”¨é›†åˆåœ¨ kotlin ä¸­è¡¨ç¤ºå¤šä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªå‡½æ•° foo()ï¼Œå®ƒè¿”å›åŒ…å«ä¸‰ä¸ªæ•°å­—çš„ Listï¼Œç„¶åä½¿ç”¨ forEach æ‰“å°å®ƒä»¬</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: List&lt;<span class="built_in">Int</span>&gt; = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    foo().forEach &#123; value -&gt; println(value) &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>

<h2 id="1-1ã€åºåˆ—"><a href="#1-1ã€åºåˆ—" class="headerlink" title="1.1ã€åºåˆ—"></a>1.1ã€åºåˆ—</h2><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€äº› CPU æ¶ˆè€—å‹ çš„é˜»å¡ä»£ç ï¼ˆæ¯æ¬¡è®¡ç®—éœ€è¦100æ¯«ç§’ï¼‰æ¥è®¡ç®—æ•°å­—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåºåˆ—(Sequence)æ¥è¡¨ç¤ºæ•°å­—ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Sequence&lt;<span class="built_in">Int</span>&gt; = sequence &#123;</span><br><span class="line">    <span class="comment">// sequence builder</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>) <span class="comment">// pretend we are computing it</span></span><br><span class="line">        yield(i) <span class="comment">// yield next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    foo().forEach &#123; value -&gt; println(value) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç è¾“å‡ºç›¸åŒçš„æ•°å­—åˆ—è¡¨ï¼Œä½†æ¯æ‰“å°ä¸€ä¸ªæ•°å­—å‰éƒ½éœ€è¦ç­‰å¾…100æ¯«ç§’</p>
<h2 id="1-2ã€æŒ‚èµ·å‡½æ•°"><a href="#1-2ã€æŒ‚èµ·å‡½æ•°" class="headerlink" title="1.2ã€æŒ‚èµ·å‡½æ•°"></a>1.2ã€æŒ‚èµ·å‡½æ•°</h2><p>ä¸Šä¸€èŠ‚çš„ä»£ç çš„è®¡ç®—æ“ä½œä¼šé˜»å¡è¿è¡Œä»£ç çš„ä¸»çº¿ç¨‹ã€‚å½“è¿™äº›å€¼ç”±å¼‚æ­¥ä»£ç è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ suspend ä¿®é¥°ç¬¦æ ‡è®°å‡½æ•° fooï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨ä¸é˜»å¡çš„æƒ…å†µä¸‹æ‰§è¡Œå…¶å·¥ä½œï¼Œå¹¶å°†ç»“æœä½œä¸ºåˆ—è¡¨è¿”å›</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*                 </span><br><span class="line">                           </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: List&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    delay(<span class="number">1000</span>) <span class="comment">// pretend we are doing something asynchronous here</span></span><br><span class="line">    <span class="keyword">return</span> listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    foo().forEach &#123; value -&gt; println(value) &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç åœ¨ç­‰å¾…ä¸€ç§’åè¾“å‡ºæ•°å­—</p>
<h2 id="1-3ã€Flows"><a href="#1-3ã€Flows" class="headerlink" title="1.3ã€Flows"></a>1.3ã€Flows</h2><p>ä½¿ç”¨ List&lt; Int &gt; ä½œä¸ºè¿”å›å€¼ç±»å‹ï¼Œæ„å‘³ç€æˆ‘ä»¬åªèƒ½åŒæ—¶è¿”å›æ‰€æœ‰å€¼ã€‚ä¸ºäº†è¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„å€¼æµï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Flow&lt; Int &gt; ç±»å‹ï¼Œå°±åƒåŒæ­¥è®¡ç®—å€¼çš„ Sequence&lt; Int &gt; ç±»å‹ä¸€æ ·</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123; <span class="comment">// flow builder</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// pretend we are doing something useful here</span></span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// Launch a concurrent coroutine to check if the main thread is blocked</span></span><br><span class="line">    launch &#123;</span><br><span class="line">        <span class="keyword">for</span> (k <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">            println(<span class="string">&quot;I&#x27;m not blocked <span class="variable">$k</span>&quot;</span>)</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Collect the flow</span></span><br><span class="line">    foo().collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>æ­¤ä»£ç åœ¨æ‰“å°æ¯ä¸ªæ•°å­—å‰ç­‰å¾…100æ¯«ç§’ï¼Œä½†ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚é€šè¿‡ä»ä¸»çº¿ç¨‹ä¸­è¿è¡Œçš„å•ç‹¬åç¨‹ä¸­æ¯éš”100æ¯«ç§’æ‰“å°äº†ä¸€æ¬¡ â€œIâ€™m not blockedâ€ï¼Œå¯ä»¥éªŒè¯è¿™ä¸€ç‚¹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">I<span class="string">&#x27;m not blocked 1</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string">I&#x27;</span>m not blocked <span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">I<span class="string">&#x27;m not blocked 3</span></span><br><span class="line"><span class="string">3</span></span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œä»£ç ä¸å‰é¢ç¤ºä¾‹ä¸­çš„ Flow æœ‰ä»¥ä¸‹ä¸åŒï¼š</p>
<ul>
<li>Flow ç±»å‹çš„æ„é€ å™¨å‡½æ•°åä¸º flow</li>
<li>flow{â€¦} ä¸­çš„ä»£ç å—å¯ä»¥æŒ‚èµ·</li>
<li>foo å‡½æ•°ä¸å†æ ‡è®° suspend ä¿®é¥°ç¬¦</li>
<li>å€¼é€šè¿‡ emit å‡½æ•°ä»æµä¸­å‘å‡º</li>
<li>é€šè¿‡ collect å‡½æ•°ä» flow ä¸­å–å€¼</li>
</ul>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ Thread.sleep æ¥ä»£æ›¿ flow{â€¦} ä¸­çš„ delayï¼Œå¯ä»¥çœ‹åˆ°åœ¨è¿™ç§æƒ…å†µä¸‹ä¸»çº¿ç¨‹è¢«é˜»å¡ä½äº†</p>
</blockquote>
<h1 id="äºŒã€æµæ˜¯å†·çš„"><a href="#äºŒã€æµæ˜¯å†·çš„" class="headerlink" title="äºŒã€æµæ˜¯å†·çš„"></a>äºŒã€æµæ˜¯å†·çš„</h1><p>Flows æ˜¯å†·æµï¼ˆcold streamsï¼‰ï¼Œç±»ä¼¼äºåºåˆ—ï¼ˆsequencesï¼‰ï¼Œflow builder ä¸­çš„ä»£ç åœ¨å¼€å§‹æ”¶é›†æµå€¼ä¹‹å‰ä¸ä¼šè¿è¡Œã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart      </span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123; </span><br><span class="line">    println(<span class="string">&quot;Flow started&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    println(<span class="string">&quot;Calling foo...&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> flow = foo()</span><br><span class="line">    println(<span class="string">&quot;Calling collect...&quot;</span>)</span><br><span class="line">    flow.collect &#123; value -&gt; println(value) &#125; </span><br><span class="line">    println(<span class="string">&quot;Calling collect again...&quot;</span>)</span><br><span class="line">    flow.collect &#123; value -&gt; println(value) &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Calling foo...</span><br><span class="line">Calling collect...</span><br><span class="line">Flow started</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Calling collect again...</span><br><span class="line">Flow started</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ foo() å‡½æ•°ï¼ˆè¿”å›äº† flowï¼‰æœªæ ‡è®° <code>suspend</code> ä¿®é¥°ç¬¦çš„ä¸€ä¸ªå…³é”®åŸå› ã€‚<code>foo()</code> æœ¬èº«è¿”å›å¾ˆå¿«ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•ç­‰å¾…ã€‚flow æ¯æ¬¡æ”¶é›†æ—¶éƒ½ä¼šå¯åŠ¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å†æ¬¡è°ƒç”¨ <code>collect</code> æ—¶ä¼šçœ‹åˆ°â€œflow startedâ€çš„åŸå› </p>
<h1 id="ä¸‰ã€å–æ¶ˆæµ"><a href="#ä¸‰ã€å–æ¶ˆæµ" class="headerlink" title="ä¸‰ã€å–æ¶ˆæµ"></a>ä¸‰ã€å–æ¶ˆæµ</h1><p>Flow é‡‡ç”¨å’Œåç¨‹å–åŒæ ·çš„åä½œå–æ¶ˆã€‚ä½†æ˜¯ï¼ŒFlow å®ç°åŸºç¡€å¹¶æ²¡æœ‰å¼•å…¥é¢å¤–çš„å–æ¶ˆç‚¹ï¼Œå®ƒå¯¹äºå–æ¶ˆæ“ä½œæ˜¯å®Œå…¨é€æ˜çš„ã€‚é€šå¸¸ï¼Œæµçš„æ”¶é›†æ“ä½œå¯ä»¥åœ¨å½“æµåœ¨ä¸€ä¸ªå¯å–æ¶ˆçš„æŒ‚èµ·å‡½æ•°ï¼ˆå¦‚ delayï¼‰ä¸­æŒ‚èµ·çš„æ—¶å€™å–æ¶ˆï¼Œå¦åˆ™ä¸èƒ½å–æ¶ˆ</p>
<p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†åœ¨ withTimeoutOrNull å—ä¸­æµå¦‚ä½•åœ¨è¶…æ—¶æ—¶è¢«å–æ¶ˆå¹¶åœæ­¢æ‰§è¡Œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>)</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    withTimeoutOrNull(<span class="number">250</span>) &#123;</span><br><span class="line">        <span class="comment">// Timeout after 250ms</span></span><br><span class="line">        foo().collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œfoo() å‡½æ•°ä¸­çš„ Flow åªä¼ å‡ºä¸¤ä¸ªæ•°å­—ï¼Œå¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Emitting <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Emitting <span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<p>ç›¸å¯¹åº”çš„ï¼Œå¯ä»¥æ³¨é‡Šæ‰ flow ä¸­çš„ delay å‡½æ•°ï¼Œå¹¶å¢å¤§ for å¾ªç¯çš„å¾ªç¯èŒƒå›´ï¼Œæ­¤æ—¶å¯ä»¥å‘ç° flow æ²¡æœ‰è¢«å–æ¶ˆï¼Œå› ä¸º flow ä¸­æ²¡æœ‰å¼•å…¥é¢å¤–çš„æŒ‚èµ·ç‚¹</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span>.<span class="built_in">Int</span>.MAX_VALUE) &#123;</span><br><span class="line"><span class="comment">//        delay(100)</span></span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    withTimeoutOrNull(<span class="number">250</span>) &#123;</span><br><span class="line">        <span class="comment">// Timeout after 250ms</span></span><br><span class="line">        foo().collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<h1 id="å››ã€æµæ„å»ºå™¨"><a href="#å››ã€æµæ„å»ºå™¨" class="headerlink" title="å››ã€æµæ„å»ºå™¨"></a>å››ã€æµæ„å»ºå™¨</h1><p>å‰é¢ä¾‹å­ä¸­çš„ flow{â€¦} æ˜¯æœ€åŸºç¡€çš„ä¸€ä¸ªæµæ„å»ºå™¨ï¼Œè¿˜æœ‰å…¶å®ƒçš„æ„å»ºå™¨å¯ä»¥æ›´å®¹æ˜“åœ°å£°æ˜æµï¼š</p>
<ul>
<li>flowOf() å®šä¹‰äº†ä¸€ä¸ªå‘å‡ºå›ºå®šå€¼é›†çš„æµæ„å»ºå™¨</li>
<li>å¯ä»¥ä½¿ç”¨æ‰©å±•å‡½æ•° <code>.asFlow()</code> å°†å„ç§é›†åˆå’Œåºåˆ—è½¬æ¢ä¸ºæµ</li>
</ul>
<p>å› æ­¤ï¼Œä»æµä¸­æ‰“å°ä» 1 åˆ° 3 çš„æ•°å­—çš„ä¾‹å­å¯ä»¥æ”¹å†™æˆï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//sampleStart</span></span><br><span class="line">    <span class="comment">// Convert an integer range to a flow</span></span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow().collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">    <span class="comment">//sampleEnd</span></span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<h1 id="äº”ã€ä¸­é—´æµè¿ç®—ç¬¦"><a href="#äº”ã€ä¸­é—´æµè¿ç®—ç¬¦" class="headerlink" title="äº”ã€ä¸­é—´æµè¿ç®—ç¬¦"></a>äº”ã€ä¸­é—´æµè¿ç®—ç¬¦</h1><p>å¯ä»¥ä½¿ç”¨è¿ç®—ç¬¦æ¥è½¬æ¢æµï¼Œå°±åƒä½¿ç”¨é›†åˆå’Œåºåˆ—ä¸€æ ·ã€‚ä¸­é—´è¿ç®—ç¬¦åº”ç”¨äºä¸Šæ¸¸æµå¹¶è¿”å›ä¸‹æ¸¸æµã€‚è¿™äº›è¿ç®—ç¬¦æ˜¯å†·æ“ä½œç¬¦ï¼Œå’Œæµä¸€æ ·ã€‚æ­¤ç±»è¿ç®—ç¬¦æœ¬èº«ä¸æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œå®ƒå·¥ä½œå¾—å¾ˆå¿«ï¼Œå…¶è¿”å›ä¸€ä¸ªæ–°çš„è½¬æ¢åçš„æµï¼Œä½†å¼•ç”¨ä»…åŒ…å«å¯¹æ–°æµçš„æ“ä½œå®šä¹‰ï¼Œå¹¶ä¸é©¬ä¸Šè¿›è¡Œè½¬æ¢</p>
<p>åŸºç¡€è¿ç®—ç¬¦æœ‰ç€ç†Ÿæ‚‰çš„åç§°ï¼Œä¾‹å¦‚ map å’Œ filterã€‚æµè¿ç®—ç¬¦å’Œåºåˆ—çš„é‡è¦åŒºåˆ«åœ¨äºæµè¿ç®—ç¬¦ä¸­çš„ä»£ç å¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°</p>
<p>ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ map è¿ç®—ç¬¦å°†ä¼ å…¥è¯·æ±‚æµæ˜ å°„ä¸ºç»“æœå€¼ï¼Œå³ä½¿æ‰§è¡Œè¯·æ±‚æ˜¯ç”±æŒ‚èµ·å‡½æ•°å®ç°çš„é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">performRequest</span><span class="params">(request: <span class="type">Int</span>)</span></span>: String &#123;</span><br><span class="line">    delay(<span class="number">1000</span>) <span class="comment">// imitate long-running asynchronous work</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;response <span class="variable">$request</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow() <span class="comment">// a flow of requests</span></span><br><span class="line">        .map &#123; request -&gt; performRequest(request) &#125;</span><br><span class="line">        .collect &#123; response -&gt; println(response) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœå…±æœ‰ä¸‰è¡Œï¼Œæ¯ä¸€ç§’æ‰“å°ä¸€è¡Œè¾“å‡º</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response <span class="number">1</span></span><br><span class="line">response <span class="number">2</span></span><br><span class="line">response <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h2 id="5-1ã€è½¬æ¢æ“ä½œç¬¦"><a href="#5-1ã€è½¬æ¢æ“ä½œç¬¦" class="headerlink" title="5.1ã€è½¬æ¢æ“ä½œç¬¦"></a>5.1ã€è½¬æ¢æ“ä½œç¬¦</h2><p>åœ¨æµçš„è½¬æ¢è¿ç®—ç¬¦ä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¸€ä¸ªç§°ä¸º <code>transform</code>ã€‚å®ƒå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿç®€å•çš„æ•°æ®è½¬æ¢ï¼ˆå°±åƒ map å’Œ filterï¼‰ï¼Œä»¥åŠå®ç°æ›´å¤æ‚çš„è½¬æ¢ã€‚ä½¿ç”¨ <code>transform</code> è¿ç®—ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥å‘å‡ºä»»æ„æ¬¡æ•°çš„ä»»æ„å€¼</p>
<p>ä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨ <code>transform</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥è¯·æ±‚ä¹‹å‰å‘å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨è¯¥å­—ç¬¦ä¸²åé¢è·Ÿéšä¸€ä¸ªå“åº”ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">performRequest</span><span class="params">(request: <span class="type">Int</span>)</span></span>: String &#123;</span><br><span class="line">    delay(<span class="number">1000</span>) <span class="comment">// imitate long-running asynchronous work</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;response <span class="variable">$request</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//sampleStart</span></span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow() <span class="comment">// a flow of requests</span></span><br><span class="line">        .transform &#123; request -&gt;</span><br><span class="line">            emit(<span class="string">&quot;Making request <span class="variable">$request</span>&quot;</span>)</span><br><span class="line">            emit(performRequest(request))</span><br><span class="line">        &#125;</span><br><span class="line">        .collect &#123; response -&gt; println(response) &#125;</span><br><span class="line">    <span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå€¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Making request <span class="number">1</span></span><br><span class="line">response <span class="number">1</span></span><br><span class="line">Making request <span class="number">2</span></span><br><span class="line">response <span class="number">2</span></span><br><span class="line">Making request <span class="number">3</span></span><br><span class="line">response <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2ã€é™é•¿è¿ç®—ç¬¦"><a href="#5-2ã€é™é•¿è¿ç®—ç¬¦" class="headerlink" title="5.2ã€é™é•¿è¿ç®—ç¬¦"></a>5.2ã€é™é•¿è¿ç®—ç¬¦</h2><p>é™é•¿ä¸­é—´è¿ç®—ç¬¦åœ¨è¾¾åˆ°ç›¸åº”é™åˆ¶æ—¶å–æ¶ˆæµçš„æ‰§è¡Œã€‚åç¨‹ä¸­çš„å–æ¶ˆæ€»æ˜¯é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥å®ç°ï¼Œè¿™æ ·æ‰€æœ‰çš„èµ„æºç®¡ç†å‡½æ•°ï¼ˆä¾‹å¦‚ try { â€¦ } finally { â€¦ } ï¼‰å°±å¯ä»¥åœ¨å–æ¶ˆæ—¶æ­£å¸¸æ‰§è¡Œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">numbers</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        emit(<span class="number">1</span>)</span><br><span class="line">        emit(<span class="number">2</span>)</span><br><span class="line">        println(<span class="string">&quot;This line will not execute&quot;</span>)</span><br><span class="line">        emit(<span class="number">3</span>)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Finally in numbers&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    numbers()</span><br><span class="line">        .take(<span class="number">2</span>) <span class="comment">// take only the first two</span></span><br><span class="line">        .collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç çš„è¾“å‡ºæ¸…æ¥šåœ°æ˜¾ç¤ºäº† numbers() å‡½æ•°ä¸­çš„ flow{â€¦} å‡½æ•°ä½“åœ¨å‘å‡ºç¬¬äºŒä¸ªæ•°å­—åå°±åœæ­¢äº†ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Finally <span class="keyword">in</span> numbers</span><br></pre></td></tr></table></figure>

<h1 id="å…­ã€æµè¿ç®—ç¬¦"><a href="#å…­ã€æµè¿ç®—ç¬¦" class="headerlink" title="å…­ã€æµè¿ç®—ç¬¦"></a>å…­ã€æµè¿ç®—ç¬¦</h1><p>ç»ˆç«¯æµè¿ç®—ç¬¦æ˜¯ç”¨äºå¯åŠ¨æµçš„æŒ‚èµ·å‡½æ•°ã€‚<code>collect</code> æ˜¯æœ€åŸºæœ¬çš„ç»ˆç«¯æµè¿ç®—ç¬¦ï¼Œä½†è¿˜æœ‰å…¶å®ƒç»ˆç«¯è¿ç®—ç¬¦ï¼Œå¯ä»¥ä½¿å¾—æ“ä½œæ›´åŠ ç®€ä¾¿ï¼š</p>
<ul>
<li>è½¬æ¢ä¸ºå„ç§é›†åˆï¼Œå¦‚ toList å’Œ toSet å‡½æ•°</li>
<li>first è¿ç®—ç¬¦ç”¨äºè·å–ç¬¬ä¸€ä¸ªå€¼ï¼Œsingle è¿ç®—ç¬¦ç”¨äºç¡®ä¿æµå‘å‡ºå•ä¸ªå€¼</li>
<li>ä½¿ç”¨ reduce å’Œ fold å°†æµè¿˜åŸä¸ºæŸä¸ªå€¼</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line"><span class="comment">//sampleStart         </span></span><br><span class="line">    <span class="keyword">val</span> sum = (<span class="number">1.</span><span class="number">.5</span>).asFlow()</span><br><span class="line">        .map &#123; it * it &#125; <span class="comment">// squares of numbers from 1 to 5                           </span></span><br><span class="line">        .reduce &#123; a, b -&gt; a + b &#125; <span class="comment">// sum them (terminal operator)</span></span><br><span class="line">    println(sum)</span><br><span class="line"><span class="comment">//sampleEnd     </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå•ä¸ªå€¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">55</span></span><br></pre></td></tr></table></figure>

<h1 id="ä¸ƒã€æµæ˜¯è¿ç»­çš„"><a href="#ä¸ƒã€æµæ˜¯è¿ç»­çš„" class="headerlink" title="ä¸ƒã€æµæ˜¯è¿ç»­çš„"></a>ä¸ƒã€æµæ˜¯è¿ç»­çš„</h1><p>é™¤éä½¿ç”¨å¯¹å¤šä¸ªæµè¿›è¡Œæ“ä½œçš„ç‰¹æ®Šè¿ç®—ç¬¦ï¼Œå¦åˆ™æ¯ä¸ªæµçš„å•ç‹¬é›†åˆéƒ½æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ã€‚é›†åˆç›´æ¥åœ¨è°ƒç”¨ç»ˆç«¯è¿ç®—ç¬¦çš„åç¨‹ä¸­å·¥ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ä¼šå¯åŠ¨æ–°çš„åç¨‹ã€‚æ¯ä¸ªå‘å‡ºçš„å€¼éƒ½ç”±æ‰€æœ‰ä¸­é—´è¿ç®—ç¬¦ä»ä¸Šæ¸¸åˆ°ä¸‹æ¸¸è¿›è¡Œå¤„ç†ï¼Œç„¶ååœ¨ä¹‹åä¼ é€’ç»™ç»ˆç«¯è¿ç®—ç¬¦</p>
<p>è¯·å‚é˜…ä»¥ä¸‹ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹è¿‡æ»¤å¶æ•°å¹¶å°†å…¶æ˜ å°„åˆ°å­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line"><span class="comment">//sampleStart         </span></span><br><span class="line">    (<span class="number">1.</span><span class="number">.5</span>).asFlow()</span><br><span class="line">        .filter &#123;</span><br><span class="line">            println(<span class="string">&quot;Filter <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">            it % <span class="number">2</span> == <span class="number">0</span>              </span><br><span class="line">        &#125;              </span><br><span class="line">        .map &#123; </span><br><span class="line">            println(<span class="string">&quot;Map <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">            <span class="string">&quot;string <span class="variable">$it</span>&quot;</span></span><br><span class="line">        &#125;.collect &#123; </span><br><span class="line">            println(<span class="string">&quot;Collect <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">        &#125;    </span><br><span class="line"><span class="comment">//sampleEnd                  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Filter <span class="number">1</span></span><br><span class="line">Filter <span class="number">2</span></span><br><span class="line">Map <span class="number">2</span></span><br><span class="line">Collect string <span class="number">2</span></span><br><span class="line">Filter <span class="number">3</span></span><br><span class="line">Filter <span class="number">4</span></span><br><span class="line">Map <span class="number">4</span></span><br><span class="line">Collect string <span class="number">4</span></span><br><span class="line">Filter <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h1 id="å…«ã€æµä¸Šä¸‹æ–‡"><a href="#å…«ã€æµä¸Šä¸‹æ–‡" class="headerlink" title="å…«ã€æµä¸Šä¸‹æ–‡"></a>å…«ã€æµä¸Šä¸‹æ–‡</h1><p>æµçš„æ”¶é›†æ€»æ˜¯åœ¨è°ƒç”¨åç¨‹çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœå­˜åœ¨ foo æµï¼Œåˆ™æ— è®º foo æµçš„å®ç°è¯¦ç»†ä¿¡æ¯å¦‚ä½•ï¼Œä»¥ä¸‹ä»£ç éƒ½å°†åœ¨è¯¥å¼€å‘è€…æŒ‡å®šçš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">withContext(context) &#123;</span><br><span class="line">    foo.collect &#123; value -&gt;</span><br><span class="line">        println(value) <span class="comment">// run in the specified context </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµçš„è¿™ä¸ªç‰¹æ€§ç§°ä¸ºä¸Šä¸‹æ–‡ä¿ç•™</p>
<p>æ‰€ä»¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œflow{â€¦} ä¸­çš„ä»£ç åœ¨ç›¸åº”æµçš„æ”¶é›†å™¨æä¾›çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ä¾‹å¦‚ï¼Œè§‚å¯Ÿ foo çš„å®ç°ï¼Œå®ƒæ‰“å°è°ƒç”¨å®ƒçš„çº¿ç¨‹å¹¶å‘å‡ºä¸‰ä¸ªæ•°å­—ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">log</span><span class="params">(msg: <span class="type">String</span>)</span></span> = println(<span class="string">&quot;[<span class="subst">$&#123;Thread.currentThread().name&#125;</span>] <span class="variable">$msg</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    log(<span class="string">&quot;Started foo flow&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    foo().collect &#123; value -&gt; log(<span class="string">&quot;Collected <span class="variable">$value</span>&quot;</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[main <span class="meta">@coroutine</span>#<span class="number">1</span>] Started foo flow</span><br><span class="line">[main <span class="meta">@coroutine</span>#<span class="number">1</span>] Collected <span class="number">1</span></span><br><span class="line">[main <span class="meta">@coroutine</span>#<span class="number">1</span>] Collected <span class="number">2</span></span><br><span class="line">[main <span class="meta">@coroutine</span>#<span class="number">1</span>] Collected <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>ç”±äº <code>foo().collect</code> æ˜¯åœ¨ä¸»çº¿ç¨‹è°ƒç”¨çš„ï¼Œæ‰€ä»¥ foo æµä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ã€‚å¯¹äºä¸å…³å¿ƒæ‰§è¡Œä¸Šä¸‹æ–‡ä¸”ä¸é˜»å¡è°ƒç”¨æ–¹çš„å¿«é€Ÿè¿”å›ä»£ç æˆ–è€…å¼‚æ­¥ä»£ç ï¼Œè¿™æ˜¯å®Œç¾çš„é»˜è®¤è®¾ç½®</p>
<h2 id="8-1ã€é”™è¯¯åœ°ä½¿ç”¨-withContext"><a href="#8-1ã€é”™è¯¯åœ°ä½¿ç”¨-withContext" class="headerlink" title="8.1ã€é”™è¯¯åœ°ä½¿ç”¨ withContext"></a>8.1ã€é”™è¯¯åœ°ä½¿ç”¨ withContext</h2><p>ä½†æ˜¯ï¼Œå¯èƒ½éœ€è¦åœ¨ Dispatchers çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„å ç”¨ CPU çš„ä»£ç ï¼Œå¯èƒ½éœ€è¦åœ¨ Dispatchers.Main çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œé»˜è®¤ä»£ç å’Œ UI æ›´æ–°ã€‚é€šå¸¸ï¼ŒwithContext ç”¨äºåœ¨ä½¿ç”¨ kotlin åç¨‹æ—¶æ›´æ”¹ä»£ç ä¸­çš„ä¸Šä¸‹æ–‡ï¼Œä½† <code>fow&#123;...&#125;</code> ä¸­çš„ä»£ç å¿…é¡»éµå®ˆä¸Šä¸‹æ–‡æœ¬ä¿ç•™å±æ€§ï¼Œå¹¶ä¸”ä¸å…è®¸ä»å…¶å®ƒä¸Šä¸‹æ–‡ä¸­è§¦å‘</p>
<p>å°è¯•è¿è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line">                      </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="comment">// The WRONG way to change context for CPU-consuming code in flow builder</span></span><br><span class="line">    kotlinx.coroutines.withContext(Dispatchers.Default) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>) <span class="comment">// pretend we are computing it in CPU-consuming way</span></span><br><span class="line">            emit(i) <span class="comment">// emit next value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    foo().collect &#123; value -&gt; println(value) &#125; </span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç ä¼šç”Ÿæˆä»¥ä¸‹å¼‚å¸¸ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalStateException: Flow invariant is violated:</span><br><span class="line">		Flow was collected in [CoroutineId(1), &quot;coroutine#1&quot;:BlockingCoroutine&#123;Active&#125;@5511c7f8, BlockingEventLoop@2eac3323],</span><br><span class="line">		but emission happened in [CoroutineId(1), &quot;coroutine#1&quot;:DispatchedCoroutine&#123;Active&#125;@2dae0000, DefaultDispatcher].</span><br><span class="line">		Please refer to &#x27;flow&#x27; documentation or use &#x27;flowOn&#x27; instead</span><br><span class="line">	at ...</span><br></pre></td></tr></table></figure>

<h2 id="8-2ã€flowOn-è¿ç®—ç¬¦"><a href="#8-2ã€flowOn-è¿ç®—ç¬¦" class="headerlink" title="8.2ã€flowOn è¿ç®—ç¬¦"></a>8.2ã€flowOn è¿ç®—ç¬¦</h2><p>æœ‰ä¸ªä¾‹å¤–æƒ…å†µï¼ŒflowOn å‡½æ•°èƒ½ç”¨äºæ”¹å˜æµå‘é€å€¼æ—¶çš„ä¸Šä¸‹æ–‡ã€‚æ”¹å˜æµä¸Šä¸‹æ–‡çš„æ­£ç¡®æ–¹å¼å¦‚ä¸‹é¢çš„ç¤ºä¾‹æ‰€ç¤ºï¼Œè¯¥ç¤ºä¾‹è¿˜æ‰“å°äº†ç›¸åº”çº¿ç¨‹çš„åç§°ï¼Œä»¥æ˜¾ç¤ºæ‰€æœ‰çº¿ç¨‹çš„å·¥ä½œæ–¹å¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">log</span><span class="params">(msg: <span class="type">String</span>)</span></span> = println(<span class="string">&quot;[<span class="subst">$&#123;Thread.currentThread().name&#125;</span>] <span class="variable">$msg</span>&quot;</span>)</span><br><span class="line">           </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>) <span class="comment">// pretend we are computing it in CPU-consuming way</span></span><br><span class="line">        log(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;.flowOn(Dispatchers.Default) <span class="comment">// RIGHT way to change context for CPU-consuming code in flow builder</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    foo().collect &#123; value -&gt;</span><br><span class="line">        log(<span class="string">&quot;Collected <span class="variable">$value</span>&quot;</span>) </span><br><span class="line">    &#125; </span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œflow{â€¦} åœ¨åå°çº¿ç¨‹ä¸­å·¥ä½œï¼Œè€Œåœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œå–å€¼</p>
<p>è¿™é‡Œè¦æ³¨æ„çš„å¦ä¸€ä»¶äº‹æ˜¯ flowOn æ“ä½œç¬¦æ”¹å˜äº†æµçš„é»˜è®¤é¡ºåºæ€§è´¨ã€‚ç°åœ¨å–å€¼æ“ä½œå‘ç”Ÿåœ¨åç¨‹ â€œcoroutine#1â€ ä¸­ï¼Œè€Œå‘å°„å€¼çš„æ“ä½œåŒæ—¶è¿è¡Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„åç¨‹ â€œcoroutine#2â€ ä¸Šã€‚å½“å¿…é¡»åœ¨ä¸Šæ¸¸æµçš„ä¸Šä¸‹æ–‡ä¸­æ›´æ”¹ CoroutineDispatcher æ—¶ï¼ŒflowOn è¿ç®—ç¬¦å°†ä¸ºè¯¥ä¸Šæ¸¸æµåˆ›å»ºå¦ä¸€ä¸ªåç¨‹</p>
<h1 id="ä¹ã€ç¼“å†²"><a href="#ä¹ã€ç¼“å†²" class="headerlink" title="ä¹ã€ç¼“å†²"></a>ä¹ã€ç¼“å†²</h1><p>ä»æ”¶é›†æµæ‰€éœ€çš„æ€»æ—¶é—´çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨ä¸åŒçš„åç¨‹ä¸­è¿è¡Œæµçš„ä¸åŒéƒ¨åˆ†å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼Œç‰¹åˆ«æ˜¯å½“æ¶‰åŠåˆ°é•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥æ“ä½œæ—¶ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ foo() æµçš„å‘å°„å¾ˆæ…¢ï¼Œç”Ÿæˆå…ƒç´ éœ€è¦100æ¯«ç§’ï¼›æ”¶é›†å™¨ä¹Ÿå¾ˆæ…¢ï¼Œå¤„ç†å…ƒç´ éœ€è¦300æ¯«ç§’ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ç”¨ä¸‰ä¸ªæ•°å­—æ”¶é›†è¿™æ ·çš„æµéœ€è¦å¤šé•¿æ—¶é—´ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"><span class="keyword">import</span> kotlin.system.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// pretend we are asynchronously waiting 100 ms</span></span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        foo().collect &#123; value -&gt; </span><br><span class="line">            delay(<span class="number">300</span>) <span class="comment">// pretend we are processing it for 300 ms</span></span><br><span class="line">            println(value) </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;   </span><br><span class="line">    println(<span class="string">&quot;Collected in <span class="variable">$time</span> ms&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç ä¼šäº§ç”Ÿå¦‚ä¸‹ç±»ä¼¼çš„ç»“æœï¼Œæ•´ä¸ªæ”¶é›†è¿‡ç¨‹å¤§çº¦éœ€è¦1200æ¯«ç§’ï¼ˆä¸‰ä¸ªæ•°å­—ï¼Œæ¯ä¸ª400æ¯«ç§’ï¼‰</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">1220</span> ms</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥åœ¨æµä¸Šä½¿ç”¨ buffer è¿ç®—ç¬¦ï¼Œåœ¨è¿è¡Œå–é›†ä»£ç çš„åŒæ—¶è¿è¡Œ foo() çš„å‘å€¼ä»£ç ï¼Œè€Œä¸æ˜¯æŒ‰é¡ºåºè¿è¡Œå®ƒä»¬</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"><span class="keyword">import</span> kotlin.system.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// pretend we are asynchronously waiting 100 ms</span></span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        foo()</span><br><span class="line">            .buffer() <span class="comment">// buffer emissions, don&#x27;t wait</span></span><br><span class="line">            .collect &#123; value -&gt; </span><br><span class="line">                delay(<span class="number">300</span>) <span class="comment">// pretend we are processing it for 300 ms</span></span><br><span class="line">                println(value) </span><br><span class="line">            &#125; </span><br><span class="line">    &#125;   </span><br><span class="line">    println(<span class="string">&quot;Collected in <span class="variable">$time</span> ms&quot;</span>)</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å¯ä»¥å¾—åˆ°ç›¸åŒçš„è¾“å‡ºç»“æœä½†è¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰æ•ˆåœ°åˆ›å»ºäº†ä¸€ä¸ªå¤„ç†ç®¡é“ï¼Œç¬¬ä¸€ä¸ªæ•°å­—åªéœ€è¦ç­‰å¾…100æ¯«ç§’ï¼Œç„¶ååªéœ€è¦èŠ±è´¹300æ¯«ç§’æ¥å¤„ç†æ¯ä¸ªæ•°å­—ã€‚è¿™æ ·è¿è¡Œå¤§çº¦éœ€è¦1000æ¯«ç§’ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">1071</span> ms</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼ŒflowOn è¿ç®—ç¬¦åœ¨å¿…é¡»æ›´æ”¹ CoroutineDispatcher æ—¶ä½¿ç”¨ç›¸åŒçš„ç¼“å†²æœºåˆ¶ï¼Œä½†è¿™é‡Œæˆ‘ä»¬æ˜¾ç¤ºåœ°è¯·æ±‚ç¼“å†²è€Œä¸æ›´æ”¹æ‰§è¡Œä¸Šä¸‹æ–‡</p>
<h2 id="9-1ã€åˆå¹¶"><a href="#9-1ã€åˆå¹¶" class="headerlink" title="9.1ã€åˆå¹¶"></a>9.1ã€åˆå¹¶</h2><p>å½“æµç”¨äºè¡¨ç¤ºæ“ä½œæˆ–æ“ä½œçŠ¶æ€æ›´æ–°çš„éƒ¨åˆ†ç»“æœæ—¶ï¼Œå¯èƒ½ä¸éœ€è¦å¤„ç†æ¯ä¸ªå€¼ï¼Œè€Œæ˜¯åªå¤„ç†æœ€è¿‘çš„å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å–å€¼å™¨å¤„ç†ä¸­é—´å€¼å¤ªæ…¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åˆå¹¶è¿ç®—ç¬¦è·³è¿‡ä¸­é—´å€¼ã€‚åœ¨å‰é¢çš„ä¾‹å­çš„åŸºç¡€ä¸Šå†æ¥ä¿®æ”¹ä¸‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"><span class="keyword">import</span> kotlin.system.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// pretend we are asynchronously waiting 100 ms</span></span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        foo()</span><br><span class="line">            .conflate() <span class="comment">// conflate emissions, don&#x27;t process each one</span></span><br><span class="line">            .collect &#123; value -&gt; </span><br><span class="line">                delay(<span class="number">300</span>) <span class="comment">// pretend we are processing it for 300 ms</span></span><br><span class="line">                println(value) </span><br><span class="line">            &#125; </span><br><span class="line">    &#125;   </span><br><span class="line">    println(<span class="string">&quot;Collected in <span class="variable">$time</span> ms&quot;</span>)</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ç¬¬ä¸€ä¸ªæ•°å­—ä»åœ¨å¤„ç†ä¸­ï¼Œä½†ç¬¬äºŒä¸ªæ•°å­—å’Œç¬¬ä¸‰ä¸ªæ•°å­—å·²ç»ç”Ÿæˆï¼Œå› æ­¤ç¬¬äºŒä¸ªæ•°å­—è¢«åˆå¹¶ï¼ˆä¸¢å¼ƒï¼‰ï¼Œåªæœ‰æœ€è¿‘çš„ä¸€ä¸ªæ•°å­—ï¼ˆç¬¬ä¸‰ä¸ªï¼‰è¢«äº¤ä»˜ç»™å–å€¼å™¨ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">758</span> ms</span><br></pre></td></tr></table></figure>

<h2 id="9-2ã€å¤„ç†æœ€æ–°å€¼"><a href="#9-2ã€å¤„ç†æœ€æ–°å€¼" class="headerlink" title="9.2ã€å¤„ç†æœ€æ–°å€¼"></a>9.2ã€å¤„ç†æœ€æ–°å€¼</h2><p>åœ¨å‘å°„ç«¯å’Œå¤„ç†ç«¯éƒ½å¾ˆæ…¢çš„æƒ…å†µä¸‹ï¼Œåˆå¹¶æ˜¯åŠ å¿«å¤„ç†é€Ÿåº¦çš„ä¸€ç§æ–¹æ³•ã€‚å®ƒé€šè¿‡ä¸¢å¼ƒå‘å°„çš„å€¼æ¥å®ç°ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯å–æ¶ˆæ…¢é€Ÿæ”¶é›†å™¨ï¼Œå¹¶åœ¨æ¯æ¬¡å‘å‡ºæ–°å€¼æ—¶é‡æ–°å¯åŠ¨å®ƒã€‚æœ‰ä¸€ç³»åˆ— xxxLatest è¿ç®—ç¬¦ä¸ xxx è¿ç®—ç¬¦æ‰§è¡Œç›¸åŒçš„åŸºæœ¬é€»è¾‘ï¼Œä½†æ˜¯åœ¨æ–°å€¼äº§ç”Ÿçš„æ—¶å€™å–æ¶ˆæ‰§è¡Œå…¶å—ä¸­çš„ä»£ç ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°è¯•å°† conflate æ›´æ”¹ä¸º collectLatestï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"><span class="keyword">import</span> kotlin.system.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// pretend we are asynchronously waiting 100 ms</span></span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        foo()</span><br><span class="line">            .collectLatest &#123; value -&gt; <span class="comment">// cancel &amp; restart on the latest value</span></span><br><span class="line">                println(<span class="string">&quot;Collecting <span class="variable">$value</span>&quot;</span>) </span><br><span class="line">                delay(<span class="number">300</span>) <span class="comment">// pretend we are processing it for 300 ms</span></span><br><span class="line">                println(<span class="string">&quot;Done <span class="variable">$value</span>&quot;</span>) </span><br><span class="line">            &#125; </span><br><span class="line">    &#125;   </span><br><span class="line">    println(<span class="string">&quot;Collected in <span class="variable">$time</span> ms&quot;</span>)</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº collectLatest çš„ä¸»ä½“éœ€è¦å»¶è¿Ÿ300æ¯«ç§’ï¼Œè€Œæ¯100æ¯«ç§’ä¼šå‘å‡ºä¸€ä¸ªæ–°å€¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ° collectLatest ä»£ç å—å¾—åˆ°äº†æ¯ä¸€ä¸ªå‘å°„å€¼ï¼Œä½†æœ€ç»ˆåªå®Œæˆäº†æœ€åä¸€ä¸ªå€¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Collecting <span class="number">1</span></span><br><span class="line">Collecting <span class="number">2</span></span><br><span class="line">Collecting <span class="number">3</span></span><br><span class="line">Done <span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">741</span> ms</span><br></pre></td></tr></table></figure>

<h1 id="åã€ç»„åˆå¤šä¸ªæµ"><a href="#åã€ç»„åˆå¤šä¸ªæµ" class="headerlink" title="åã€ç»„åˆå¤šä¸ªæµ"></a>åã€ç»„åˆå¤šä¸ªæµ</h1><p>æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥ç»„åˆå¤šä¸ªæµ</p>
<h2 id="10-1ã€zip"><a href="#10-1ã€zip" class="headerlink" title="10.1ã€zip"></a>10.1ã€zip</h2><p>ä¸ Kotlin æ ‡å‡†åº“ä¸­çš„ Sequence.zip æ‰©å±•å‡½æ•°ä¸€æ ·ï¼Œæµæœ‰ä¸€ä¸ª zip è¿ç®—ç¬¦ï¼Œç”¨äºç»„åˆä¸¤ä¸ªæµçš„ç›¸åº”å€¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart                                                                           </span></span><br><span class="line">    <span class="keyword">val</span> nums = (<span class="number">1.</span><span class="number">.3</span>).asFlow() <span class="comment">// numbers 1..3</span></span><br><span class="line">    <span class="keyword">val</span> strs = flowOf(<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>) <span class="comment">// strings </span></span><br><span class="line">    nums.zip(strs) &#123; a, b -&gt; <span class="string">&quot;<span class="variable">$a</span> -&gt; <span class="variable">$b</span>&quot;</span> &#125; <span class="comment">// compose a single string</span></span><br><span class="line">        .collect &#123; println(it) &#125; <span class="comment">// collect and print</span></span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> -&gt; one</span><br><span class="line"><span class="number">2</span> -&gt; two</span><br><span class="line"><span class="number">3</span> -&gt; three</span><br></pre></td></tr></table></figure>

<h2 id="10-2ã€Combine"><a href="#10-2ã€Combine" class="headerlink" title="10.2ã€Combine"></a>10.2ã€Combine</h2><p>å½“ flow è¡¨ç¤ºå˜é‡æˆ–æ“ä½œçš„æœ€æ–°å€¼æ—¶ï¼ˆå‚é˜…æœ‰å…³ conflation çš„ç›¸å…³ç« èŠ‚ï¼‰ï¼Œå¯èƒ½éœ€è¦æ‰§è¡Œä¾èµ–äºç›¸åº”æµçš„æœ€æ–°å€¼çš„è®¡ç®—ï¼Œå¹¶åœ¨ä»»ä½•ä¸Šæ¸¸æµå‘å‡ºå€¼æ—¶é‡æ–°è®¡ç®—å®ƒã€‚ç›¸åº”çš„è¿ç®—ç¬¦æ—ç§°ä¸º combine</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœä¸Šä¾‹ä¸­çš„æ•°å­—æ¯300æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œä½†å­—ç¬¦ä¸²æ¯400æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œåˆ™ä½¿ç”¨ zip è¿ç®—ç¬¦å‹ç¼©å®ƒä»¬ä»ä¼šäº§ç”Ÿç›¸åŒçš„ç»“æœï¼Œå°½ç®¡ç»“æœæ˜¯æ¯400æ¯«ç§’æ‰“å°ä¸€æ¬¡</p>
<blockquote>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸­é—´è¿ç®—ç¬¦ onEach æ¥å»¶è¿Ÿæ¯ä¸ªå…ƒç´ ï¼Œå¹¶ä½¿å‘å‡ºæ ·æœ¬æµçš„ä»£ç æ›´å…·å£°æ˜æ€§ï¼Œæ›´åŠ ç®€çŸ­</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart                                                                           </span></span><br><span class="line">    <span class="keyword">val</span> nums = (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">300</span>) &#125; <span class="comment">// numbers 1..3 every 300 ms</span></span><br><span class="line">    <span class="keyword">val</span> strs = flowOf(<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>).onEach &#123; delay(<span class="number">400</span>) &#125; <span class="comment">// strings every 400 ms</span></span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// remember the start time </span></span><br><span class="line">    nums.zip(strs) &#123; a, b -&gt; <span class="string">&quot;<span class="variable">$a</span> -&gt; <span class="variable">$b</span>&quot;</span> &#125; <span class="comment">// compose a single string with &quot;zip&quot;</span></span><br><span class="line">        .collect &#123; value -&gt; <span class="comment">// collect and print </span></span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start&quot;</span>) </span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ï¼Œå¦‚æœåœ¨æ­¤å¤„ä½¿ç”¨ combine è¿ç®—ç¬¦è€Œä¸æ˜¯ zip æ—¶ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart                                                                           </span></span><br><span class="line">    <span class="keyword">val</span> nums = (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">300</span>) &#125; <span class="comment">// numbers 1..3 every 300 ms</span></span><br><span class="line">    <span class="keyword">val</span> strs = flowOf(<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>).onEach &#123; delay(<span class="number">400</span>) &#125; <span class="comment">// strings every 400 ms          </span></span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// remember the start time </span></span><br><span class="line">    nums.combine(strs) &#123; a, b -&gt; <span class="string">&quot;<span class="variable">$a</span> -&gt; <span class="variable">$b</span>&quot;</span> &#125; <span class="comment">// compose a single string with &quot;combine&quot;</span></span><br><span class="line">        .collect &#123; value -&gt; <span class="comment">// collect and print </span></span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start&quot;</span>) </span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¾—åˆ°äº†å®Œå…¨ä¸åŒçš„è¾“å‡ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> -&gt; one at <span class="number">452</span> ms from start</span><br><span class="line"><span class="number">2</span> -&gt; one at <span class="number">651</span> ms from start</span><br><span class="line"><span class="number">2</span> -&gt; two at <span class="number">854</span> ms from start</span><br><span class="line"><span class="number">3</span> -&gt; two at <span class="number">952</span> ms from start</span><br><span class="line"><span class="number">3</span> -&gt; three at <span class="number">1256</span> ms from start</span><br></pre></td></tr></table></figure>

<h1 id="åä¸€ã€å±•å¹³æµ"><a href="#åä¸€ã€å±•å¹³æµ" class="headerlink" title="åä¸€ã€å±•å¹³æµ"></a>åä¸€ã€å±•å¹³æµ</h1><p>æµè¡¨ç¤ºå¼‚æ­¥æ¥æ”¶çš„å€¼åºåˆ—ï¼Œå› æ­¤åœ¨æ¯ä¸ªå€¼è§¦å‘å¯¹å¦ä¸€ä¸ªå€¼åºåˆ—çš„è¯·æ±‚çš„æƒ…å†µä¸‹å¾ˆå®¹æ˜“è·å–æ–°å€¼ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ç›¸éš”500æ¯«ç§’çš„ä¸¤ä¸ªå­—ç¬¦ä¸²æµï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span>: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: First&quot;</span>) </span><br><span class="line">    delay(<span class="number">500</span>) <span class="comment">// wait 500 ms</span></span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: Second&quot;</span>)    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ•´æ•°çš„æµï¼Œå¹¶ä¸ºæ¯ä¸ªæ•´æ•°è°ƒç”¨ requestFlowï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1.</span><span class="number">.3</span>).asFlow().map &#123; requestFlow(it) &#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæµï¼ˆflow&lt; flow&lt; String &gt;&gt;ï¼‰ï¼Œéœ€è¦å°†å…¶å±•å¹³ä¸ºå•ç‹¬ä¸€ä¸ªæµä»¥è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚é›†åˆå’Œåºåˆ—å¯¹æ­¤æä¾›äº† flatten å’Œ flatMap è¿ç®—ç¬¦ã€‚ç„¶è€Œï¼Œç”±äºæµçš„å¼‚æ­¥ç‰¹æ€§ï¼Œå®ƒä»¬éœ€è¦ä¸åŒçš„å±•å¼€æ¨¡å¼ï¼Œå› æ­¤æµä¸Šæœ‰ä¸€ç³»åˆ— flattening è¿ç®—ç¬¦</p>
<h2 id="11-1ã€flatMapConcat"><a href="#11-1ã€flatMapConcat" class="headerlink" title="11.1ã€flatMapConcat"></a>11.1ã€flatMapConcat</h2><p>flatMapConcat å’Œ flattencat è¿ç®—ç¬¦å®ç°äº† Concatenating æ¨¡å¼ï¼Œå®ƒä»¬æ˜¯ä¸åºåˆ—è¿ç®—ç¬¦æœ€ç›´æ¥çš„ç±»æ¯”ã€‚å®ƒä»¬ç­‰å¾…å†…éƒ¨æµå®Œæˆï¼Œç„¶åå¼€å§‹æ”¶é›†ä¸‹ä¸€ä¸ªæµï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span>: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: First&quot;</span>)</span><br><span class="line">    delay(<span class="number">500</span>) <span class="comment">// wait 500 ms</span></span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: Second&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//sampleStart</span></span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// remember the start time</span></span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125; <span class="comment">// a number every 100 ms</span></span><br><span class="line">        .flatMapConcat &#123; requestFlow(it) &#125;</span><br><span class="line">        .collect &#123; value -&gt;</span><br><span class="line">            <span class="comment">// collect and print</span></span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flatMapConcat çš„é¡ºåºç‰¹æ€§åœ¨è¾“å‡ºç»“æœä¸­æ¸…æ™°å¯è§ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: First at <span class="number">121</span> ms from start</span><br><span class="line"><span class="number">1</span>: Second at <span class="number">622</span> ms from start</span><br><span class="line"><span class="number">2</span>: First at <span class="number">727</span> ms from start</span><br><span class="line"><span class="number">2</span>: Second at <span class="number">1227</span> ms from start</span><br><span class="line"><span class="number">3</span>: First at <span class="number">1328</span> ms from start</span><br><span class="line"><span class="number">3</span>: Second at <span class="number">1829</span> ms from start</span><br></pre></td></tr></table></figure>

<h2 id="11-2ã€flatMapMerge"><a href="#11-2ã€flatMapMerge" class="headerlink" title="11.2ã€flatMapMerge"></a>11.2ã€flatMapMerge</h2><p>å¦ä¸€ç§ flattening æ¨¡å¼æ˜¯åŒæ—¶æ”¶é›†æ‰€æœ‰ä¼ å…¥æµå¹¶å°†å…¶å€¼åˆå¹¶åˆ°å•ä¸ªæµä¸­ï¼Œä»¥ä¾¿å°½å¿«å‘å‡ºå€¼ã€‚å®ƒç”± flatMapMerge  å’Œ flattenMerge è¿ç®—ç¬¦å®ç°ã€‚å®ƒä»¬éƒ½æ¥å—ä¸€ä¸ªå¯é€‰çš„å¹¶å‘å‚æ•°ï¼Œè¯¥å‚æ•°ç”¨äºé™åˆ¶åŒæ—¶æ”¶é›†çš„å¹¶å‘æµçš„æ•°é‡ï¼ˆé»˜è®¤æƒ…å†µä¸‹ç­‰äº DEFAULT_CONCURRENCYï¼‰</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span>: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: First&quot;</span>) </span><br><span class="line">    delay(<span class="number">500</span>) <span class="comment">// wait 500 ms</span></span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: Second&quot;</span>)    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// remember the start time </span></span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125; <span class="comment">// a number every 100 ms </span></span><br><span class="line">        .flatMapMerge &#123; requestFlow(it) &#125;                                                                           </span><br><span class="line">        .collect &#123; value -&gt; <span class="comment">// collect and print </span></span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start&quot;</span>) </span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flatMapMerge çš„å¹¶å‘æ€§æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: First at <span class="number">136</span> ms from start</span><br><span class="line"><span class="number">2</span>: First at <span class="number">231</span> ms from start</span><br><span class="line"><span class="number">3</span>: First at <span class="number">333</span> ms from start</span><br><span class="line"><span class="number">1</span>: Second at <span class="number">639</span> ms from start</span><br><span class="line"><span class="number">2</span>: Second at <span class="number">732</span> ms from start</span><br><span class="line"><span class="number">3</span>: Second at <span class="number">833</span> ms from start</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼ŒflatMapMerge æŒ‰é¡ºåºè°ƒç”¨å…¶ä»£ç å—ï¼ˆ{requestFlow(it)}ï¼‰ï¼Œä½†åŒæ—¶æ”¶é›†ç»“æœæµï¼Œè¿™ç›¸å½“äºå…ˆæ‰§è¡Œåºåˆ— map{requestFlow(it)}ï¼Œç„¶åå¯¹è¿”å›å€¼è°ƒç”¨ flattenMerge</p>
<h2 id="11-3ã€flatMapLatest"><a href="#11-3ã€flatMapLatest" class="headerlink" title="11.3ã€flatMapLatest"></a>11.3ã€flatMapLatest</h2><p>ä¸â€œProcessing the latest valueï¼ˆå¤„ç†æœ€æ–°å€¼ï¼‰â€ç« èŠ‚ä»‹ç»çš„ collectLatest æ“ä½œç¬¦ç±»ä¼¼ï¼Œå­˜åœ¨ç›¸åº”çš„ â€œLatestâ€ flattening æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä¸€æ—¦å‘å‡ºæ–°æµï¼Œå°†å–æ¶ˆå…ˆå‰å·²å‘å‡ºçš„æµã€‚è¿™é€šè¿‡ flatMapLatest è¿ç®—ç¬¦å®ç°</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span>: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: First&quot;</span>) </span><br><span class="line">    delay(<span class="number">500</span>) <span class="comment">// wait 500 ms</span></span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: Second&quot;</span>)    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// remember the start time </span></span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125; <span class="comment">// a number every 100 ms </span></span><br><span class="line">        .flatMapLatest &#123; requestFlow(it) &#125;                                                                           </span><br><span class="line">        .collect &#123; value -&gt; <span class="comment">// collect and print </span></span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start&quot;</span>) </span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ¬ä¾‹ä¸­çš„è¾“å‡ºå¾ˆå¥½çš„æ¼”ç¤ºäº† flatMapLatest çš„å·¥ä½œåŸç†</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: First at <span class="number">142</span> ms from start</span><br><span class="line"><span class="number">2</span>: First at <span class="number">322</span> ms from start</span><br><span class="line"><span class="number">3</span>: First at <span class="number">425</span> ms from start</span><br><span class="line"><span class="number">3</span>: Second at <span class="number">931</span> ms from start</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œå½“æ–°å€¼åˆ°æ¥æ—¶ï¼ŒflatMapLatest å°†å–æ¶ˆå…¶å—ä¸­çš„æ‰€æœ‰ä»£ç ï¼ˆ{requestFlow(it)}ï¼‰ã€‚requestFlow å‡½æ•°æœ¬èº«çš„è°ƒç”¨æ˜¯å¾ˆå¿«é€Ÿçš„ï¼Œå¹¶éæŒ‚èµ·å‡½æ•°ï¼Œå¦‚æœå…¶å†…éƒ¨ä¸åŒ…å«é¢å¤–çš„æŒ‚èµ·ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°±ä¸èƒ½è¢«å–æ¶ˆï¼Œæ‰€ä»¥æ­¤å¤„å°±åœ¨å…¶å†…éƒ¨ä½¿ç”¨äº† delay å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥è¾¾åˆ°è¢«å–æ¶ˆçš„ç›®çš„</p>
<h1 id="åäºŒã€æµå¼‚å¸¸"><a href="#åäºŒã€æµå¼‚å¸¸" class="headerlink" title="åäºŒã€æµå¼‚å¸¸"></a>åäºŒã€æµå¼‚å¸¸</h1><p>å½“å‘å°„å™¨æˆ–è¿ç®—ç¬¦å†…éƒ¨çš„ä»£ç å¼•å‘å¼‚å¸¸æ—¶ï¼Œæµæ”¶é›†å™¨å¯ä»¥ç»“æŸè¿è¡Œï¼Œä½†ä¼šå‡ºç°å¼‚å¸¸ã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¤„ç†è¿™äº›å¼‚å¸¸</p>
<h2 id="12-1ã€æ”¶é›†å™¨-try-ä¸-catch"><a href="#12-1ã€æ”¶é›†å™¨-try-ä¸-catch" class="headerlink" title="12.1ã€æ”¶é›†å™¨ try ä¸ catch"></a>12.1ã€æ”¶é›†å™¨ try ä¸ catch</h2><p>æ”¶é›†å™¨å¯ä»¥ä½¿ç”¨ kotlin çš„ try&#x2F;catch ä»£ç å—æ¥å¤„ç†å¼‚å¸¸</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        foo().collect &#123; value -&gt;         </span><br><span class="line">            println(value)</span><br><span class="line">            check(value &lt;= <span class="number">1</span>) &#123; <span class="string">&quot;Collected <span class="variable">$value</span>&quot;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$e</span>&quot;</span>)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>æ­¤ä»£ç æˆåŠŸæ•è· collect è¿ç®—ç¬¦ä¸­çš„å¼‚å¸¸ï¼Œå¦‚æˆ‘ä»¬æ‰€è§ï¼Œåœ¨æ­¤ä¹‹åä¸å†å‘å‡ºä»»ä½•å€¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Emitting <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Emitting <span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Caught java.lang.IllegalStateException: Collected <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="12-2ã€ä¸€åˆ‡éƒ½å·²æ•è·"><a href="#12-2ã€ä¸€åˆ‡éƒ½å·²æ•è·" class="headerlink" title="12.2ã€ä¸€åˆ‡éƒ½å·²æ•è·"></a>12.2ã€ä¸€åˆ‡éƒ½å·²æ•è·</h2><p>å‰é¢çš„ç¤ºä¾‹å®é™…ä¸Šæ•è·äº†å‘å°„å™¨æˆ–ä»»ä½•ä¸­é—´æˆ–ç»ˆç«¯è¿ç®—ç¬¦ä¸­å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬æ›´æ”¹ä»£ç ï¼Œä»¥ä¾¿å°†å‘å‡ºçš„å€¼æ˜ å°„åˆ°å­—ç¬¦ä¸²ï¼Œä½†ç›¸åº”çš„ä»£ç ä¼šäº§ç”Ÿå¼‚å¸¸ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;String&gt; = </span><br><span class="line">    flow &#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">            println(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">            emit(i) <span class="comment">// emit next value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .map &#123; value -&gt;</span><br><span class="line">        check(value &lt;= <span class="number">1</span>) &#123; <span class="string">&quot;Crashed on <span class="variable">$value</span>&quot;</span> &#125;                 </span><br><span class="line">        <span class="string">&quot;string <span class="variable">$value</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        foo().collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$e</span>&quot;</span>)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>ä»æ•è·æ­¤å¼‚å¸¸å¹¶åœæ­¢æ”¶é›†ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Emitting <span class="number">1</span></span><br><span class="line">string <span class="number">1</span></span><br><span class="line">Emitting <span class="number">2</span></span><br><span class="line">Caught java.lang.IllegalStateException: Crashed on <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h1 id="åä¸‰ã€å¼‚å¸¸é€æ˜æ€§"><a href="#åä¸‰ã€å¼‚å¸¸é€æ˜æ€§" class="headerlink" title="åä¸‰ã€å¼‚å¸¸é€æ˜æ€§"></a>åä¸‰ã€å¼‚å¸¸é€æ˜æ€§</h1><p>ä½†æ˜¯å‘å°„å™¨çš„ä»£ç å¦‚ä½•å°è£…å…¶å¼‚å¸¸å¤„ç†è¡Œä¸ºå‘¢ï¼Ÿ</p>
<p>flows å¯¹äºå¼‚å¸¸å¿…é¡»æ˜¯é€æ˜çš„ï¼Œå¹¶ä¸”åœ¨ flow{â€¦} æ„å»ºå™¨ä¸­å‘å°„å€¼æœ‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å¿…é¡»æ˜¾å¼åœ°ä» try&#x2F;catch å—å†…éƒ¨æŠ›å‡ºã€‚è¿™ä¿è¯äº†æŠ›å‡ºå¼‚å¸¸çš„æ”¶é›†å™¨å§‹ç»ˆå¯ä»¥ä½¿ç”¨ try&#x2F;catch æ¥æ•è·å¼‚å¸¸ï¼Œå¦‚å‰ä¸€ä¸ªç¤ºä¾‹æ‰€ç¤º</p>
<p>å‘å°„å™¨å¯ä»¥ä½¿ç”¨ catch è¿ç®—ç¬¦æ¥ä¿æŒæ­¤å¼‚å¸¸çš„é€æ˜æ€§ï¼Œå¹¶å…è®¸å°è£…å…¶å¼‚å¸¸å¤„ç†è¡Œä¸ºã€‚catch è¿ç®—ç¬¦å¯ä»¥åˆ†æå¼‚å¸¸å¹¶æ ¹æ®æ•è·åˆ°çš„å¼‚å¸¸ä»¥ä¸åŒçš„æ–¹å¼å¯¹å…¶ä½œå‡ºååº”ï¼š</p>
<ul>
<li>å¯ä»¥ä½¿ç”¨ throw é‡æ–°å¼•å‘å¼‚å¸¸</li>
<li>ä½¿ç”¨ catch çš„ emit å¯ä»¥å°†å¼‚å¸¸è½¬æ¢ä¸ºå€¼çš„ emission</li>
<li>å¼‚å¸¸å¯ä»¥è¢«å…¶ä»–ä»£ç å¿½ç•¥ã€è®°å½•æˆ–å¤„ç†</li>
</ul>
<p>ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬åœ¨æ•è·å¼‚å¸¸æ—¶å‘å‡ºä¸€æ®µæ–‡æœ¬ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;String&gt; = </span><br><span class="line">    flow &#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">            println(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">            emit(i) <span class="comment">// emit next value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .map &#123; value -&gt;</span><br><span class="line">        check(value &lt;= <span class="number">1</span>) &#123; <span class="string">&quot;Crashed on <span class="variable">$value</span>&quot;</span> &#125;                 </span><br><span class="line">        <span class="string">&quot;string <span class="variable">$value</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    foo()</span><br><span class="line">        .<span class="keyword">catch</span> &#123; e -&gt; emit(<span class="string">&quot;Caught <span class="variable">$e</span>&quot;</span>) &#125; <span class="comment">// emit on exception</span></span><br><span class="line">        .collect &#123; value -&gt; println(value) &#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;            </span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹ä»£ç çš„è¾“å‡ºç»“æœæ˜¯ä¸ä¹‹å‰ç›¸åŒçš„ï¼Œå³ä½¿æˆ‘ä»¬ä¸å†åœ¨ä»£ç å‘¨å›´ä½¿ç”¨ try&#x2F;catch</p>
<h2 id="13-1ã€é€æ˜æ•è·"><a href="#13-1ã€é€æ˜æ•è·" class="headerlink" title="13.1ã€é€æ˜æ•è·"></a>13.1ã€é€æ˜æ•è·</h2><p>catch ä¸­é—´è¿ç®—ç¬¦éµå¾ªå¼‚å¸¸é€æ˜æ€§ï¼Œåªæ•è·ä¸Šæ¸¸å¼‚å¸¸ï¼ˆå³ catch ä¸Šæ‰€æœ‰è¿ç®—ç¬¦çš„å¼‚å¸¸ï¼Œè€Œä¸æ˜¯ catch ä¸‹æ‰€æœ‰è¿ç®—ç¬¦çš„å¼‚å¸¸ï¼‰ã€‚å¦‚æœ collect{â€¦}ï¼ˆæ”¾åœ¨ catch ä¸‹é¢ï¼‰æŠ›å‡ºå¼‚å¸¸ï¼Œç¨‹åºå°†é€€å‡ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    foo()</span><br><span class="line">        .<span class="keyword">catch</span> &#123; e -&gt; println(<span class="string">&quot;Caught <span class="variable">$e</span>&quot;</span>) &#125; <span class="comment">// does not catch downstream exceptions</span></span><br><span class="line">        .collect &#123; value -&gt;</span><br><span class="line">            check(value &lt;= <span class="number">1</span>) &#123; <span class="string">&quot;Collected <span class="variable">$value</span>&quot;</span> &#125;                 </span><br><span class="line">            println(value) </span><br><span class="line">        &#125;</span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>å°½ç®¡å­˜åœ¨ catch è¿ç®—ç¬¦ï¼Œä½†ä¸ä¼šæ‰“å° â€œCaught â€¦â€ æ—¥å¿—</p>
<h2 id="13-2ã€å£°æ˜å¼æ•è·"><a href="#13-2ã€å£°æ˜å¼æ•è·" class="headerlink" title="13.2ã€å£°æ˜å¼æ•è·"></a>13.2ã€å£°æ˜å¼æ•è·</h2><p>æˆ‘ä»¬å¯ä»¥å°† catch è¿ç®—ç¬¦çš„å£°æ˜æ€§ä¸å¤„ç†æ‰€æœ‰å¼‚å¸¸çš„æ„¿æœ›ç»“åˆèµ·æ¥ï¼Œæ–¹æ³•æ˜¯å°† collect è¿ç®—ç¬¦åŸå…ˆæ‰€è¦åšçš„æ“ä½œç§»åŠ¨åˆ° onEach ä¸­ï¼Œå¹¶å°†å…¶æ”¾åœ¨ catch è¿ç®—ç¬¦ä¹‹å‰ã€‚æ­¤æµçš„å–å€¼æ“ä½œå¿…é¡»ç”±ä¸å¸¦å‚æ•°çš„ collect() å‡½æ•°æ¥è°ƒç”¨è§¦å‘ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    foo()</span><br><span class="line">        .onEach &#123; value -&gt;</span><br><span class="line">            check(value &lt;= <span class="number">1</span>) &#123; <span class="string">&quot;Collected <span class="variable">$value</span>&quot;</span> &#125;                 </span><br><span class="line">            println(value) </span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="keyword">catch</span> &#123; e -&gt; println(<span class="string">&quot;Caught <span class="variable">$e</span>&quot;</span>) &#125;</span><br><span class="line">        .collect()</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;            </span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰“å°äº†ä¸€æ¡ â€œCaught â€¦â€ æ¶ˆæ¯ï¼Œè‡³æ­¤æˆ‘ä»¬æ•è·äº†æ‰€æœ‰å¼‚å¸¸ï¼Œè€Œæ— éœ€æ˜¾å¼ä½¿ç”¨ try&#x2F;catch </p>
<h1 id="åå››ã€æµå®Œæˆ"><a href="#åå››ã€æµå®Œæˆ" class="headerlink" title="åå››ã€æµå®Œæˆ"></a>åå››ã€æµå®Œæˆ</h1><p>å½“æµæ”¶é›†å®Œæˆæ—¶ï¼ˆæ­£å¸¸æˆ–å¼‚å¸¸ï¼‰ï¼Œå®ƒå¯èƒ½éœ€è¦æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚æ­£å¦‚ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°çš„ï¼Œå®ƒå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å®Œæˆï¼šå‘½ä»¤å¼æˆ–å£°æ˜å¼</p>
<h2 id="14-1ã€å‘½ä»¤å¼-finally-å—"><a href="#14-1ã€å‘½ä»¤å¼-finally-å—" class="headerlink" title="14.1ã€å‘½ä»¤å¼ finally å—"></a>14.1ã€å‘½ä»¤å¼ finally å—</h2><p>é™¤äº† try&#x2F;catch å¤–ï¼Œæ”¶é›†å™¨è¿˜å¯ä»¥ä½¿ç”¨ finally åœ¨æ”¶é›†å®Œæˆæ—¶æ‰§è¡Œæ“ä½œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        foo().collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>æ­¤ä»£ç æ‰“å° fon() æµç”Ÿæˆçš„ä¸‰ä¸ªæ•°å­—ï¼Œä¹‹åè·Ÿéš â€œDoneâ€ å­—ç¬¦ä¸²</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<h2 id="14-2ã€å£°æ˜å¼å¤„ç†"><a href="#14-2ã€å£°æ˜å¼å¤„ç†" class="headerlink" title="14.2ã€å£°æ˜å¼å¤„ç†"></a>14.2ã€å£°æ˜å¼å¤„ç†</h2><p>å¯¹äºå£°æ˜æ€§æ–¹æ³•ï¼Œflow æœ‰ä¸€ä¸ª onCompletion ä¸­é—´è¿ç®—ç¬¦ï¼Œè¯¥è¿ç®—ç¬¦åœ¨æµå®Œå…¨æ”¶é›†åè°ƒç”¨</p>
<p>å‰é¢çš„ç¤ºä¾‹å¯ä»¥ä½¿ç”¨ onCompletion è¿ç®—ç¬¦é‡å†™ï¼Œå¹¶ç”Ÿæˆç›¸åŒçš„è¾“å‡ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line">    foo()</span><br><span class="line">        .onCompletion &#123; println(<span class="string">&quot;Done&quot;</span>) &#125;</span><br><span class="line">        .collect &#123; value -&gt; println(value) &#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br><span class="line">&#125;            </span><br></pre></td></tr></table></figure>

<p>onCompletion çš„ä¸»è¦ä¼˜ç‚¹æ˜¯åŒ…å«ä¸€ä¸ª lambda å‚æ•°ï¼Œè¯¥ lambda åŒ…å«ä¸€ä¸ªå¯ç©ºçš„ Throwable å‚æ•°ï¼Œè¯¥ Throwable å‚æ•°å¯ç”¨äºç¡®å®šæµæ”¶é›†æ˜¯æ­£å¸¸å®Œæˆè¿˜æ˜¯å¼‚å¸¸å®Œæˆã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œfoo() æµåœ¨å‘å‡ºæ•°å­—1åå¼•å‘å¼‚å¸¸ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    emit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">throw</span> RuntimeException()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    foo()</span><br><span class="line">        .onCompletion &#123; cause -&gt; <span class="keyword">if</span> (cause != <span class="literal">null</span>) println(<span class="string">&quot;Flow completed exceptionally&quot;</span>) &#125;</span><br><span class="line">        .<span class="keyword">catch</span> &#123; cause -&gt; println(<span class="string">&quot;Caught exception&quot;</span>) &#125;</span><br><span class="line">        .collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>å¦‚ä½ æ‰€æ–™ï¼Œå°†æ‰“å°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line">Flow completed exceptionally</span><br><span class="line">Caught exception</span><br></pre></td></tr></table></figure>

<p>ä¸ catch è¿ç®—ç¬¦ä¸åŒï¼ŒonCompletion è¿ç®—ç¬¦ä¸å¤„ç†å¼‚å¸¸ã€‚æ­£å¦‚æˆ‘ä»¬ä»ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­çœ‹åˆ°çš„ï¼Œå¼‚å¸¸ä»ç„¶ä¼šæµå‘ä¸‹æ¸¸ã€‚å®ƒå°†è¢«ä¼ é€’ç»™å…¶ä»–å®Œæˆ onCompletion è¿ç®—ç¬¦ï¼Œå¹¶å¯ä»¥ä½¿ç”¨ catch è¿ç®—ç¬¦è¿›è¡Œå¤„ç†</p>
<h2 id="14-3ã€ä»…é™ä¸Šæ¸¸å¼‚å¸¸"><a href="#14-3ã€ä»…é™ä¸Šæ¸¸å¼‚å¸¸" class="headerlink" title="14.3ã€ä»…é™ä¸Šæ¸¸å¼‚å¸¸"></a>14.3ã€ä»…é™ä¸Šæ¸¸å¼‚å¸¸</h2><p>å°±åƒ catch æ“ä½œç¬¦ä¸€æ ·ï¼ŒonCompletion åªçœ‹åˆ°æ¥è‡ªä¸Šæ¸¸çš„å¼‚å¸¸ï¼Œè€Œçœ‹ä¸åˆ°ä¸‹æ¸¸çš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œè¿è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    foo()</span><br><span class="line">        .onCompletion &#123; cause -&gt; println(<span class="string">&quot;Flow completed with <span class="variable">$cause</span>&quot;</span>) &#125;</span><br><span class="line">        .collect &#123; value -&gt;</span><br><span class="line">            check(value &lt;= <span class="number">1</span>) &#123; <span class="string">&quot;Collected <span class="variable">$value</span>&quot;</span> &#125;                 </span><br><span class="line">            println(value) </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°  completion cause ä¸ºç©ºï¼Œä½†æµæ”¶é›†å¤±è´¥å¹¶æŠ›å‡ºå¼‚å¸¸:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line">Flow completed with <span class="literal">null</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.IllegalStateException: Collected <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h1 id="åäº”ã€å‘½ä»¤å¼è¿˜æ˜¯å£°æ˜å¼"><a href="#åäº”ã€å‘½ä»¤å¼è¿˜æ˜¯å£°æ˜å¼" class="headerlink" title="åäº”ã€å‘½ä»¤å¼è¿˜æ˜¯å£°æ˜å¼"></a>åäº”ã€å‘½ä»¤å¼è¿˜æ˜¯å£°æ˜å¼</h1><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“å¦‚ä½•æ”¶é›†æµï¼Œå¹¶ä»¥å‘½ä»¤å¼å’Œå£°æ˜å¼çš„æ–¹å¼å¤„ç†å®ƒçš„å®Œæˆå’Œå¼‚å¸¸ã€‚è¿™é‡Œå¾ˆè‡ªç„¶çš„å°±æœ‰äº†ä¸ªé—®é¢˜ï¼Œåº”è¯¥é¦–é€‰å“ªç§æ–¹æ³•å‘¢ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿä½œä¸ºä¸€ä¸ªåº“ï¼Œæˆ‘ä»¬ä¸æå€¡ä»»ä½•ç‰¹å®šçš„æ–¹æ³•ï¼Œå¹¶ä¸”ç›¸ä¿¡è¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œåº”è¯¥æ ¹æ®ä½ è‡ªå·±çš„åå¥½å’Œä»£ç é£æ ¼æ¥é€‰æ‹©</p>
<h1 id="åå…­ã€å¯åŠ¨æµ"><a href="#åå…­ã€å¯åŠ¨æµ" class="headerlink" title="åå…­ã€å¯åŠ¨æµ"></a>åå…­ã€å¯åŠ¨æµ</h1><p>å¾ˆå®¹æ˜“ä½¿ç”¨æµæ¥è¡¨ç¤ºæ¥è‡ªæŸä¸ªæ•°æ®æºçš„å¼‚æ­¥äº‹ä»¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¨¡æ‹Ÿçš„ addEventListener å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä¸€æ®µä»£ç æ³¨å†Œä¸ºå¯¹ä¼ å…¥äº‹ä»¶çš„å“åº”ï¼Œå¹¶ç»§ç»­è¿›ä¸€æ­¥å·¥ä½œã€‚onEach è¿ç®—ç¬¦å¯ä»¥æ‹…ä»»æ­¤è§’è‰²ã€‚ç„¶è€Œï¼ŒonEach æ˜¯ä¸€ä¸ªä¸­é—´è¿ç®—ç¬¦ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç»ˆç«¯è¿ç®—ç¬¦æ¥æ”¶é›†æ•°æ®ã€‚å¦åˆ™ï¼Œåªæ³¨å†Œ onEach æ˜¯æ²¡æœ‰æ•ˆæœçš„</p>
<p>å¦‚æœåœ¨ onEach ä¹‹åä½¿ç”¨ collect ç»ˆç«¯è¿ç®—ç¬¦ï¼Œåˆ™åœ¨ collect ä¹‹åçš„ä»£ç å°†ç­‰å¾…æµè¢«æ”¶é›†å®Œæˆåå†è¿è¡Œï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="comment">// Imitate a flow of events</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">events</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    events()</span><br><span class="line">        .onEach &#123; event -&gt; println(<span class="string">&quot;Event: <span class="variable">$event</span>&quot;</span>) &#125;</span><br><span class="line">        .collect() <span class="comment">// &lt;--- Collecting the flow waits</span></span><br><span class="line">    println(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>å¦‚ä½ æ‰€è§ï¼Œå°†æ‰“å°</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Event: <span class="number">1</span></span><br><span class="line">Event: <span class="number">2</span></span><br><span class="line">Event: <span class="number">3</span></span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<p>launchIn ç»ˆç«¯è¿ç®—ç¬¦åœ¨è¿™é‡Œæ˜¯å¾ˆå®ç”¨çš„ã€‚é€šè¿‡å°† collect æ›¿æ¢ä¸º launchInï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å•ç‹¬çš„åç¨‹ä¸­å¯åŠ¨æ”¶é›†æµæ•°æ®çš„æ“ä½œï¼Œä»¥ä¾¿ç«‹å³ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥çš„ä»£ç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line"><span class="comment">// Imitate a flow of events</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">events</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//sampleStart</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    events()</span><br><span class="line">        .onEach &#123; event -&gt; println(<span class="string">&quot;Event: <span class="variable">$event</span>&quot;</span>) &#125;</span><br><span class="line">        .launchIn(<span class="keyword">this</span>) <span class="comment">// &lt;--- Launching the flow in a separate coroutine</span></span><br><span class="line">    println(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//sampleEnd</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Done</span><br><span class="line">Event: <span class="number">1</span></span><br><span class="line">Event: <span class="number">2</span></span><br><span class="line">Event: <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>launchIn æ‰€éœ€çš„å‚æ•°ç”¨äºæŒ‡å®šå¯åŠ¨ç”¨äºæ”¶é›†æµçš„åç¨‹çš„ä½œç”¨åŸŸã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ­¤ä½œç”¨åŸŸæ¥è‡ª runBlockingï¼Œå› æ­¤å½“æµè¿è¡Œæ—¶ï¼ŒrunBlocking ä½œç”¨åŸŸç­‰å¾…å…¶å­åç¨‹å®Œæˆï¼Œå¹¶é˜»æ­¢ä¸»å‡½æ•°è¿”å›å’Œç»ˆæ­¢æ­¤ç¤ºä¾‹ä»£ç </p>
<p>åœ¨å®é™…åº”ç”¨ç¨‹åºä¸­ï¼Œä½œç”¨åŸŸå°†æ¥è‡ªç”Ÿå‘½å‘¨æœŸæ˜¯æœ‰é™çš„å®ä½“ã€‚ä¸€æ—¦æ­¤å®ä½“çš„ç”Ÿå‘½å‘¨æœŸç»ˆæ­¢ï¼Œç›¸åº”çš„ä½œç”¨åŸŸå°†è¢«å–æ¶ˆï¼Œä»è€Œå–æ¶ˆç›¸åº”æµçš„æ”¶é›†ã€‚onEach { â€¦ }.launchIn(scope) çš„å·¥ä½œæ–¹å¼ä¸ addEventListener ç±»ä¼¼ã€‚ä½†æ˜¯ï¼Œä¸éœ€è¦ç›¸åº”çš„ removeEventListener å‡½æ•°ï¼Œå› ä¸º cancellation å’Œç»“æ„åŒ–å¹¶å‘å¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„</p>
<p>è¯·æ³¨æ„ï¼ŒlaunchIn è¿˜è¿”å›ä¸€ä¸ª Job å¯¹è±¡ï¼Œè¯¥ Job ä»…å¯ç”¨äºå–æ¶ˆç›¸åº”çš„æµæ•°æ®æ”¶é›†åç¨‹ï¼Œè€Œä¸å–æ¶ˆæ•´ä¸ªä½œç”¨åŸŸæˆ–åŠ å…¥å®ƒ</p>
<h1 id="åä¸ƒã€Flow-and-Reactive-Streams"><a href="#åä¸ƒã€Flow-and-Reactive-Streams" class="headerlink" title="åä¸ƒã€Flow and Reactive Streams"></a>åä¸ƒã€Flow and Reactive Streams</h1><p>For those who are familiar with Reactive Streams or reactive frameworks such as RxJava and project Reactor, design of the Flow may look very familiar.</p>
<p>Indeed, its design was inspired by Reactive Streams and its various implementations. But Flow main goal is to have as simple design as possible, be Kotlin and suspension friendly and respect structured concurrency. Achieving this goal would be impossible without reactive pioneers and their tremendous work. You can read the complete story in Reactive Streams and Kotlin Flows article.</p>
<p>While being different, conceptually, Flow is a reactive stream and it is possible to convert it to the reactive (spec and TCK compliant) Publisher and vice versa. Such converters are provided by kotlinx.coroutines out-of-the-box and can be found in corresponding reactive modules (kotlinx-coroutines-reactive for Reactive Streams, kotlinx-coroutines-reactor for Project Reactor and kotlinx-coroutines-rx2 for RxJava2). Integration modules include conversions from and to Flow, integration with Reactorâ€™s Context and suspension-friendly ways to work with various reactive entities.</p>

  </article>
  <!-- tag -->
  <div class="mt-12 pt-6 border-t border-gray-200">
    
  </div>
  <!-- prev and next -->
  <div class="flex justify-between mt-12 pt-6 border-t border-gray-200">
    <div>
      
        <a href="/hexo-blog/public/2025/03/02/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%882%EF%BC%89%E5%8F%96%E6%B6%88%E5%92%8C%E8%B6%85%E6%97%B6/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          <iconify-icon width="20" icon="ri:arrow-left-s-line" data-inline="false"></iconify-icon>
          Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ2ï¼‰å–æ¶ˆå’Œè¶…æ—¶
        </a>
      
    </div>
    <div>
      
        <a href="/hexo-blog/public/2025/03/02/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%884%EF%BC%89%E5%8D%8F%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E8%B0%83%E5%BA%A6%E5%99%A8/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ4ï¼‰åç¨‹ä¸Šä¸‹æ–‡å’Œè°ƒåº¦å™¨
          <iconify-icon width="20" icon="ri:arrow-right-s-line" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>
  <!-- comment -->
  <div class="article-comments mt-12">
    
<script
  src="https://giscus.app/client.js"
  data-repo="hqqich/giscus"
  data-repo-id="R_kgDOOCZUBA"
  data-category="General"
  data-category-id="DIC_kwDOOCZUBM4Cng1l"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="preferred_color_scheme"
  data-lang="zh-CN"
  crossorigin="anonymous"
  async
></script>
<script>
  window.onload = function () {
    console.log("giscus loaded");
    const isDark = document.documentElement.classList.contains("dark");
    const giscusFrame = document.querySelector("iframe.giscus-frame");
    giscusFrame.contentWindow.postMessage(
      {
        giscus: {
          setConfig: {
            theme: isDark ? "dark" : "light",
          },
        },
      },
      "https://giscus.app"
    );
  };
</script>


  </div>
</section>
<!-- js inspect -->

<script src="/hexo-blog/public/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/hexo-blog/public/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + alt + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/hexo-blog/public/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->


  </main>
  <footer class="flex flex-col h-40 items-center justify-center text-gray-400 text-sm">
  <!-- busuanzi -->
  
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex items-center gap-2">
  <span>Visitors</span>
  <span id="busuanzi_value_site_uv"></span>
  <span>Page Views</span>
  <span id="busuanzi_value_site_pv"></span>
</div>
<!-- End Busuanzi Analytics -->


  <!-- copyright -->
  <div class="flex items-center gap-2">
    <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: inherit;">CC BY-NC-SA 4.0</a>
    <span>Â© 2022</span>
    <iconify-icon width="18" icon="emojione-monotone:maple-leaf" ></iconify-icon>
    <a href="https://github.com/xbmlz" target="_blank" rel="noopener noreferrer">xbmlz</a>
  </div>
  <!-- powered by -->
  <div class="flex items-center gap-2">
    <span>Powered by</span>
    <a href="https://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a>
    <span>&</span>
    <a href="https://github.com/xbmlz/hexo-theme-maple" target="_blank" rel="noopener noreferrer">Maple</a>
  </div>

</footer>

  <div class="back-to-top box-border fixed right-6 z-1024 -bottom-20 rounded py-1 px-1 bg-slate-900 opacity-60 text-white cursor-pointer text-center dark:bg-slate-600">
    <span class="flex justify-center items-center text-sm">
      <iconify-icon width="18" icon="ion:arrow-up-c" id="go-top"></iconify-icon>
      <span id="scrollpercent"><span>0</span> %</span>
    </span>
  </div>
  
<script src="/hexo-blog/public/js/main.js"></script>


  <script>
    $(document).ready(function () {
      const mapleCount = "10";
      const speed = "0.5";
      const mapleEl = document.getElementById("maple");
      const maples = Array.from({ length: mapleCount }).map(() => {
        const maple = document.createElement("div");
        const scale = Math.random() * 0.5 + 0.5;
        const offset = Math.random() * 2 - 1;
        const x = Math.random() * mapleEl.clientWidth;
        const y = -Math.random() * mapleEl.clientHeight;
        const duration = 10 / speed;
        const delay = -duration;
        maple.className = "maple";
        maple.style.width = `${24 * scale}px`;
        maple.style.height = `${24 * scale}px`;
        maple.style.left = `${x}px`;
        maple.style.top = `${y}px`;
        maple.style.setProperty("--maple-fall-offset", offset);
        maple.style.setProperty("--maple-fall-height", `${Math.abs(y) + mapleEl.clientHeight}px`);
        maple.style.animation = `fall ${duration}s linear infinite`;
        maple.style.animationDelay = `${delay}s`;
        mapleEl.appendChild(maple)
        return maple
      })
    });
  </script>
  


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
