<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head><script src="/hugo-blog/public/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=hugo-blog/public/livereload" data-no-instant defer></script>
  <title>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ :: Hugo Theme Tailwind Example Site - Example site for hugo-theme-tailwind</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content=" å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„ å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£
æœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº Kotlinåç¨‹ çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§
åç¨‹å®˜æ–¹æ–‡æ¡£ï¼šcoroutines-guide æŒ‚èµ·å‡½æ•°å¯ä»¥å¼‚æ­¥è¿”å›å•ä¸ªå€¼ï¼Œä½†å¦‚ä½•è¿”å›å¤šä¸ªå¼‚æ­¥è®¡ç®—å€¼å‘¢ï¼Ÿè¿™å°±æ˜¯ kotlin Flowsï¼ˆæµï¼‰ çš„ç”¨å¤„äº†
ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼ å¯ä»¥ä½¿ç”¨é›†åˆåœ¨ kotlin ä¸­è¡¨ç¤ºå¤šä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªå‡½æ•° foo()ï¼Œå®ƒè¿”å›åŒ…å«ä¸‰ä¸ªæ•°å­—çš„ Listï¼Œç„¶åä½¿ç”¨ forEach æ‰“å°å®ƒä»¬
fun foo(): List&lt;Int&gt; = listOf(1, 2, 3) fun main() { foo().forEach { value -&gt; println(value) } } è¾“å‡ºç»“æœï¼š
1 2 3 1.1ã€åºåˆ— å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€äº› CPU æ¶ˆè€—å‹ çš„é˜»å¡ä»£ç ï¼ˆæ¯æ¬¡è®¡ç®—éœ€è¦100æ¯«ç§’ï¼‰æ¥è®¡ç®—æ•°å­—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåºåˆ—(Sequence)æ¥è¡¨ç¤ºæ•°å­—ï¼š
fun foo(): Sequence&lt;Int&gt; = sequence { // sequence builder for (i in 1..3) { Thread.sleep(100) // pretend we are computing it yield(i) // yield next value } } fun main() { foo().forEach { value -&gt; println(value) } } è¿™æ®µä»£ç è¾“å‡ºç›¸åŒçš„æ•°å­—åˆ—è¡¨ï¼Œä½†æ¯æ‰“å°ä¸€ä¸ªæ•°å­—å‰éƒ½éœ€è¦ç­‰å¾…100æ¯«ç§’
1.2ã€æŒ‚èµ·å‡½æ•° ä¸Šä¸€èŠ‚çš„ä»£ç çš„è®¡ç®—æ“ä½œä¼šé˜»å¡è¿è¡Œä»£ç çš„ä¸»çº¿ç¨‹ã€‚å½“è¿™äº›å€¼ç”±å¼‚æ­¥ä»£ç è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ suspend ä¿®é¥°ç¬¦æ ‡è®°å‡½æ•° fooï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨ä¸é˜»å¡çš„æƒ…å†µä¸‹æ‰§è¡Œå…¶å·¥ä½œï¼Œå¹¶å°†ç»“æœä½œä¸ºåˆ—è¡¨è¿”å›
import kotlinx.coroutines.* //sampleStart suspend fun foo(): List&lt;Int&gt; { delay(1000) // pretend we are doing something asynchronous here return listOf(1, 2, 3) } fun main() = runBlocking&lt;Unit&gt; { foo().forEach { value -&gt; println(value) } } //sampleEnd è¿™æ®µä»£ç åœ¨ç­‰å¾…ä¸€ç§’åè¾“å‡ºæ•°å­—
"
/>
<meta
  name="keywords"
  content="hugo, tailwind, tailwindcss, hugo theme, hugo theme tailwind"
/>
<meta name="robots" content="noodp" /><link rel="manifest" href="/manifest.json" /><meta property="og:url" content="http://localhost:1313/hugo-blog/public/post/kotlin/kotlin-%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A35%E5%BC%82%E6%AD%A5%E6%B5%81/">
  <meta property="og:site_name" content="Hugo Theme Tailwind Example Site">
  <meta property="og:title" content="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ">
  <meta property="og:description" content="å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„ å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£
æœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº Kotlinåç¨‹ çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§
åç¨‹å®˜æ–¹æ–‡æ¡£ï¼šcoroutines-guide æŒ‚èµ·å‡½æ•°å¯ä»¥å¼‚æ­¥è¿”å›å•ä¸ªå€¼ï¼Œä½†å¦‚ä½•è¿”å›å¤šä¸ªå¼‚æ­¥è®¡ç®—å€¼å‘¢ï¼Ÿè¿™å°±æ˜¯ kotlin Flowsï¼ˆæµï¼‰ çš„ç”¨å¤„äº†
ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼ å¯ä»¥ä½¿ç”¨é›†åˆåœ¨ kotlin ä¸­è¡¨ç¤ºå¤šä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªå‡½æ•° foo()ï¼Œå®ƒè¿”å›åŒ…å«ä¸‰ä¸ªæ•°å­—çš„ Listï¼Œç„¶åä½¿ç”¨ forEach æ‰“å°å®ƒä»¬
fun foo(): List&lt;Int&gt; = listOf(1, 2, 3) fun main() { foo().forEach { value -&gt; println(value) } } è¾“å‡ºç»“æœï¼š
1 2 3 1.1ã€åºåˆ— å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€äº› CPU æ¶ˆè€—å‹ çš„é˜»å¡ä»£ç ï¼ˆæ¯æ¬¡è®¡ç®—éœ€è¦100æ¯«ç§’ï¼‰æ¥è®¡ç®—æ•°å­—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåºåˆ—(Sequence)æ¥è¡¨ç¤ºæ•°å­—ï¼š
fun foo(): Sequence&lt;Int&gt; = sequence { // sequence builder for (i in 1..3) { Thread.sleep(100) // pretend we are computing it yield(i) // yield next value } } fun main() { foo().forEach { value -&gt; println(value) } } è¿™æ®µä»£ç è¾“å‡ºç›¸åŒçš„æ•°å­—åˆ—è¡¨ï¼Œä½†æ¯æ‰“å°ä¸€ä¸ªæ•°å­—å‰éƒ½éœ€è¦ç­‰å¾…100æ¯«ç§’
1.2ã€æŒ‚èµ·å‡½æ•° ä¸Šä¸€èŠ‚çš„ä»£ç çš„è®¡ç®—æ“ä½œä¼šé˜»å¡è¿è¡Œä»£ç çš„ä¸»çº¿ç¨‹ã€‚å½“è¿™äº›å€¼ç”±å¼‚æ­¥ä»£ç è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ suspend ä¿®é¥°ç¬¦æ ‡è®°å‡½æ•° fooï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨ä¸é˜»å¡çš„æƒ…å†µä¸‹æ‰§è¡Œå…¶å·¥ä½œï¼Œå¹¶å°†ç»“æœä½œä¸ºåˆ—è¡¨è¿”å›
import kotlinx.coroutines.* //sampleStart suspend fun foo(): List&lt;Int&gt; { delay(1000) // pretend we are doing something asynchronous here return listOf(1, 2, 3) } fun main() = runBlocking&lt;Unit&gt; { foo().forEach { value -&gt; println(value) } } //sampleEnd è¿™æ®µä»£ç åœ¨ç­‰å¾…ä¸€ç§’åè¾“å‡ºæ•°å­—">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ">
  <meta name="twitter:description" content="å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„ å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£
æœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº Kotlinåç¨‹ çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§
åç¨‹å®˜æ–¹æ–‡æ¡£ï¼šcoroutines-guide æŒ‚èµ·å‡½æ•°å¯ä»¥å¼‚æ­¥è¿”å›å•ä¸ªå€¼ï¼Œä½†å¦‚ä½•è¿”å›å¤šä¸ªå¼‚æ­¥è®¡ç®—å€¼å‘¢ï¼Ÿè¿™å°±æ˜¯ kotlin Flowsï¼ˆæµï¼‰ çš„ç”¨å¤„äº†
ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼ å¯ä»¥ä½¿ç”¨é›†åˆåœ¨ kotlin ä¸­è¡¨ç¤ºå¤šä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªå‡½æ•° foo()ï¼Œå®ƒè¿”å›åŒ…å«ä¸‰ä¸ªæ•°å­—çš„ Listï¼Œç„¶åä½¿ç”¨ forEach æ‰“å°å®ƒä»¬
fun foo(): List&lt;Int&gt; = listOf(1, 2, 3) fun main() { foo().forEach { value -&gt; println(value) } } è¾“å‡ºç»“æœï¼š
1 2 3 1.1ã€åºåˆ— å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€äº› CPU æ¶ˆè€—å‹ çš„é˜»å¡ä»£ç ï¼ˆæ¯æ¬¡è®¡ç®—éœ€è¦100æ¯«ç§’ï¼‰æ¥è®¡ç®—æ•°å­—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåºåˆ—(Sequence)æ¥è¡¨ç¤ºæ•°å­—ï¼š
fun foo(): Sequence&lt;Int&gt; = sequence { // sequence builder for (i in 1..3) { Thread.sleep(100) // pretend we are computing it yield(i) // yield next value } } fun main() { foo().forEach { value -&gt; println(value) } } è¿™æ®µä»£ç è¾“å‡ºç›¸åŒçš„æ•°å­—åˆ—è¡¨ï¼Œä½†æ¯æ‰“å°ä¸€ä¸ªæ•°å­—å‰éƒ½éœ€è¦ç­‰å¾…100æ¯«ç§’
1.2ã€æŒ‚èµ·å‡½æ•° ä¸Šä¸€èŠ‚çš„ä»£ç çš„è®¡ç®—æ“ä½œä¼šé˜»å¡è¿è¡Œä»£ç çš„ä¸»çº¿ç¨‹ã€‚å½“è¿™äº›å€¼ç”±å¼‚æ­¥ä»£ç è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ suspend ä¿®é¥°ç¬¦æ ‡è®°å‡½æ•° fooï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨ä¸é˜»å¡çš„æƒ…å†µä¸‹æ‰§è¡Œå…¶å·¥ä½œï¼Œå¹¶å°†ç»“æœä½œä¸ºåˆ—è¡¨è¿”å›
import kotlinx.coroutines.* //sampleStart suspend fun foo(): List&lt;Int&gt; { delay(1000) // pretend we are doing something asynchronous here return listOf(1, 2, 3) } fun main() = runBlocking&lt;Unit&gt; { foo().forEach { value -&gt; println(value) } } //sampleEnd è¿™æ®µä»£ç åœ¨ç­‰å¾…ä¸€ç§’åè¾“å‡ºæ•°å­—">


<link rel="canonical" href="http://localhost:1313/hugo-blog/public/post/kotlin/kotlin-%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A35%E5%BC%82%E6%AD%A5%E6%B5%81/" />

<link rel="shortcut icon" href="/hugo-blog/public/favicon.ico" />
<link rel="stylesheet" href="/hugo-blog/public/css/index.c3a5d1586276a68cf55558ab67f2c726fee27f4aea3add1802872f471c5f233d.css">









  
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Xiaoliang Wang"},"dateModified":"0001-01-01T00:00:00Z","datePublished":"0001-01-01T00:00:00Z","description":" å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„ å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£\næœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº Kotlinåç¨‹ çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§\nåç¨‹å®˜æ–¹æ–‡æ¡£ï¼šcoroutines-guide æŒ‚èµ·å‡½æ•°å¯ä»¥å¼‚æ­¥è¿”å›å•ä¸ªå€¼ï¼Œä½†å¦‚ä½•è¿”å›å¤šä¸ªå¼‚æ­¥è®¡ç®—å€¼å‘¢ï¼Ÿè¿™å°±æ˜¯ kotlin Flowsï¼ˆæµï¼‰ çš„ç”¨å¤„äº†\nä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼ å¯ä»¥ä½¿ç”¨é›†åˆåœ¨ kotlin ä¸­è¡¨ç¤ºå¤šä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªå‡½æ•° foo()ï¼Œå®ƒè¿”å›åŒ…å«ä¸‰ä¸ªæ•°å­—çš„ Listï¼Œç„¶åä½¿ç”¨ forEach æ‰“å°å®ƒä»¬\nfun foo(): List\u0026lt;Int\u0026gt; = listOf(1, 2, 3) fun main() { foo().forEach { value -\u0026gt; println(value) } } è¾“å‡ºç»“æœï¼š\n1 2 3 1.1ã€åºåˆ— å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€äº› CPU æ¶ˆè€—å‹ çš„é˜»å¡ä»£ç ï¼ˆæ¯æ¬¡è®¡ç®—éœ€è¦100æ¯«ç§’ï¼‰æ¥è®¡ç®—æ•°å­—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåºåˆ—(Sequence)æ¥è¡¨ç¤ºæ•°å­—ï¼š\nfun foo(): Sequence\u0026lt;Int\u0026gt; = sequence { // sequence builder for (i in 1..3) { Thread.sleep(100) // pretend we are computing it yield(i) // yield next value } } fun main() { foo().forEach { value -\u0026gt; println(value) } } è¿™æ®µä»£ç è¾“å‡ºç›¸åŒçš„æ•°å­—åˆ—è¡¨ï¼Œä½†æ¯æ‰“å°ä¸€ä¸ªæ•°å­—å‰éƒ½éœ€è¦ç­‰å¾…100æ¯«ç§’\n1.2ã€æŒ‚èµ·å‡½æ•° ä¸Šä¸€èŠ‚çš„ä»£ç çš„è®¡ç®—æ“ä½œä¼šé˜»å¡è¿è¡Œä»£ç çš„ä¸»çº¿ç¨‹ã€‚å½“è¿™äº›å€¼ç”±å¼‚æ­¥ä»£ç è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ suspend ä¿®é¥°ç¬¦æ ‡è®°å‡½æ•° fooï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨ä¸é˜»å¡çš„æƒ…å†µä¸‹æ‰§è¡Œå…¶å·¥ä½œï¼Œå¹¶å°†ç»“æœä½œä¸ºåˆ—è¡¨è¿”å›\nimport kotlinx.coroutines.* //sampleStart suspend fun foo(): List\u0026lt;Int\u0026gt; { delay(1000) // pretend we are doing something asynchronous here return listOf(1, 2, 3) } fun main() = runBlocking\u0026lt;Unit\u0026gt; { foo().forEach { value -\u0026gt; println(value) } } //sampleEnd è¿™æ®µä»£ç åœ¨ç­‰å¾…ä¸€ç§’åè¾“å‡ºæ•°å­—\n","name":"Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ","url":"http://localhost:1313/hugo-blog/public/post/kotlin/kotlin-%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A35%E5%BC%82%E6%AD%A5%E6%B5%81/"}
</script>

</head>
<body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800">
    
<div class="fixed right-0 top-0 z-50 flex items-center justify-center bg-gray-200 p-2 text-sm uppercase text-black sm:bg-red-200 md:bg-yellow-200 lg:bg-green-200 xl:bg-blue-200 2xl:bg-pink-200">
  <span class="block sm:hidden">all</span>
  <span class="hidden sm:block md:hidden">sm</span>
  <span class="hidden md:block lg:hidden">md</span>
  <span class="hidden lg:block xl:hidden">lg</span>
  <span class="hidden xl:block 2xl:hidden">xl</span>
  <span class="hidden 2xl:block">2xl</span>
</div>

  <header class="flex flex-none justify-center z-10">
    <div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3">
  <div class="flex-none ml-2 md:ml-0">
    <a href="/hugo-blog/public/" class="">
      <img class="h-12 w-12 rounded-full object-cover bg-gray-100" src="/hugo-blog/public/logo.svg" alt="logo">
    </a>
  </div>
  
  <h1 class="hidden md:flex flex-col justify-center mx-2">
    <a href="/hugo-blog/public/" class="text-2xl font-semibold text-slate-800 dark:text-slate-200">
      Hugo Theme Tailwind
    </a>
  </h1>
  
  <div class="flex-1"></div>
  <div class="flex-none">
    



<nav class="h-full static">
  <button id="navbar-menu-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls="navbar-menu" aria-expanded="false">
    <span class="sr-only">Open main menu</span>
    <i class="w-8 h-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 6l16 0" />
  <path d="M4 12l16 0" />
  <path d="M4 18l16 0" />
</svg>

    </i>
  </button>
  <div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id="navbar-menu">
    <ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-xs md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
    
        <li id="post" class="">
          <a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600"
            href="/hugo-blog/public/post/" title="Post">Post</a>
        </li>
      
    
        <li id="about" class="">
          <a class="block px-3 py-3 hover:text-emerald-600"
            href="/hugo-blog/public/about/" title="About">About</a>
        </li>
      
    
    </ul>
  </div>
</nav>


  </div>
  
  <div class="flex-none">
    <div class="h-full static">
      <button id="navbar-lang-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
        <span class="sr-only">Open language switcher</span>
        <i class="w-8 h-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c0 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>

        </i>
      </button>
      <div class="absolute hidden top-16 z-50" id="navbar-lang">
        <ul class="flex flex-col rounded-xs px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
          <li class="">
            <span class="block px-3 py-3 cursor-default hover:text-emerald-600">English</span>
            </li>
        
        </ul>
      </div>
    </div>
  </div>
  
  <div class="flex-none md:hidden">
    <a href=/hugo-blog/public/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
      <span class="sr-only">Search</span>
      <i class="w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
    <path d="M21 21l-6 -6" />
</svg>

      </i>
    </a>
  </div>
  <div class="darkmode-toggle flex flex-none mr-2 md:mr-0">
    <label for="darkmode-toggle" class="relative flex items-center gap-1 px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode">
      <input name="darkmode-toggle" id="darkmode-toggle" type="checkbox" class="sr-only peer" aria-label="Toggle dark mode">
      <div class="absolute z-10 w-15 h-8 rounded-full bg-white dark:bg-gray-700"></div>
      <i class="h-6 w-6 z-20 ml-1 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:invisible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
   <path d="M12 5l0 .01"></path>
   <path d="M17 7l0 .01"></path>
   <path d="M19 12l0 .01"></path>
   <path d="M17 17l0 .01"></path>
   <path d="M12 19l0 .01"></path>
   <path d="M7 17l0 .01"></path>
   <path d="M5 12l0 .01"></path>
   <path d="M7 7l0 .01"></path>
</svg>

      </i>
      <i class="h-6 w-6 z-20 mr-1 flex-none rounded-full place-self-center invisible peer-checked:visible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
   <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
   <path d="M19 11h2m-1 -1v2"></path>
</svg>

      </i>
    </label>
  </div>
</div>

  </header>
  <main class="flex flex-auto justify-center">
    
<div id="progress" class="fixed top-0 left-0 w-full h-1 bg-blue-500"></div>
<div class="w-full max-w-4xl lg:max-w-5xl">
  <div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700">
    <div>
      <a href="/hugo-blog/public/post/kotlin/kotlin-%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A35%E5%BC%82%E6%AD%A5%E6%B5%81/">
        
      </a>
    </div>
    <div class="flex flex-col gap-y-3 p-6">
      <h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100">
        <a href="/hugo-blog/public/post/kotlin/kotlin-%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A35%E5%BC%82%E6%AD%A5%E6%B5%81/">Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ</a>
      </h1>

      
      


      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M6.5 7h11"></path>
   <path d="M6 20v-2a6 6 0 1 1 12 0v2a1 1 0 0 1 -1 1h-10a1 1 0 0 1 -1 -1z"></path>
   <path d="M6 4v2a6 6 0 1 0 12 0v-2a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1z"></path>
</svg>

    </i>
    <span>
      15 minutes to read
    </span>
  </div>
</div>

      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
    class="icon icon-tabler icons-tabler-outline icon-tabler-user">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>

    </i>
    <span>Xiaoliang Wang</span>
  </div>
</div>

      
        
        <section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6">
          <h2>Table of Contents</h2>
          <aside><nav id="TableOfContents">
  <ul>
    <li><a href="#11åºåˆ—">1.1ã€åºåˆ—</a></li>
    <li><a href="#12æŒ‚èµ·å‡½æ•°">1.2ã€æŒ‚èµ·å‡½æ•°</a></li>
    <li><a href="#13flows">1.3ã€Flows</a></li>
  </ul>

  <ul>
    <li><a href="#51è½¬æ¢æ“ä½œç¬¦">5.1ã€è½¬æ¢æ“ä½œç¬¦</a></li>
    <li><a href="#52é™é•¿è¿ç®—ç¬¦">5.2ã€é™é•¿è¿ç®—ç¬¦</a></li>
  </ul>

  <ul>
    <li><a href="#81é”™è¯¯åœ°ä½¿ç”¨-withcontext">8.1ã€é”™è¯¯åœ°ä½¿ç”¨ withContext</a></li>
    <li><a href="#82flowon-è¿ç®—ç¬¦">8.2ã€flowOn è¿ç®—ç¬¦</a></li>
  </ul>

  <ul>
    <li><a href="#91åˆå¹¶">9.1ã€åˆå¹¶</a></li>
    <li><a href="#92å¤„ç†æœ€æ–°å€¼">9.2ã€å¤„ç†æœ€æ–°å€¼</a></li>
  </ul>

  <ul>
    <li><a href="#101zip">10.1ã€zip</a></li>
    <li><a href="#102combine">10.2ã€Combine</a></li>
  </ul>

  <ul>
    <li><a href="#111flatmapconcat">11.1ã€flatMapConcat</a></li>
    <li><a href="#112flatmapmerge">11.2ã€flatMapMerge</a></li>
    <li><a href="#113flatmaplatest">11.3ã€flatMapLatest</a></li>
  </ul>

  <ul>
    <li><a href="#121æ”¶é›†å™¨-try-ä¸-catch">12.1ã€æ”¶é›†å™¨ try ä¸ catch</a></li>
    <li><a href="#122ä¸€åˆ‡éƒ½å·²æ•è·">12.2ã€ä¸€åˆ‡éƒ½å·²æ•è·</a></li>
  </ul>

  <ul>
    <li><a href="#131é€æ˜æ•è·">13.1ã€é€æ˜æ•è·</a></li>
    <li><a href="#132å£°æ˜å¼æ•è·">13.2ã€å£°æ˜å¼æ•è·</a></li>
  </ul>

  <ul>
    <li><a href="#141å‘½ä»¤å¼-finally-å—">14.1ã€å‘½ä»¤å¼ finally å—</a></li>
    <li><a href="#142å£°æ˜å¼å¤„ç†">14.2ã€å£°æ˜å¼å¤„ç†</a></li>
    <li><a href="#143ä»…é™ä¸Šæ¸¸å¼‚å¸¸">14.3ã€ä»…é™ä¸Šæ¸¸å¼‚å¸¸</a></li>
  </ul>
</nav></aside>
        </section>
        
      

      <article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content">
        <blockquote>
<p>å…¬ä¼—å·ï¼š<a href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image" target="_blank" rel="noopener">å­—èŠ‚æ•°ç»„</a>
</p>
<p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p></blockquote>
<blockquote>
<p>æœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº <strong>Kotlinåç¨‹</strong> çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§</p>
<p>åç¨‹å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md" target="_blank" rel="noopener">coroutines-guide</a>
</p></blockquote>
<p>æŒ‚èµ·å‡½æ•°å¯ä»¥å¼‚æ­¥è¿”å›å•ä¸ªå€¼ï¼Œä½†å¦‚ä½•è¿”å›å¤šä¸ªå¼‚æ­¥è®¡ç®—å€¼å‘¢ï¼Ÿè¿™å°±æ˜¯ kotlin Flowsï¼ˆæµï¼‰ çš„ç”¨å¤„äº†</p>
<h1 id="ä¸€è¡¨ç¤ºå¤šä¸ªå€¼">ä¸€ã€è¡¨ç¤ºå¤šä¸ªå€¼</h1>
<p>å¯ä»¥ä½¿ç”¨é›†åˆåœ¨ kotlin ä¸­è¡¨ç¤ºå¤šä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªå‡½æ•° foo()ï¼Œå®ƒè¿”å›åŒ…å«ä¸‰ä¸ªæ•°å­—çš„ Listï¼Œç„¶åä½¿ç”¨ forEach æ‰“å°å®ƒä»¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">().</span><span class="n">forEach</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¾“å‡ºç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span></code></pre></div><h2 id="11åºåˆ—">1.1ã€åºåˆ—</h2>
<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€äº› CPU æ¶ˆè€—å‹ çš„é˜»å¡ä»£ç ï¼ˆæ¯æ¬¡è®¡ç®—éœ€è¦100æ¯«ç§’ï¼‰æ¥è®¡ç®—æ•°å­—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåºåˆ—(Sequence)æ¥è¡¨ç¤ºæ•°å­—ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Sequence</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">sequence</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sequence builder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are computing it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">yield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// yield next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">().</span><span class="n">forEach</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç è¾“å‡ºç›¸åŒçš„æ•°å­—åˆ—è¡¨ï¼Œä½†æ¯æ‰“å°ä¸€ä¸ªæ•°å­—å‰éƒ½éœ€è¦ç­‰å¾…100æ¯«ç§’</p>
<h2 id="12æŒ‚èµ·å‡½æ•°">1.2ã€æŒ‚èµ·å‡½æ•°</h2>
<p>ä¸Šä¸€èŠ‚çš„ä»£ç çš„è®¡ç®—æ“ä½œä¼šé˜»å¡è¿è¡Œä»£ç çš„ä¸»çº¿ç¨‹ã€‚å½“è¿™äº›å€¼ç”±å¼‚æ­¥ä»£ç è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ suspend ä¿®é¥°ç¬¦æ ‡è®°å‡½æ•° fooï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨ä¸é˜»å¡çš„æƒ…å†µä¸‹æ‰§è¡Œå…¶å·¥ä½œï¼Œå¹¶å°†ç»“æœä½œä¸ºåˆ—è¡¨è¿”å›</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>                 
</span></span><span class="line"><span class="cl">                           
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="c1">// pretend we are doing something asynchronous here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">listOf</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">().</span><span class="n">forEach</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>è¿™æ®µä»£ç åœ¨ç­‰å¾…ä¸€ç§’åè¾“å‡ºæ•°å­—</p>
<h2 id="13flows">1.3ã€Flows</h2>
<p>ä½¿ç”¨ List&lt; Int &gt; ä½œä¸ºè¿”å›å€¼ç±»å‹ï¼Œæ„å‘³ç€æˆ‘ä»¬åªèƒ½åŒæ—¶è¿”å›æ‰€æœ‰å€¼ã€‚ä¸ºäº†è¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„å€¼æµï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Flow&lt; Int &gt; ç±»å‹ï¼Œå°±åƒåŒæ­¥è®¡ç®—å€¼çš„ Sequence&lt; Int &gt; ç±»å‹ä¸€æ ·</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span> <span class="c1">// flow builder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are doing something useful here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Launch a concurrent coroutine to check if the main thread is blocked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">launch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;I&#39;m not blocked </span><span class="si">$k</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Collect the flow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>æ­¤ä»£ç åœ¨æ‰“å°æ¯ä¸ªæ•°å­—å‰ç­‰å¾…100æ¯«ç§’ï¼Œä½†ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚é€šè¿‡ä»ä¸»çº¿ç¨‹ä¸­è¿è¡Œçš„å•ç‹¬åç¨‹ä¸­æ¯éš”100æ¯«ç§’æ‰“å°äº†ä¸€æ¬¡ â€œI&rsquo;m not blockedâ€ï¼Œå¯ä»¥éªŒè¯è¿™ä¸€ç‚¹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">I</span><span class="err">&#39;</span><span class="n">m</span> <span class="n">not</span> <span class="n">blocked</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">I</span><span class="err">&#39;</span><span class="n">m</span> <span class="n">not</span> <span class="n">blocked</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">I</span><span class="err">&#39;</span><span class="n">m</span> <span class="n">not</span> <span class="n">blocked</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span></code></pre></div><p>è¯·æ³¨æ„ï¼Œä»£ç ä¸å‰é¢ç¤ºä¾‹ä¸­çš„ Flow æœ‰ä»¥ä¸‹ä¸åŒï¼š</p>
<ul>
<li>Flow ç±»å‹çš„æ„é€ å™¨å‡½æ•°åä¸º flow</li>
<li>flow{&hellip;} ä¸­çš„ä»£ç å—å¯ä»¥æŒ‚èµ·</li>
<li>foo å‡½æ•°ä¸å†æ ‡è®° suspend ä¿®é¥°ç¬¦</li>
<li>å€¼é€šè¿‡ emit å‡½æ•°ä»æµä¸­å‘å‡º</li>
<li>é€šè¿‡ collect å‡½æ•°ä» flow ä¸­å–å€¼</li>
</ul>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ Thread.sleep æ¥ä»£æ›¿ flow{&hellip;} ä¸­çš„ delayï¼Œå¯ä»¥çœ‹åˆ°åœ¨è¿™ç§æƒ…å†µä¸‹ä¸»çº¿ç¨‹è¢«é˜»å¡ä½äº†</p></blockquote>
<h1 id="äºŒæµæ˜¯å†·çš„">äºŒã€æµæ˜¯å†·çš„</h1>
<p>Flows æ˜¯å†·æµï¼ˆcold streamsï¼‰ï¼Œç±»ä¼¼äºåºåˆ—ï¼ˆsequencesï¼‰ï¼Œflow builder ä¸­çš„ä»£ç åœ¨å¼€å§‹æ”¶é›†æµå€¼ä¹‹å‰ä¸ä¼šè¿è¡Œã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart      
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Flow started&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Calling foo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">flow</span> <span class="p">=</span> <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Calling collect...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flow</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Calling collect again...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flow</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Calling</span> <span class="n">foo</span><span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Calling</span> <span class="n">collect</span><span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Flow</span> <span class="n">started</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Calling</span> <span class="n">collect</span> <span class="n">again</span><span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Flow</span> <span class="n">started</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span></code></pre></div><p>è¿™æ˜¯ foo() å‡½æ•°ï¼ˆè¿”å›äº† flowï¼‰æœªæ ‡è®° <code>suspend</code> ä¿®é¥°ç¬¦çš„ä¸€ä¸ªå…³é”®åŸå› ã€‚<code>foo()</code> æœ¬èº«è¿”å›å¾ˆå¿«ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•ç­‰å¾…ã€‚flow æ¯æ¬¡æ”¶é›†æ—¶éƒ½ä¼šå¯åŠ¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å†æ¬¡è°ƒç”¨ <code>collect</code> æ—¶ä¼šçœ‹åˆ°â€œflow startedâ€çš„åŸå› </p>
<h1 id="ä¸‰å–æ¶ˆæµ">ä¸‰ã€å–æ¶ˆæµ</h1>
<p>Flow é‡‡ç”¨å’Œåç¨‹å–åŒæ ·çš„åä½œå–æ¶ˆã€‚ä½†æ˜¯ï¼ŒFlow å®ç°åŸºç¡€å¹¶æ²¡æœ‰å¼•å…¥é¢å¤–çš„å–æ¶ˆç‚¹ï¼Œå®ƒå¯¹äºå–æ¶ˆæ“ä½œæ˜¯å®Œå…¨é€æ˜çš„ã€‚é€šå¸¸ï¼Œæµçš„æ”¶é›†æ“ä½œå¯ä»¥åœ¨å½“æµåœ¨ä¸€ä¸ªå¯å–æ¶ˆçš„æŒ‚èµ·å‡½æ•°ï¼ˆå¦‚ delayï¼‰ä¸­æŒ‚èµ·çš„æ—¶å€™å–æ¶ˆï¼Œå¦åˆ™ä¸èƒ½å–æ¶ˆ</p>
<p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†åœ¨ withTimeoutOrNull å—ä¸­æµå¦‚ä½•åœ¨è¶…æ—¶æ—¶è¢«å–æ¶ˆå¹¶åœæ­¢æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">withTimeoutOrNull</span><span class="p">(</span><span class="m">250</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Timeout after 250ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>æ³¨æ„ï¼Œfoo() å‡½æ•°ä¸­çš„ Flow åªä¼ å‡ºä¸¤ä¸ªæ•°å­—ï¼Œå¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Emitting</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Emitting</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Done</span>
</span></span></code></pre></div><p>ç›¸å¯¹åº”çš„ï¼Œå¯ä»¥æ³¨é‡Šæ‰ flow ä¸­çš„ delay å‡½æ•°ï¼Œå¹¶å¢å¤§ for å¾ªç¯çš„å¾ªç¯èŒƒå›´ï¼Œæ­¤æ—¶å¯ä»¥å‘ç° flow æ²¡æœ‰è¢«å–æ¶ˆï¼Œå› ä¸º flow ä¸­æ²¡æœ‰å¼•å…¥é¢å¤–çš„æŒ‚èµ·ç‚¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="nc">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//        delay(100)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">withTimeoutOrNull</span><span class="p">(</span><span class="m">250</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Timeout after 250ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><h1 id="å››æµæ„å»ºå™¨">å››ã€æµæ„å»ºå™¨</h1>
<p>å‰é¢ä¾‹å­ä¸­çš„ flow{&hellip;} æ˜¯æœ€åŸºç¡€çš„ä¸€ä¸ªæµæ„å»ºå™¨ï¼Œè¿˜æœ‰å…¶å®ƒçš„æ„å»ºå™¨å¯ä»¥æ›´å®¹æ˜“åœ°å£°æ˜æµï¼š</p>
<ul>
<li>flowOf() å®šä¹‰äº†ä¸€ä¸ªå‘å‡ºå›ºå®šå€¼é›†çš„æµæ„å»ºå™¨</li>
<li>å¯ä»¥ä½¿ç”¨æ‰©å±•å‡½æ•° <code>.asFlow()</code> å°†å„ç§é›†åˆå’Œåºåˆ—è½¬æ¢ä¸ºæµ</li>
</ul>
<p>å› æ­¤ï¼Œä»æµä¸­æ‰“å°ä» 1 åˆ° 3 çš„æ•°å­—çš„ä¾‹å­å¯ä»¥æ”¹å†™æˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Convert an integer range to a flow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>   
</span></span></code></pre></div><h1 id="äº”ä¸­é—´æµè¿ç®—ç¬¦">äº”ã€ä¸­é—´æµè¿ç®—ç¬¦</h1>
<p>å¯ä»¥ä½¿ç”¨è¿ç®—ç¬¦æ¥è½¬æ¢æµï¼Œå°±åƒä½¿ç”¨é›†åˆå’Œåºåˆ—ä¸€æ ·ã€‚ä¸­é—´è¿ç®—ç¬¦åº”ç”¨äºä¸Šæ¸¸æµå¹¶è¿”å›ä¸‹æ¸¸æµã€‚è¿™äº›è¿ç®—ç¬¦æ˜¯å†·æ“ä½œç¬¦ï¼Œå’Œæµä¸€æ ·ã€‚æ­¤ç±»è¿ç®—ç¬¦æœ¬èº«ä¸æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œå®ƒå·¥ä½œå¾—å¾ˆå¿«ï¼Œå…¶è¿”å›ä¸€ä¸ªæ–°çš„è½¬æ¢åçš„æµï¼Œä½†å¼•ç”¨ä»…åŒ…å«å¯¹æ–°æµçš„æ“ä½œå®šä¹‰ï¼Œå¹¶ä¸é©¬ä¸Šè¿›è¡Œè½¬æ¢</p>
<p>åŸºç¡€è¿ç®—ç¬¦æœ‰ç€ç†Ÿæ‚‰çš„åç§°ï¼Œä¾‹å¦‚ map å’Œ filterã€‚æµè¿ç®—ç¬¦å’Œåºåˆ—çš„é‡è¦åŒºåˆ«åœ¨äºæµè¿ç®—ç¬¦ä¸­çš„ä»£ç å¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°</p>
<p>ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ map è¿ç®—ç¬¦å°†ä¼ å…¥è¯·æ±‚æµæ˜ å°„ä¸ºç»“æœå€¼ï¼Œå³ä½¿æ‰§è¡Œè¯·æ±‚æ˜¯ç”±æŒ‚èµ·å‡½æ•°å®ç°çš„é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">performRequest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="c1">// imitate long-running asynchronous work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="s2">&#34;response </span><span class="si">$request</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span> <span class="c1">// a flow of requests
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">request</span> <span class="o">-&gt;</span> <span class="n">performRequest</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">response</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>è¿è¡Œç»“æœå…±æœ‰ä¸‰è¡Œï¼Œæ¯ä¸€ç§’æ‰“å°ä¸€è¡Œè¾“å‡º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">response</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="m">3</span>
</span></span></code></pre></div><h2 id="51è½¬æ¢æ“ä½œç¬¦">5.1ã€è½¬æ¢æ“ä½œç¬¦</h2>
<p>åœ¨æµçš„è½¬æ¢è¿ç®—ç¬¦ä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¸€ä¸ªç§°ä¸º <code>transform</code>ã€‚å®ƒå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿç®€å•çš„æ•°æ®è½¬æ¢ï¼ˆå°±åƒ map å’Œ filterï¼‰ï¼Œä»¥åŠå®ç°æ›´å¤æ‚çš„è½¬æ¢ã€‚ä½¿ç”¨ <code>transform</code> è¿ç®—ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥å‘å‡ºä»»æ„æ¬¡æ•°çš„ä»»æ„å€¼</p>
<p>ä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨ <code>transform</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥è¯·æ±‚ä¹‹å‰å‘å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨è¯¥å­—ç¬¦ä¸²åé¢è·Ÿéšä¸€ä¸ªå“åº”ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">performRequest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="c1">// imitate long-running asynchronous work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="s2">&#34;response </span><span class="si">$request</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span> <span class="c1">// a flow of requests
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">transform</span> <span class="p">{</span> <span class="n">request</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;Making request </span><span class="si">$request</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">emit</span><span class="p">(</span><span class="n">performRequest</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">response</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è¾“å‡ºå€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Making</span> <span class="n">request</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Making</span> <span class="n">request</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Making</span> <span class="n">request</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="m">3</span>
</span></span></code></pre></div><h2 id="52é™é•¿è¿ç®—ç¬¦">5.2ã€é™é•¿è¿ç®—ç¬¦</h2>
<p>é™é•¿ä¸­é—´è¿ç®—ç¬¦åœ¨è¾¾åˆ°ç›¸åº”é™åˆ¶æ—¶å–æ¶ˆæµçš„æ‰§è¡Œã€‚åç¨‹ä¸­çš„å–æ¶ˆæ€»æ˜¯é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥å®ç°ï¼Œè¿™æ ·æ‰€æœ‰çš„èµ„æºç®¡ç†å‡½æ•°ï¼ˆä¾‹å¦‚ try { &hellip; } finally { &hellip; } ï¼‰å°±å¯ä»¥åœ¨å–æ¶ˆæ—¶æ­£å¸¸æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">numbers</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;This line will not execute&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Finally in numbers&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">numbers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="c1">// take only the first two
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>è¿™æ®µä»£ç çš„è¾“å‡ºæ¸…æ¥šåœ°æ˜¾ç¤ºäº† numbers() å‡½æ•°ä¸­çš„ flow{&hellip;} å‡½æ•°ä½“åœ¨å‘å‡ºç¬¬äºŒä¸ªæ•°å­—åå°±åœæ­¢äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Finally</span> <span class="k">in</span> <span class="n">numbers</span>
</span></span></code></pre></div><h1 id="å…­æµè¿ç®—ç¬¦">å…­ã€æµè¿ç®—ç¬¦</h1>
<p>ç»ˆç«¯æµè¿ç®—ç¬¦æ˜¯ç”¨äºå¯åŠ¨æµçš„æŒ‚èµ·å‡½æ•°ã€‚<code>collect</code> æ˜¯æœ€åŸºæœ¬çš„ç»ˆç«¯æµè¿ç®—ç¬¦ï¼Œä½†è¿˜æœ‰å…¶å®ƒç»ˆç«¯è¿ç®—ç¬¦ï¼Œå¯ä»¥ä½¿å¾—æ“ä½œæ›´åŠ ç®€ä¾¿ï¼š</p>
<ul>
<li>è½¬æ¢ä¸ºå„ç§é›†åˆï¼Œå¦‚ toList å’Œ toSet å‡½æ•°</li>
<li>first è¿ç®—ç¬¦ç”¨äºè·å–ç¬¬ä¸€ä¸ªå€¼ï¼Œsingle è¿ç®—ç¬¦ç”¨äºç¡®ä¿æµå‘å‡ºå•ä¸ªå€¼</li>
<li>ä½¿ç”¨ reduce å’Œ fold å°†æµè¿˜åŸä¸ºæŸä¸ªå€¼</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart         
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">sum</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">5</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="k">it</span> <span class="p">*</span> <span class="k">it</span> <span class="p">}</span> <span class="c1">// squares of numbers from 1 to 5                           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">reduce</span> <span class="p">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span> <span class="p">}</span> <span class="c1">// sum them (terminal operator)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">println</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è¾“å‡ºå•ä¸ªå€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">55</span>
</span></span></code></pre></div><h1 id="ä¸ƒæµæ˜¯è¿ç»­çš„">ä¸ƒã€æµæ˜¯è¿ç»­çš„</h1>
<p>é™¤éä½¿ç”¨å¯¹å¤šä¸ªæµè¿›è¡Œæ“ä½œçš„ç‰¹æ®Šè¿ç®—ç¬¦ï¼Œå¦åˆ™æ¯ä¸ªæµçš„å•ç‹¬é›†åˆéƒ½æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ã€‚é›†åˆç›´æ¥åœ¨è°ƒç”¨ç»ˆç«¯è¿ç®—ç¬¦çš„åç¨‹ä¸­å·¥ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ä¼šå¯åŠ¨æ–°çš„åç¨‹ã€‚æ¯ä¸ªå‘å‡ºçš„å€¼éƒ½ç”±æ‰€æœ‰ä¸­é—´è¿ç®—ç¬¦ä»ä¸Šæ¸¸åˆ°ä¸‹æ¸¸è¿›è¡Œå¤„ç†ï¼Œç„¶ååœ¨ä¹‹åä¼ é€’ç»™ç»ˆç«¯è¿ç®—ç¬¦</p>
<p>è¯·å‚é˜…ä»¥ä¸‹ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹è¿‡æ»¤å¶æ•°å¹¶å°†å…¶æ˜ å°„åˆ°å­—ç¬¦ä¸²ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart         
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">5</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">filter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Filter </span><span class="si">$it</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">it</span> <span class="p">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">0</span>              
</span></span><span class="line"><span class="cl">        <span class="p">}</span>              
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Map </span><span class="si">$it</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;string </span><span class="si">$it</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}.</span><span class="n">collect</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Collect </span><span class="si">$it</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>    
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd                  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è¾“å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Filter</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Filter</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Collect</span> <span class="n">string</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Filter</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Filter</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Collect</span> <span class="n">string</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Filter</span> <span class="m">5</span>
</span></span></code></pre></div><h1 id="å…«æµä¸Šä¸‹æ–‡">å…«ã€æµä¸Šä¸‹æ–‡</h1>
<p>æµçš„æ”¶é›†æ€»æ˜¯åœ¨è°ƒç”¨åç¨‹çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœå­˜åœ¨ foo æµï¼Œåˆ™æ— è®º foo æµçš„å®ç°è¯¦ç»†ä¿¡æ¯å¦‚ä½•ï¼Œä»¥ä¸‹ä»£ç éƒ½å°†åœ¨è¯¥å¼€å‘è€…æŒ‡å®šçš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">withContext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="c1">// run in the specified context 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æµçš„è¿™ä¸ªç‰¹æ€§ç§°ä¸ºä¸Šä¸‹æ–‡ä¿ç•™</p>
<p>æ‰€ä»¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œflow{&hellip;} ä¸­çš„ä»£ç åœ¨ç›¸åº”æµçš„æ”¶é›†å™¨æä¾›çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ä¾‹å¦‚ï¼Œè§‚å¯Ÿ foo çš„å®ç°ï¼Œå®ƒæ‰“å°è°ƒç”¨å®ƒçš„çº¿ç¨‹å¹¶å‘å‡ºä¸‰ä¸ªæ•°å­—ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">${Thread.currentThread().name}</span><span class="s2">] </span><span class="si">$msg</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="s2">&#34;Started foo flow&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="p">(</span><span class="s2">&#34;Collected </span><span class="si">$value</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="na">[main @coroutine#1]</span> <span class="n">Started</span> <span class="n">foo</span> <span class="n">flow</span>
</span></span><span class="line"><span class="cl"><span class="na">[main @coroutine#1]</span> <span class="n">Collected</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="na">[main @coroutine#1]</span> <span class="n">Collected</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="na">[main @coroutine#1]</span> <span class="n">Collected</span> <span class="m">3</span>
</span></span></code></pre></div><p>ç”±äº <code>foo().collect</code> æ˜¯åœ¨ä¸»çº¿ç¨‹è°ƒç”¨çš„ï¼Œæ‰€ä»¥ foo æµä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ã€‚å¯¹äºä¸å…³å¿ƒæ‰§è¡Œä¸Šä¸‹æ–‡ä¸”ä¸é˜»å¡è°ƒç”¨æ–¹çš„å¿«é€Ÿè¿”å›ä»£ç æˆ–è€…å¼‚æ­¥ä»£ç ï¼Œè¿™æ˜¯å®Œç¾çš„é»˜è®¤è®¾ç½®</p>
<h2 id="81é”™è¯¯åœ°ä½¿ç”¨-withcontext">8.1ã€é”™è¯¯åœ°ä½¿ç”¨ withContext</h2>
<p>ä½†æ˜¯ï¼Œå¯èƒ½éœ€è¦åœ¨ Dispatchers çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„å ç”¨ CPU çš„ä»£ç ï¼Œå¯èƒ½éœ€è¦åœ¨ Dispatchers.Main çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œé»˜è®¤ä»£ç å’Œ UI æ›´æ–°ã€‚é€šå¸¸ï¼ŒwithContext ç”¨äºåœ¨ä½¿ç”¨ kotlin åç¨‹æ—¶æ›´æ”¹ä»£ç ä¸­çš„ä¸Šä¸‹æ–‡ï¼Œä½† <code>fow{...}</code> ä¸­çš„ä»£ç å¿…é¡»éµå®ˆä¸Šä¸‹æ–‡æœ¬ä¿ç•™å±æ€§ï¼Œå¹¶ä¸”ä¸å…è®¸ä»å…¶å®ƒä¸Šä¸‹æ–‡ä¸­è§¦å‘</p>
<p>å°è¯•è¿è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">                      
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The WRONG way to change context for CPU-consuming code in flow builder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">kotlinx</span><span class="p">.</span><span class="n">coroutines</span><span class="p">.</span><span class="n">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="n">Default</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are computing it in CPU-consuming way
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>ä»£ç ä¼šç”Ÿæˆä»¥ä¸‹å¼‚å¸¸ï¼š</p>
<pre tabindex="0"><code>Exception in thread &#34;main&#34; java.lang.IllegalStateException: Flow invariant is violated:
		Flow was collected in [CoroutineId(1), &#34;coroutine#1&#34;:BlockingCoroutine{Active}@5511c7f8, BlockingEventLoop@2eac3323],
		but emission happened in [CoroutineId(1), &#34;coroutine#1&#34;:DispatchedCoroutine{Active}@2dae0000, DefaultDispatcher].
		Please refer to &#39;flow&#39; documentation or use &#39;flowOn&#39; instead
	at ...
</code></pre><h2 id="82flowon-è¿ç®—ç¬¦">8.2ã€flowOn è¿ç®—ç¬¦</h2>
<p>æœ‰ä¸ªä¾‹å¤–æƒ…å†µï¼ŒflowOn å‡½æ•°èƒ½ç”¨äºæ”¹å˜æµå‘é€å€¼æ—¶çš„ä¸Šä¸‹æ–‡ã€‚æ”¹å˜æµä¸Šä¸‹æ–‡çš„æ­£ç¡®æ–¹å¼å¦‚ä¸‹é¢çš„ç¤ºä¾‹æ‰€ç¤ºï¼Œè¯¥ç¤ºä¾‹è¿˜æ‰“å°äº†ç›¸åº”çº¿ç¨‹çš„åç§°ï¼Œä»¥æ˜¾ç¤ºæ‰€æœ‰çº¿ç¨‹çš„å·¥ä½œæ–¹å¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">${Thread.currentThread().name}</span><span class="s2">] </span><span class="si">$msg</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are computing it in CPU-consuming way
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}.</span><span class="n">flowOn</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="n">Default</span><span class="p">)</span> <span class="c1">// RIGHT way to change context for CPU-consuming code in flow builder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="p">(</span><span class="s2">&#34;Collected </span><span class="si">$value</span><span class="s2">&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>æ³¨æ„ï¼Œflow{&hellip;} åœ¨åå°çº¿ç¨‹ä¸­å·¥ä½œï¼Œè€Œåœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œå–å€¼</p>
<p>è¿™é‡Œè¦æ³¨æ„çš„å¦ä¸€ä»¶äº‹æ˜¯ flowOn æ“ä½œç¬¦æ”¹å˜äº†æµçš„é»˜è®¤é¡ºåºæ€§è´¨ã€‚ç°åœ¨å–å€¼æ“ä½œå‘ç”Ÿåœ¨åç¨‹ &ldquo;coroutine#1&rdquo; ä¸­ï¼Œè€Œå‘å°„å€¼çš„æ“ä½œåŒæ—¶è¿è¡Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„åç¨‹ &ldquo;coroutine#2&rdquo; ä¸Šã€‚å½“å¿…é¡»åœ¨ä¸Šæ¸¸æµçš„ä¸Šä¸‹æ–‡ä¸­æ›´æ”¹ CoroutineDispatcher æ—¶ï¼ŒflowOn è¿ç®—ç¬¦å°†ä¸ºè¯¥ä¸Šæ¸¸æµåˆ›å»ºå¦ä¸€ä¸ªåç¨‹</p>
<h1 id="ä¹ç¼“å†²">ä¹ã€ç¼“å†²</h1>
<p>ä»æ”¶é›†æµæ‰€éœ€çš„æ€»æ—¶é—´çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨ä¸åŒçš„åç¨‹ä¸­è¿è¡Œæµçš„ä¸åŒéƒ¨åˆ†å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼Œç‰¹åˆ«æ˜¯å½“æ¶‰åŠåˆ°é•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥æ“ä½œæ—¶ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ foo() æµçš„å‘å°„å¾ˆæ…¢ï¼Œç”Ÿæˆå…ƒç´ éœ€è¦100æ¯«ç§’ï¼›æ”¶é›†å™¨ä¹Ÿå¾ˆæ…¢ï¼Œå¤„ç†å…ƒç´ éœ€è¦300æ¯«ç§’ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ç”¨ä¸‰ä¸ªæ•°å­—æ”¶é›†è¿™æ ·çš„æµéœ€è¦å¤šé•¿æ—¶é—´ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlin.system.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are asynchronously waiting 100 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="n">measureTimeMillis</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> 
</span></span><span class="line"><span class="cl">            <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span> <span class="c1">// pretend we are processing it for 300 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Collected in </span><span class="si">$time</span><span class="s2"> ms&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>ä»¥ä¸Šä»£ç ä¼šäº§ç”Ÿå¦‚ä¸‹ç±»ä¼¼çš„ç»“æœï¼Œæ•´ä¸ªæ”¶é›†è¿‡ç¨‹å¤§çº¦éœ€è¦1200æ¯«ç§’ï¼ˆä¸‰ä¸ªæ•°å­—ï¼Œæ¯ä¸ª400æ¯«ç§’ï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Collected</span> <span class="k">in</span> <span class="m">1220</span> <span class="n">ms</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨æµä¸Šä½¿ç”¨ buffer è¿ç®—ç¬¦ï¼Œåœ¨è¿è¡Œå–é›†ä»£ç çš„åŒæ—¶è¿è¡Œ foo() çš„å‘å€¼ä»£ç ï¼Œè€Œä¸æ˜¯æŒ‰é¡ºåºè¿è¡Œå®ƒä»¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlin.system.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are asynchronously waiting 100 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="n">measureTimeMillis</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">buffer</span><span class="p">()</span> <span class="c1">// buffer emissions, don&#39;t wait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> 
</span></span><span class="line"><span class="cl">                <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span> <span class="c1">// pretend we are processing it for 300 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Collected in </span><span class="si">$time</span><span class="s2"> ms&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è¿™å¯ä»¥å¾—åˆ°ç›¸åŒçš„è¾“å‡ºç»“æœä½†è¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰æ•ˆåœ°åˆ›å»ºäº†ä¸€ä¸ªå¤„ç†ç®¡é“ï¼Œç¬¬ä¸€ä¸ªæ•°å­—åªéœ€è¦ç­‰å¾…100æ¯«ç§’ï¼Œç„¶ååªéœ€è¦èŠ±è´¹300æ¯«ç§’æ¥å¤„ç†æ¯ä¸ªæ•°å­—ã€‚è¿™æ ·è¿è¡Œå¤§çº¦éœ€è¦1000æ¯«ç§’ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Collected</span> <span class="k">in</span> <span class="m">1071</span> <span class="n">ms</span>
</span></span></code></pre></div><p>è¯·æ³¨æ„ï¼ŒflowOn è¿ç®—ç¬¦åœ¨å¿…é¡»æ›´æ”¹ CoroutineDispatcher æ—¶ä½¿ç”¨ç›¸åŒçš„ç¼“å†²æœºåˆ¶ï¼Œä½†è¿™é‡Œæˆ‘ä»¬æ˜¾ç¤ºåœ°è¯·æ±‚ç¼“å†²è€Œä¸æ›´æ”¹æ‰§è¡Œä¸Šä¸‹æ–‡</p>
<h2 id="91åˆå¹¶">9.1ã€åˆå¹¶</h2>
<p>å½“æµç”¨äºè¡¨ç¤ºæ“ä½œæˆ–æ“ä½œçŠ¶æ€æ›´æ–°çš„éƒ¨åˆ†ç»“æœæ—¶ï¼Œå¯èƒ½ä¸éœ€è¦å¤„ç†æ¯ä¸ªå€¼ï¼Œè€Œæ˜¯åªå¤„ç†æœ€è¿‘çš„å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å–å€¼å™¨å¤„ç†ä¸­é—´å€¼å¤ªæ…¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åˆå¹¶è¿ç®—ç¬¦è·³è¿‡ä¸­é—´å€¼ã€‚åœ¨å‰é¢çš„ä¾‹å­çš„åŸºç¡€ä¸Šå†æ¥ä¿®æ”¹ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlin.system.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are asynchronously waiting 100 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="n">measureTimeMillis</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">conflate</span><span class="p">()</span> <span class="c1">// conflate emissions, don&#39;t process each one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> 
</span></span><span class="line"><span class="cl">                <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span> <span class="c1">// pretend we are processing it for 300 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Collected in </span><span class="si">$time</span><span class="s2"> ms&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ç¬¬ä¸€ä¸ªæ•°å­—ä»åœ¨å¤„ç†ä¸­ï¼Œä½†ç¬¬äºŒä¸ªæ•°å­—å’Œç¬¬ä¸‰ä¸ªæ•°å­—å·²ç»ç”Ÿæˆï¼Œå› æ­¤ç¬¬äºŒä¸ªæ•°å­—è¢«åˆå¹¶ï¼ˆä¸¢å¼ƒï¼‰ï¼Œåªæœ‰æœ€è¿‘çš„ä¸€ä¸ªæ•°å­—ï¼ˆç¬¬ä¸‰ä¸ªï¼‰è¢«äº¤ä»˜ç»™å–å€¼å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Collected</span> <span class="k">in</span> <span class="m">758</span> <span class="n">ms</span>
</span></span></code></pre></div><h2 id="92å¤„ç†æœ€æ–°å€¼">9.2ã€å¤„ç†æœ€æ–°å€¼</h2>
<p>åœ¨å‘å°„ç«¯å’Œå¤„ç†ç«¯éƒ½å¾ˆæ…¢çš„æƒ…å†µä¸‹ï¼Œåˆå¹¶æ˜¯åŠ å¿«å¤„ç†é€Ÿåº¦çš„ä¸€ç§æ–¹æ³•ã€‚å®ƒé€šè¿‡ä¸¢å¼ƒå‘å°„çš„å€¼æ¥å®ç°ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯å–æ¶ˆæ…¢é€Ÿæ”¶é›†å™¨ï¼Œå¹¶åœ¨æ¯æ¬¡å‘å‡ºæ–°å€¼æ—¶é‡æ–°å¯åŠ¨å®ƒã€‚æœ‰ä¸€ç³»åˆ— xxxLatest è¿ç®—ç¬¦ä¸ xxx è¿ç®—ç¬¦æ‰§è¡Œç›¸åŒçš„åŸºæœ¬é€»è¾‘ï¼Œä½†æ˜¯åœ¨æ–°å€¼äº§ç”Ÿçš„æ—¶å€™å–æ¶ˆæ‰§è¡Œå…¶å—ä¸­çš„ä»£ç ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°è¯•å°† conflate æ›´æ”¹ä¸º collectLatestï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlin.system.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// pretend we are asynchronously waiting 100 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="n">measureTimeMillis</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">collectLatest</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="c1">// cancel &amp; restart on the latest value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Collecting </span><span class="si">$value</span><span class="s2">&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span> <span class="c1">// pretend we are processing it for 300 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Done </span><span class="si">$value</span><span class="s2">&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Collected in </span><span class="si">$time</span><span class="s2"> ms&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>ç”±äº collectLatest çš„ä¸»ä½“éœ€è¦å»¶è¿Ÿ300æ¯«ç§’ï¼Œè€Œæ¯100æ¯«ç§’ä¼šå‘å‡ºä¸€ä¸ªæ–°å€¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ° collectLatest ä»£ç å—å¾—åˆ°äº†æ¯ä¸€ä¸ªå‘å°„å€¼ï¼Œä½†æœ€ç»ˆåªå®Œæˆäº†æœ€åä¸€ä¸ªå€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Done</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Collected</span> <span class="k">in</span> <span class="m">741</span> <span class="n">ms</span>
</span></span></code></pre></div><h1 id="åç»„åˆå¤šä¸ªæµ">åã€ç»„åˆå¤šä¸ªæµ</h1>
<p>æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥ç»„åˆå¤šä¸ªæµ</p>
<h2 id="101zip">10.1ã€zip</h2>
<p>ä¸ Kotlin æ ‡å‡†åº“ä¸­çš„ Sequence.zip æ‰©å±•å‡½æ•°ä¸€æ ·ï¼Œæµæœ‰ä¸€ä¸ª zip è¿ç®—ç¬¦ï¼Œç”¨äºç»„åˆä¸¤ä¸ªæµçš„ç›¸åº”å€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart                                                                           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">nums</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span> <span class="c1">// numbers 1..3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">strs</span> <span class="p">=</span> <span class="n">flowOf</span><span class="p">(</span><span class="s2">&#34;one&#34;</span><span class="p">,</span> <span class="s2">&#34;two&#34;</span><span class="p">,</span> <span class="s2">&#34;three&#34;</span><span class="p">)</span> <span class="c1">// strings 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nums</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">strs</span><span class="p">)</span> <span class="p">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="s2">&#34;</span><span class="si">$a</span><span class="s2"> -&gt; </span><span class="si">$b</span><span class="s2">&#34;</span> <span class="p">}</span> <span class="c1">// compose a single string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">println</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// collect and print
</span></span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span> <span class="o">-&gt;</span> <span class="n">one</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span> <span class="o">-&gt;</span> <span class="n">two</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span> <span class="o">-&gt;</span> <span class="n">three</span>
</span></span></code></pre></div><h2 id="102combine">10.2ã€Combine</h2>
<p>å½“ flow è¡¨ç¤ºå˜é‡æˆ–æ“ä½œçš„æœ€æ–°å€¼æ—¶ï¼ˆå‚é˜…æœ‰å…³ conflation çš„ç›¸å…³ç« èŠ‚ï¼‰ï¼Œå¯èƒ½éœ€è¦æ‰§è¡Œä¾èµ–äºç›¸åº”æµçš„æœ€æ–°å€¼çš„è®¡ç®—ï¼Œå¹¶åœ¨ä»»ä½•ä¸Šæ¸¸æµå‘å‡ºå€¼æ—¶é‡æ–°è®¡ç®—å®ƒã€‚ç›¸åº”çš„è¿ç®—ç¬¦æ—ç§°ä¸º combine</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœä¸Šä¾‹ä¸­çš„æ•°å­—æ¯300æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œä½†å­—ç¬¦ä¸²æ¯400æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œåˆ™ä½¿ç”¨ zip è¿ç®—ç¬¦å‹ç¼©å®ƒä»¬ä»ä¼šäº§ç”Ÿç›¸åŒçš„ç»“æœï¼Œå°½ç®¡ç»“æœæ˜¯æ¯400æ¯«ç§’æ‰“å°ä¸€æ¬¡</p>
<blockquote>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸­é—´è¿ç®—ç¬¦ onEach æ¥å»¶è¿Ÿæ¯ä¸ªå…ƒç´ ï¼Œå¹¶ä½¿å‘å‡ºæ ·æœ¬æµçš„ä»£ç æ›´å…·å£°æ˜æ€§ï¼Œæ›´åŠ ç®€çŸ­</p></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart                                                                           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">nums</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// numbers 1..3 every 300 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">strs</span> <span class="p">=</span> <span class="n">flowOf</span><span class="p">(</span><span class="s2">&#34;one&#34;</span><span class="p">,</span> <span class="s2">&#34;two&#34;</span><span class="p">,</span> <span class="s2">&#34;three&#34;</span><span class="p">).</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">400</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// strings every 400 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="c1">// remember the start time 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nums</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">strs</span><span class="p">)</span> <span class="p">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="s2">&#34;</span><span class="si">$a</span><span class="s2"> -&gt; </span><span class="si">$b</span><span class="s2">&#34;</span> <span class="p">}</span> <span class="c1">// compose a single string with &#34;zip&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="c1">// collect and print 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$value</span><span class="s2"> at </span><span class="si">${System.currentTimeMillis() - startTime}</span><span class="s2"> ms from start&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>ä½†æ˜¯ï¼Œå¦‚æœåœ¨æ­¤å¤„ä½¿ç”¨ combine è¿ç®—ç¬¦è€Œä¸æ˜¯ zip æ—¶ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart                                                                           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">nums</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// numbers 1..3 every 300 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">strs</span> <span class="p">=</span> <span class="n">flowOf</span><span class="p">(</span><span class="s2">&#34;one&#34;</span><span class="p">,</span> <span class="s2">&#34;two&#34;</span><span class="p">,</span> <span class="s2">&#34;three&#34;</span><span class="p">).</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">400</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// strings every 400 ms          
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="c1">// remember the start time 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nums</span><span class="p">.</span><span class="n">combine</span><span class="p">(</span><span class="n">strs</span><span class="p">)</span> <span class="p">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="s2">&#34;</span><span class="si">$a</span><span class="s2"> -&gt; </span><span class="si">$b</span><span class="s2">&#34;</span> <span class="p">}</span> <span class="c1">// compose a single string with &#34;combine&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="c1">// collect and print 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$value</span><span class="s2"> at </span><span class="si">${System.currentTimeMillis() - startTime}</span><span class="s2"> ms from start&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¾—åˆ°äº†å®Œå…¨ä¸åŒçš„è¾“å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span> <span class="o">-&gt;</span> <span class="n">one</span> <span class="n">at</span> <span class="m">452</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span> <span class="o">-&gt;</span> <span class="n">one</span> <span class="n">at</span> <span class="m">651</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span> <span class="o">-&gt;</span> <span class="n">two</span> <span class="n">at</span> <span class="m">854</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span> <span class="o">-&gt;</span> <span class="n">two</span> <span class="n">at</span> <span class="m">952</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span> <span class="o">-&gt;</span> <span class="n">three</span> <span class="n">at</span> <span class="m">1256</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span></code></pre></div><h1 id="åä¸€å±•å¹³æµ">åä¸€ã€å±•å¹³æµ</h1>
<p>æµè¡¨ç¤ºå¼‚æ­¥æ¥æ”¶çš„å€¼åºåˆ—ï¼Œå› æ­¤åœ¨æ¯ä¸ªå€¼è§¦å‘å¯¹å¦ä¸€ä¸ªå€¼åºåˆ—çš„è¯·æ±‚çš„æƒ…å†µä¸‹å¾ˆå®¹æ˜“è·å–æ–°å€¼ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ç›¸éš”500æ¯«ç§’çš„ä¸¤ä¸ªå­—ç¬¦ä¸²æµï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">requestFlow</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: First&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">500</span><span class="p">)</span> <span class="c1">// wait 500 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: Second&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ•´æ•°çš„æµï¼Œå¹¶ä¸ºæ¯ä¸ªæ•´æ•°è°ƒç”¨ requestFlowï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">map</span> <span class="p">{</span> <span class="n">requestFlow</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæµï¼ˆflow&lt; flow&lt; String &raquo;ï¼‰ï¼Œéœ€è¦å°†å…¶å±•å¹³ä¸ºå•ç‹¬ä¸€ä¸ªæµä»¥è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚é›†åˆå’Œåºåˆ—å¯¹æ­¤æä¾›äº† flatten å’Œ flatMap è¿ç®—ç¬¦ã€‚ç„¶è€Œï¼Œç”±äºæµçš„å¼‚æ­¥ç‰¹æ€§ï¼Œå®ƒä»¬éœ€è¦ä¸åŒçš„å±•å¼€æ¨¡å¼ï¼Œå› æ­¤æµä¸Šæœ‰ä¸€ç³»åˆ— flattening è¿ç®—ç¬¦</p>
<h2 id="111flatmapconcat">11.1ã€flatMapConcat</h2>
<p>flatMapConcat å’Œ flattencat è¿ç®—ç¬¦å®ç°äº† Concatenating æ¨¡å¼ï¼Œå®ƒä»¬æ˜¯ä¸åºåˆ—è¿ç®—ç¬¦æœ€ç›´æ¥çš„ç±»æ¯”ã€‚å®ƒä»¬ç­‰å¾…å†…éƒ¨æµå®Œæˆï¼Œç„¶åå¼€å§‹æ”¶é›†ä¸‹ä¸€ä¸ªæµï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">requestFlow</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: First&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">500</span><span class="p">)</span> <span class="c1">// wait 500 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: Second&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="c1">// remember the start time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// a number every 100 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">flatMapConcat</span> <span class="p">{</span> <span class="n">requestFlow</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// collect and print
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$value</span><span class="s2"> at </span><span class="si">${System.currentTimeMillis() - startTime}</span><span class="s2"> ms from start&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>flatMapConcat çš„é¡ºåºç‰¹æ€§åœ¨è¾“å‡ºç»“æœä¸­æ¸…æ™°å¯è§ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">121</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="p">:</span> <span class="n">Second</span> <span class="n">at</span> <span class="m">622</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">727</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="p">:</span> <span class="n">Second</span> <span class="n">at</span> <span class="m">1227</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">1328</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="p">:</span> <span class="n">Second</span> <span class="n">at</span> <span class="m">1829</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span></code></pre></div><h2 id="112flatmapmerge">11.2ã€flatMapMerge</h2>
<p>å¦ä¸€ç§ flattening æ¨¡å¼æ˜¯åŒæ—¶æ”¶é›†æ‰€æœ‰ä¼ å…¥æµå¹¶å°†å…¶å€¼åˆå¹¶åˆ°å•ä¸ªæµä¸­ï¼Œä»¥ä¾¿å°½å¿«å‘å‡ºå€¼ã€‚å®ƒç”± flatMapMerge  å’Œ flattenMerge è¿ç®—ç¬¦å®ç°ã€‚å®ƒä»¬éƒ½æ¥å—ä¸€ä¸ªå¯é€‰çš„å¹¶å‘å‚æ•°ï¼Œè¯¥å‚æ•°ç”¨äºé™åˆ¶åŒæ—¶æ”¶é›†çš„å¹¶å‘æµçš„æ•°é‡ï¼ˆé»˜è®¤æƒ…å†µä¸‹ç­‰äº DEFAULT_CONCURRENCYï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">requestFlow</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: First&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">500</span><span class="p">)</span> <span class="c1">// wait 500 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: Second&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="c1">// remember the start time 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// a number every 100 ms 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">flatMapMerge</span> <span class="p">{</span> <span class="n">requestFlow</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span>                                                                           
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="c1">// collect and print 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$value</span><span class="s2"> at </span><span class="si">${System.currentTimeMillis() - startTime}</span><span class="s2"> ms from start&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>flatMapMerge çš„å¹¶å‘æ€§æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">136</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">231</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">333</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="p">:</span> <span class="n">Second</span> <span class="n">at</span> <span class="m">639</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="p">:</span> <span class="n">Second</span> <span class="n">at</span> <span class="m">732</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="p">:</span> <span class="n">Second</span> <span class="n">at</span> <span class="m">833</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span></code></pre></div><p>è¯·æ³¨æ„ï¼ŒflatMapMerge æŒ‰é¡ºåºè°ƒç”¨å…¶ä»£ç å—ï¼ˆ{requestFlow(it)}ï¼‰ï¼Œä½†åŒæ—¶æ”¶é›†ç»“æœæµï¼Œè¿™ç›¸å½“äºå…ˆæ‰§è¡Œåºåˆ— map{requestFlow(it)}ï¼Œç„¶åå¯¹è¿”å›å€¼è°ƒç”¨ flattenMerge</p>
<h2 id="113flatmaplatest">11.3ã€flatMapLatest</h2>
<p>ä¸â€œProcessing the latest valueï¼ˆå¤„ç†æœ€æ–°å€¼ï¼‰â€ç« èŠ‚ä»‹ç»çš„ collectLatest æ“ä½œç¬¦ç±»ä¼¼ï¼Œå­˜åœ¨ç›¸åº”çš„ &ldquo;Latest&rdquo; flattening æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä¸€æ—¦å‘å‡ºæ–°æµï¼Œå°†å–æ¶ˆå…ˆå‰å·²å‘å‡ºçš„æµã€‚è¿™é€šè¿‡ flatMapLatest è¿ç®—ç¬¦å®ç°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">requestFlow</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: First&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">500</span><span class="p">)</span> <span class="c1">// wait 500 ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$i</span><span class="s2">: Second&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="c1">// remember the start time 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// a number every 100 ms 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">flatMapLatest</span> <span class="p">{</span> <span class="n">requestFlow</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span>                                                                           
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="c1">// collect and print 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$value</span><span class="s2"> at </span><span class="si">${System.currentTimeMillis() - startTime}</span><span class="s2"> ms from start&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>æœ¬ä¾‹ä¸­çš„è¾“å‡ºå¾ˆå¥½çš„æ¼”ç¤ºäº† flatMapLatest çš„å·¥ä½œåŸç†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">142</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">322</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="p">:</span> <span class="n">First</span> <span class="n">at</span> <span class="m">425</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="p">:</span> <span class="n">Second</span> <span class="n">at</span> <span class="m">931</span> <span class="n">ms</span> <span class="n">from</span> <span class="n">start</span>
</span></span></code></pre></div><p>è¯·æ³¨æ„ï¼Œå½“æ–°å€¼åˆ°æ¥æ—¶ï¼ŒflatMapLatest å°†å–æ¶ˆå…¶å—ä¸­çš„æ‰€æœ‰ä»£ç ï¼ˆ{requestFlow(it)}ï¼‰ã€‚requestFlow å‡½æ•°æœ¬èº«çš„è°ƒç”¨æ˜¯å¾ˆå¿«é€Ÿçš„ï¼Œå¹¶éæŒ‚èµ·å‡½æ•°ï¼Œå¦‚æœå…¶å†…éƒ¨ä¸åŒ…å«é¢å¤–çš„æŒ‚èµ·ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°±ä¸èƒ½è¢«å–æ¶ˆï¼Œæ‰€ä»¥æ­¤å¤„å°±åœ¨å…¶å†…éƒ¨ä½¿ç”¨äº† delay å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥è¾¾åˆ°è¢«å–æ¶ˆçš„ç›®çš„</p>
<h1 id="åäºŒæµå¼‚å¸¸">åäºŒã€æµå¼‚å¸¸</h1>
<p>å½“å‘å°„å™¨æˆ–è¿ç®—ç¬¦å†…éƒ¨çš„ä»£ç å¼•å‘å¼‚å¸¸æ—¶ï¼Œæµæ”¶é›†å™¨å¯ä»¥ç»“æŸè¿è¡Œï¼Œä½†ä¼šå‡ºç°å¼‚å¸¸ã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¤„ç†è¿™äº›å¼‚å¸¸</p>
<h2 id="121æ”¶é›†å™¨-try-ä¸-catch">12.1ã€æ”¶é›†å™¨ try ä¸ catch</h2>
<p>æ”¶é›†å™¨å¯ä»¥ä½¿ç”¨ kotlin çš„ try/catch ä»£ç å—æ¥å¤„ç†å¼‚å¸¸</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>         
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">check</span><span class="p">(</span><span class="k">value</span> <span class="o">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Collected </span><span class="si">$value</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Caught </span><span class="si">$e</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>æ­¤ä»£ç æˆåŠŸæ•è· collect è¿ç®—ç¬¦ä¸­çš„å¼‚å¸¸ï¼Œå¦‚æˆ‘ä»¬æ‰€è§ï¼Œåœ¨æ­¤ä¹‹åä¸å†å‘å‡ºä»»ä½•å€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Emitting</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Emitting</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Caught</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">IllegalStateException</span><span class="p">:</span> <span class="n">Collected</span> <span class="m">2</span>
</span></span></code></pre></div><h2 id="122ä¸€åˆ‡éƒ½å·²æ•è·">12.2ã€ä¸€åˆ‡éƒ½å·²æ•è·</h2>
<p>å‰é¢çš„ç¤ºä¾‹å®é™…ä¸Šæ•è·äº†å‘å°„å™¨æˆ–ä»»ä½•ä¸­é—´æˆ–ç»ˆç«¯è¿ç®—ç¬¦ä¸­å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬æ›´æ”¹ä»£ç ï¼Œä»¥ä¾¿å°†å‘å‡ºçš„å€¼æ˜ å°„åˆ°å­—ç¬¦ä¸²ï¼Œä½†ç›¸åº”çš„ä»£ç ä¼šäº§ç”Ÿå¼‚å¸¸ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">=</span> 
</span></span><span class="line"><span class="cl">    <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="k">value</span> <span class="o">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Crashed on </span><span class="si">$value</span><span class="s2">&#34;</span> <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;string </span><span class="si">$value</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Caught </span><span class="si">$e</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>ä»æ•è·æ­¤å¼‚å¸¸å¹¶åœæ­¢æ”¶é›†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Emitting</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">string</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Emitting</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Caught</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">IllegalStateException</span><span class="p">:</span> <span class="n">Crashed</span> <span class="n">on</span> <span class="m">2</span>
</span></span></code></pre></div><h1 id="åä¸‰å¼‚å¸¸é€æ˜æ€§">åä¸‰ã€å¼‚å¸¸é€æ˜æ€§</h1>
<p>ä½†æ˜¯å‘å°„å™¨çš„ä»£ç å¦‚ä½•å°è£…å…¶å¼‚å¸¸å¤„ç†è¡Œä¸ºå‘¢ï¼Ÿ</p>
<p>flows å¯¹äºå¼‚å¸¸å¿…é¡»æ˜¯é€æ˜çš„ï¼Œå¹¶ä¸”åœ¨ flow{&hellip;} æ„å»ºå™¨ä¸­å‘å°„å€¼æœ‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å¿…é¡»æ˜¾å¼åœ°ä» try/catch å—å†…éƒ¨æŠ›å‡ºã€‚è¿™ä¿è¯äº†æŠ›å‡ºå¼‚å¸¸çš„æ”¶é›†å™¨å§‹ç»ˆå¯ä»¥ä½¿ç”¨ try/catch æ¥æ•è·å¼‚å¸¸ï¼Œå¦‚å‰ä¸€ä¸ªç¤ºä¾‹æ‰€ç¤º</p>
<p>å‘å°„å™¨å¯ä»¥ä½¿ç”¨ catch è¿ç®—ç¬¦æ¥ä¿æŒæ­¤å¼‚å¸¸çš„é€æ˜æ€§ï¼Œå¹¶å…è®¸å°è£…å…¶å¼‚å¸¸å¤„ç†è¡Œä¸ºã€‚catch è¿ç®—ç¬¦å¯ä»¥åˆ†æå¼‚å¸¸å¹¶æ ¹æ®æ•è·åˆ°çš„å¼‚å¸¸ä»¥ä¸åŒçš„æ–¹å¼å¯¹å…¶ä½œå‡ºååº”ï¼š</p>
<ul>
<li>å¯ä»¥ä½¿ç”¨ throw é‡æ–°å¼•å‘å¼‚å¸¸</li>
<li>ä½¿ç”¨ catch çš„ emit å¯ä»¥å°†å¼‚å¸¸è½¬æ¢ä¸ºå€¼çš„ emission</li>
<li>å¼‚å¸¸å¯ä»¥è¢«å…¶ä»–ä»£ç å¿½ç•¥ã€è®°å½•æˆ–å¤„ç†</li>
</ul>
<p>ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬åœ¨æ•è·å¼‚å¸¸æ—¶å‘å‡ºä¸€æ®µæ–‡æœ¬ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">=</span> 
</span></span><span class="line"><span class="cl">    <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1">// emit next value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="k">value</span> <span class="o">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Crashed on </span><span class="si">$value</span><span class="s2">&#34;</span> <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;string </span><span class="si">$value</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">emit</span><span class="p">(</span><span class="s2">&#34;Caught </span><span class="si">$e</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// emit on exception
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>            
</span></span></code></pre></div><p>ç¤ºä¾‹ä»£ç çš„è¾“å‡ºç»“æœæ˜¯ä¸ä¹‹å‰ç›¸åŒçš„ï¼Œå³ä½¿æˆ‘ä»¬ä¸å†åœ¨ä»£ç å‘¨å›´ä½¿ç”¨ try/catch</p>
<h2 id="131é€æ˜æ•è·">13.1ã€é€æ˜æ•è·</h2>
<p>catch ä¸­é—´è¿ç®—ç¬¦éµå¾ªå¼‚å¸¸é€æ˜æ€§ï¼Œåªæ•è·ä¸Šæ¸¸å¼‚å¸¸ï¼ˆå³ catch ä¸Šæ‰€æœ‰è¿ç®—ç¬¦çš„å¼‚å¸¸ï¼Œè€Œä¸æ˜¯ catch ä¸‹æ‰€æœ‰è¿ç®—ç¬¦çš„å¼‚å¸¸ï¼‰ã€‚å¦‚æœ collect{&hellip;}ï¼ˆæ”¾åœ¨ catch ä¸‹é¢ï¼‰æŠ›å‡ºå¼‚å¸¸ï¼Œç¨‹åºå°†é€€å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Caught </span><span class="si">$e</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// does not catch downstream exceptions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check</span><span class="p">(</span><span class="k">value</span> <span class="o">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Collected </span><span class="si">$value</span><span class="s2">&#34;</span> <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>å°½ç®¡å­˜åœ¨ catch è¿ç®—ç¬¦ï¼Œä½†ä¸ä¼šæ‰“å° â€œCaught &hellip;â€ æ—¥å¿—</p>
<h2 id="132å£°æ˜å¼æ•è·">13.2ã€å£°æ˜å¼æ•è·</h2>
<p>æˆ‘ä»¬å¯ä»¥å°† catch è¿ç®—ç¬¦çš„å£°æ˜æ€§ä¸å¤„ç†æ‰€æœ‰å¼‚å¸¸çš„æ„¿æœ›ç»“åˆèµ·æ¥ï¼Œæ–¹æ³•æ˜¯å°† collect è¿ç®—ç¬¦åŸå…ˆæ‰€è¦åšçš„æ“ä½œç§»åŠ¨åˆ° onEach ä¸­ï¼Œå¹¶å°†å…¶æ”¾åœ¨ catch è¿ç®—ç¬¦ä¹‹å‰ã€‚æ­¤æµçš„å–å€¼æ“ä½œå¿…é¡»ç”±ä¸å¸¦å‚æ•°çš„ collect() å‡½æ•°æ¥è°ƒç”¨è§¦å‘ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Emitting </span><span class="si">$i</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check</span><span class="p">(</span><span class="k">value</span> <span class="o">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Collected </span><span class="si">$value</span><span class="s2">&#34;</span> <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Caught </span><span class="si">$e</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>            
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰“å°äº†ä¸€æ¡ â€œCaught &hellip;â€ æ¶ˆæ¯ï¼Œè‡³æ­¤æˆ‘ä»¬æ•è·äº†æ‰€æœ‰å¼‚å¸¸ï¼Œè€Œæ— éœ€æ˜¾å¼ä½¿ç”¨ try/catch</p>
<h1 id="åå››æµå®Œæˆ">åå››ã€æµå®Œæˆ</h1>
<p>å½“æµæ”¶é›†å®Œæˆæ—¶ï¼ˆæ­£å¸¸æˆ–å¼‚å¸¸ï¼‰ï¼Œå®ƒå¯èƒ½éœ€è¦æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚æ­£å¦‚ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°çš„ï¼Œå®ƒå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å®Œæˆï¼šå‘½ä»¤å¼æˆ–å£°æ˜å¼</p>
<h2 id="141å‘½ä»¤å¼-finally-å—">14.1ã€å‘½ä»¤å¼ finally å—</h2>
<p>é™¤äº† try/catch å¤–ï¼Œæ”¶é›†å™¨è¿˜å¯ä»¥ä½¿ç”¨ finally åœ¨æ”¶é›†å®Œæˆæ—¶æ‰§è¡Œæ“ä½œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span><span class="p">().</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>æ­¤ä»£ç æ‰“å° fon() æµç”Ÿæˆçš„ä¸‰ä¸ªæ•°å­—ï¼Œä¹‹åè·Ÿéš &ldquo;Done&rdquo; å­—ç¬¦ä¸²</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Done</span>
</span></span></code></pre></div><h2 id="142å£°æ˜å¼å¤„ç†">14.2ã€å£°æ˜å¼å¤„ç†</h2>
<p>å¯¹äºå£°æ˜æ€§æ–¹æ³•ï¼Œflow æœ‰ä¸€ä¸ª onCompletion ä¸­é—´è¿ç®—ç¬¦ï¼Œè¯¥è¿ç®—ç¬¦åœ¨æµå®Œå…¨æ”¶é›†åè°ƒç”¨</p>
<p>å‰é¢çš„ç¤ºä¾‹å¯ä»¥ä½¿ç”¨ onCompletion è¿ç®—ç¬¦é‡å†™ï¼Œå¹¶ç”Ÿæˆç›¸åŒçš„è¾“å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">onCompletion</span> <span class="p">{</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Done&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>            
</span></span></code></pre></div><p>onCompletion çš„ä¸»è¦ä¼˜ç‚¹æ˜¯åŒ…å«ä¸€ä¸ª lambda å‚æ•°ï¼Œè¯¥ lambda åŒ…å«ä¸€ä¸ªå¯ç©ºçš„ Throwable å‚æ•°ï¼Œè¯¥ Throwable å‚æ•°å¯ç”¨äºç¡®å®šæµæ”¶é›†æ˜¯æ­£å¸¸å®Œæˆè¿˜æ˜¯å¼‚å¸¸å®Œæˆã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œfoo() æµåœ¨å‘å‡ºæ•°å­—1åå¼•å‘å¼‚å¸¸ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">onCompletion</span> <span class="p">{</span> <span class="n">cause</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Flow completed exceptionally&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">cause</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Caught exception&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>å¦‚ä½ æ‰€æ–™ï¼Œå°†æ‰“å°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Flow</span> <span class="n">completed</span> <span class="n">exceptionally</span>
</span></span><span class="line"><span class="cl"><span class="n">Caught</span> <span class="n">exception</span>
</span></span></code></pre></div><p>ä¸ catch è¿ç®—ç¬¦ä¸åŒï¼ŒonCompletion è¿ç®—ç¬¦ä¸å¤„ç†å¼‚å¸¸ã€‚æ­£å¦‚æˆ‘ä»¬ä»ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­çœ‹åˆ°çš„ï¼Œå¼‚å¸¸ä»ç„¶ä¼šæµå‘ä¸‹æ¸¸ã€‚å®ƒå°†è¢«ä¼ é€’ç»™å…¶ä»–å®Œæˆ onCompletion è¿ç®—ç¬¦ï¼Œå¹¶å¯ä»¥ä½¿ç”¨ catch è¿ç®—ç¬¦è¿›è¡Œå¤„ç†</p>
<h2 id="143ä»…é™ä¸Šæ¸¸å¼‚å¸¸">14.3ã€ä»…é™ä¸Šæ¸¸å¼‚å¸¸</h2>
<p>å°±åƒ catch æ“ä½œç¬¦ä¸€æ ·ï¼ŒonCompletion åªçœ‹åˆ°æ¥è‡ªä¸Šæ¸¸çš„å¼‚å¸¸ï¼Œè€Œçœ‹ä¸åˆ°ä¸‹æ¸¸çš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œè¿è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">foo</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">onCompletion</span> <span class="p">{</span> <span class="n">cause</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Flow completed with </span><span class="si">$cause</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check</span><span class="p">(</span><span class="k">value</span> <span class="o">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Collected </span><span class="si">$value</span><span class="s2">&#34;</span> <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°  completion cause ä¸ºç©ºï¼Œä½†æµæ”¶é›†å¤±è´¥å¹¶æŠ›å‡ºå¼‚å¸¸:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Flow</span> <span class="n">completed</span> <span class="n">with</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl"><span class="n">Exception</span> <span class="k">in</span> <span class="n">thread</span> <span class="s2">&#34;main&#34;</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">IllegalStateException</span><span class="p">:</span> <span class="n">Collected</span> <span class="m">2</span>
</span></span></code></pre></div><h1 id="åäº”å‘½ä»¤å¼è¿˜æ˜¯å£°æ˜å¼">åäº”ã€å‘½ä»¤å¼è¿˜æ˜¯å£°æ˜å¼</h1>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“å¦‚ä½•æ”¶é›†æµï¼Œå¹¶ä»¥å‘½ä»¤å¼å’Œå£°æ˜å¼çš„æ–¹å¼å¤„ç†å®ƒçš„å®Œæˆå’Œå¼‚å¸¸ã€‚è¿™é‡Œå¾ˆè‡ªç„¶çš„å°±æœ‰äº†ä¸ªé—®é¢˜ï¼Œåº”è¯¥é¦–é€‰å“ªç§æ–¹æ³•å‘¢ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿä½œä¸ºä¸€ä¸ªåº“ï¼Œæˆ‘ä»¬ä¸æå€¡ä»»ä½•ç‰¹å®šçš„æ–¹æ³•ï¼Œå¹¶ä¸”ç›¸ä¿¡è¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œåº”è¯¥æ ¹æ®ä½ è‡ªå·±çš„åå¥½å’Œä»£ç é£æ ¼æ¥é€‰æ‹©</p>
<h1 id="åå…­å¯åŠ¨æµ">åå…­ã€å¯åŠ¨æµ</h1>
<p>å¾ˆå®¹æ˜“ä½¿ç”¨æµæ¥è¡¨ç¤ºæ¥è‡ªæŸä¸ªæ•°æ®æºçš„å¼‚æ­¥äº‹ä»¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¨¡æ‹Ÿçš„ addEventListener å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä¸€æ®µä»£ç æ³¨å†Œä¸ºå¯¹ä¼ å…¥äº‹ä»¶çš„å“åº”ï¼Œå¹¶ç»§ç»­è¿›ä¸€æ­¥å·¥ä½œã€‚onEach è¿ç®—ç¬¦å¯ä»¥æ‹…ä»»æ­¤è§’è‰²ã€‚ç„¶è€Œï¼ŒonEach æ˜¯ä¸€ä¸ªä¸­é—´è¿ç®—ç¬¦ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç»ˆç«¯è¿ç®—ç¬¦æ¥æ”¶é›†æ•°æ®ã€‚å¦åˆ™ï¼Œåªæ³¨å†Œ onEach æ˜¯æ²¡æœ‰æ•ˆæœçš„</p>
<p>å¦‚æœåœ¨ onEach ä¹‹åä½¿ç”¨ collect ç»ˆç«¯è¿ç®—ç¬¦ï¼Œåˆ™åœ¨ collect ä¹‹åçš„ä»£ç å°†ç­‰å¾…æµè¢«æ”¶é›†å®Œæˆåå†è¿è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1">// Imitate a flow of events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">events</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">events</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">event</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Event: </span><span class="si">$event</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collect</span><span class="p">()</span> <span class="c1">// &lt;--- Collecting the flow waits
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>å¦‚ä½ æ‰€è§ï¼Œå°†æ‰“å°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Event</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Event</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Event</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Done</span>
</span></span></code></pre></div><p>launchIn ç»ˆç«¯è¿ç®—ç¬¦åœ¨è¿™é‡Œæ˜¯å¾ˆå®ç”¨çš„ã€‚é€šè¿‡å°† collect æ›¿æ¢ä¸º launchInï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å•ç‹¬çš„åç¨‹ä¸­å¯åŠ¨æ”¶é›†æµæ•°æ®çš„æ“ä½œï¼Œä»¥ä¾¿ç«‹å³ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥çš„ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">kotlinx.coroutines.flow.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Imitate a flow of events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">events</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">3</span><span class="p">).</span><span class="n">asFlow</span><span class="p">().</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//sampleStart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">events</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">event</span> <span class="o">-&gt;</span> <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Event: </span><span class="si">$event</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">launchIn</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="c1">// &lt;--- Launching the flow in a separate coroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;Done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>            
</span></span><span class="line"><span class="cl"><span class="c1">//sampleEnd
</span></span></span></code></pre></div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Event</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Event</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Event</span><span class="p">:</span> <span class="m">3</span>
</span></span></code></pre></div><p>launchIn æ‰€éœ€çš„å‚æ•°ç”¨äºæŒ‡å®šå¯åŠ¨ç”¨äºæ”¶é›†æµçš„åç¨‹çš„ä½œç”¨åŸŸã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ­¤ä½œç”¨åŸŸæ¥è‡ª runBlockingï¼Œå› æ­¤å½“æµè¿è¡Œæ—¶ï¼ŒrunBlocking ä½œç”¨åŸŸç­‰å¾…å…¶å­åç¨‹å®Œæˆï¼Œå¹¶é˜»æ­¢ä¸»å‡½æ•°è¿”å›å’Œç»ˆæ­¢æ­¤ç¤ºä¾‹ä»£ç </p>
<p>åœ¨å®é™…åº”ç”¨ç¨‹åºä¸­ï¼Œä½œç”¨åŸŸå°†æ¥è‡ªç”Ÿå‘½å‘¨æœŸæ˜¯æœ‰é™çš„å®ä½“ã€‚ä¸€æ—¦æ­¤å®ä½“çš„ç”Ÿå‘½å‘¨æœŸç»ˆæ­¢ï¼Œç›¸åº”çš„ä½œç”¨åŸŸå°†è¢«å–æ¶ˆï¼Œä»è€Œå–æ¶ˆç›¸åº”æµçš„æ”¶é›†ã€‚onEach { &hellip; }.launchIn(scope) çš„å·¥ä½œæ–¹å¼ä¸ addEventListener ç±»ä¼¼ã€‚ä½†æ˜¯ï¼Œä¸éœ€è¦ç›¸åº”çš„ removeEventListener å‡½æ•°ï¼Œå› ä¸º cancellation å’Œç»“æ„åŒ–å¹¶å‘å¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„</p>
<p>è¯·æ³¨æ„ï¼ŒlaunchIn è¿˜è¿”å›ä¸€ä¸ª Job å¯¹è±¡ï¼Œè¯¥ Job ä»…å¯ç”¨äºå–æ¶ˆç›¸åº”çš„æµæ•°æ®æ”¶é›†åç¨‹ï¼Œè€Œä¸å–æ¶ˆæ•´ä¸ªä½œç”¨åŸŸæˆ–åŠ å…¥å®ƒ</p>
<h1 id="åä¸ƒflow-and-reactive-streams">åä¸ƒã€Flow and Reactive Streams</h1>
<p>For those who are familiar with Reactive Streams or reactive frameworks such as RxJava and project Reactor, design of the Flow may look very familiar.</p>
<p>Indeed, its design was inspired by Reactive Streams and its various implementations. But Flow main goal is to have as simple design as possible, be Kotlin and suspension friendly and respect structured concurrency. Achieving this goal would be impossible without reactive pioneers and their tremendous work. You can read the complete story in Reactive Streams and Kotlin Flows article.</p>
<p>While being different, conceptually, Flow is a reactive stream and it is possible to convert it to the reactive (spec and TCK compliant) Publisher and vice versa. Such converters are provided by kotlinx.coroutines out-of-the-box and can be found in corresponding reactive modules (kotlinx-coroutines-reactive for Reactive Streams, kotlinx-coroutines-reactor for Project Reactor and kotlinx-coroutines-rx2 for RxJava2). Integration modules include conversions from and to Flow, integration with Reactor&rsquo;s Context and suspension-friendly ways to work with various reactive entities.</p>

      </article>

      


  
<script type="text/javascript">
  (function() {
    const themeToggle = document.querySelector('.darkmode-toggle input');
    const light = 'light';
    const dark = 'dark';
    let isDark = localStorage.theme === dark || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
    let theme = isDark ? dark : light;

    const s = document.createElement('script');
    s.type = 'text/javascript';
    const dataset = {
        repo: 'tomowang\/hugo-theme-tailwind',
        repoId: 'R_kgDOKjVJHA',
        category: 'Announcements',
        categoryId: 'DIC_kwDOKjVJHM4CafqS',
        mapping: 'pathname',
        reactionsEnabled: '1',
        emitMetadata: '0',
        theme: theme,
        lang: 'en',
    };
    s.src = 'https://giscus.app/client.js';
    s.crossorigin = 'anonymous';
    s.async = true;
    Object.entries(dataset).forEach(function(a) {
        return s.dataset[a[0]] = a[1];
    });

    const curScriptElement = document.currentScript;
    curScriptElement.parentNode.insertBefore(s, curScriptElement);

    function sendMessage(message) {
      const iframe = document.querySelector('iframe.giscus-frame');
      
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
    }

    themeToggle.addEventListener('change', function () {
      if (this.checked) {
        theme = dark;
      } else {
        theme = light;
      }
      sendMessage({
        setConfig: {
          theme: theme,
        }
      });
    });
  })();
</script>
  



    </div>
  </div>
</div>

  </main>
  <footer class="flex flex-none justify-center">
    <section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row">
    
  
  
    <a href="https://x.com/hqqich" target="_blank" title="X" class="flex flex-row mr-2">
      <span class="hidden">X</span>
      <i class="h-6 w-6 flex-none"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-x" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M4 4l11.733 16h4.267l-11.733 -16z"></path>
   <path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"></path>
</svg>
 </i>
    </a>
  
  
  
    <a href="https://github.com/hqqich" target="_blank" title="Github" class="flex flex-row mr-2">
      <span class="hidden">Github</span>
      <i class="h-6 w-6 flex-none"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
</svg>
 </i>
    </a>
  
  


  </div>
  <div class="grow"></div>
  <div class="flex flex-row">
    <i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
   <path d="M14 9.75a3.016 3.016 0 0 0 -4.163 .173a2.993 2.993 0 0 0 0 4.154a3.016 3.016 0 0 0 4.163 .173"></path>
</svg>
</i> 2022 - 2025 Hqqich
    
  </div>
  
  <div class="flex flex-row">
    <span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">
      Powered by <a href="https://gohugo.io" target="_blank" rel="noopener" class="underline">Hugo</a> <span class="text-red-600">&hearts;</span> <a href="https://github.com/tomowang/hugo-theme-tailwind" target="_blank" rel="noopener" class="underline">Tailwind</a>
    </span>
  </div>
  
</section>

  </footer>
  <script src="/hugo-blog/public/main.js"></script>

<div class="hidden top-1 right-1" id="code-copy">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />
  <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" />
</svg>

  </i>
</div>
<div class="hidden top-1 right-1" id="code-copy-done">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M5 12l5 5l10 -10" />
</svg>

  </i>
</div><script src="/hugo-blog/public/code-copy.js"></script>





</body>
</html>
