<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html"><meta property="og:site_name" content="blog"><meta property="og:title" content="ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶"><meta property="og:description" content="å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„ (https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image) å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£ Handler åœ¨æ•´ä¸ª Android å¼€å‘ä½“ç³»ä¸­å æ®ç€å¾ˆé‡è¦çš„åœ°ä½ï¼Œæ˜¯ä¸€ç§æ ‡å‡†..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="hqqich"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶","image":[""],"dateModified":null,"author":[{"@type":"Person","name":"hqqich","url":"https://mister-hope.com"}]}</script><title>ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶ | blog</title><meta name="description" content="å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„ (https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image) å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£ Handler åœ¨æ•´ä¸ª Android å¼€å‘ä½“ç³»ä¸­å æ®ç€å¾ˆé‡è¦çš„åœ°ä½ï¼Œæ˜¯ä¸€ç§æ ‡å‡†...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/blog/dist/assets/style-e1af0ae0.css" as="style"><link rel="stylesheet" href="/blog/dist/assets/style-e1af0ae0.css">
    <link rel="modulepreload" href="/blog/dist/assets/app-6847d3e4.js"><link rel="modulepreload" href="/blog/dist/assets/ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶.html-b83e7a10.js"><link rel="modulepreload" href="/blog/dist/assets/ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶.html-2e6ee611.js"><link rel="modulepreload" href="/blog/dist/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/blog/dist/assets/index.html-e68a8aa2.js" as="script"><link rel="prefetch" href="/blog/dist/assets/slides.html-141feb08.js" as="script"><link rel="prefetch" href="/blog/dist/assets/resume.html-af74f6e4.js" as="script"><link rel="prefetch" href="/blog/dist/assets/day01.html-5cb6ea40.js" as="script"><link rel="prefetch" href="/blog/dist/assets/JVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰ æ•´ç†ï¼ˆä¸€ï¼‰.html-c802af0e.js" as="script"><link rel="prefetch" href="/blog/dist/assets/MySQLå®æˆ˜45è®²ç¬”è®°.html-ec2ab87d.js" as="script"><link rel="prefetch" href="/blog/dist/assets/index.html-8542c835.js" as="script"><link rel="prefetch" href="/blog/dist/assets/SpringBootç¬¬åä¸‰ç¯‡ï¼šåŒæ—¶é›†æˆåä¸ºRC6.5.1å®‰å…¨ç‰ˆkafkaå’ŒåŸç”Ÿkafkaï¼Œé€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€æ§åˆ¶.html-ac22ae42.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ã€SpringBootã€‘38 ä¸ªå¸¸ç”¨æ³¨è§£.html-d7c57776.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€å¥è¯æ€»ç»“Dockerä¸K8Sçš„å…³ç³».html-6a7f6a6a.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Gson å’Œ Kotlin Data Class çš„é¿å‘æŒ‡å—.html-4ef25010.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java _ Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ1ï¼‰.html-4be2b241.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java _ Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ2ï¼‰.html-5409f006.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java _ Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ3ï¼‰.html-9cc8e7fe.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹.html-926ae862.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ2ï¼‰æ€ä¹ˆå®ç°å¤šçº¿ç¨‹åŒæ­¥.html-21b575b6.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ3ï¼‰çº¿ç¨‹æ´»æ€§æ•…éšœæœ‰å“ªäº›.html-8afc8c39.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ4ï¼‰é”çš„åˆ†ç±»æœ‰è¿™ä¹ˆå¤š.html-64ebf45c.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ5ï¼‰è¶…è¯¦ç»†çš„ ThreadPoolExecutor æºç è§£æ.html-779ab900.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ1ï¼‰åç¨‹åŸºç¡€.html-e76de760.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ2ï¼‰å–æ¶ˆå’Œè¶…æ—¶.html-a013f20c.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ3ï¼‰ç»„åˆæŒ‚èµ·å‡½æ•°.html-906a72b3.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ4ï¼‰åç¨‹ä¸Šä¸‹æ–‡å’Œè°ƒåº¦å™¨.html-87dd6d3c.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ.html-d8acf7fa.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ6ï¼‰é€šé“.html-fefa6085.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ7ï¼‰å¼‚å¸¸å¤„ç†.html-184269ff.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ8ï¼‰å…±äº«å¯å˜çŠ¶æ€å’Œå¹¶å‘æ€§.html-90cf0947.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ9ï¼‰é€‰æ‹©è¡¨è¾¾å¼.html-f6235f18.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ ConstraintLayout.html-2dfef235.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Gson.html-9d50047b.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Kotlin åç¨‹.html-454b238f.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ RxJava 2.html-0c933355.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡è¯»æ‡‚ Java å’Œ Kotlin çš„æ³›å‹éš¾ç‚¹.html-0209f67e.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸¤ä¸‡å…­åƒå­—å¸¦ä½  Kotlin å…¥é—¨.html-dcfc63bb.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£.html-41ba2913.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ12ï¼‰OkHttp _ Retrofit å¼€å‘è°ƒè¯•åˆ©å™¨.html-458950f8.js" as="script"><link rel="prefetch" href="/blog/dist/assets/æ¢ç©¶ Bitmap çš„ä¼˜åŒ–æ‰‹æ®µ.html-52d8142b.js" as="script"><link rel="prefetch" href="/blog/dist/assets/æ¢ç©¶ Kotlin çš„éšè—æ€§èƒ½å¼€é”€ä¸é¿å‘æŒ‡å—.html-f86e10c2.js" as="script"><link rel="prefetch" href="/blog/dist/assets/404.html-3afd45f4.js" as="script"><link rel="prefetch" href="/blog/dist/assets/index.html-8daec251.js" as="script"><link rel="prefetch" href="/blog/dist/assets/index.html-8ecd507a.js" as="script"><link rel="prefetch" href="/blog/dist/assets/index.html-12fcd146.js" as="script"><link rel="prefetch" href="/blog/dist/assets/slides.html-c34de2ee.js" as="script"><link rel="prefetch" href="/blog/dist/assets/resume.html-9942c685.js" as="script"><link rel="prefetch" href="/blog/dist/assets/day01.html-a31fdbf7.js" as="script"><link rel="prefetch" href="/blog/dist/assets/JVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰ æ•´ç†ï¼ˆä¸€ï¼‰.html-1bf76551.js" as="script"><link rel="prefetch" href="/blog/dist/assets/MySQLå®æˆ˜45è®²ç¬”è®°.html-9a8df87f.js" as="script"><link rel="prefetch" href="/blog/dist/assets/index.html-24c60f82.js" as="script"><link rel="prefetch" href="/blog/dist/assets/SpringBootç¬¬åä¸‰ç¯‡ï¼šåŒæ—¶é›†æˆåä¸ºRC6.5.1å®‰å…¨ç‰ˆkafkaå’ŒåŸç”Ÿkafkaï¼Œé€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€æ§åˆ¶.html-fe294f3d.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ã€SpringBootã€‘38 ä¸ªå¸¸ç”¨æ³¨è§£.html-5f73fbfa.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€å¥è¯æ€»ç»“Dockerä¸K8Sçš„å…³ç³».html-587f5983.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Gson å’Œ Kotlin Data Class çš„é¿å‘æŒ‡å—.html-e5defc33.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java _ Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ1ï¼‰.html-c4e8e2df.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java _ Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ2ï¼‰.html-70d0b545.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java _ Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ3ï¼‰.html-72b0aa6f.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹.html-5b7e4972.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ2ï¼‰æ€ä¹ˆå®ç°å¤šçº¿ç¨‹åŒæ­¥.html-21ac1d9f.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ3ï¼‰çº¿ç¨‹æ´»æ€§æ•…éšœæœ‰å“ªäº›.html-ec4fea86.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ4ï¼‰é”çš„åˆ†ç±»æœ‰è¿™ä¹ˆå¤š.html-b7d9865b.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ5ï¼‰è¶…è¯¦ç»†çš„ ThreadPoolExecutor æºç è§£æ.html-3b6277c9.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ1ï¼‰åç¨‹åŸºç¡€.html-d22d6f99.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ2ï¼‰å–æ¶ˆå’Œè¶…æ—¶.html-ff65bbdf.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ3ï¼‰ç»„åˆæŒ‚èµ·å‡½æ•°.html-a73ab9a7.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ4ï¼‰åç¨‹ä¸Šä¸‹æ–‡å’Œè°ƒåº¦å™¨.html-4406649b.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ.html-fa3b7012.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ6ï¼‰é€šé“.html-b412ea58.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ7ï¼‰å¼‚å¸¸å¤„ç†.html-98e3e68c.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ8ï¼‰å…±äº«å¯å˜çŠ¶æ€å’Œå¹¶å‘æ€§.html-c1d8b982.js" as="script"><link rel="prefetch" href="/blog/dist/assets/Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ9ï¼‰é€‰æ‹©è¡¨è¾¾å¼.html-493d1377.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ ConstraintLayout.html-e1964282.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Gson.html-05d7e3f3.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Kotlin åç¨‹.html-7cfb8b5c.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡å¿«é€Ÿå…¥é—¨ RxJava 2.html-a0a04e3f.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸€æ–‡è¯»æ‡‚ Java å’Œ Kotlin çš„æ³›å‹éš¾ç‚¹.html-f2e918b0.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸¤ä¸‡å…­åƒå­—å¸¦ä½  Kotlin å…¥é—¨.html-79735e84.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£.html-04d14fbb.js" as="script"><link rel="prefetch" href="/blog/dist/assets/ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ12ï¼‰OkHttp _ Retrofit å¼€å‘è°ƒè¯•åˆ©å™¨.html-b0cb7ab2.js" as="script"><link rel="prefetch" href="/blog/dist/assets/æ¢ç©¶ Bitmap çš„ä¼˜åŒ–æ‰‹æ®µ.html-23362b77.js" as="script"><link rel="prefetch" href="/blog/dist/assets/æ¢ç©¶ Kotlin çš„éšè—æ€§èƒ½å¼€é”€ä¸é¿å‘æŒ‡å—.html-99fbb911.js" as="script"><link rel="prefetch" href="/blog/dist/assets/404.html-ddac28c5.js" as="script"><link rel="prefetch" href="/blog/dist/assets/index.html-214a6c03.js" as="script"><link rel="prefetch" href="/blog/dist/assets/index.html-f98bfbac.js" as="script"><link rel="prefetch" href="/blog/dist/assets/photoswipe.esm-060dc2da.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/blog/dist/"><img class="vp-nav-logo" src="/blog/dist/logo.svg" alt="blog"><!----><span class="vp-site-name hide-in-pad">blog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="ä¸»é¡µ" class="vp-link nav-link nav-link" href="/blog/dist/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="about me" class="vp-link nav-link nav-link" href="/blog/dist/md/resume.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>about me<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="å­¦ä¹ æ—¥å¿—" class="vp-link nav-link nav-link" href="/blog/dist/md/dev-log/day01.html"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>å­¦ä¹ æ—¥å¿—<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="kotlin" class="vp-link nav-link nav-link" href="/blog/dist/md/kotlin/%E4%B8%A4%E4%B8%87%E5%85%AD%E5%8D%83%E5%AD%97%E5%B8%A6%E4%BD%A0%20Kotlin%20%E5%85%A5%E9%97%A8.html"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>kotlin<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/hqqich/hqqich.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="ä¸»é¡µ" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>ä¸»é¡µ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">å­¦ä¹ æ—¥å¿—</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a aria-label="Day01" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/dev-log/day01.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Day01<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="MySQLå®æˆ˜45è®²ç¬”è®°" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/dev-log/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2%E7%AC%94%E8%AE%B0.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>MySQLå®æˆ˜45è®²ç¬”è®°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SpringBootç¬¬åä¸‰ç¯‡ï¼šåŒæ—¶é›†æˆåä¸ºRC6.5.1å®‰å…¨ç‰ˆkafkaå’ŒåŸç”Ÿkafkaï¼Œé€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€æ§åˆ¶" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/dev-log/SpringBoot%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AF%87%EF%BC%9A%E5%90%8C%E6%97%B6%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BARC6.5.1%E5%AE%89%E5%85%A8%E7%89%88kafka%E5%92%8C%E5%8E%9F%E7%94%9Fkafka%EF%BC%8C%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A8%E6%80%81%E6%8E%A7%E5%88%B6.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>SpringBootç¬¬åä¸‰ç¯‡ï¼šåŒæ—¶é›†æˆåä¸ºRC6.5.1å®‰å…¨ç‰ˆkafkaå’ŒåŸç”Ÿkafkaï¼Œé€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€æ§åˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="/md/dev-log/ã€SpringBootã€‘ SpringBootæ ¸å¿ƒ-CSDNåšå®¢.md" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/dev-log/ã€SpringBootã€‘ SpringBootæ ¸å¿ƒ-CSDNåšå®¢.html"><!---->/md/dev-log/ã€SpringBootã€‘ SpringBootæ ¸å¿ƒ-CSDNåšå®¢.md<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸€å¥è¯æ€»ç»“Dockerä¸K8Sçš„å…³ç³»" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/dev-log/%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%80%BB%E7%BB%93Docker%E4%B8%8EK8S%E7%9A%84%E5%85%B3%E7%B3%BB.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€å¥è¯æ€»ç»“Dockerä¸K8Sçš„å…³ç³»<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="JVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰ æ•´ç†ï¼ˆä¸€ï¼‰" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/dev-log/JVM%EF%BC%88Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%89%20%E6%95%B4%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>JVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰ æ•´ç†ï¼ˆä¸€ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ã€SpringBootã€‘38 ä¸ªå¸¸ç”¨æ³¨è§£" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/dev-log/%E3%80%90SpringBoot%E3%80%9138%20%E4%B8%AA%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ã€SpringBootã€‘38 ä¸ªå¸¸ç”¨æ³¨è§£<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading active"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">kotlin</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a aria-label="Gson å’Œ Kotlin Data Class çš„é¿å‘æŒ‡å—" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Gson%20%E5%92%8C%20Kotlin%20Data%20Class%20%E7%9A%84%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Gson å’Œ Kotlin Data Class çš„é¿å‘æŒ‡å—<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java &amp; Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ1ï¼‰" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20_%20Android%20%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E9%A1%BB%E7%9F%A5%E9%A1%BB%E4%BC%9A%EF%BC%881%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java &amp; Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ1ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java &amp; Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ2ï¼‰" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20_%20Android%20%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E9%A1%BB%E7%9F%A5%E9%A1%BB%E4%BC%9A%EF%BC%882%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java &amp; Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ2ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java &amp; Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ3ï¼‰" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20_%20Android%20%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E9%A1%BB%E7%9F%A5%E9%A1%BB%E4%BC%9A%EF%BC%883%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java &amp; Android é›†åˆæ¡†æ¶é¡»çŸ¥é¡»ä¼šï¼ˆ3ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91%EF%BC%881%EF%BC%89%E4%BB%80%E4%B9%88%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ2ï¼‰æ€ä¹ˆå®ç°å¤šçº¿ç¨‹åŒæ­¥" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91%EF%BC%882%EF%BC%89%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ2ï¼‰æ€ä¹ˆå®ç°å¤šçº¿ç¨‹åŒæ­¥<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ3ï¼‰çº¿ç¨‹æ´»æ€§æ•…éšœæœ‰å“ªäº›" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91%EF%BC%883%EF%BC%89%E7%BA%BF%E7%A8%8B%E6%B4%BB%E6%80%A7%E6%95%85%E9%9A%9C%E6%9C%89%E5%93%AA%E4%BA%9B.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ3ï¼‰çº¿ç¨‹æ´»æ€§æ•…éšœæœ‰å“ªäº›<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ4ï¼‰é”çš„åˆ†ç±»æœ‰è¿™ä¹ˆå¤š" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ4ï¼‰é”çš„åˆ†ç±»æœ‰è¿™ä¹ˆå¤š<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ5ï¼‰è¶…è¯¦ç»†çš„ ThreadPoolExecutor æºç è§£æ" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Java%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91%EF%BC%885%EF%BC%89%E8%B6%85%E8%AF%A6%E7%BB%86%E7%9A%84%20ThreadPoolExecutor%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Java å¤šçº¿ç¨‹å¼€å‘ï¼ˆ5ï¼‰è¶…è¯¦ç»†çš„ ThreadPoolExecutor æºç è§£æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ1ï¼‰åç¨‹åŸºç¡€" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%881%EF%BC%89%E5%8D%8F%E7%A8%8B%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ1ï¼‰åç¨‹åŸºç¡€<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ2ï¼‰å–æ¶ˆå’Œè¶…æ—¶" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%882%EF%BC%89%E5%8F%96%E6%B6%88%E5%92%8C%E8%B6%85%E6%97%B6.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ2ï¼‰å–æ¶ˆå’Œè¶…æ—¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ3ï¼‰ç»„åˆæŒ‚èµ·å‡½æ•°" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%883%EF%BC%89%E7%BB%84%E5%90%88%E6%8C%82%E8%B5%B7%E5%87%BD%E6%95%B0.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ3ï¼‰ç»„åˆæŒ‚èµ·å‡½æ•°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ4ï¼‰åç¨‹ä¸Šä¸‹æ–‡å’Œè°ƒåº¦å™¨" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%884%EF%BC%89%E5%8D%8F%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E8%B0%83%E5%BA%A6%E5%99%A8.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ4ï¼‰åç¨‹ä¸Šä¸‹æ–‡å’Œè°ƒåº¦å™¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%885%EF%BC%89%E5%BC%82%E6%AD%A5%E6%B5%81.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ5ï¼‰å¼‚æ­¥æµ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ6ï¼‰é€šé“" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%886%EF%BC%89%E9%80%9A%E9%81%93.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ6ï¼‰é€šé“<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ7ï¼‰å¼‚å¸¸å¤„ç†" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%887%EF%BC%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ7ï¼‰å¼‚å¸¸å¤„ç†<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ8ï¼‰å…±äº«å¯å˜çŠ¶æ€å’Œå¹¶å‘æ€§" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%888%EF%BC%89%E5%85%B1%E4%BA%AB%E5%8F%AF%E5%8F%98%E7%8A%B6%E6%80%81%E5%92%8C%E5%B9%B6%E5%8F%91%E6%80%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ8ï¼‰å…±äº«å¯å˜çŠ¶æ€å’Œå¹¶å‘æ€§<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ9ï¼‰é€‰æ‹©è¡¨è¾¾å¼" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/Kotlin%20%E5%8D%8F%E7%A8%8B%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%889%EF%BC%89%E9%80%89%E6%8B%A9%E8%A1%A8%E8%BE%BE%E5%BC%8F.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ9ï¼‰é€‰æ‹©è¡¨è¾¾å¼<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸€æ–‡å¿«é€Ÿå…¥é—¨ ConstraintLayout" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20ConstraintLayout.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡å¿«é€Ÿå…¥é—¨ ConstraintLayout<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Gson" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20Gson.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Gson<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Kotlin åç¨‹" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20Kotlin%20%E5%8D%8F%E7%A8%8B.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Kotlin åç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸€æ–‡å¿«é€Ÿå…¥é—¨ RxJava 2" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20RxJava%202.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡å¿«é€Ÿå…¥é—¨ RxJava 2<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="1ã€Message" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_1ã€message"><!---->1ã€Message<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="2ã€MessageQueue" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_2ã€messagequeue"><!---->2ã€MessageQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="3ã€Handler" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_3ã€handler"><!---->3ã€Handler<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="4ã€Looper" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_4ã€looper"><!---->4ã€Looper<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5ã€åšä¸€ä¸ªæ€»ç»“" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_5ã€åšä¸€ä¸ªæ€»ç»“"><!---->5ã€åšä¸€ä¸ªæ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="1ã€Handler  å¦‚ä½•åˆå§‹åŒ–" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_1ã€handler-å¦‚ä½•åˆå§‹åŒ–"><!---->1ã€Handler  å¦‚ä½•åˆå§‹åŒ–<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="2ã€Looper  å¦‚ä½•åˆå§‹åŒ–" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_2ã€looper-å¦‚ä½•åˆå§‹åŒ–"><!---->2ã€Looper  å¦‚ä½•åˆå§‹åŒ–<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="3ã€Handler å‘é€æ¶ˆæ¯" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_3ã€handler-å‘é€æ¶ˆæ¯"><!---->3ã€Handler å‘é€æ¶ˆæ¯<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="4ã€MessageQueue" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_4ã€messagequeue"><!---->4ã€MessageQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5ã€æ¶ˆæ¯å±éšœ" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_5ã€æ¶ˆæ¯å±éšœ"><!---->5ã€æ¶ˆæ¯å±éšœ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6ã€é€€å‡º Looper å¾ªç¯" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_6ã€é€€å‡º-looper-å¾ªç¯"><!---->6ã€é€€å‡º Looper å¾ªç¯<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7ã€IdleHandler" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_7ã€idlehandler"><!---->7ã€IdleHandler<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="8ã€åšä¸€ä¸ªæ€»ç»“" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_8ã€åšä¸€ä¸ªæ€»ç»“"><!---->8ã€åšä¸€ä¸ªæ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="1ã€HandlerThread" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_1ã€handlerthread"><!---->1ã€HandlerThread<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="2ã€IntentService" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_2ã€intentservice"><!---->2ã€IntentService<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="1ã€EventBus" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_1ã€eventbus"><!---->1ã€EventBus<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="2ã€Retrofit" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_2ã€retrofit"><!---->2ã€Retrofit<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="1ã€Handlerã€Looperã€MessageQueueã€Thread çš„å¯¹åº”å…³ç³»" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_1ã€handlerã€looperã€messagequeueã€thread-çš„å¯¹åº”å…³ç³»"><!---->1ã€Handlerã€Looperã€MessageQueueã€Thread çš„å¯¹åº”å…³ç³»<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="2ã€Handler çš„åŒæ­¥æœºåˆ¶" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_2ã€handler-çš„åŒæ­¥æœºåˆ¶"><!---->2ã€Handler çš„åŒæ­¥æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="3ã€Handler å‘é€åŒæ­¥æ¶ˆæ¯" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_3ã€handler-å‘é€åŒæ­¥æ¶ˆæ¯"><!---->3ã€Handler å‘é€åŒæ­¥æ¶ˆæ¯<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="4ã€Handler é¿å…å†…å­˜æ³„æ¼" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_4ã€handler-é¿å…å†…å­˜æ³„æ¼"><!---->4ã€Handler é¿å…å†…å­˜æ³„æ¼<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5ã€Message å¦‚ä½•å¤ç”¨" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_5ã€message-å¦‚ä½•å¤ç”¨"><!---->5ã€Message å¦‚ä½•å¤ç”¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6ã€Message å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_6ã€message-å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜"><!---->6ã€Message å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7ã€Message å¦‚ä½•æé«˜ä¼˜å…ˆçº§" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_7ã€message-å¦‚ä½•æé«˜ä¼˜å…ˆçº§"><!---->7ã€Message å¦‚ä½•æé«˜ä¼˜å…ˆçº§<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="8ã€æ£€æµ‹ Looper åˆ†å‘ Message çš„æ•ˆç‡" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_8ã€æ£€æµ‹-looper-åˆ†å‘-message-çš„æ•ˆç‡"><!---->8ã€æ£€æµ‹ Looper åˆ†å‘ Message çš„æ•ˆç‡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="9ã€ä¸»çº¿ç¨‹ Looper åœ¨å“ªé‡Œåˆ›å»º" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_9ã€ä¸»çº¿ç¨‹-looper-åœ¨å“ªé‡Œåˆ›å»º"><!---->9ã€ä¸»çº¿ç¨‹ Looper åœ¨å“ªé‡Œåˆ›å»º<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="10ã€ä¸»çº¿ç¨‹ Looper ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_10ã€ä¸»çº¿ç¨‹-looper-ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯"><!---->10ã€ä¸»çº¿ç¨‹ Looper ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="11ã€ä¸»çº¿ç¨‹ Looper.loop() ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´ ANR" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_11ã€ä¸»çº¿ç¨‹-looper-loop-ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´-anr"><!---->11ã€ä¸»çº¿ç¨‹ Looper.loop() ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´ ANR<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹ Toast å—" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹-toast-å—"><!---->12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹ Toast å—<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–° UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–°-ui-ä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥"><!---->13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–° UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="14ã€ä¸ºä»€ä¹ˆ UI ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_14ã€ä¸ºä»€ä¹ˆ-ui-ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹"><!---->14ã€ä¸ºä»€ä¹ˆ UI ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡"><!---->15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹"><!---->16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Handler%20%E6%9C%BA%E5%88%B6.html#_17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸"><!---->17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="ä¸€æ–‡è¯»æ‡‚ Java å’Œ Kotlin çš„æ³›å‹éš¾ç‚¹" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Java%20%E5%92%8C%20Kotlin%20%E7%9A%84%E6%B3%9B%E5%9E%8B%E9%9A%BE%E7%82%B9.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡è¯»æ‡‚ Java å’Œ Kotlin çš„æ³›å‹éš¾ç‚¹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸¤ä¸‡å…­åƒå­—å¸¦ä½  Kotlin å…¥é—¨" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%A4%E4%B8%87%E5%85%AD%E5%8D%83%E5%AD%97%E5%B8%A6%E4%BD%A0%20Kotlin%20%E5%85%A5%E9%97%A8.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸¤ä¸‡å…­åƒå­—å¸¦ä½  Kotlin å…¥é—¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%BB%E6%B5%81%E5%BC%80%E6%BA%90%E5%BA%93%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%8811%EF%BC%89OkHttp%20%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ12ï¼‰OkHttp &amp; Retrofit å¼€å‘è°ƒè¯•åˆ©å™¨" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E4%B8%BB%E6%B5%81%E5%BC%80%E6%BA%90%E5%BA%93%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%8812%EF%BC%89OkHttp%20_%20Retrofit%20%E5%BC%80%E5%8F%91%E8%B0%83%E8%AF%95%E5%88%A9%E5%99%A8.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ12ï¼‰OkHttp &amp; Retrofit å¼€å‘è°ƒè¯•åˆ©å™¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="æ¢ç©¶ Bitmap çš„ä¼˜åŒ–æ‰‹æ®µ" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E6%8E%A2%E7%A9%B6%20Bitmap%20%E7%9A%84%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>æ¢ç©¶ Bitmap çš„ä¼˜åŒ–æ‰‹æ®µ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="æ¢ç©¶ Kotlin çš„éšè—æ€§èƒ½å¼€é”€ä¸é¿å‘æŒ‡å—" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/dist/md/kotlin/%E6%8E%A2%E7%A9%B6%20Kotlin%20%E7%9A%84%E9%9A%90%E8%97%8F%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%E4%B8%8E%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>æ¢ç©¶ Kotlin çš„éšè—æ€§èƒ½å¼€é”€ä¸é¿å‘æŒ‡å—<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://mister-hope.com" target="_blank" rel="noopener noreferrer">hqqich</a></span><span property="author" content="hqqich"></span></span><!----><!----><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 44 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT44M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category1" role>kotlin</span><!--]--><meta property="articleSection" content="kotlin"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_1ã€message">1ã€Message</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_2ã€messagequeue">2ã€MessageQueue</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_3ã€handler">3ã€Handler</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_4ã€looper">4ã€Looper</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_5ã€åšä¸€ä¸ªæ€»ç»“">5ã€åšä¸€ä¸ªæ€»ç»“</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_1ã€handler-å¦‚ä½•åˆå§‹åŒ–">1ã€Handler  å¦‚ä½•åˆå§‹åŒ–</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_2ã€looper-å¦‚ä½•åˆå§‹åŒ–">2ã€Looper  å¦‚ä½•åˆå§‹åŒ–</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_3ã€handler-å‘é€æ¶ˆæ¯">3ã€Handler å‘é€æ¶ˆæ¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_4ã€messagequeue">4ã€MessageQueue</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_5ã€æ¶ˆæ¯å±éšœ">5ã€æ¶ˆæ¯å±éšœ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_6ã€é€€å‡º-looper-å¾ªç¯">6ã€é€€å‡º Looper å¾ªç¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_7ã€idlehandler">7ã€IdleHandler</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_8ã€åšä¸€ä¸ªæ€»ç»“">8ã€åšä¸€ä¸ªæ€»ç»“</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_1ã€handlerthread">1ã€HandlerThread</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_2ã€intentservice">2ã€IntentService</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_1ã€eventbus">1ã€EventBus</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_2ã€retrofit">2ã€Retrofit</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_1ã€handlerã€looperã€messagequeueã€thread-çš„å¯¹åº”å…³ç³»">1ã€Handlerã€Looperã€MessageQueueã€Thread çš„å¯¹åº”å…³ç³»</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_2ã€handler-çš„åŒæ­¥æœºåˆ¶">2ã€Handler çš„åŒæ­¥æœºåˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_3ã€handler-å‘é€åŒæ­¥æ¶ˆæ¯">3ã€Handler å‘é€åŒæ­¥æ¶ˆæ¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_4ã€handler-é¿å…å†…å­˜æ³„æ¼">4ã€Handler é¿å…å†…å­˜æ³„æ¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_5ã€message-å¦‚ä½•å¤ç”¨">5ã€Message å¦‚ä½•å¤ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_6ã€message-å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜">6ã€Message å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_7ã€message-å¦‚ä½•æé«˜ä¼˜å…ˆçº§">7ã€Message å¦‚ä½•æé«˜ä¼˜å…ˆçº§</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_8ã€æ£€æµ‹-looper-åˆ†å‘-message-çš„æ•ˆç‡">8ã€æ£€æµ‹ Looper åˆ†å‘ Message çš„æ•ˆç‡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_9ã€ä¸»çº¿ç¨‹-looper-åœ¨å“ªé‡Œåˆ›å»º">9ã€ä¸»çº¿ç¨‹ Looper åœ¨å“ªé‡Œåˆ›å»º</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_10ã€ä¸»çº¿ç¨‹-looper-ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯">10ã€ä¸»çº¿ç¨‹ Looper ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_11ã€ä¸»çº¿ç¨‹-looper-loop-ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´-anr">11ã€ä¸»çº¿ç¨‹ Looper.loop() ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´ ANR</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹-toast-å—">12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹ Toast å—</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–°-ui-ä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥">13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–° UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_14ã€ä¸ºä»€ä¹ˆ-ui-ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹">14ã€ä¸ºä»€ä¹ˆ UI ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡">15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹">16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blog/dist/#_17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸">17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><blockquote><p>å…¬ä¼—å·ï¼š<a href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image" target="_blank" rel="noopener noreferrer">å­—èŠ‚æ•°ç»„<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p></blockquote><p>Handler åœ¨æ•´ä¸ª Android å¼€å‘ä½“ç³»ä¸­å æ®ç€å¾ˆé‡è¦çš„åœ°ä½ï¼Œæ˜¯ä¸€ç§æ ‡å‡†çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œå¯¹å¼€å‘è€…æ¥è¯´èµ·åˆ°çš„ä½œç”¨å¾ˆæ˜ç¡®ï¼Œå°±æ˜¯ä¸ºäº†å®ç°çº¿ç¨‹åˆ‡æ¢æˆ–è€…æ˜¯æ‰§è¡Œå»¶æ—¶ä»»åŠ¡ï¼Œç¨å¾®æ›´é«˜çº§ä¸€ç‚¹çš„ç”¨æ³•å¯èƒ½æ˜¯ä¸ºäº†ä¿è¯å¤šä¸ªä»»åŠ¡åœ¨æ‰§è¡Œæ—¶çš„æœ‰åºæ€§ã€‚ç”±äº Android ç³»ç»Ÿä¸­çš„ä¸»çº¿ç¨‹æœ‰ç‰¹æ®Šåœ°ä½ï¼Œæ‰€ä»¥åƒ EventBus å’Œ Retrofit è¿™ç±»å¹¶é Android ç‹¬æœ‰çš„ä¸‰æ–¹åº“ï¼Œéƒ½æ˜¯é€šè¿‡ Handler æ¥å®ç°å¯¹ Android ç³»ç»Ÿçš„ç‰¹æ®Šå¹³å°æ”¯æŒã€‚å¤§éƒ¨åˆ†å¼€å‘è€…éƒ½å·²ç»å¯¹å¦‚ä½•ä½¿ç”¨ Handler å¾ˆç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œå°±å†æ¥äº†è§£ä¸‹å…¶å†…éƒ¨å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p><p><strong>æœ¬æ–‡åŸºäº Android API 30ï¼ˆå³ Android 11ï¼‰çš„ç³»ç»Ÿæºç è¿›è¡Œè®²è§£</strong></p><h1 id="ä¸€ã€åŠ¨æ‰‹å®ç°-handler" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€åŠ¨æ‰‹å®ç°-handler" aria-hidden="true">#</a> ä¸€ã€åŠ¨æ‰‹å®ç° Handler</h1><p>æœ¬æ–‡ä¸ä¼šä¸€ä¸Šæ¥å°±ç›´æ¥ä»‹ç»æºç ï¼Œè€Œæ˜¯ä¼šå…ˆæ ¹æ®æˆ‘ä»¬æƒ³è¦å®ç°çš„æ•ˆæœæ¥åæ¨æºç ï¼Œä¸€æ­¥æ­¥æ¥è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªç®€å•çš„ Handler</p><h2 id="_1ã€message" tabindex="-1"><a class="header-anchor" href="#_1ã€message" aria-hidden="true">#</a> 1ã€Message</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸ªè½½ä½“æ¥è¡¨ç¤ºè¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå°±å«å®ƒ Message å§ï¼ŒMessage åº”è¯¥æœ‰ä»€ä¹ˆå‚æ•°å‘¢ï¼Ÿ</p><ul><li>éœ€è¦æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œå› ä¸ºè¦æ‰§è¡Œçš„ä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªï¼Œæˆ‘ä»¬è¦åˆ†å¾—æ¸…å“ªä¸ªæ˜¯å“ªä¸ªï¼Œç”¨ä¸ª Int ç±»å‹å˜é‡å°±è¶³å¤Ÿè¡¨ç¤ºäº†</li><li>éœ€è¦èƒ½å¤Ÿæ‰¿è½½æ•°æ®ï¼Œéœ€è¦å‘é€çš„æ•°æ®ç±»å‹ä¼šæœ‰å¾ˆå¤šç§å¯èƒ½ï¼Œé‚£å°±ç›´æ¥ç”¨ä¸€ä¸ª Object ç±»å‹å˜é‡æ¥è¡¨ç¤ºå§ï¼Œç”±å¼€å‘è€…è‡ªå·±åœ¨ä½¿ç”¨æ—¶å†æ¥å¼ºè½¬ç±»å‹</li><li>éœ€è¦æœ‰ä¸€ä¸ª long ç±»å‹å˜é‡æ¥è¡¨ç¤ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æˆ³</li></ul><p>æ‰€ä»¥ï¼ŒMessage ç±»å°±åº”è¯¥è‡³å°‘åŒ…å«ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * @Author: leavesCZY
 * @Desc:
 * @å…¬ä¼—å·ï¼šå­—èŠ‚æ•°ç»„
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
    <span class="token comment">//å”¯ä¸€æ ‡è¯†</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> what<span class="token punctuation">;</span>
    <span class="token comment">//æ•°æ®</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> obj<span class="token punctuation">;</span>
    <span class="token comment">//æ—¶é—´æˆ³</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> when<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2ã€messagequeue" tabindex="-1"><a class="header-anchor" href="#_2ã€messagequeue" aria-hidden="true">#</a> 2ã€MessageQueue</h2><p>å› ä¸º Message å¹¶ä¸æ˜¯å‘é€äº†å°±èƒ½å¤Ÿé©¬ä¸Šè¢«æ¶ˆè´¹æ‰ï¼Œæ‰€ä»¥å°±è‚¯å®šè¦æœ‰ä¸ªå¯ä»¥ç”¨æ¥å­˜æ”¾çš„åœ°æ–¹ï¼Œå°±å«å®ƒ MessageQueue å§ï¼Œå³æ¶ˆæ¯é˜Ÿåˆ—ã€‚Message å¯èƒ½éœ€è¦å»¶è¿Ÿå¤„ç†ï¼Œé‚£ä¹ˆ MessageQueue åœ¨ä¿å­˜ Message çš„æ—¶å€™å°±åº”è¯¥æŒ‰ç…§æ—¶é—´æˆ³çš„å¤§å°æ¥é¡ºåºå­˜æ”¾ï¼Œæ—¶é—´æˆ³å°çš„ Message æ”¾åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œåœ¨æ¶ˆè´¹ Message çš„æ—¶å€™å°±ç›´æ¥ä»é˜Ÿåˆ—å¤´å–å€¼å³å¯</p><p>é‚£ä¹ˆç”¨ä»€ä¹ˆæ•°æ®ç»“æ„æ¥å­˜æ”¾ Message æ¯”è¾ƒå¥½å‘¢ï¼Ÿ</p><ul><li>ç”¨æ•°ç»„ï¼Ÿä¸å¤ªåˆé€‚ï¼Œæ•°ç»„è™½ç„¶åœ¨éå†çš„æ—¶å€™ä¼šæ¯”è¾ƒå¿«ï¼Œä½†éœ€è¦é¢„å…ˆå°±ç”³è¯·å›ºå®šçš„å†…å­˜ç©ºé—´ï¼Œå¯¼è‡´åœ¨æ’å…¥æ•°æ®å’Œç§»é™¤æ•°æ®æ—¶å¯èƒ½éœ€è¦ç§»åŠ¨å¤§é‡æ•°æ®ã€‚è€Œ MessageQueue å¯èƒ½éšæ—¶ä¼šæ”¶åˆ°æ•°é‡ä¸å®šã€æ—¶é—´æˆ³å¤§å°ä¸å®šçš„ Messageï¼Œæ¶ˆè´¹å®Œ Message åè¿˜éœ€è¦å°†è¯¥å…¶ç§»å‡ºé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„å¹¶ä¸åˆé€‚</li><li>ç”¨é“¾è¡¨ï¼Ÿå¥½åƒå¯ä»¥ï¼Œé“¾è¡¨åœ¨æ’å…¥æ•°æ®å’Œç§»é™¤æ•°æ®æ—¶åªéœ€è¦æ”¹å˜æŒ‡é’ˆçš„å¼•ç”¨å³å¯ï¼Œä¸éœ€è¦ç§»åŠ¨æ•°æ®ï¼Œå†…å­˜ç©ºé—´ä¹Ÿåªéœ€è¦æŒ‰éœ€ç”³è¯·å³å¯ã€‚è™½ç„¶é“¾è¡¨åœ¨éšæœºè®¿é—®çš„æ—¶å€™æ€§èƒ½ä¸é«˜ï¼Œä½†æ˜¯å¯¹äº MessageQueue è€Œè¨€æ— æ‰€è°“ï¼Œå› ä¸ºåœ¨æ¶ˆè´¹ Message çš„æ—¶å€™ä¹Ÿåªéœ€è¦å–é˜Ÿåˆ—å¤´çš„å€¼ï¼Œå¹¶ä¸éœ€è¦éšæœºè®¿é—®</li></ul><p>å¥½äº†ï¼Œæ—¢ç„¶å†³å®šç”¨é“¾è¡¨ç»“æ„ï¼Œé‚£ä¹ˆ Message å°±éœ€è¦å¢åŠ ä¸€ä¸ªå­—æ®µç”¨äºæŒ‡å‘ä¸‹ä¸€æ¡æ¶ˆæ¯æ‰è¡Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
    <span class="token comment">//å”¯ä¸€æ ‡è¯†</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> what<span class="token punctuation">;</span>
    <span class="token comment">//æ•°æ®</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> obj<span class="token punctuation">;</span>
    <span class="token comment">//æ—¶é—´æˆ³</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> when<span class="token punctuation">;</span>
	<span class="token comment">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
    <span class="token keyword">public</span> <span class="token class-name">Message</span> next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MessageQueue éœ€è¦æä¾›ä¸€ä¸ª <code>enqueueMessage</code>æ–¹æ³•ç”¨æ¥å‘é“¾è¡¨æ’å…¥ Messageï¼Œç”±äºå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶å‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯çš„å¯èƒ½ï¼Œæ‰€ä»¥æ–¹æ³•å†…éƒ¨è¿˜éœ€è¦åšä¸‹çº¿ç¨‹åŒæ­¥æ‰è¡Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageQueue</span> <span class="token punctuation">{</span>

    <span class="token comment">//é“¾è¡¨ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯</span>
    <span class="token keyword">private</span> <span class="token class-name">Message</span> mMessages<span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
            <span class="token comment">//å¦‚æœé“¾è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…å¤„äºé˜Ÿå¤´çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯” msg è¦å¤§ï¼Œåˆ™å°† msg ä½œä¸ºé“¾è¡¨å¤´éƒ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> prev<span class="token punctuation">;</span>
                <span class="token comment">//ä»é“¾è¡¨å¤´å‘é“¾è¡¨å°¾éå†ï¼Œå¯»æ‰¾é“¾è¡¨ä¸­ç¬¬ä¸€æ¡æ—¶é—´æˆ³æ¯” msg å¤§çš„æ¶ˆæ¯ï¼Œå°† msg æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                    p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤å¤–ï¼ŒMessageQueue è¦æœ‰ä¸€ä¸ªå¯ä»¥è·å–é˜Ÿå¤´æ¶ˆæ¯çš„æ–¹æ³•æ‰è¡Œï¼Œå°±å«åš<code>next()</code>å§ã€‚å¤–éƒ¨æœ‰å¯èƒ½ä¼šéšæ—¶å‘ MessageQueue å‘é€ Messageï¼Œ<code>next()</code>æ–¹æ³•å†…éƒ¨å°±ç›´æ¥æ¥å¼€å¯ä¸€ä¸ªæ— é™å¾ªç¯æ¥åå¤å–å€¼å§ã€‚å¦‚æœå½“å‰é˜Ÿå¤´çš„æ¶ˆæ¯å¯ä»¥ç›´æ¥å¤„ç†çš„è¯ï¼ˆå³æ¶ˆæ¯çš„æ—¶é—´æˆ³å°äºæˆ–ç­‰äºå½“å‰æ—¶é—´ï¼‰ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›é˜Ÿå¤´æ¶ˆæ¯ã€‚è€Œå¦‚æœé˜Ÿå¤´æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯”å½“å‰æ—¶é—´è¿˜è¦å¤§ï¼ˆå³é˜Ÿå¤´æ¶ˆæ¯æ˜¯ä¸€ä¸ªå»¶æ—¶æ¶ˆæ¯ï¼‰ï¼Œé‚£ä¹ˆå°±è®¡ç®—å½“å‰æ—¶é—´å’Œé˜Ÿå¤´æ¶ˆæ¯çš„æ—¶é—´æˆ³çš„å·®å€¼ï¼Œè®¡ç®— <code>next()</code> æ–¹æ³•éœ€è¦é˜»å¡ç­‰å¾…çš„æ—¶é—´ï¼Œè°ƒç”¨ <code>nativePollOnce()</code>æ–¹æ³•æ¥ç­‰å¾…ä¸€æ®µæ—¶é—´åå†ç»§ç»­å¾ªç¯éå†</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">//ç”¨æ¥æ ‡è®° next() æ–¹æ³•æ˜¯å¦æ­£å¤„äºé˜»å¡ç­‰å¾…çš„çŠ¶æ€</span>
<span class="token keyword">private</span> boolean mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

Message <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    int nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å½“å‰æ—¶é—´</span>
            <span class="token keyword">final</span> long now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Message msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//å¦‚æœå½“å‰æ—¶é—´è¿˜æœªåˆ°è¾¾æ¶ˆæ¯çš„çš„å¤„ç†æ—¶é—´ï¼Œé‚£ä¹ˆå°±è®¡ç®—è¿˜éœ€è¦ç­‰å¾…çš„æ—¶é—´</span>
                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//å¯ä»¥å¤„ç†é˜Ÿå¤´çš„æ¶ˆæ¯äº†ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯æˆä¸ºé˜Ÿå¤´</span>
                    mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// No more messages.</span>
                nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//å°† next æ–¹æ³•çš„è°ƒç”¨çº¿ç¨‹ä¼‘çœ æŒ‡å®šæ—¶é—´</span>
<span class="token keyword">private</span> void <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>long nextPollTimeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶å°±éœ€è¦è€ƒè™‘åˆ°ä¸€ç§æƒ…å½¢ï¼š<strong>å½“ <code>next()</code>è¿˜å¤„äºé˜»å¡çŠ¶æ€çš„æ—¶å€™ï¼Œå¤–éƒ¨å‘æ¶ˆæ¯é˜Ÿåˆ—æ’å…¥äº†ä¸€ä¸ªå¯ä»¥ç«‹å³å¤„ç†æˆ–è€…æ˜¯é˜»å¡ç­‰å¾…æ—¶é—´æ¯”è¾ƒçŸ­çš„ Message</strong>ã€‚æ­¤æ—¶å°±éœ€è¦å”¤é†’ä¼‘çœ çš„çº¿ç¨‹ï¼Œå› æ­¤ <code>enqueueMessage</code>è¿˜éœ€è¦å†æ”¹åŠ¨ä¸‹ï¼Œå¢åŠ åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’<code>next()</code>æ–¹æ³•çš„é€»è¾‘</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ç”¨äºæ ‡è®°æ˜¯å¦éœ€è¦å”¤é†’ next æ–¹æ³•</span>
        <span class="token keyword">boolean</span> needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>         
        <span class="token class-name">Message</span> p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
        <span class="token comment">//å¦‚æœé“¾è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…å¤„äºé˜Ÿå¤´çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯” msg è¦å¤§ï¼Œåˆ™å°† msg ä½œä¸ºé“¾è¡¨å¤´éƒ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>     
            <span class="token comment">//éœ€è¦å”¤é†’</span>
            needWake <span class="token operator">=</span> mBlocked<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> prev<span class="token punctuation">;</span>
            <span class="token comment">//ä»é“¾è¡¨å¤´å‘é“¾è¡¨å°¾éå†ï¼Œå¯»æ‰¾é“¾è¡¨ä¸­ç¬¬ä¸€æ¡æ—¶é—´æˆ³æ¯” msg å¤§çš„æ¶ˆæ¯ï¼Œå°† msg æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å”¤é†’ next() æ–¹æ³•</span>
            <span class="token function">nativeWake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//å”¤é†’ next() æ–¹æ³•</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">nativeWake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3ã€handler" tabindex="-1"><a class="header-anchor" href="#_3ã€handler" aria-hidden="true">#</a> 3ã€Handler</h2><p>æ—¢ç„¶å­˜æ”¾æ¶ˆæ¯çš„åœ°æ–¹å·²ç»ç¡®å®šå°±æ˜¯ MessageQueue äº†ï¼Œé‚£ä¹ˆè‡ªç„¶å°±è¿˜éœ€è¦æœ‰ä¸€ä¸ªç±»å¯ä»¥ç”¨æ¥å‘ MessageQueue å‘é€æ¶ˆæ¯äº†ï¼Œå°±å«å®ƒ Handler å§ã€‚Handler å¯ä»¥å®ç°å“ªäº›åŠŸèƒ½å‘¢ï¼Ÿ</p><ul><li>å¸Œæœ›é™¤äº†å¯ä»¥å‘é€ Message ç±»å‹çš„æ¶ˆæ¯å¤–è¿˜å¯ä»¥å‘é€ Runnable ç±»å‹çš„æ¶ˆæ¯ã€‚è¿™ä¸ªç®€å•ï¼ŒHandler å†…éƒ¨å°† Runnable åŒ…è£…ä¸º Message å³å¯</li><li>å¸Œæœ›å¯ä»¥å‘é€å»¶æ—¶æ¶ˆæ¯ï¼Œä»¥æ­¤æ¥æ‰§è¡Œå»¶æ—¶ä»»åŠ¡ã€‚è¿™ä¸ªä¹Ÿç®€å•ï¼Œç”¨ Message å†…éƒ¨çš„ when å­—æ®µæ¥æ ‡è¯†å¸Œæœ›ä»»åŠ¡æ‰§è¡Œæ—¶çš„æ—¶é—´æˆ³å³å¯</li><li>å¸Œæœ›å¯ä»¥å®ç°çº¿ç¨‹åˆ‡æ¢ï¼Œå³ä»å­çº¿ç¨‹å‘é€çš„ Message å¯ä»¥åœ¨ä¸»çº¿ç¨‹è¢«æ‰§è¡Œï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚è¿™ä¸ªä¹Ÿä¸éš¾ï¼Œå­çº¿ç¨‹å¯ä»¥å‘ä¸€ä¸ªç‰¹å®šçš„ mainMessageQueue å‘é€æ¶ˆæ¯ï¼Œç„¶åè®©ä¸»çº¿ç¨‹è´Ÿè´£å¾ªç¯ä»è¯¥é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯å¹¶æ‰§è¡Œå³å¯ï¼Œè¿™æ ·ä¸å°±å®ç°äº†çº¿ç¨‹åˆ‡æ¢äº†å—ï¼Ÿ</li></ul><p><strong>æ‰€ä»¥è¯´ï¼ŒMessage çš„å®šä¹‰å’Œå‘é€æ˜¯ç”± Handler æ¥å®Œæˆçš„ï¼Œä½† Message çš„åˆ†å‘åˆ™å¯ä»¥äº¤ç”±å…¶ä»–çº¿ç¨‹æ¥å®Œæˆ</strong></p><p>æ ¹æ®ä»¥ä¸Šéœ€æ±‚ï¼š<strong>Runnable è¦èƒ½å¤ŸåŒ…è£…ä¸º Message ç±»å‹ï¼ŒMessage çš„å¤„ç†é€»è¾‘è¦äº¤ç”± Handler æ¥å®šä¹‰</strong>ï¼Œæ‰€ä»¥ Message å°±è¿˜éœ€è¦å¢åŠ ä¸¤ä¸ªå­—æ®µæ‰è¡Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * @Author: leavesCZY
 * @Desc:
 * @Githubï¼šhttps://github.com/leavesCZY
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
    <span class="token comment">//å”¯ä¸€æ ‡è¯†</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> what<span class="token punctuation">;</span>
    <span class="token comment">//æ•°æ®</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> obj<span class="token punctuation">;</span>
    <span class="token comment">//æ—¶é—´æˆ³</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> when<span class="token punctuation">;</span>
	<span class="token comment">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
    <span class="token keyword">public</span> <span class="token class-name">Message</span> next<span class="token punctuation">;</span>
	<span class="token comment">//ç”¨äºå°† Runnable åŒ…è£…ä¸º Message</span>
    <span class="token keyword">public</span> <span class="token class-name">Runnable</span> callback<span class="token punctuation">;</span>
    <span class="token comment">//æŒ‡å‘ Message çš„å‘é€è€…ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ Message çš„æœ€ç»ˆå¤„ç†è€…</span>
    <span class="token keyword">public</span> <span class="token class-name">Handler</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Handler è‡³å°‘éœ€è¦åŒ…å«å‡ ä¸ªæ–¹æ³•ï¼šç”¨äºå‘é€ Message å’Œ Runnable çš„æ–¹æ³•ã€ç”¨æ¥å¤„ç†æ¶ˆæ¯çš„ <code>handleMessage</code> æ–¹æ³•ã€ç”¨äºåˆ†å‘æ¶ˆæ¯çš„ <code>dispatchMessage</code>æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * @Author: leavesCZY
 * @Desc:
 * @Githubï¼šhttps://github.com/leavesCZY
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">MessageQueue</span> mQueue<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> mQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mQueue <span class="token operator">=</span> mQueue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span><span class="token function">getPostMessage</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span><span class="token function">getPostMessage</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delayMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        mQueue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> <span class="token function">getPostMessage</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m<span class="token punctuation">.</span>callback <span class="token operator">=</span> r<span class="token punctuation">;</span>
        <span class="token keyword">return</span> m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//ç”±å¤–éƒ¨æ¥é‡å†™è¯¥æ–¹æ³•ï¼Œä»¥æ­¤æ¥æ¶ˆè´¹ Message</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//ç”¨äºåˆ†å‘æ¶ˆæ¯</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åï¼Œå­çº¿ç¨‹å°±å¯ä»¥åƒè¿™æ ·æ¥ä½¿ç”¨ Handler äº†ï¼š<strong>å°†å­çº¿ç¨‹æŒæœ‰çš„ Handler å¯¹è±¡å’Œä¸»çº¿ç¨‹å…³è”çš„ mainMessageQueue ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸»çº¿ç¨‹è´Ÿè´£å¾ªç¯ä» mainMessageQueue å–å‡º Message åå†æ¥è°ƒç”¨ Handler çš„ <code>dispatchMessage</code> æ–¹æ³•ï¼Œä»¥æ­¤å®ç°çº¿ç¨‹åˆ‡æ¢çš„ç›®çš„</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Handler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>mainThreadMessageQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> ob <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ob <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Message</span> messageA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messageA<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
messageA<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">&quot;https://github.com/leavesCZY&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">Message</span> messageB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messageB<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
messageB<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
handler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>messageA<span class="token punctuation">)</span><span class="token punctuation">;</span>
handler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>messageB<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4ã€looper" tabindex="-1"><a class="header-anchor" href="#_4ã€looper" aria-hidden="true">#</a> 4ã€Looper</h2><p>ç°åœ¨å°±å†æ¥æƒ³æƒ³æ€ä¹ˆè®© Handler æ‹¿åˆ°å’Œä¸»çº¿ç¨‹å…³è”çš„ MessageQueueï¼Œä»¥åŠä¸»çº¿ç¨‹æ€ä¹ˆä» MessageQueue è·å– Message å¹¶å›è°ƒ Handlerã€‚è¿™ä¹‹é—´å°±ä¸€å®šéœ€è¦ä¸€ä¸ªä¸­è½¬å™¨ï¼Œå°±å«å®ƒ Looper å§ã€‚Looper å…·ä½“éœ€è¦å®ç°ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿ</p><ul><li>æ¯ä¸ª Looper å¯¹è±¡åº”è¯¥éƒ½æ˜¯å¯¹åº”ä¸€ä¸ªç‹¬æœ‰çš„ MessageQueue å®ä¾‹å’Œ Thread å®ä¾‹ï¼Œè¿™æ ·å­çº¿ç¨‹å’Œä¸»çº¿ç¨‹æ‰å¯ä»¥äº’ç›¸å‘é€ Message äº¤ç”±å¯¹æ–¹çº¿ç¨‹å¤„ç†</li><li>Looper å†…éƒ¨éœ€è¦å¼€å¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå…¶å…³è”çš„çº¿ç¨‹å°±è´Ÿè´£ä» MessageQueue å¾ªç¯è·å– Message è¿›è¡Œå¤„ç†</li><li>å› ä¸ºä¸»çº¿ç¨‹è¾ƒä¸ºç‰¹æ®Šï¼Œæ‰€ä»¥å’Œä¸»çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡è¦èƒ½å¤Ÿè¢«å­çº¿ç¨‹ç›´æ¥è·å–åˆ°ï¼Œå¯ä»¥è€ƒè™‘å°†å…¶ä½œä¸ºé™æ€å˜é‡å­˜ç€</li></ul><p>è¿™æ ·ï¼ŒLooper çš„å¤§ä½“æ¡†æ¶å°±å‡ºæ¥äº†ã€‚é€šè¿‡ ThreadLocal æ¥ä¸ºä¸åŒçš„çº¿ç¨‹å•ç‹¬ç»´æŠ¤ä¸€ä¸ª Looper å®ä¾‹ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡ <code>prepare()</code>æ–¹æ³•æ¥åˆå§‹åŒ–æœ¬çº¿ç¨‹ç‹¬æœ‰çš„ Looper å®ä¾‹ ï¼Œå†é€šè¿‡ <code>myLooper()</code>æ–¹æ³•æ¥è·å–å’Œå½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå’Œä¸»çº¿ç¨‹å…³è”çš„ <code>sMainLooper</code> ä½œä¸ºé™æ€å˜é‡å­˜åœ¨ï¼Œæ–¹ä¾¿å­çº¿ç¨‹è·å–</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * @Author: leavesCZY
 * @Desc:
 * @Githubï¼šhttps://github.com/leavesCZY
 */</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Looper</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> mQueue<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">Thread</span> mThread<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Looper</span> sMainLooper<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span> sThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Only one Looper may be created per thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainLooper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;The main Looper has already been prepared.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sMainLooper <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Looper</span> <span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sMainLooper<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Looper</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Looper è¿˜éœ€è¦æœ‰ä¸€ä¸ªç”¨äºå¾ªç¯ä» MessageQueue è·å–æ¶ˆæ¯å¹¶å¤„ç†çš„æ–¹æ³•ï¼Œå°±å«å®ƒ<code>loop()</code>å§ã€‚å…¶ä½œç”¨ä¹Ÿèƒ½ç®€å•ï¼Œå°±æ˜¯å¾ªç¯ä» MessageQueue ä¸­å–å‡º Messageï¼Œç„¶åå°† Message å†åè¿‡æ¥åˆ†å‘ç»™ Handler å³å¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;No Looper; Looper.prepare() wasn&#39;t called on this thread.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯èƒ½ä¼šé˜»å¡</span>
        msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œä¸»çº¿ç¨‹å°±å…ˆé€šè¿‡è°ƒç”¨<code>prepareMainLooper()</code>æ¥å®Œæˆ sMainLooper çš„åˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨<code>loop()</code>å¼€å§‹å‘ mainMessageQueue å¾ªç¯å–å€¼å¹¶è¿›è¡Œå¤„ç†ï¼Œæ²¡æœ‰æ¶ˆæ¯çš„è¯ä¸»çº¿ç¨‹å°±æš‚æ—¶ä¼‘çœ ç€ã€‚å­çº¿ç¨‹æ‹¿åˆ° sMainLooper åå°±ä»¥æ­¤æ¥åˆå§‹åŒ– Handlerï¼Œè¿™æ ·å­çº¿ç¨‹å‘ Handler å‘é€çš„æ¶ˆæ¯å°±éƒ½ä¼šè¢«å­˜åˆ° mainMessageQueue ä¸­ï¼Œæœ€ç»ˆåœ¨ä¸»çº¿ç¨‹è¢«æ¶ˆè´¹æ‰</p><h2 id="_5ã€åšä¸€ä¸ªæ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_5ã€åšä¸€ä¸ªæ€»ç»“" aria-hidden="true">#</a> 5ã€åšä¸€ä¸ªæ€»ç»“</h2><p>è¿™æ ·ä¸€æ­¥æ­¥èµ°ä¸‹æ¥åï¼Œè¯»è€…å¯¹äº Messageã€MessageQueueã€Handlerã€Looper è¿™å››ä¸ªç±»çš„å®šä½å°±åº”è¯¥éƒ½å¾ˆæ¸…æ™°äº†å§ï¼Ÿä¸åŒçº¿ç¨‹ä¹‹é—´å°±å¯ä»¥ä¾é æ‹¿åˆ°å¯¹æ–¹çš„ Looper æ¥å®ç°æ¶ˆæ¯çš„è·¨çº¿ç¨‹å¤„ç†äº†</p><p>ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹ä»£ç ï¼Œå³ä½¿ Handler æ˜¯åœ¨ otherThread ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼Œä½† <code>handleMessage</code> æ–¹æ³•æœ€ç»ˆæ˜¯ä¼šåœ¨ mainThread è¢«è°ƒç”¨æ‰§è¡Œçš„ï¼Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Thread</span> mainThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//åˆå§‹åŒ– mainLooper</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å¼€å¯å¾ªç¯</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Thread</span> otherThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Looper</span> mainLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Handler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>mainLooper<span class="token punctuation">.</span>mQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> ob <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ob <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Message</span> messageA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageA<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        messageA<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">&quot;https://github.com/leavesCZY&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Message</span> messageB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageB<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        messageB<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>messageA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>messageB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ¥åšä¸ªç®€å•çš„æ€»ç»“ï¼š</p><ul><li>Messageï¼šç”¨æ¥è¡¨ç¤ºè¦æ‰§è¡Œçš„ä»»åŠ¡</li><li>Handlerï¼šå­çº¿ç¨‹æŒæœ‰çš„ Handler å¦‚æœç»‘å®šåˆ°çš„æ˜¯ä¸»çº¿ç¨‹çš„ MessageQueue çš„è¯ï¼Œé‚£ä¹ˆå­çº¿ç¨‹å‘é€çš„ Message å°±å¯ä»¥ç”±ä¸»çº¿ç¨‹æ¥æ¶ˆè´¹ï¼Œä»¥æ­¤æ¥å®ç°çº¿ç¨‹åˆ‡æ¢ï¼Œæ‰§è¡Œ UI æ›´æ–°æ“ä½œç­‰ç›®çš„</li><li>MessageQueueï¼šå³æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡ Handler å‘é€çš„æ¶ˆæ¯å¹¶ééƒ½æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œéœ€è¦å…ˆæŒ‰ç…§ Message çš„ä¼˜å…ˆçº§é«˜ä½ï¼ˆå»¶æ—¶æ—¶é—´çš„é•¿çŸ­ï¼‰ä¿å­˜åˆ° MessageQueue ä¸­ï¼Œä¹‹åå†æ¥ä¾æ¬¡æ‰§è¡Œ</li><li>Looperï¼šLooper ç”¨äºä» MessageQueue ä¸­å¾ªç¯è·å– Message å¹¶å°†ä¹‹ä¼ é€’ç»™æ¶ˆæ¯å¤„ç†è€…ï¼ˆå³æ¶ˆæ¯å‘é€è€… Handler æœ¬èº«ï¼‰æ¥è¿›è¡Œæ¶ˆè´¹ï¼Œæ¯æ¡ Message éƒ½æœ‰ä¸ª target å˜é‡ç”¨æ¥æŒ‡å‘ Handlerï¼Œä»¥æ­¤æŠŠ Message å’Œå…¶å¤„ç†è€…å…³è”èµ·æ¥ã€‚ä¸åŒçº¿ç¨‹ä¹‹é—´é€šè¿‡äº’ç›¸æ‹¿åˆ°å¯¹æ–¹çš„ Looper å¯¹è±¡ï¼Œä»¥æ­¤æ¥å®ç°è·¨çº¿ç¨‹å‘é€æ¶ˆæ¯</li></ul><p><strong>æœ‰äº†ä»¥ä¸Šçš„è®¤çŸ¥åŸºç¡€åï¼Œä¸‹é¢å°±æ¥çœ‹çœ‹å®é™…çš„æºç å®ç° ~ ~</strong></p><h1 id="äºŒã€handler-æºç " tabindex="-1"><a class="header-anchor" href="#äºŒã€handler-æºç " aria-hidden="true">#</a> äºŒã€Handler æºç </h1><h2 id="_1ã€handler-å¦‚ä½•åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#_1ã€handler-å¦‚ä½•åˆå§‹åŒ–" aria-hidden="true">#</a> 1ã€Handler å¦‚ä½•åˆå§‹åŒ–</h2><p>Handler çš„æ„é€ å‡½æ•°ä¸€å…±æœ‰ä¸ƒä¸ªï¼Œé™¤å»<strong>ä¸¤ä¸ªå·²ç»åºŸå¼ƒçš„å’Œä¸‰ä¸ªéšè—çš„</strong>ï¼Œå®é™…ä¸Šå¼€å‘è€…å¯ä»¥ä½¿ç”¨çš„åªæœ‰ä¸¤ä¸ªã€‚è€Œä¸ç®¡æ˜¯ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°ï¼Œæœ€ç»ˆçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†å®Œæˆ <strong>mLooperã€mQueueã€mCallbackã€mAsynchronous</strong> è¿™å››ä¸ªå¸¸é‡çš„åˆå§‹åŒ–ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ MessageQueue æ˜¯ç”± Looper æ¥å®Œæˆåˆå§‹åŒ–çš„ï¼Œè€Œä¸” Handler å¯¹äº Looper å’Œ MessageQueue éƒ½æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¸€æ—¦åˆå§‹åŒ–åå°±ä¸å¯æ”¹å˜</p><p><strong>å¤§éƒ¨åˆ†å¼€å‘è€…ä½¿ç”¨çš„åº”è¯¥éƒ½æ˜¯ Handler çš„æ— å‚æ„é€ å‡½æ•°ï¼Œè€Œåœ¨ Android 11 ä¸­ Handler çš„æ— å‚æ„é€ å‡½æ•°å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒçš„äº†</strong>ã€‚Google å®˜æ–¹æ›´æ¨èçš„åšæ³•æ˜¯é€šè¿‡æ˜¾å¼ä¼ å…¥ Looper å¯¹è±¡æ¥å®Œæˆåˆå§‹åŒ–ï¼Œè€Œééšå¼ä½¿ç”¨å½“å‰çº¿ç¨‹å…³è”çš„ Looper</p><blockquote><p>Handler å¯¹äº Looper å’Œ MessageQueue éƒ½æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä½†æ˜¯ Looper å’Œ MessageQueue å¯¹äº Handler å¯ä»¥æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">final</span> <span class="token class-name">Looper</span> mLooper<span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> mQueue<span class="token punctuation">;</span>
<span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">final</span> <span class="token class-name">Callback</span> mCallback<span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> mAsynchronous<span class="token punctuation">;</span>

<span class="token comment">//çœç•¥å…¶å®ƒæ„é€ å‡½æ•°</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@hide</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">FIND_POTENTIAL_LEAKS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span><span class="token punctuation">&gt;</span></span> klass <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>klass<span class="token punctuation">.</span><span class="token function">isAnonymousClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> klass<span class="token punctuation">.</span><span class="token function">isMemberClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> klass<span class="token punctuation">.</span><span class="token function">isLocalClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>klass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">STATIC</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;The following Handler class should be static or leaks might occur: &quot;</span> <span class="token operator">+</span>
                klass<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mLooper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Can&#39;t create handler inside thread &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot; that has not called Looper.prepare()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mQueue <span class="token operator">=</span> mLooper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>
    mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2ã€looper-å¦‚ä½•åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#_2ã€looper-å¦‚ä½•åˆå§‹åŒ–" aria-hidden="true">#</a> 2ã€Looper å¦‚ä½•åˆå§‹åŒ–</h2><p>åœ¨åˆå§‹åŒ– Handler æ—¶ï¼Œå¦‚æœå¤–éƒ¨è°ƒç”¨çš„æ„é€ å‡½æ•°æ²¡æœ‰ä¼ å…¥ Looperï¼Œé‚£å°±ä¼šè°ƒç”¨<code>Looper.myLooper()</code>æ¥è·å–å’Œå½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå†ä» Looper ä¸­å– MessageQueueã€‚å¦‚æœè·å–åˆ°çš„ Looper å¯¹è±¡ä¸º null å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ ¹æ®å¼‚å¸¸ä¿¡æ¯ <code>Can&#39;t create handler inside thread that has not called Looper.prepare()</code> å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨åˆå§‹åŒ– Handler ä¹‹å‰éœ€è¦å…ˆè°ƒç”¨ <code>Looper.prepare()</code>å®Œæˆ Looper çš„åˆå§‹åŒ–</p><p>èµ°è¿› <code>Looper</code> ç±»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>myLooper()</code>æ–¹æ³•æ˜¯ Looper ç±»çš„é™æ€æ–¹æ³•ï¼Œå…¶åªæ˜¯å•çº¯åœ°ä» <code>sThreadLocal</code> å˜é‡ä¸­å–å€¼å¹¶è¿”å›è€Œå·²ã€‚<code>sThreadLocal</code> åˆæ˜¯é€šè¿‡ <code>prepare(boolean)</code> æ–¹æ³•æ¥è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼çš„ï¼Œä¸”åªèƒ½èµ‹å€¼ä¸€æ¬¡ï¼Œé‡å¤è°ƒç”¨å°†æŠ›å‡ºå¼‚å¸¸</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒThreadLocal çš„ç‰¹æ€§å°±æ˜¯å¯ä»¥ä¸ºä¸åŒçš„çº¿ç¨‹åˆ†åˆ«ç»´æŠ¤å•ç‹¬çš„ä¸€ä¸ªå˜é‡å®ä¾‹ï¼Œæ‰€ä»¥ï¼Œä¸åŒçš„çº¿ç¨‹å°±ä¼šåˆ†åˆ«å¯¹åº”ç€ä¸åŒçš„ Looper å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span> sThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token doc-comment comment">/**
 * Return the Looper object associated with the current thread.  Returns
 * null if the calling thread is not associated with a Looper.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Looper</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/** Initialize the current thread as a looper.
  * This gives you a chance to create handlers that then reference
  * this looper, before actually starting the loop. Be sure to call
  * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> after calling this method, and end it by calling
  * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>.
  */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//åªå…è®¸èµ‹å€¼ä¸€æ¬¡</span>
        <span class="token comment">//å¦‚æœé‡å¤èµ‹å€¼åˆ™æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Only one Looper may be created per thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤å¤–ï¼ŒLooper ç±»çš„æ„é€ å‡½æ•°ä¹Ÿæ˜¯ç§æœ‰çš„ï¼Œä¼šåˆå§‹åŒ–ä¸¤ä¸ªå¸¸é‡å€¼ï¼šmQueue å’Œ mThreadï¼Œè¿™è¯´æ˜äº† Looper å¯¹äº MessageQueue å’Œ Thread éƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œå…³è”ä¹‹åä¸èƒ½æ”¹å˜</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> mQueue<span class="token punctuation">;</span>

<span class="token keyword">final</span> <span class="token class-name">Thread</span> mThread<span class="token punctuation">;</span>    

<span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åœ¨é€šè¿‡ Handler æ¥æ‰§è¡Œ UI åˆ·æ–°æ“ä½œæ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„æ˜¯ Handler çš„æ— å‚æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆæ­¤æ—¶è‚¯å®šå°±æ˜¯ä½¿ç”¨äº†å’Œä¸»çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå¯¹åº” Looper ç±»ä¸­çš„é™æ€å˜é‡ <code>sMainLooper</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Looper</span> sMainLooper<span class="token punctuation">;</span>  <span class="token comment">// guarded by Looper.class</span>

<span class="token comment">//è¢«æ ‡è®°ä¸ºåºŸå¼ƒçš„åŸå› æ˜¯å› ä¸º sMainLooper ä¼šäº¤ç”± Android ç³»ç»Ÿè‡ªåŠ¨æ¥å®Œæˆåˆå§‹åŒ–ï¼Œå¤–éƒ¨ä¸åº”è¯¥ä¸»åŠ¨æ¥åˆå§‹åŒ–</span>
<span class="token annotation punctuation">@Deprecated</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainLooper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;The main Looper has already been prepared.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sMainLooper <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Returns the application&#39;s main looper, which lives in the main thread of the application.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Looper</span> <span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sMainLooper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>prepareMainLooper()</code>å°±ç”¨äºä¸ºä¸»çº¿ç¨‹åˆå§‹åŒ– Looper å¯¹è±¡ï¼Œè¯¥æ–¹æ³•åˆæ˜¯ç”± ActivityThread ç±»çš„ <code>main()</code> æ–¹æ³•æ¥è°ƒç”¨çš„ã€‚è¯¥ <code>main()</code> æ–¹æ³•å³ Java ç¨‹åºçš„è¿è¡Œèµ·å§‹ç‚¹ï¼Œæ‰€ä»¥å½“åº”ç”¨å¯åŠ¨æ—¶ç³»ç»Ÿå°±è‡ªåŠ¨ä¸ºæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹åšå¥½äº† mainLooper çš„åˆå§‹åŒ–ï¼Œè€Œä¸”å·²ç»è°ƒç”¨äº†<code>Looper.loop()</code>æ–¹æ³•å¼€å¯äº†æ¶ˆæ¯çš„å¾ªç¯å¤„ç†ï¼Œåº”ç”¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å„ç§äº¤äº’é€»è¾‘ï¼ˆä¾‹å¦‚ï¼šå±å¹•çš„è§¦æ‘¸äº‹ä»¶ã€åˆ—è¡¨çš„æ»‘åŠ¨ç­‰ï¼‰å°±éƒ½æ˜¯åœ¨è¿™ä¸ªå¾ªç¯é‡Œå®Œæˆåˆ†å‘çš„</p><p>æ­£æ˜¯å› ä¸º Android ç³»ç»Ÿå·²ç»è‡ªåŠ¨å®Œæˆäº†ä¸»çº¿ç¨‹ Looper çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­æ‰å¯ä»¥ç›´æ¥ä½¿ç”¨ Handler çš„æ— å‚æ„é€ å‡½æ•°æ¥å®Œæˆ UI ç›¸å…³äº‹ä»¶çš„å¤„ç†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Â·Â·Â·
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Â·Â·Â·
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread loop unexpectedly exited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3ã€handler-å‘é€æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_3ã€handler-å‘é€æ¶ˆæ¯" aria-hidden="true">#</a> 3ã€Handler å‘é€æ¶ˆæ¯</h2><p>Handler ç”¨äºå‘é€æ¶ˆæ¯çš„æ–¹æ³•éå¸¸å¤šï¼Œæœ‰åå‡ ä¸ªï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æœ€ç»ˆè°ƒç”¨åˆ°çš„éƒ½æ˜¯ <code>sendMessageAtTime()</code> æ–¹æ³•ã€‚uptimeMillis å³ Message å…·ä½“è¦æ‰§è¡Œçš„æ—¶é—´æˆ³ï¼Œå¦‚æœè¯¥æ—¶é—´æˆ³æ¯”å½“å‰æ—¶é—´å¤§ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¦æ‰§è¡Œçš„æ˜¯å»¶è¿Ÿä»»åŠ¡ã€‚å¦‚æœä¸º mQueue ä¸º nullï¼Œå°±ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯å¹¶ç›´æ¥è¿”å›ï¼Œå› ä¸º Message æ˜¯éœ€è¦äº¤ç”± MessageQueue æ¥å¤„ç†çš„</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MessageQueue</span> queue <span class="token operator">=</span> mQueue<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RuntimeException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; sendMessageAtTime() called with no mQueue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">&quot;Looper&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éœ€è¦æ³¨æ„ <code>msg.target = this</code> è¿™å¥ä»£ç ï¼Œtarget æŒ‡å‘äº†<strong>å‘é€æ¶ˆæ¯çš„ä¸»ä½“</strong>ï¼Œå³ Handler å¯¹è±¡æœ¬èº«ï¼Œå³ç”± Handler å¯¹è±¡å‘ç»™ MessageQueue çš„æ¶ˆæ¯æœ€åè¿˜æ˜¯è¦äº¤ç”± Handler å¯¹è±¡æœ¬èº«æ¥å¤„ç†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MessageQueue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
        <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>workSourceUid <span class="token operator">=</span> <span class="token class-name">ThreadLocalWorkSource</span><span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAsynchronous<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//å°†æ¶ˆæ¯äº¤ç”± MessageQueue å¤„ç†</span>
    <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4ã€messagequeue" tabindex="-1"><a class="header-anchor" href="#_4ã€messagequeue" aria-hidden="true">#</a> 4ã€MessageQueue</h2><p>MessageQueue é€šè¿‡ <code>enqueueMessage</code> æ–¹æ³•æ¥æ¥æ”¶æ¶ˆæ¯</p><ul><li>å› ä¸ºå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶å¾€ä¸€ä¸ª MessageQueue å‘é€æ¶ˆæ¯çš„å¯èƒ½ï¼Œæ‰€ä»¥ <code>enqueueMessage</code> å†…éƒ¨è‚¯å®šéœ€è¦è¿›è¡Œçº¿ç¨‹åŒæ­¥</li><li>å¯ä»¥çœ‹å‡º MessageQueue å†…éƒ¨æ˜¯ä»¥é“¾è¡¨çš„ç»“æ„æ¥å­˜å‚¨ Message çš„ï¼ˆMessage.nextï¼‰ï¼Œæ ¹æ® Message çš„æ—¶é—´æˆ³å¤§å°æ¥å†³å®šå…¶åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä½ç½®</li><li>mMessages ä»£è¡¨çš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚å¦‚æœ mMessages ä¸ºç©ºï¼ˆæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼‰ï¼Œæˆ–è€… mMessages çš„æ—¶é—´æˆ³è¦æ¯”æ–°æ¶ˆæ¯çš„æ—¶é—´æˆ³å¤§ï¼Œåˆ™å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´éƒ¨ï¼›å¦‚æœ mMessages ä¸ä¸ºç©ºï¼Œåˆ™å¯»æ‰¾æ¶ˆæ¯åˆ—é˜Ÿä¸­ç¬¬ä¸€æ¡è§¦å‘æ—¶é—´æ¯”æ–°æ¶ˆæ¯æ™šçš„éç©ºæ¶ˆæ¯ï¼Œå°†æ–°æ¶ˆæ¯æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</li></ul><p>åˆ°æ­¤ï¼Œä¸€ä¸ªæŒ‰ç…§æ—¶é—´æˆ³å¤§å°è¿›è¡Œæ’åºçš„æ¶ˆæ¯é˜Ÿåˆ—å°±å®Œæˆäº†ï¼Œåè¾¹è¦åšçš„å°±æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¾æ¬¡å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†äº†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Message must have a target.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Â·Â·Â·
        msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>
        <span class="token class-name">Message</span> p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
        <span class="token comment">//ç”¨äºæ ‡è®°æ˜¯å¦éœ€è¦å”¤é†’çº¿ç¨‹</span>
        <span class="token keyword">boolean</span> needWake<span class="token punctuation">;</span>
        <span class="token comment">//å¦‚æœé“¾è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…å¤„äºé˜Ÿå¤´çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³æ¯” msg è¦å¤§ï¼Œåˆ™å°† msg ä½œä¸ºé“¾è¡¨å¤´éƒ¨</span>
        <span class="token comment">//when == 0 è¯´æ˜ Handler è°ƒç”¨çš„æ˜¯ sendMessageAtFrontOfQueue æ–¹æ³•ï¼Œç›´æ¥å°† msg æ’åˆ°é˜Ÿåˆ—å¤´éƒ¨ </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// New head, wake up the event queue if blocked.</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            needWake <span class="token operator">=</span> mBlocked<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœå½“å‰çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ + é˜Ÿå¤´æ¶ˆæ¯æ˜¯å±éšœæ¶ˆæ¯ + msg æ˜¯å¼‚æ­¥æ¶ˆæ¯</span>
            <span class="token comment">//é‚£ä¹ˆå°±éœ€è¦å”¤é†’çº¿ç¨‹</span>
            needWake <span class="token operator">=</span> mBlocked <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Message</span> prev<span class="token punctuation">;</span>
            <span class="token comment">//ä»é“¾è¡¨å¤´å‘é“¾è¡¨å°¾éå†ï¼Œå¯»æ‰¾é“¾è¡¨ä¸­ç¬¬ä¸€æ¡æ—¶é—´æˆ³æ¯” msg å¤§çš„æ¶ˆæ¯ï¼Œå°† msg æ’åˆ°è¯¥æ¶ˆæ¯çš„å‰é¢</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//å¦‚æœåœ¨ msg ä¹‹å‰é˜Ÿåˆ—ä¸­è¿˜æœ‰å¼‚æ­¥æ¶ˆæ¯é‚£ä¹ˆå°±ä¸éœ€è¦ä¸»åŠ¨å”¤é†’</span>
                    <span class="token comment">//å› ä¸ºå·²ç»è®¾å®šå”¤é†’æ—¶é—´äº†</span>
                    needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// invariant: p == prev.next</span>
            prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// We can assume mPtr != 0 because mQuitting is false.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çŸ¥é“äº† Message æ˜¯å¦‚ä½•ä¿å­˜çš„äº†ï¼Œå†æ¥çœ‹ä¸‹ MessageQueue æ˜¯å¦‚ä½•å–å‡º Message å¹¶å›è°ƒç»™ Handler çš„ã€‚åœ¨ MessageQueue ä¸­è¯»å–æ¶ˆæ¯çš„æ“ä½œå¯¹åº”çš„æ˜¯<code>next()</code> æ–¹æ³•ã€‚<code>next()</code> æ–¹æ³•å†…éƒ¨å¼€å¯äº†ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æˆ–è€…æ˜¯é˜Ÿå¤´æ¶ˆæ¯è¿˜æ²¡åˆ°å¯ä»¥å¤„ç†çš„æ—¶é—´ï¼Œè¯¥æ–¹æ³•å°±ä¼šå¯¼è‡´ Loop çº¿ç¨‹ä¼‘çœ æŒ‚èµ·ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³åå†é‡æ–°éå†æ¶ˆæ¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Â·Â·Â·
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextPollTimeoutMillis <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">flushPendingCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//å°† Loop çº¿ç¨‹ä¼‘çœ æŒ‚èµ·</span>
        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Try to retrieve the next message.  Return if found.</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> prevMsg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
                    msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//é˜Ÿå¤´æ¶ˆæ¯è¿˜æœªåˆ°å¤„ç†æ—¶é—´ï¼Œè®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´</span>
                    <span class="token comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span>
                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Got a message.</span>
                    mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    msg<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Returning message: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// No more messages.</span>
                nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Â·Â·Â·
        <span class="token punctuation">}</span>
        Â·Â·Â·
        <span class="token punctuation">}</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>next()</code> æ–¹æ³•åˆæ˜¯é€šè¿‡ Looper ç±»çš„ <code>loop()</code> æ–¹æ³•æ¥å¾ªç¯è°ƒç”¨çš„ï¼Œ<code>loop()</code> æ–¹æ³•å†…ä¹Ÿæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå”¯ä¸€è·³å‡ºå¾ªç¯çš„æ¡ä»¶å°±æ˜¯ <code>queue.next()</code>æ–¹æ³•è¿”å›ä¸º nullã€‚å› ä¸º <code>next()</code> æ–¹æ³•å¯èƒ½ä¼šè§¦å‘é˜»å¡æ“ä½œï¼Œæ‰€ä»¥æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†æ—¶ä¹Ÿä¼šå¯¼è‡´ <code>loop()</code> æ–¹æ³•è¢«é˜»å¡ç€ï¼Œè€Œå½“ MessageQueue æœ‰äº†æ–°çš„æ¶ˆæ¯ï¼ŒLooper å°±ä¼šåŠæ—¶åœ°å¤„ç†è¿™æ¡æ¶ˆæ¯å¹¶è°ƒç”¨ <code>msg.target.dispatchMessage(msg)</code> æ–¹æ³•å°†æ¶ˆæ¯å›ä¼ ç»™ Handler è¿›è¡Œå¤„ç†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Run the message queue in this thread. Be sure to call
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> to end the loop.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;No Looper; Looper.prepare() wasn&#39;t called on this thread.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Â·Â·Â·	
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// might block</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// No message indicates that the message queue is quitting.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Â·Â·Â·
        msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Handler çš„<code>dispatchMessage</code>æ–¹æ³•å°±æ˜¯åœ¨å‘å¤–éƒ¨åˆ†å‘å¤„ç† Message äº†ï¼ŒMessage æœ€ç»ˆæ˜¯æŒ‰å¦‚ä¸‹é¡ºåºè¿›è¡Œå¤„ç†çš„ï¼š</p><ul><li>å¦‚æœè¯¥ Message æ˜¯é€šè¿‡ <code>post(Runnable)</code>ç­‰æ–¹æ³•è¿›è¡Œå‘é€çš„ï¼Œé‚£ä¹ˆå°±ç›´æ¥å›è°ƒè¯¥ Runnable å¯¹è±¡</li><li>å¦‚æœåœ¨åˆå§‹åŒ– Handler æ—¶ä¼ å…¥äº† Callback å¯¹è±¡ï¼Œåˆ™ä¼˜å…ˆäº¤ç”±å…¶å¤„ç†ï¼Œå¦‚æœ Callback çš„ <code>handleMessage</code> æ–¹æ³•è¿”å›äº† trueï¼Œåˆ™ç»“æŸæµç¨‹</li><li>è°ƒç”¨ Handler çš„<code>handleMessage</code> æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ï¼Œå¤–éƒ¨é€šè¿‡é‡å†™è¯¥æ–¹æ³•æ¥å®šä¹‰ä¸šåŠ¡é€»è¾‘</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleCallback</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼ŒMessage çš„æ•´ä¸ªåˆ†å‘æµç¨‹å°±ç»“æŸäº†</p><h2 id="_5ã€æ¶ˆæ¯å±éšœ" tabindex="-1"><a class="header-anchor" href="#_5ã€æ¶ˆæ¯å±éšœ" aria-hidden="true">#</a> 5ã€æ¶ˆæ¯å±éšœ</h2><p>Android ç³»ç»Ÿä¸ºäº†ä¿è¯æŸäº›é«˜ä¼˜å…ˆçº§çš„ Messageï¼ˆå¼‚æ­¥æ¶ˆæ¯ï¼‰ èƒ½å¤Ÿè¢«å°½å¿«æ‰§è¡Œï¼Œé‡‡ç”¨äº†ä¸€ç§æ¶ˆæ¯å±éšœï¼ˆBarrierï¼‰æœºåˆ¶ã€‚å…¶å¤§è‡´æµç¨‹æ˜¯ï¼šå…ˆå‘é€ä¸€ä¸ªå±éšœæ¶ˆæ¯åˆ° MessageQueue ä¸­ï¼Œå½“ MessageQueue éå†åˆ°è¯¥å±éšœæ¶ˆæ¯æ—¶ï¼Œå°±ä¼šåˆ¤æ–­å½“å‰é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨<strong>å¼‚æ­¥æ¶ˆæ¯</strong>ï¼Œæœ‰çš„è¯åˆ™å…ˆè·³è¿‡åŒæ­¥æ¶ˆæ¯ï¼ˆå¼€å‘è€…ä¸»åŠ¨å‘é€çš„éƒ½å±äºåŒæ­¥æ¶ˆæ¯ï¼‰ï¼Œä¼˜å…ˆæ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯ã€‚è¿™ç§æœºåˆ¶å°±ä¼šä½¿å¾—åœ¨å¼‚æ­¥æ¶ˆæ¯è¢«æ‰§è¡Œå®Œä¹‹å‰ï¼ŒåŒæ­¥æ¶ˆæ¯éƒ½ä¸ä¼šå¾—åˆ°å¤„ç†</p><p>Handler çš„æ„é€ å‡½æ•°ä¸­çš„<code>async</code>å‚æ•°å°±ç”¨äºæ§åˆ¶å‘é€çš„ Message æ˜¯å¦å±äºå¼‚æ­¥æ¶ˆæ¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token keyword">boolean</span> mAsynchronous<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Looper</span> looper<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Â·Â·Â·
        mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MessageQueue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
            <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>workSourceUid <span class="token operator">=</span> <span class="token class-name">ThreadLocalWorkSource</span><span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAsynchronous<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//è®¾ä¸ºå¼‚æ­¥æ¶ˆæ¯</span>
            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MessageQueue åœ¨è·å–é˜Ÿå¤´æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœåˆ¤æ–­åˆ°é˜Ÿå¤´æ¶ˆæ¯çš„ target å¯¹è±¡ä¸º null çš„è¯ï¼Œå°±çŸ¥é“è¯¥ Message å±äºå±éšœæ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ä¼šå†å‘åéå†æ‰¾åˆ°ç¬¬ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯ä¼˜å…ˆè¿›è¡Œå¤„ç†ï¼Œæ¯æ¬¡è°ƒç”¨ <code>next()</code> æ–¹æ³•æ—¶éƒ½ä¼šé‡å¤æ­¤æ­¥éª¤çŸ¥é“æ‰€æœ‰å¼‚æ­¥æ¶ˆæ¯å‡è¢«å¤„ç†å®Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Â·Â·Â·
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextPollTimeoutMillis <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">flushPendingCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Try to retrieve the next message.  Return if found.</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> prevMsg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//target ä¸º null å³å±äºå±éšœæ¶ˆæ¯</span>
                <span class="token comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span>
                <span class="token comment">//å¾ªç¯éå†ï¼Œæ‰¾åˆ°å±éšœæ¶ˆæ¯åé¢çš„ç¬¬ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œå¤„ç†</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
                    msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Â·Â·Â·
        <span class="token punctuation">}</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ Message å¯¹è±¡çš„ <code>setAsynchronous(boolean async)</code> æ–¹æ³•æ¥ä¸»åŠ¨å‘é€å¼‚æ­¥æ¶ˆæ¯ã€‚è€Œå¦‚æœæƒ³è¦ä¸»åŠ¨å‘é€å±éšœæ¶ˆæ¯çš„è¯ï¼Œå°±éœ€è¦é€šè¿‡åå°„æ¥è°ƒç”¨ MessageQueue çš„ <code>postSyncBarrier()</code> æ–¹æ³•äº†ï¼Œè¯¥æ–¹æ³•è¢«ç³»ç»Ÿéšè—èµ·æ¥äº†</p><p>å±éšœæ¶ˆæ¯çš„ä½œç”¨å°±æ˜¯å¯ä»¥ç¡®ä¿é«˜ä¼˜å…ˆçº§çš„å¼‚æ­¥æ¶ˆæ¯å¯ä»¥ä¼˜å…ˆè¢«å¤„ç†ï¼ŒViewRootImpl å°±é€šè¿‡è¯¥æœºåˆ¶æ¥ä½¿å¾— View çš„ç»˜åˆ¶æµç¨‹å¯ä»¥ä¼˜å…ˆè¢«å¤„ç†</p><h2 id="_6ã€é€€å‡º-looper-å¾ªç¯" tabindex="-1"><a class="header-anchor" href="#_6ã€é€€å‡º-looper-å¾ªç¯" aria-hidden="true">#</a> 6ã€é€€å‡º Looper å¾ªç¯</h2><p>Looper ç±»æœ¬èº«åšäº†æ–¹æ³•é™åˆ¶ï¼Œé™¤äº†ä¸»çº¿ç¨‹å¤–ï¼Œå­çº¿ç¨‹å…³è”çš„ MessageQueue éƒ½æ”¯æŒé€€å‡º Loop å¾ªç¯ï¼Œå³ quitAllowed åªæœ‰ä¸»çº¿ç¨‹æ‰èƒ½æ˜¯ false</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Looper</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Only one Looper may be created per thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MessageQueue æ”¯æŒä¸¤ç§æ–¹å¼æ¥é€€å‡º Loopï¼š</p><ul><li>safe ä¸º trueï¼Œåªç§»é™¤æ‰€æœ‰å°šæœªæ‰§è¡Œçš„æ¶ˆæ¯ï¼Œä¸ç§»é™¤æ—¶é—´æˆ³ç­‰äºå½“å‰æ—¶é—´çš„æ¶ˆæ¯</li><li>safe ä¸º falseï¼Œç§»é™¤æ‰€æœ‰æ¶ˆæ¯</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">quit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> safe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mQuitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//MessageQueue è®¾ç½®äº†ä¸å…è®¸é€€å‡ºå¾ªç¯ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread not allowed to quit.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//é¿å…é‡å¤è°ƒç”¨</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mQuitting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>safe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//åªç§»é™¤æ‰€æœ‰å°šæœªæ‰§è¡Œçš„æ¶ˆæ¯ï¼Œä¸ç§»é™¤æ—¶é—´æˆ³ç­‰äºå½“å‰æ—¶é—´çš„æ¶ˆæ¯</span>
            <span class="token function">removeAllFutureMessagesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//ç§»é™¤æ‰€æœ‰æ¶ˆæ¯</span>
            <span class="token function">removeAllMessagesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// We can assume mPtr != 0 because mQuitting was previously false.</span>
        <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7ã€idlehandler" tabindex="-1"><a class="header-anchor" href="#_7ã€idlehandler" aria-hidden="true">#</a> 7ã€IdleHandler</h2><p>IdleHandler æ˜¯ MessageQueue çš„ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œå¯ä»¥ç”¨äºåœ¨ Loop çº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™æ‰§è¡Œä¸€äº›ä¼˜å…ˆçº§ä¸é«˜çš„æ“ä½œï¼Œé€šè¿‡ MessageQueue çš„ <code>addIdleHandler</code> æ–¹æ³•æ¥æäº¤è¦æ‰§è¡Œçš„æ“ä½œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">interface</span> <span class="token class-name">IdleHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IdleHandler</span><span class="token punctuation">&gt;</span></span> mIdleHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IdleHandler</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IdleHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t add a null IdleHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mIdleHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeIdleHandler</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IdleHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mIdleHandlers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MessageQueue åœ¨æ‰§è¡Œ <code>next()</code> æ–¹æ³•æ—¶ï¼Œå¦‚æœå‘ç°å½“å‰é˜Ÿåˆ—æ˜¯ç©ºçš„æˆ–è€…é˜Ÿå¤´æ¶ˆæ¯éœ€è¦å»¶è¿Ÿå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå»å°è¯•éå† <code>mIdleHandlers</code>æ¥ä¾æ¬¡æ‰§è¡Œ IdleHandler</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Â·Â·Â·
    <span class="token keyword">int</span> pendingIdleHandlerCount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// -1 only during first iteration</span>
    <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Â·Â·Â·
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Â·Â·Â·
            <span class="token comment">//å¦‚æœé˜Ÿå¤´æ¶ˆæ¯ mMessages ä¸º null æˆ–è€… mMessages éœ€è¦å»¶è¿Ÿå¤„ç†</span>
            <span class="token comment">//é‚£ä¹ˆå°±æ¥æ‰§è¡Œ IdleHandler</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;</span> <span class="token number">0</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mMessages <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> now <span class="token operator">&lt;</span> mMessages<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pendingIdleHandlerCount <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// No idle handlers to run.  Loop and wait some more.</span>
                mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingIdleHandlers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPendingIdleHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdleHandler</span><span class="token punctuation">[</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>pendingIdleHandlerCount<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mPendingIdleHandlers <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>mPendingIdleHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingIdleHandlerCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">IdleHandler</span> idler <span class="token operator">=</span> mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// release the reference to the handler</span>
            <span class="token keyword">boolean</span> keep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//æ‰§è¡Œ IdleHandler</span>
                <span class="token comment">//å¦‚æœè¿”å› false çš„è¯è¯´æ˜ä¹‹åä¸å†éœ€è¦æ‰§è¡Œï¼Œé‚£å°±å°†å…¶ç§»é™¤</span>
                keep <span class="token operator">=</span> idler<span class="token punctuation">.</span><span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;IdleHandler threw exception&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mIdleHandlers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>idler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¾‹å¦‚ï¼ŒActivityThread å°±å‘ä¸»çº¿ç¨‹ MessageQueue æ·»åŠ äº†ä¸€ä¸ª GcIdlerï¼Œç”¨äºåœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶å°è¯•å»æ‰§è¡Œ GC æ“ä½œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">void</span> <span class="token function">scheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mGcIdlerScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mGcIdlerScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//æ·»åŠ  IdleHandler</span>
            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span>mGcIdler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mH<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">GC_WHEN_IDLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">GcIdler</span> <span class="token keyword">implements</span> <span class="token class-name">MessageQueue<span class="token punctuation">.</span>IdleHandler</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å°è¯• GC</span>
            <span class="token function">doGcIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">purgePendingResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8ã€åšä¸€ä¸ªæ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_8ã€åšä¸€ä¸ªæ€»ç»“" aria-hidden="true">#</a> 8ã€åšä¸€ä¸ªæ€»ç»“</h2><p>å†æ¥æ€»ç»“ä¸‹ä»¥ä¸Šçš„æ‰€æœ‰å†…å®¹</p><ol><li>æ¯ä¸ª Handler éƒ½ä¼šå’Œä¸€ä¸ª Looper å®ä¾‹å…³è”åœ¨ä¸€èµ·ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ– Handler æ—¶é€šè¿‡æ„é€ å‡½æ•°ä¸»åŠ¨ä¼ å…¥å®ä¾‹ï¼Œå¦åˆ™å°±ä¼šé»˜è®¤ä½¿ç”¨å’Œå½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡</li><li>æ¯ä¸ª Looper éƒ½ä¼šå’Œä¸€ä¸ª MessageQueue å®ä¾‹å…³è”åœ¨ä¸€èµ·ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦é€šè¿‡è°ƒç”¨ <code>Looper.prepare()</code>æ–¹æ³•æ¥åˆå§‹åŒ–æœ¬çº¿ç¨‹ç‹¬æœ‰çš„ Looper å®ä¾‹ï¼Œå¹¶é€šè¿‡è°ƒç”¨<code>Looper.loop()</code>æ–¹æ³•æ¥ä½¿å¾—æœ¬çº¿ç¨‹å¾ªç¯å‘ MessageQueue å–å‡ºæ¶ˆæ¯å¹¶æ‰§è¡Œã€‚Android ç³»ç»Ÿé»˜è®¤ä¼šä¸ºæ¯ä¸ªåº”ç”¨åˆå§‹åŒ–å’Œä¸»çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå¹¶ä¸”é»˜è®¤å°±å¼€å¯äº† loop å¾ªç¯æ¥å¤„ç†ä¸»çº¿ç¨‹æ¶ˆæ¯</li><li>MessageQueue æŒ‰ç…§é“¾æ¥ç»“æ„æ¥ä¿å­˜ Messageï¼Œæ‰§è¡Œæ—¶é—´æ—©ï¼ˆå³æ—¶é—´æˆ³å°ï¼‰çš„ Message ä¼šæ’åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼ŒLooper ä¼šå¾ªç¯ä»é“¾è¡¨ä¸­å–å‡º Message å¹¶å›è°ƒç»™ Handlerï¼Œå–å€¼çš„è¿‡ç¨‹å¯èƒ½ä¼šåŒ…å«é˜»å¡æ“ä½œ</li><li>Messageã€Handlerã€Looperã€MessageQueue è¿™å››è€…å°±æ„æˆäº†ä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ã€‚Message ç›¸å½“äºäº§å“ï¼ŒMessageQueue ç›¸å½“äºä¼ è¾“ç®¡é“ï¼ŒHandler ç›¸å½“äºç”Ÿäº§è€…ï¼ŒLooper ç›¸å½“äºæ¶ˆè´¹è€…</li><li>Handler å¯¹äº Looperã€Handler å¯¹äº MessageQueueã€Looper å¯¹äº MessageQueueã€Looper å¯¹äº Thread ï¼Œè¿™å‡ ä¸ªä¹‹é—´éƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œåœ¨å…³è”åæ— æ³•æ›´æ”¹ï¼Œä½† Looper å¯¹äº Handlerã€MessageQueue å¯¹äº Handler å¯ä»¥æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»</li><li>Handler èƒ½ç”¨äºæ›´æ–° UI åŒ…å«äº†ä¸€ä¸ªéšæ€§çš„å‰ææ¡ä»¶ï¼šHandler ä¸ä¸»çº¿ç¨‹ Looper å…³è”åœ¨äº†ä¸€èµ·ã€‚åœ¨ä¸»çº¿ç¨‹ä¸­åˆå§‹åŒ–çš„ Handler ä¼šé»˜è®¤ä¸ä¸»çº¿ç¨‹ Looper å…³è”åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥å…¶ <code>handleMessage(Message msg)</code> æ–¹æ³•å°±ä¼šç”±ä¸»çº¿ç¨‹æ¥è°ƒç”¨ã€‚åœ¨å­çº¿ç¨‹åˆå§‹åŒ–çš„ Handler å¦‚æœä¹Ÿæƒ³æ‰§è¡Œ UI æ›´æ–°æ“ä½œçš„è¯ï¼Œåˆ™éœ€è¦ä¸»åŠ¨è·å– mainLooper æ¥åˆå§‹åŒ– Handler</li><li>å¯¹äºæˆ‘ä»¬è‡ªå·±åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºçš„ Looperï¼Œå½“ä¸å†éœ€è¦çš„æ—¶å€™æˆ‘ä»¬åº”è¯¥ä¸»åŠ¨é€€å‡ºå¾ªç¯ï¼Œå¦åˆ™å­çº¿ç¨‹å°†ä¸€ç›´æ— æ³•å¾—åˆ°é‡Šæ”¾ã€‚å¯¹äºä¸»çº¿ç¨‹ Loop æˆ‘ä»¬åˆ™ä¸åº”è¯¥å»ä¸»åŠ¨é€€å‡ºï¼Œå¦åˆ™å°†å¯¼è‡´åº”ç”¨å´©æºƒ</li><li>æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘ MessageQueue æ·»åŠ  IdleHandler çš„æ–¹å¼ï¼Œæ¥å®ç°åœ¨ Loop çº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™æ‰§è¡Œä¸€äº›ä¼˜å…ˆçº§ä¸é«˜çš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸ªéœ€æ±‚æ˜¯å¸Œæœ›å½“ä¸»çº¿ç¨‹å®Œæˆç•Œé¢ç»˜åˆ¶ç­‰äº‹ä»¶åå†æ‰§è¡Œä¸€äº› UI æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ IdleHandler æ¥å®ç°ï¼Œè¿™å¯ä»¥é¿å…æ‹–æ…¢ç”¨æˆ·çœ‹åˆ°é¦–å±é¡µé¢çš„é€Ÿåº¦</li></ol><h1 id="ä¸‰ã€handler-åœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€handler-åœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨" aria-hidden="true">#</a> ä¸‰ã€Handler åœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨</h1><h2 id="_1ã€handlerthread" tabindex="-1"><a class="header-anchor" href="#_1ã€handlerthread" aria-hidden="true">#</a> 1ã€HandlerThread</h2><p>HandlerThread æ˜¯ Android SDK ä¸­å’Œ Handler åœ¨åŒä¸ªåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä»å…¶åå­—å°±å¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œä¸”ä½¿ç”¨åˆ°äº† Handler</p><p>å…¶ç”¨æ³•ç±»ä¼¼äºä»¥ä¸‹ä»£ç ã€‚é€šè¿‡ HandlerThread å†…éƒ¨çš„ Looper å¯¹è±¡æ¥åˆå§‹åŒ– Handlerï¼ŒåŒæ—¶åœ¨ Handler ä¸­å£°æ˜éœ€è¦æ‰§è¡Œçš„è€—æ—¶ä»»åŠ¡ï¼Œä¸»çº¿ç¨‹é€šè¿‡å‘ Handler å‘é€æ¶ˆæ¯æ¥è§¦å‘ HandlerThread å»æ‰§è¡Œè€—æ—¶ä»»åŠ¡</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> handlerThread <span class="token operator">=</span> <span class="token function">HandlerThread</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;I am HandlerThread&quot;</span></span><span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> handler <span class="token keyword">by</span> lazy <span class="token punctuation">{</span>
        <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">Handler</span><span class="token punctuation">(</span>handlerThread<span class="token punctuation">.</span>looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;MainActivity&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;è¿™é‡Œæ˜¯å­çº¿ç¨‹ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼š&quot;</span></span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        btn_test<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
            handler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        handlerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HandlerThread çš„æºç è¿˜æ˜¯æŒºç®€å•çš„ï¼Œåªæœ‰ä¸€ç™¾å¤šè¡Œ</p><p>HandlerThread æ˜¯ Thread çš„å­ç±»ï¼Œå…¶ä½œç”¨å°±æ˜¯ä¸ºäº†ç”¨æ¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œå…¶ <code>run()</code>æ–¹æ³•ä¼šè‡ªåŠ¨ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ª Looper å¯¹è±¡å¹¶ä¿å­˜åˆ° <code>mLooper</code>ï¼Œä¹‹åå°±ä¸»åŠ¨å¼€å¯æ¶ˆæ¯å¾ªç¯ï¼Œè¿™æ · HandlerThread å°±ä¼šæ¥å¾ªç¯å¤„ç† Message äº†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HandlerThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    
    <span class="token comment">//çº¿ç¨‹ä¼˜å…ˆçº§</span>
    <span class="token keyword">int</span> mPriority<span class="token punctuation">;</span>
    <span class="token comment">//çº¿ç¨‹ID</span>
    <span class="token keyword">int</span> mTid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//å½“å‰çº¿ç¨‹æŒæœ‰çš„ Looper å¯¹è±¡</span>
    <span class="token class-name">Looper</span> mLooper<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Handler</span> mHandler<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HandlerThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPriority <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">THREAD_PRIORITY_DEFAULT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">HandlerThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPriority <span class="token operator">=</span> priority<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTid <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">myTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§¦å‘å½“å‰çº¿ç¨‹åˆ›å»º Looper å¯¹è±¡</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//è·å– Looper å¯¹è±¡</span>
            mLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å”¤é†’æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹</span>
            <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§</span>
        <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>mPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">onLooperPrepared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å¼€å¯æ¶ˆæ¯å¾ªç¯</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤å¤–ï¼ŒHandlerThread è¿˜åŒ…å«ä¸€ä¸ª<code>getLooper()</code>æ–¹æ³•ç”¨äºè·å– Looperã€‚å½“æˆ‘ä»¬åœ¨å¤–éƒ¨è°ƒç”¨<code>handlerThread.start()</code>å¯åŠ¨çº¿ç¨‹åï¼Œç”±äºå…¶<code>run()</code>æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºä¾ç„¶æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥ <code>getLooper()</code>æ–¹æ³•å°±å¿…é¡»ç­‰åˆ° Looper åˆå§‹åŒ–å®Œæ¯•åæ‰èƒ½è¿”å›ï¼Œå¦åˆ™å°±ä¼šç”±äº<code>wait()</code>æ–¹æ³•è€Œä¸€ç›´é˜»å¡ç­‰å¾…ã€‚å½“<code>run()</code>æ–¹æ³•åˆå§‹åŒ– Looper å®Œæˆåï¼Œå°±ä¼šè°ƒç”¨<code>notifyAll()</code>æ¥å”¤é†’æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚æ‰€ä»¥å¤–éƒ¨åœ¨ä½¿ç”¨ HandlerThread å‰å°±è®°å¾—å¿…é¡»å…ˆè°ƒç”¨ <code>start()</code> æ–¹æ³•æ¥å¯åŠ¨ HandlerThread</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//è·å–ä¸ HandlerThread å…³è”çš„ Looper å¯¹è±¡</span>
<span class="token comment">//å› ä¸º getLooper() å¯èƒ½å…ˆäº run() è¢«æ‰§è¡Œ</span>
<span class="token comment">//æ‰€ä»¥å½“ mLooper ä¸º null æ—¶è°ƒç”¨è€…çº¿ç¨‹å°±éœ€è¦é˜»å¡ç­‰å¾… Looper å¯¹è±¡åˆ›å»ºå®Œæ¯•</span>
<span class="token keyword">public</span> <span class="token class-name">Looper</span> <span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If the thread has been started, wait until the looper has been created.</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mLooper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mLooper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HandlerThread èµ·åˆ°çš„ä½œç”¨å°±æ˜¯æ–¹ä¾¿äº†ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ï¼Œä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥é€šè¿‡ Handler æ¥å£°æ˜è€—æ—¶ä»»åŠ¡å¹¶äº¤ç”±å­çº¿ç¨‹æ¥æ‰§è¡Œã€‚ä½¿ç”¨ HandlerThread ä¹Ÿæ–¹ä¾¿åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ï¼Œä¸»çº¿ç¨‹å’Œå…¶å®ƒå­çº¿ç¨‹éƒ½å¯ä»¥å‘ HandlerThread ä¸‹å‘ä»»åŠ¡ï¼Œä¸” HandlerThread å¯ä»¥ä¿è¯å¤šä¸ªä»»åŠ¡æ‰§è¡Œæ—¶çš„æœ‰åºæ€§</p><h2 id="_2ã€intentservice" tabindex="-1"><a class="header-anchor" href="#_2ã€intentservice" aria-hidden="true">#</a> 2ã€IntentService</h2><p>IntentService æ˜¯ç³»ç»Ÿæä¾›çš„ Service å­ç±»ï¼Œç”¨äºåœ¨åå°ä¸²è¡Œæ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œåœ¨å¤„ç†å®Œæ‰€æœ‰ä»»åŠ¡åä¼šè‡ªåŠ¨åœæ­¢ï¼Œä¸å¿…æ¥æ‰‹åŠ¨è°ƒç”¨ <code>stopSelf()</code> æ–¹æ³•ã€‚è€Œä¸”ç”±äºIntentService æ˜¯å››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œæ‹¥æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œä¸æ˜“è¢«ç³»ç»Ÿæ€æ­»ï¼Œå› æ­¤é€‚åˆç”¨äºæ‰§è¡Œä¸€äº›é«˜ä¼˜å…ˆçº§çš„å¼‚æ­¥ä»»åŠ¡</p><p><strong>Google å®˜æ–¹ä»¥å‰ä¹Ÿæ¨èå¼€å‘è€…ä½¿ç”¨ IntentServiceï¼Œä½†æ˜¯åœ¨ Android 11 ä¸­å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒçŠ¶æ€äº†ï¼Œä½†è¿™ä¹Ÿä¸å¦¨ç¢æˆ‘ä»¬æ¥äº†è§£ä¸‹å…¶å®ç°åŸç†</strong></p><p>IntentService å†…éƒ¨ä¾é  HandlerThread æ¥å®ç°ï¼Œå…¶ <code>onCreate()</code>æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª HandlerThreadï¼Œæ‹¿åˆ° Looper å¯¹è±¡æ¥åˆå§‹åŒ– ServiceHandlerã€‚ServiceHandler ä¼šå°†å…¶æ¥å—åˆ°çš„æ¯ä¸ª Message éƒ½è½¬äº¤ç”±æŠ½è±¡æ–¹æ³• <code>onHandleIntent</code>æ¥å¤„ç†ï¼Œå­ç±»å°±é€šè¿‡å®ç°è¯¥æ–¹æ³•æ¥å£°æ˜è€—æ—¶ä»»åŠ¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">IntentService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Looper</span> mServiceLooper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ServiceHandler</span> mServiceHandler<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">ServiceHandler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span> looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onHandleIntent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stopSelf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerThread</span><span class="token punctuation">(</span><span class="token string">&quot;IntentService[&quot;</span> <span class="token operator">+</span> mName <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§¦å‘ HandlerThread åˆ›å»º Looper å¯¹è±¡</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//è·å– Looper å¯¹è±¡ï¼Œæ„å»ºå¯ä»¥å‘ HandlerThread å‘é€ Message çš„ Handler</span>
        mServiceLooper <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mServiceHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceHandler</span><span class="token punctuation">(</span>mServiceLooper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@WorkerThread</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">onHandleIntent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯æ¬¡ start IntentService æ—¶ï¼Œ<code>onStart()</code>æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œå°† <code>intent</code> å’Œ <code>startId</code> åŒ…è£…ä¸ºä¸€ä¸ª Message å¯¹è±¡åå‘é€ç»™<code>mServiceHandler</code>ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ <strong>startId</strong> è¿™ä¸ªå‚æ•°ï¼Œå®ƒç”¨äºå”¯ä¸€æ ‡è¯†æ¯æ¬¡å¯¹ IntentService å‘èµ·çš„ä»»åŠ¡è¯·æ±‚ï¼Œæ¯æ¬¡å›è°ƒ <code>onStart()</code> æ–¹æ³•æ—¶ï¼ŒstartId çš„å€¼éƒ½æ˜¯è‡ªåŠ¨é€’å¢çš„ã€‚IntentService ä¸åº”è¯¥åœ¨å¤„ç†å®Œä¸€ä¸ª Message ä¹‹åå°±ç«‹å³åœæ­¢ IntentServiceï¼Œå› ä¸ºæ­¤æ—¶ MessageQueue ä¸­å¯èƒ½è¿˜æœ‰å¾…å¤„ç†çš„ä»»åŠ¡è¿˜æœªå–å‡ºæ¥ï¼Œæ‰€ä»¥å¦‚æœå½“è°ƒç”¨ <code>stopSelf(int)</code>æ–¹æ³•æ—¶ä¼ å…¥çš„å‚æ•°ä¸ç­‰äºå½“å‰æœ€æ–°çš„ startId å€¼çš„è¯ï¼Œé‚£ä¹ˆ<code>stopSelf(int)</code> æ–¹æ³•å°±ä¸ä¼šå¯¼è‡´ IntentService è¢«åœæ­¢ï¼Œä»è€Œé¿å…äº†å°†å°šæœªå¤„ç†çš„ Message ç»™é—æ¼äº†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> mServiceHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> startId<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> intent<span class="token punctuation">;</span>
    mServiceHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onStart</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mRedelivery <span class="token operator">?</span> <span class="token constant">START_REDELIVER_INTENT</span> <span class="token operator">:</span> <span class="token constant">START_NOT_STICKY</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å››ã€handler-åœ¨ä¸‰æ–¹åº“ä¸­çš„åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#å››ã€handler-åœ¨ä¸‰æ–¹åº“ä¸­çš„åº”ç”¨" aria-hidden="true">#</a> å››ã€Handler åœ¨ä¸‰æ–¹åº“ä¸­çš„åº”ç”¨</h1><h2 id="_1ã€eventbus" tabindex="-1"><a class="header-anchor" href="#_1ã€eventbus" aria-hidden="true">#</a> 1ã€EventBus</h2><p>EventBus çš„ Github ä¸Šæœ‰è¿™ä¹ˆä¸€å¥ä»‹ç»ï¼š<a href="https://greenrobot.org/eventbus/" target="_blank" rel="noopener noreferrer">EventBus<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> is a publish/subscribe event bus for Android and Java. è¿™è¯´æ˜äº† EventBus æ˜¯æ™®éé€‚ç”¨äº Java ç¯å¢ƒçš„ï¼Œåªæ˜¯å¯¹ Android ç³»ç»Ÿåšäº†ç‰¹æ®Šçš„å¹³å°æ”¯æŒè€Œå·²ã€‚EventBus çš„å››ç§æ¶ˆæ¯å‘é€ç­–ç•¥åŒ…å«äº†<code>ThreadMode.MAIN</code> ç”¨äºæŒ‡å®šåœ¨ä¸»çº¿ç¨‹è¿›è¡Œæ¶ˆæ¯å›è°ƒï¼Œå…¶å†…éƒ¨å°±æ˜¯é€šè¿‡ Handler æ¥å®ç°çš„</p><p>EventBusBuilder ä¼šå»å°è¯•è·å– MainLooperï¼Œå¦‚æœæ‹¿å¾—åˆ°çš„è¯å°±å¯ä»¥ç”¨æ¥åˆå§‹åŒ– HandlerPosterï¼Œä»è€Œå®ç°ä¸»çº¿ç¨‹å›è°ƒ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">MainThreadSupport</span> <span class="token function">getMainThreadSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mainThreadSupport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mainThreadSupport<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AndroidLogger</span><span class="token punctuation">.</span><span class="token function">isAndroidLogAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> looperOrNull <span class="token operator">=</span> <span class="token function">getAndroidMainLooperOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> looperOrNull <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span>
                <span class="token keyword">new</span> <span class="token class-name">MainThreadSupport<span class="token punctuation">.</span>AndroidHandlerMainThreadSupport</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">)</span> looperOrNull<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getAndroidMainLooperOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Not really a functional Android (e.g. &quot;Stub!&quot; maven dependencies)</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HandlerPoster</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token keyword">implements</span> <span class="token class-name">Poster</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">HandlerPoster</span><span class="token punctuation">(</span><span class="token class-name">EventBus</span> eventBus<span class="token punctuation">,</span> <span class="token class-name">Looper</span> looper<span class="token punctuation">,</span> <span class="token keyword">int</span> maxMillisInsideHandleMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
    
	Â·Â·Â·
        
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2ã€retrofit" tabindex="-1"><a class="header-anchor" href="#_2ã€retrofit" aria-hidden="true">#</a> 2ã€Retrofit</h2><p>å’Œ EventBus ä¸€æ ·ï¼ŒRetrofit çš„å†…éƒ¨å®ç°ä¹Ÿä¸éœ€è¦ä¾èµ–äº Android å¹³å°ï¼Œè€Œæ˜¯å¯ä»¥ç”¨äºä»»æ„çš„ Java å®¢æˆ·ç«¯ï¼ŒRetrofit åªæ˜¯å¯¹ Android å¹³å°è¿›è¡Œäº†ç‰¹æ®Šå®ç°è€Œå·²</p><p>åœ¨æ„å»º Retrofit å¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¼ é€’ä¸€ä¸ª Platform å¯¹è±¡ç”¨äºæ ‡è®°è°ƒç”¨æ–¹æ‰€å¤„çš„å¹³å°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Builder</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Platform</span> platform<span class="token punctuation">;</span>
    
    <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token class-name">Platform</span> platform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>platform <span class="token operator">=</span> platform<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	Â·Â·Â·
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Platform ç±»åªå…·æœ‰ä¸€ä¸ªå”¯ä¸€å­ç±»ï¼Œå³ Android ç±»ã€‚å…¶ä¸»è¦é€»è¾‘å°±æ˜¯é‡å†™äº†çˆ¶ç±»çš„ <code>defaultCallbackExecutor()</code>æ–¹æ³•ï¼Œé€šè¿‡ Handler æ¥å®ç°åœ¨ä¸»çº¿ç¨‹å›è°ƒç½‘ç»œè¯·æ±‚ç»“æœ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Android</span> <span class="token keyword">extends</span> <span class="token class-name">Platform</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">defaultCallbackExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Â·Â·Â·

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MainThreadExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Handler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="äº”ã€æé—®ç¯èŠ‚" tabindex="-1"><a class="header-anchor" href="#äº”ã€æé—®ç¯èŠ‚" aria-hidden="true">#</a> äº”ã€æé—®ç¯èŠ‚</h1><h2 id="_1ã€handlerã€looperã€messagequeueã€thread-çš„å¯¹åº”å…³ç³»" tabindex="-1"><a class="header-anchor" href="#_1ã€handlerã€looperã€messagequeueã€thread-çš„å¯¹åº”å…³ç³»" aria-hidden="true">#</a> 1ã€Handlerã€Looperã€MessageQueueã€Thread çš„å¯¹åº”å…³ç³»</h2><p>é¦–å…ˆï¼ŒLooper ä¸­çš„ MessageQueue å’Œ Thread ä¸¤ä¸ªå­—æ®µéƒ½å±äºå¸¸é‡ï¼Œä¸” Looper å®ä¾‹æ˜¯å­˜åœ¨ ThreadLocal ä¸­ï¼Œè¿™è¯´æ˜äº† Looper å’Œ MessageQueue ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€åº”çš„å…³ç³»ï¼Œä¸”ä¸€ä¸ª Thread åœ¨å…¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…éƒ½åªä¼šå…³è”åˆ°åŒä¸€ä¸ª Looper å¯¹è±¡å’ŒåŒä¸€ä¸ª MessageQueue å¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Looper</span> <span class="token punctuation">{</span>
 
   <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> mQueue<span class="token punctuation">;</span>
   <span class="token keyword">final</span> <span class="token class-name">Thread</span> mThread<span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span> sThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Handler ä¸­çš„ Looper å’Œ MessageQueue ä¸¤ä¸ªå­—æ®µä¹Ÿéƒ½å±äºå¸¸é‡ï¼Œè¯´æ˜ Handler å¯¹äº Looper å’Œ MessageQueue éƒ½æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚<strong>ä½†æ˜¯ Looper å’Œ MessageQueue å¯¹äº Handler å´å¯ä»¥æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¾‹å¦‚ï¼Œå¤šä¸ªå­çº¿ç¨‹å†…å£°æ˜çš„ Handler éƒ½å¯ä»¥å…³è”åˆ° mainLooper</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> mLooper<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> mQueue<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2ã€handler-çš„åŒæ­¥æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_2ã€handler-çš„åŒæ­¥æœºåˆ¶" aria-hidden="true">#</a> 2ã€Handler çš„åŒæ­¥æœºåˆ¶</h2><p>MessageQueue åœ¨ä¿å­˜ Message çš„æ—¶å€™ï¼Œ<code>enqueueMessage</code>æ–¹æ³•å†…éƒ¨å·²ç»åŠ ä¸Šäº†åŒæ­¥é”ï¼Œä»è€Œé¿å…äº†å¤šä¸ªçº¿ç¨‹åŒæ—¶å‘é€æ¶ˆæ¯å¯¼è‡´ç«æ€é—®é¢˜ã€‚æ­¤å¤–ï¼Œ<code>next()</code>æ–¹æ³•å†…éƒ¨ä¹ŸåŠ ä¸Šäº†åŒæ­¥é”ï¼Œæ‰€ä»¥ä¹Ÿä¿éšœäº† Looper åˆ†å‘ Message çš„æœ‰åºæ€§ã€‚æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼ŒLooper æ€»æ˜¯ç”±ä¸€ä¸ªç‰¹å®šçš„çº¿ç¨‹æ¥æ‰§è¡Œéå†ï¼Œæ‰€ä»¥åœ¨æ¶ˆè´¹ Message çš„æ—¶å€™ä¹Ÿä¸å­˜åœ¨ç«æ€</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Message must have a target.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Â·Â·Â·
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextPollTimeoutMillis <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">flushPendingCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Â·Â·Â·
        <span class="token punctuation">}</span>

        Â·Â·Â·
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3ã€handler-å‘é€åŒæ­¥æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_3ã€handler-å‘é€åŒæ­¥æ¶ˆæ¯" aria-hidden="true">#</a> 3ã€Handler å‘é€åŒæ­¥æ¶ˆæ¯</h2><p>å¦‚æœæˆ‘ä»¬åœ¨å­çº¿ç¨‹é€šè¿‡ Handler å‘ä¸»çº¿ç¨‹å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¸Œæœ›ç­‰åˆ°æ¶ˆæ¯æ‰§è¡Œå®Œæ¯•åå­çº¿ç¨‹æ‰ç»§ç»­è¿è¡Œï¼Œè¿™è¯¥å¦‚ä½•å®ç°ï¼Ÿå…¶å®åƒè¿™ç§æ¶‰åŠåˆ°å¤šçº¿ç¨‹åŒæ­¥ç­‰å¾…çš„é—®é¢˜ï¼Œå¾€å¾€éƒ½æ˜¯éœ€è¦ä¾èµ–äº<strong>çº¿ç¨‹ä¼‘çœ +çº¿ç¨‹å”¤é†’</strong>æœºåˆ¶æ¥å®ç°çš„</p><p>Handler æœ¬èº«å°±æä¾›äº†ä¸€ä¸ª<code>runWithScissors</code>æ–¹æ³•å¯ä»¥ç”¨äºå®ç°è¿™ç§åŠŸèƒ½ï¼Œåªæ˜¯è¢«éšè—äº†ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è°ƒç”¨åˆ°ã€‚<code>runWithScissors</code>é¦–å…ˆä¼šåˆ¤æ–­ç›®æ ‡çº¿ç¨‹æ˜¯å¦å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œæ˜¯çš„è¯åˆ™ç›´æ¥æ‰§è¡Œ Runnableï¼Œå¦åˆ™å°±éœ€è¦ä½¿ç”¨åˆ° BlockingRunnable</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@hide</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">runWithScissors</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;runnable must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;timeout must be non-negative&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mLooper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">BlockingRunnable</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockingRunnable</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> br<span class="token punctuation">.</span><span class="token function">postAndWait</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>BlockingRunnable çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ Runnable æ‰§è¡Œå®Œå‰ä¼šé€šè¿‡è°ƒç”¨ <code>wait()</code>æ–¹æ³•æ¥ä½¿å‘é€è€…çº¿ç¨‹è½¬ä¸ºé˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå†é€šè¿‡<code>notifyAll()</code>æ¥å”¤é†’å‘é€è€…çº¿ç¨‹ï¼Œä»è€Œå®ç°äº†åœ¨ Runnable è¢«æ‰§è¡Œå®Œä¹‹å‰å‘é€è€…çº¿ç¨‹éƒ½ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BlockingRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> mTask<span class="token punctuation">;</span>
    	<span class="token comment">//ç”¨äºæ ‡è®° mTask æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæ¯• </span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> mDone<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">BlockingRunnable</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTask <span class="token operator">=</span> task<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mTask<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">postAndWait</span><span class="token punctuation">(</span><span class="token class-name">Handler</span> handler<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> expirationTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timeout<span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>mDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">long</span> delay <span class="token operator">=</span> expirationTime <span class="token operator">-</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// timeout</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">//é™æ—¶ç­‰å¾…</span>
                            <span class="token function">wait</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>mDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">//æ— é™æœŸç­‰å¾…</span>
                            <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶ <code>runWithScissors</code> æ–¹æ³•æˆ‘ä»¬æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¾é è¿™æ€è·¯è‡ªå·±æ¥å®ç° BlockingRunnableï¼ŒæŠ˜ä¸­å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ä½†è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¦‚æœ Loop æ„å¤–é€€å‡ºå¾ªç¯å¯¼è‡´è¯¥ Runnable æ— æ³•è¢«æ‰§è¡Œçš„è¯ï¼Œå°±ä¼šå¯¼è‡´è¢«æš‚åœçš„çº¿ç¨‹ä¸€ç›´æ— æ³•è¢«å”¤é†’ï¼Œéœ€è¦è°¨æ…ä½¿ç”¨</p><h2 id="_4ã€handler-é¿å…å†…å­˜æ³„æ¼" tabindex="-1"><a class="header-anchor" href="#_4ã€handler-é¿å…å†…å­˜æ³„æ¼" aria-hidden="true">#</a> 4ã€Handler é¿å…å†…å­˜æ³„æ¼</h2><p>å½“é€€å‡º Activity æ—¶ï¼Œå¦‚æœä½œä¸ºå†…éƒ¨ç±»çš„ Handler ä¸­è¿˜ä¿å­˜ç€å¾…å¤„ç†çš„å»¶æ—¶æ¶ˆæ¯çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨<code>Handler.removeCallbacksAndMessages(null)</code>æ¥ç§»é™¤æ‰€æœ‰å¾…å¤„ç†çš„ Message</p><p>è¯¥æ–¹æ³•ä¼šå°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰€æœ‰ <code>Message.obj</code> ç­‰äº token çš„ Message å‡ç»™ç§»é™¤æ‰ï¼Œå¦‚æœ token ä¸º null çš„è¯åˆ™ä¼šç§»é™¤æ‰€æœ‰ Message</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">removeCallbacksAndMessages</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mQueue<span class="token punctuation">.</span><span class="token function">removeCallbacksAndMessages</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5ã€message-å¦‚ä½•å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#_5ã€message-å¦‚ä½•å¤ç”¨" aria-hidden="true">#</a> 5ã€Message å¦‚ä½•å¤ç”¨</h2><p>å› ä¸º Android ç³»ç»Ÿæœ¬èº«å°±å­˜åœ¨å¾ˆå¤šäº‹ä»¶éœ€è¦äº¤ç”± Message æ¥äº¤ä»˜ç»™ mainLooperï¼Œæ‰€ä»¥ Message çš„åˆ›å»ºæ˜¯å¾ˆé¢‘ç¹çš„ã€‚ä¸ºäº†å‡å°‘ Message é¢‘ç¹é‡å¤åˆ›å»ºçš„æƒ…å†µï¼ŒMessage æä¾›äº† MessagePool ç”¨äºå®ç° Message çš„ç¼“å­˜å¤ç”¨ï¼Œä»¥æ­¤æ¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨</p><p>å½“ Looper æ¶ˆè´¹äº† Message åä¼šè°ƒç”¨<code>recycleUnchecked()</code>æ–¹æ³•å°† Message è¿›è¡Œå›æ”¶ï¼Œåœ¨æ¸…é™¤äº†å„é¡¹èµ„æºåä¼šç¼“å­˜åˆ° sPool å˜é‡ä¸Šï¼ŒåŒæ—¶å°†ä¹‹å‰ç¼“å­˜çš„ Message ç½®ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹ nextï¼Œé€šè¿‡è¿™ç§é“¾è¡¨ç»“æ„æ¥ç¼“å­˜æœ€å¤š 50 ä¸ªMessageã€‚è¿™é‡Œä½¿ç”¨åˆ°çš„æ˜¯<strong>äº«å…ƒè®¾è®¡æ¨¡å¼</strong></p><p><code>obtain()</code>æ–¹æ³•åˆ™ä¼šåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å¯ç”¨çš„ç¼“å­˜ï¼Œæœ‰çš„è¯åˆ™å°† sPool ä»é“¾è¡¨ä¸­ç§»é™¤åè¿”å›ï¼Œå¦åˆ™å°±è¿”å›ä¸€ä¸ªæ–°çš„ Message å®ä¾‹ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™åº”è¯¥å°½é‡é€šè¿‡è°ƒç”¨<code>Message.obtain()</code>æˆ–è€…<code>Handler.obtainMessage()</code>æ–¹æ³•æ¥è·å– Message å®ä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span> <span class="token punctuation">{</span>
    
    <span class="token doc-comment comment">/** <span class="token keyword">@hide</span> */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> sPoolSync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> sPool<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sPoolSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> <span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sPoolSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sPool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> m <span class="token operator">=</span> sPool<span class="token punctuation">;</span>
                sPool <span class="token operator">=</span> m<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// clear in-use flag</span>
                sPoolSize<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> m<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">void</span> <span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mark the message as in use while it remains in the recycled object pool.</span>
        <span class="token comment">// Clear out all other details.</span>
        flags <span class="token operator">=</span> <span class="token constant">FLAG_IN_USE</span><span class="token punctuation">;</span>
        what <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        arg1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        arg2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        replyTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        sendingUid <span class="token operator">=</span> <span class="token constant">UID_NONE</span><span class="token punctuation">;</span>
        workSourceUid <span class="token operator">=</span> <span class="token constant">UID_NONE</span><span class="token punctuation">;</span>
        when <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sPoolSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sPoolSize <span class="token operator">&lt;</span> <span class="token constant">MAX_POOL_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next <span class="token operator">=</span> sPool<span class="token punctuation">;</span>
                sPool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
                sPoolSize<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6ã€message-å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_6ã€message-å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜" aria-hidden="true">#</a> 6ã€Message å¤ç”¨æœºåˆ¶å­˜åœ¨çš„é—®é¢˜</h2><p>ç”±äº Message é‡‡ç”¨äº†ç¼“å­˜å¤ç”¨æœºåˆ¶ï¼Œä»è€Œå¯¼è‡´äº†ä¸€ä¸ª Message å¤±æ•ˆé—®é¢˜ã€‚å½“ <code>handleMessage</code> æ–¹æ³•è¢«å›è°ƒåï¼ŒMessage æºå¸¦çš„æ‰€æœ‰å‚æ•°éƒ½ä¼šè¢«æ¸…ç©ºï¼Œè€Œå¦‚æœå¤–éƒ¨çš„ <code>handleMessage</code>æ–¹æ³•æ˜¯ä½¿ç”¨äº†å¼‚æ­¥çº¿ç¨‹æ¥å¤„ç† Message çš„è¯ï¼Œé‚£ä¹ˆå¼‚æ­¥çº¿ç¨‹åªä¼šå¾—åˆ°ä¸€ä¸ªç©ºç™½çš„ Message</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">val</span> handler <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleMessageAsync</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">handleMessageAsync</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    thread <span class="token punctuation">{</span>
        <span class="token comment">//åªä¼šå¾—åˆ°ä¸€ä¸ªç©ºç™½çš„ Message å¯¹è±¡</span>
        <span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7ã€message-å¦‚ä½•æé«˜ä¼˜å…ˆçº§" tabindex="-1"><a class="header-anchor" href="#_7ã€message-å¦‚ä½•æé«˜ä¼˜å…ˆçº§" aria-hidden="true">#</a> 7ã€Message å¦‚ä½•æé«˜ä¼˜å…ˆçº§</h2><p>Handler åŒ…å«ä¸€ä¸ª <code>sendMessageAtFrontOfQueue</code>æ–¹æ³•å¯ä»¥ç”¨äºæé«˜ Message çš„å¤„ç†ä¼˜å…ˆçº§ã€‚è¯¥æ–¹æ³•ä¸º Message è®¾å®šçš„æ—¶é—´æˆ³æ˜¯ 0ï¼Œä½¿å¾— Message å¯ä»¥ç›´æ¥æ’å…¥åˆ° MessageQueue çš„å¤´éƒ¨ï¼Œä»è€Œåšåˆ°ä¼˜å…ˆå¤„ç†ã€‚ä½†å®˜æ–¹å¹¶ä¸æ¨èä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºæœ€æç«¯çš„æƒ…å†µä¸‹å¯èƒ½ä¼šä½¿å¾—å…¶å®ƒ Message ä¸€ç›´å¾—ä¸åˆ°å¤„ç†æˆ–è€…å…¶å®ƒæ„æƒ³ä¸åˆ°çš„æƒ…å†µ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageAtFrontOfQueue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MessageQueue</span> queue <span class="token operator">=</span> mQueue<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RuntimeException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; sendMessageAtTime() called with no mQueue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">&quot;Looper&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8ã€æ£€æµ‹-looper-åˆ†å‘-message-çš„æ•ˆç‡" tabindex="-1"><a class="header-anchor" href="#_8ã€æ£€æµ‹-looper-åˆ†å‘-message-çš„æ•ˆç‡" aria-hidden="true">#</a> 8ã€æ£€æµ‹ Looper åˆ†å‘ Message çš„æ•ˆç‡</h2><p>Looper åœ¨è¿›è¡Œ Loop å¾ªç¯æ—¶ï¼Œä¼šé€šè¿‡ Observer å‘å¤–å›è°ƒæ¯ä¸ª Message çš„å›è°ƒäº‹ä»¶ã€‚ä¸”å¦‚æœè®¾å®šäº† <code>slowDispatchThresholdMs</code> å’Œ <code>slowDeliveryThresholdMs</code> è¿™ä¸¤ä¸ªé˜ˆå€¼çš„è¯ï¼Œåˆ™ä¼šå¯¹ Message çš„<strong>åˆ†å‘æ—¶æœº</strong>å’Œ<strong>åˆ†å‘è€—æ—¶</strong>è¿›è¡Œç›‘æµ‹ï¼Œå­˜åœ¨å¼‚å¸¸æƒ…å†µçš„è¯å°±ä¼šæ‰“å° Logã€‚è¯¥æœºåˆ¶å¯ä»¥ç”¨äºå®ç°åº”ç”¨æ€§èƒ½ç›‘æµ‹ï¼Œå‘ç°æ½œåœ¨çš„ Message å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œä½†å¯æƒœç›‘æµ‹æ–¹æ³•è¢«ç³»ç»Ÿéšè—äº†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Â·Â·Â·
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// might block</span>
        Â·Â·Â·
        <span class="token comment">//ç”¨äºå‘å¤–å›è°ƒé€šçŸ¥ Message çš„åˆ†å‘äº‹ä»¶</span>
        <span class="token keyword">final</span> <span class="token class-name">Observer</span> observer <span class="token operator">=</span> sObserver<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> traceTag <span class="token operator">=</span> me<span class="token punctuation">.</span>mTraceTag<span class="token punctuation">;</span>
        <span class="token comment">//å¦‚æœLooperåˆ†å‘Messageçš„æ—¶é—´æ™šäºé¢„å®šæ—¶é—´ä¸”è¶…å‡ºè¿™ä¸ªé˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºLooperåˆ†å‘è¿‡æ…¢</span>
        <span class="token keyword">long</span> slowDispatchThresholdMs <span class="token operator">=</span> me<span class="token punctuation">.</span>mSlowDispatchThresholdMs<span class="token punctuation">;</span>
        <span class="token comment">//å¦‚æœå‘å¤–åˆ†å‘å‡ºå»çš„Messageçš„å¤„ç†æ—¶é—´è¶…å‡ºè¿™ä¸ªé˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºå¤–éƒ¨å¤„ç†è¿‡æ…¢</span>
        <span class="token keyword">long</span> slowDeliveryThresholdMs <span class="token operator">=</span> me<span class="token punctuation">.</span>mSlowDeliveryThresholdMs<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thresholdOverride <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            slowDispatchThresholdMs <span class="token operator">=</span> thresholdOverride<span class="token punctuation">;</span>
            slowDeliveryThresholdMs <span class="token operator">=</span> thresholdOverride<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> logSlowDelivery <span class="token operator">=</span> <span class="token punctuation">(</span>slowDeliveryThresholdMs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> logSlowDispatch <span class="token operator">=</span> <span class="token punctuation">(</span>slowDispatchThresholdMs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> needStartTime <span class="token operator">=</span> logSlowDelivery <span class="token operator">||</span> logSlowDispatch<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> needEndTime <span class="token operator">=</span> logSlowDispatch<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>traceTag <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getTraceName</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//å¼€å§‹åˆ†å‘ Message çš„æ—¶é—´</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> dispatchStart <span class="token operator">=</span> needStartTime <span class="token operator">?</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//Message åˆ†å‘ç»“æŸçš„æ—¶é—´</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> dispatchEnd<span class="token punctuation">;</span>
        <span class="token class-name">Object</span> token <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¼€å§‹åˆ†å‘ Message </span>
            token <span class="token operator">=</span> observer<span class="token punctuation">.</span><span class="token function">messageDispatchStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> origWorkSource <span class="token operator">=</span> <span class="token class-name">ThreadLocalWorkSource</span><span class="token punctuation">.</span><span class="token function">setUid</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>workSourceUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//å®Œæˆ Message çš„åˆ†å‘ï¼Œä¸”æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸</span>
                observer<span class="token punctuation">.</span><span class="token function">messageDispatched</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            dispatchEnd <span class="token operator">=</span> needEndTime <span class="token operator">?</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//åˆ†å‘ Message æ—¶æŠ›å‡ºäº†å¼‚å¸¸</span>
                observer<span class="token punctuation">.</span><span class="token function">dispatchingThrewException</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> exception<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadLocalWorkSource</span><span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>origWorkSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>traceTag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logSlowDelivery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slowDeliveryDetected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dispatchStart <span class="token operator">-</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//å¦‚æœ Message çš„åˆ†å‘æ—¶é—´æ™šäºé¢„å®šæ—¶é—´ï¼Œä¸”é—´éš”è¶…å‡º10æ¯«ç§’ï¼Œåˆ™è®¤ä¸ºå±äºå»¶è¿Ÿäº¤ä»˜</span>
                    <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Drained&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    slowDeliveryDetected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">showSlowLog</span><span class="token punctuation">(</span>slowDeliveryThresholdMs<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">,</span> dispatchStart<span class="token punctuation">,</span> <span class="token string">&quot;delivery&quot;</span><span class="token punctuation">,</span>
                        msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Once we write a slow delivery log, suppress until the queue drains.</span>
                    slowDeliveryDetected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9ã€ä¸»çº¿ç¨‹-looper-åœ¨å“ªé‡Œåˆ›å»º" tabindex="-1"><a class="header-anchor" href="#_9ã€ä¸»çº¿ç¨‹-looper-åœ¨å“ªé‡Œåˆ›å»º" aria-hidden="true">#</a> 9ã€ä¸»çº¿ç¨‹ Looper åœ¨å“ªé‡Œåˆ›å»º</h2><p>ç”± ActivityThread ç±»çš„ <code>main()</code> æ–¹æ³•æ¥åˆ›å»ºã€‚è¯¥ <code>main()</code> æ–¹æ³•å³ Java ç¨‹åºçš„è¿è¡Œèµ·å§‹ç‚¹ï¼Œå½“åº”ç”¨å¯åŠ¨æ—¶ç³»ç»Ÿå°±è‡ªåŠ¨ä¸ºæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹åšå¥½äº† mainLooper çš„åˆå§‹åŒ–ï¼Œè€Œä¸”å·²ç»è°ƒç”¨äº†<code>Looper.loop()</code>æ–¹æ³•å¼€å¯äº†æ¶ˆæ¯çš„å¾ªç¯å¤„ç†ï¼Œåº”ç”¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å„ç§äº¤äº’é€»è¾‘ï¼ˆä¾‹å¦‚ï¼šå±å¹•çš„è§¦æ‘¸äº‹ä»¶ã€åˆ—è¡¨çš„æ»‘åŠ¨ç­‰ï¼‰å°±éƒ½æ˜¯åœ¨è¿™ä¸ªå¾ªç¯é‡Œå®Œæˆåˆ†å‘çš„ã€‚æ­£æ˜¯å› ä¸º Android ç³»ç»Ÿå·²ç»è‡ªåŠ¨å®Œæˆäº†ä¸»çº¿ç¨‹ Looper çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­æ‰å¯ä»¥ç›´æ¥ä½¿ç”¨ Handler çš„æ— å‚æ„é€ å‡½æ•°æ¥å®Œæˆ UI ç›¸å…³äº‹ä»¶çš„å¤„ç†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Â·Â·Â·
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Â·Â·Â·
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread loop unexpectedly exited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10ã€ä¸»çº¿ç¨‹-looper-ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯" tabindex="-1"><a class="header-anchor" href="#_10ã€ä¸»çº¿ç¨‹-looper-ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯" aria-hidden="true">#</a> 10ã€ä¸»çº¿ç¨‹ Looper ä»€ä¹ˆæ—¶å€™é€€å‡ºå¾ªç¯</h2><p>å½“ ActivityThread å†…éƒ¨çš„ Handler æ”¶åˆ°äº† EXIT_APPLICATION æ¶ˆæ¯åï¼Œå°±ä¼šé€€å‡º Looper å¾ªç¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">EXIT_APPLICATION</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInitialApplication <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mInitialApplication<span class="token punctuation">.</span><span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11ã€ä¸»çº¿ç¨‹-looper-loop-ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´-anr" tabindex="-1"><a class="header-anchor" href="#_11ã€ä¸»çº¿ç¨‹-looper-loop-ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´-anr" aria-hidden="true">#</a> 11ã€ä¸»çº¿ç¨‹ Looper.loop() ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´ ANR</h2><p>è¿™ä¸ªé—®é¢˜åœ¨ç½‘ä¸Šå¾ˆå¸¸è§ï¼Œæˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°æ—¶å°±è§‰å¾—è¿™ç§é—®é¢˜å¾ˆå¥‡æ€ªï¼Œä¸»çº¿ç¨‹å‡­å•¥ä¼š ANRï¼Ÿè¿™ä¸ªé—®é¢˜æ„Ÿè§‰æœ¬èº«å°±æ˜¯ç‰¹æ„ä¸ºäº†æ¥è¯¯å¯¼äºº</p><p>çœ‹ä»¥ä¸‹ä¾‹å­ã€‚<code>doSomeThing()</code>æ–¹æ³•æ˜¯æ”¾åœ¨ for å¾ªç¯è¿™ä¸ªæ­»å¾ªç¯çš„åè¾¹ï¼Œå¯¹äºè¯¥æ–¹æ³•æ¥è¯´ï¼Œä¸»çº¿ç¨‹çš„ç¡®æ˜¯è¢«é˜»å¡ä½äº†ï¼Œå¯¼è‡´è¯¥æ–¹æ³•ä¸€ç›´æ— æ³•å¾—åˆ°æ‰§è¡Œã€‚å¯æ˜¯å¯¹äºåº”ç”¨æ¥è¯´ï¼Œåº”ç”¨åœ¨ä¸»çº¿ç¨‹å†…çš„æ‰€æœ‰æ“ä½œå…¶å®éƒ½æ˜¯è¢«æ”¾åœ¨äº† for å¾ªç¯ä¹‹å†…ï¼Œä¸€ç›´æœ‰å¾—åˆ°æ‰§è¡Œï¼Œæ˜¯ä¸ªæ­»å¾ªç¯ä¹Ÿæ— æ‰€è°“ï¼Œæ‰€ä»¥å¯¹äºåº”ç”¨æ¥è¯´ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰è¢«é˜»å¡ï¼Œè‡ªç„¶ä¸ä¼šå¯¼è‡´ ANRã€‚æ­¤å¤–ï¼Œå½“ MessageQueue ä¸­å½“å‰æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†æ—¶ï¼Œä¹Ÿä¼šä¾é  epoll æœºåˆ¶æŒ‚èµ·ä¸»çº¿ç¨‹ï¼Œé¿å…äº†å…¶ä¸€ç›´å ç”¨ CPU èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ä¸»çº¿ç¨‹æ‰§è¡Œ....</span>
    <span class="token punctuation">}</span>
    <span class="token function">doSomeThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥åœ¨ ActivityThread çš„ main æ–¹æ³•ä¸­ï¼Œåœ¨å¼€å¯äº†æ¶ˆæ¯å¾ªç¯ä¹‹åï¼Œå¹¶æ²¡æœ‰å£°æ˜ä»€ä¹ˆæœ‰æ„ä¹‰çš„ä»£ç ã€‚æ­£å¸¸æ¥è¯´åº”ç”¨æ˜¯ä¸ä¼šé€€å‡º loop å¾ªç¯çš„ï¼Œå¦‚æœèƒ½å¤Ÿè·³å‡ºå¾ªç¯ï¼Œä¹Ÿåªä¼šå¯¼è‡´ç›´æ¥å°±æŠ›å‡ºå¼‚å¸¸</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Â·Â·Â·
    <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Â·Â·Â·
    <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread loop unexpectedly exited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥è¯´ï¼Œloop å¾ªç¯æœ¬èº«ä¸ä¼šå¯¼è‡´ ANRï¼Œä¼šå‡ºç° ANR æ˜¯å› ä¸ºåœ¨ loop å¾ªç¯ä¹‹å†… Message å¤„ç†æ—¶é—´è¿‡é•¿</p><h2 id="_12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹-toast-å—" tabindex="-1"><a class="header-anchor" href="#_12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹-toast-å—" aria-hidden="true">#</a> 12ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•å¼¹ Toast å—</h2><p>ä¸ä¸€å®šï¼Œåªèƒ½è¯´æ˜¯<strong>åœ¨å­çº¿ç¨‹ä¸­æ— æ³•ç›´æ¥å¼¹å‡º Toastï¼Œä½†å¯ä»¥å®ç°</strong>ã€‚å› ä¸º Toast çš„æ„é€ å‡½æ•°ä¸­ä¼šè¦æ±‚æ‹¿åˆ°ä¸€ä¸ª Looper å¯¹è±¡ï¼Œå¦‚æœæ„é€ å‚æ•°æ²¡æœ‰ä¼ å…¥ä¸ä¸º null çš„ Looper å®ä¾‹çš„è¯ï¼Œåˆ™å°è¯•ä½¿ç”¨è°ƒç”¨è€…çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼Œå¦‚æœéƒ½è·å–ä¸åˆ°çš„è¯åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Toast</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Toast</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Looper</span> looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    mToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    looper <span class="token operator">=</span> <span class="token function">getLooper</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Â·Â·Â·
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Looper</span> <span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Looper</span> looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>looper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> looper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Looper.myLooper() ä¸º null çš„è¯å°±ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
    <span class="token keyword">return</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;Can&#39;t toast on a thread that has not called Looper.prepare()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†åœ¨å­çº¿ç¨‹å¼¹ Toastï¼Œå°±éœ€è¦ä¸»åŠ¨ä¸ºå­çº¿ç¨‹åˆ›å»º Looper å¯¹è±¡åŠå¼€å¯ loop å¾ªç¯ã€‚ä½†è¿™ç§æ–¹æ³•ä¼šå¯¼è‡´å­çº¿ç¨‹ä¸€ç›´æ— æ³•é€€å‡ºå¾ªç¯ï¼Œéœ€è¦é€šè¿‡<code>Looper.myLooper().quit()</code>æ¥ä¸»åŠ¨é€€å‡ºå¾ªç¯</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">inner</span> <span class="token keyword">class</span> TestThread <span class="token operator">:</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">&quot;Hello: &quot;</span></span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            Toast<span class="token punctuation">.</span>LENGTH_SHORT
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–°-ui-ä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥" tabindex="-1"><a class="header-anchor" href="#_13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–°-ui-ä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥" aria-hidden="true">#</a> 13ã€å­çº¿ç¨‹ä¸€å®šæ— æ³•æ›´æ–° UIï¼Ÿä¸»çº¿ç¨‹å°±ä¸€å®šå¯ä»¥ï¼Ÿ</h2><p>åœ¨å­çº¿ç¨‹èƒ½å¤Ÿå¼¹å‡º Toast å°±å·²ç»è¯´æ˜äº†å­çº¿ç¨‹ä¹Ÿæ˜¯å¯ä»¥æ›´æ–° UI çš„ï¼Œ<strong>Android ç³»ç»Ÿåªæ˜¯é™åˆ¶äº†å¿…é¡»åœ¨åŒä¸ªçº¿ç¨‹å†…è¿›è¡Œ ViewRootImpl çš„åˆ›å»ºå’Œæ›´æ–°è¿™ä¸¤ä¸ªæ“ä½œ</strong>ï¼Œè€Œä¸æ˜¯è¦æ±‚å¿…é¡»åœ¨ä¸»çº¿ç¨‹è¿›è¡Œ</p><p>å¦‚æœä½¿ç”¨ä¸å½“çš„è¯ï¼Œå³ä½¿åœ¨ä¸»çº¿ç¨‹æ›´æ–° UI ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨å´©æºƒã€‚ä¾‹å¦‚ï¼Œåœ¨å­çº¿ç¨‹å…ˆé€šè¿‡ show+hide æ¥è§¦å‘ ViewRootImpl çš„åˆ›å»ºï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹å†æ¥å°è¯•æ˜¾ç¤ºè¯¥ Dialogï¼Œæ­¤æ—¶å°±ä¼šå‘ç°ç¨‹åºç›´æ¥å´©æºƒäº†</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> alertDialog<span class="token operator">:</span> AlertDialog

    <span class="token keyword">private</span> <span class="token keyword">val</span> thread <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;hello&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{</span>
                alertDialog <span class="token operator">=</span>
                    AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                alertDialog<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                alertDialog<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        btn_test<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
            alertDialog<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">E</span><span class="token operator">/</span><span class="token class-name">AndroidRuntime</span><span class="token operator">:</span> <span class="token constant">FATAL</span> <span class="token constant">EXCEPTION</span><span class="token operator">:</span> main
<span class="token class-name">Process</span><span class="token operator">:</span> github<span class="token punctuation">.</span>leavesc<span class="token punctuation">.</span>test<span class="token punctuation">,</span> <span class="token constant">PID</span><span class="token operator">:</span> <span class="token number">5243</span>
<span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewRootImpl</span>$<span class="token class-name">CalledFromWrongThreadException</span><span class="token operator">:</span> <span class="token class-name">Only</span> the original thread that created a view hierarchy can touch its views<span class="token punctuation">.</span>
    at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewRootImpl</span><span class="token punctuation">.</span><span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6892</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewRootImpl</span><span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1048</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>View</span><span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">19781</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>View</span><span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">11478</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>View</span><span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">8069</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>Dialog</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token class-name">Dialog</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">293</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ViewRootImpl åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå°†å½“å‰çº¿ç¨‹ä¿å­˜åˆ° mThreadï¼Œåœ¨åç»­è¿›è¡Œ UI æ›´æ–°çš„æ—¶å€™å°±ä¼šè°ƒç”¨<code>checkThread()</code>æ–¹æ³•è¿›è¡Œçº¿ç¨‹æ£€æŸ¥ï¼Œå¦‚æœå‘ç°å­˜åœ¨å¤šçº¿ç¨‹è°ƒç”¨åˆ™ç›´æ¥æŠ›å‡ºä»¥ä¸Šçš„å¼‚å¸¸ä¿¡æ¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ViewRootImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ViewParent</span><span class="token punctuation">,</span>
        <span class="token class-name">View<span class="token punctuation">.</span>AttachInfo<span class="token punctuation">.</span>Callbacks</span><span class="token punctuation">,</span> <span class="token class-name">ThreadedRenderer<span class="token punctuation">.</span>DrawCallbacks</span> <span class="token punctuation">{</span>
            
     <span class="token keyword">final</span> <span class="token class-name">Thread</span> mThread<span class="token punctuation">;</span>       
            
     <span class="token keyword">public</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Display</span> display<span class="token punctuation">,</span> <span class="token class-name">IWindowSession</span> session<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> useSfChoreographer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Â·Â·Â·
    <span class="token punctuation">}</span>       
            
    <span class="token keyword">void</span> <span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mThread <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CalledFromWrongThreadException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
            
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14ã€ä¸ºä»€ä¹ˆ-ui-ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_14ã€ä¸ºä»€ä¹ˆ-ui-ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹" aria-hidden="true">#</a> 14ã€ä¸ºä»€ä¹ˆ UI ä½“ç³»è¦é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹</h2><p>å…¶å®è¿™å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä¸ºäº†æé«˜è¿è¡Œæ•ˆç‡å’Œé™ä½å®ç°éš¾åº¦ã€‚å¦‚æœå…è®¸å¤šçº¿ç¨‹å¹¶å‘è®¿é—® UI çš„è¯ï¼Œä¸ºäº†é¿å…ç«æ€ï¼Œå¾ˆå¤šå³ä½¿åªæ˜¯å°èŒƒå›´çš„å±€éƒ¨åˆ·æ–°æ“ä½œï¼ˆä¾‹å¦‚ï¼ŒTextView.setTextï¼‰éƒ½åŠ¿å¿…éœ€è¦åŠ ä¸ŠåŒæ­¥é”ï¼Œè¿™æ— ç–‘ä¼šåŠ å¤§ UI åˆ·æ–°æ“ä½œçš„â€œæˆæœ¬â€ï¼Œé™ä½äº†æ•´ä¸ªåº”ç”¨çš„è¿è¡Œæ•ˆç‡ã€‚è€Œä¸”ä¼šå¯¼è‡´ Android çš„ UI ä½“ç³»åœ¨å®ç°æ—¶å°±è¢«è¿«éœ€è¦å¯¹å¤šçº¿ç¨‹ç¯å¢ƒè¿›è¡Œâ€œé˜²å¾¡â€ï¼Œå³ä½¿å¼€å‘è€…ä¸€ç›´æ˜¯ä½¿ç”¨åŒä¸ªçº¿ç¨‹æ¥æ›´æ–° UIï¼Œè¿™å°±åŠ å¤§äº†ç³»ç»Ÿçš„å®ç°éš¾åº¦</p><p>æ‰€ä»¥ï¼Œæœ€ä¸ºç®€å•é«˜æ•ˆçš„æ–¹å¼å°±æ˜¯é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹æ¥è®¿é—® UI</p><h2 id="_15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#_15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡" aria-hidden="true">#</a> 15ã€å¦‚ä½•è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œéœ€è¦åšå¾ˆå¤šçº¿ç¨‹åŒæ­¥æ“ä½œã€‚è€Œä¾é  Looper çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æ¯”è¾ƒç®€å•çš„æ–¹å¼æ¥å®ç°è·¨çº¿ç¨‹ä¸‹å‘ä»»åŠ¡</p><p>çœ‹ä»¥ä¸‹ä»£ç ï¼Œä» TestThread è¿è¡Œåå¼¹å‡ºçš„çº¿ç¨‹åå¯ä»¥çŸ¥é“ï¼Œ Toast æ˜¯åœ¨ Thread_1 è¢«å¼¹å‡ºæ¥çš„ã€‚å¦‚æœå°† Thread_2 æƒ³åƒæˆä¸»çº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆä»¥ä¸‹ä»£ç å°±ç›¸å½“äºä»ä¸»çº¿ç¨‹å‘å­çº¿ç¨‹ä¸‹å‘è€—æ—¶ä»»åŠ¡äº†ï¼Œè¿™ä¸ªå®ç°æ€è·¯å°±ç›¸å½“äº Android æä¾›çš„ HandlerThread ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>inner <span class="token keyword">class</span> <span class="token class-name">TestThread</span> <span class="token operator">:</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&quot;Thread_1&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    override fun <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        val looper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        object <span class="token operator">:</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&quot;Thread_2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            override fun <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                val handler <span class="token operator">=</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>looper<span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">)</span>
                handler<span class="token punctuation">.</span>post <span class="token punctuation">{</span>
                    <span class="token comment">//è¾“å‡ºç»“æœæ˜¯ï¼šThread_1</span>
                    <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token annotation punctuation">@MainActivity</span><span class="token punctuation">,</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                        <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_SHORT</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#_16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹" aria-hidden="true">#</a> 16ã€å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹</h2><p>é€šè¿‡ Looper æ¥åˆ¤æ–­</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//æ˜¯ä¸»çº¿ç¨‹</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isCurrentThread<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//æ˜¯ä¸»çº¿ç¨‹</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸" tabindex="-1"><a class="header-anchor" href="#_17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸" aria-hidden="true">#</a> 17ã€å¦‚ä½•å…¨å±€æ•è·ä¸»çº¿ç¨‹å¼‚å¸¸</h2><p>æ¯”è¾ƒå§æ§½çš„ä¸€ä¸ªåšæ³•å°±æ˜¯<strong>é€šè¿‡åµŒå¥— Loop å¾ªç¯æ¥å®ç°</strong>ã€‚å‘ä¸»çº¿ç¨‹ Loop å‘é€ ä¸€ä¸ª Runnableï¼Œåœ¨ Runnable é‡Œæ­»å¾ªç¯æ‰§è¡Œ Loop å¾ªç¯ï¼Œè¿™å°±ä¼šä½¿å¾—ä¸»çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè¢«äº¤ç”±è¯¥ Runnable æ¥è°ƒç”¨ï¼Œåªè¦åŠ ä¸Š try catch åå°±å¯ä»¥æ•è·ä¸»çº¿ç¨‹çš„ä»»æ„å¼‚å¸¸äº†ï¼Œåšåˆ°<strong>ä¸»çº¿ç¨‹æ°¸ä¸å´©æºƒ</strong></p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token function">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>throwable<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;TAG&quot;</span></span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span>message <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">&quot;&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/hqqich/hqqich.github.io/edit/main/src/md/kotlin/ä¸€æ–‡è¯»æ‡‚ Handler æœºåˆ¶.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a aria-label="ä¸€æ–‡å¿«é€Ÿå…¥é—¨ RxJava 2" class="vp-link nav-link prev nav-link prev" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20RxJava%202.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>ä¸€æ–‡å¿«é€Ÿå…¥é—¨ RxJava 2</div></a><a aria-label="ä¸€æ–‡è¯»æ‡‚ Java å’Œ Kotlin çš„æ³›å‹éš¾ç‚¹" class="vp-link nav-link next nav-link next" href="/blog/dist/md/kotlin/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%20Java%20%E5%92%8C%20Kotlin%20%E7%9A%84%E6%B3%9B%E5%9E%8B%E9%9A%BE%E7%82%B9.html"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">ä¸€æ–‡è¯»æ‡‚ Java å’Œ Kotlin çš„æ³›å‹éš¾ç‚¹<span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">hqqich</div><div class="vp-copyright">Copyright Â© 2024 hqqich</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/blog/dist/assets/app-6847d3e4.js" defer></script>
  </body>
</html>
