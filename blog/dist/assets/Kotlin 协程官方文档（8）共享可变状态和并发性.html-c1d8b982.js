import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o,c,a as n,d as s,e as t,f as i}from"./app-6847d3e4.js";const l={},u={href:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image",target:"_blank",rel:"noopener noreferrer"},r=n("p",null,"å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£",-1),k=n("p",null,[s("æœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº "),n("strong",null,"Kotlinåç¨‹"),s(" çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§")],-1),d={href:"https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md",target:"_blank",rel:"noopener noreferrer"},v=i(`<p>å¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹è°ƒåº¦å™¨ï¼ˆå¦‚ Dispatchers.Defaultï¼‰å¹¶å‘æ‰§è¡Œåç¨‹ï¼Œå®ƒå‘ˆç°äº†æ‰€æœ‰å¸¸è§çš„å¹¶å‘é—®é¢˜ã€‚ä¸»è¦é—®é¢˜æ˜¯å¯¹å…±äº«å¯å˜çŠ¶æ€çš„åŒæ­¥è®¿é—®ã€‚åœ¨åç¨‹ä½œç”¨åŸŸä¸­è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€äº›æ–¹æ³•ç±»ä¼¼äºå¤šçº¿ç¨‹ä¸–ç•Œä¸­çš„æ–¹æ³•ï¼Œä½†æœ‰ä¸€äº›å…¶å®ƒæ–¹æ³•æ˜¯ç‹¬æœ‰çš„</p><h1 id="ä¸€ã€ä¸€ä¸ªé—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€ä¸€ä¸ªé—®é¢˜" aria-hidden="true">#</a> ä¸€ã€ä¸€ä¸ªé—®é¢˜</h1><p>è®©æˆ‘ä»¬å¯åŠ¨ä¸€ç™¾ä¸ªåç¨‹ï¼Œéƒ½åšåŒæ ·çš„æ“ä½œä¸€åƒæ¬¡ã€‚æˆ‘ä»¬è¿˜å°†è®¡ç®—å®ƒä»¬çš„å®Œæˆæ—¶é—´ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥æ¯”è¾ƒï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ä»ä¸€ä¸ªéå¸¸ç®€å•çš„æ“ä½œå¼€å§‹ï¼Œè¯¥æ“ä½œä½¿ç”¨å¤šçº¿ç¨‹è°ƒåº¦å™¨ Dispatchers.Defaultï¼Œå¹¶å¢åŠ ä¸€ä¸ªå…±äº«çš„å¯å˜å˜é‡</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token operator">*</span>    

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>

<span class="token comment">//sampleStart</span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        massiveRun <span class="token punctuation">{</span>
            counter<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">counter</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//sampleEnd    </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åä¼šæ‰“å°å‡ºä»€ä¹ˆå‘¢ï¼Ÿä¸å¤ªå¯èƒ½æ‰“å°å‡º â€œCounter=100000â€ï¼Œå› ä¸º100ä¸ªåç¨‹ä»å¤šä¸ªçº¿ç¨‹å¹¶å‘åœ°é€’å¢ counter è€Œä¸è¿›è¡Œä»»ä½•åŒæ­¥ã€‚</p><h1 id="äºŒã€volatiles-æ˜¯æ²¡æœ‰ä½œç”¨çš„" tabindex="-1"><a class="header-anchor" href="#äºŒã€volatiles-æ˜¯æ²¡æœ‰ä½œç”¨çš„" aria-hidden="true">#</a> äºŒã€Volatiles æ˜¯æ²¡æœ‰ä½œç”¨çš„</h1><p>æœ‰ä¸€ç§å¸¸è§çš„è¯¯è§£æ˜¯ï¼šå°†å˜é‡æ ‡è®°ä¸º volatile å¯ä»¥è§£å†³å¹¶å‘é—®é¢˜ã€‚è®©æˆ‘ä»¬è¯•è¯•ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>

<span class="token comment">//sampleStart</span>
<span class="token annotation builtin">@Volatile</span> <span class="token comment">// in Kotlin \`volatile\` is an annotation </span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        massiveRun <span class="token punctuation">{</span>
            counter<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">counter</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//sampleEnd    </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç è¿è¡Œå¾—æ¯”è¾ƒæ…¢ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨æœ€åä»ç„¶æ²¡æœ‰å¾—åˆ°â€œCounter=100000â€ï¼Œå› ä¸º volatile å˜é‡ä¿è¯äº†å¯çº¿æ€§åŒ–ï¼ˆè¿™æ˜¯â€œatomicâ€çš„ä¸€ä¸ªæŠ€æœ¯æœ¯è¯­ï¼‰å¯¹ç›¸åº”å˜é‡çš„è¯»å†™ï¼Œä½†ä¸æä¾›æ›´å¤§è¡Œä¸ºçš„åŸå­æ€§ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æŒ‡é€’å¢æ“ä½œï¼‰</p><h1 id="ä¸‰ã€çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„" aria-hidden="true">#</a> ä¸‰ã€çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„</h1><p>å¯¹çº¿ç¨‹å’Œåç¨‹éƒ½æœ‰æ•ˆçš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ï¼ˆä¹Ÿç§°ä¸ºåŒæ­¥ã€å¯çº¿æ€§åŒ–æˆ–åŸå­ï¼‰æ•°æ®ç»“æ„ï¼Œè¯¥ç»“æ„ä¸ºéœ€è¦åœ¨å…±äº«çŠ¶æ€ä¸Šæ‰§è¡Œçš„ç›¸åº”æ“ä½œæä¾›æ‰€æœ‰å¿…è¦çš„åŒæ­¥ä¿éšœã€‚å¯¹äºä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ AtomicInteger ç±»ï¼Œè¯¥ç±»å…·æœ‰ä¿è¯åŸå­æ€§çš„ incrementAndGet æ–¹æ³•</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>

<span class="token comment">//sampleStart</span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token function">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        massiveRun <span class="token punctuation">{</span>
            counter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">counter</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//sampleEnd    </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯è§£å†³è¿™ä¸ªç‰¹æ®Šé—®é¢˜çš„æœ€å¿«æ–¹æ³•ã€‚å®ƒé€‚ç”¨äºæ™®é€šè®¡æ•°å™¨ã€é›†åˆã€é˜Ÿåˆ—å’Œå…¶ä»–æ ‡å‡†æ•°æ®ç»“æ„åŠå…¶åŸºæœ¬æ“ä½œã€‚ä½†æ˜¯ï¼Œå®ƒä¸å®¹æ˜“æ‰©å±•åˆ°å¤æ‚çš„çŠ¶æ€æˆ–æ²¡æœ‰å®ç°å¥½äº†çš„çº¿ç¨‹å®‰å…¨çš„å¤æ‚æ“ä½œ</p><h1 id="å››ã€ä»¥ç»†ç²’åº¦é™åˆ¶çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#å››ã€ä»¥ç»†ç²’åº¦é™åˆ¶çº¿ç¨‹" aria-hidden="true">#</a> å››ã€ä»¥ç»†ç²’åº¦é™åˆ¶çº¿ç¨‹</h1><p>çº¿ç¨‹é™åˆ¶æ˜¯è§£å†³å…±äº«å¯å˜çŠ¶æ€é—®é¢˜çš„ä¸€ç§æ–¹æ³•ï¼Œå…¶ä¸­å¯¹ç‰¹å®šå…±äº«çŠ¶æ€çš„æ‰€æœ‰è®¿é—®éƒ½é™åˆ¶åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ã€‚å®ƒé€šå¸¸ç”¨äº UI åº”ç”¨ç¨‹åºï¼Œå…¶ä¸­æ‰€æœ‰çš„ UI çŠ¶æ€éƒ½é™åˆ¶åœ¨â€œå•ä¸ªäº‹ä»¶åˆ†æ´¾â€æˆ–â€œåº”ç”¨ç¨‹åºçº¿ç¨‹â€ä¸­ã€‚é€šè¿‡ä½¿ç”¨å•çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°ä½¿ç”¨åç¨‹æ¥å®ç°ä¸Šè¿°çš„è®¡æ•°å™¨</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>

<span class="token comment">//sampleStart</span>
<span class="token keyword">val</span> counterContext <span class="token operator">=</span> <span class="token function">newSingleThreadContext</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;CounterContext&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        massiveRun <span class="token punctuation">{</span>
            <span class="token comment">// confine each increment to a single-threaded context</span>
            <span class="token function">withContext</span><span class="token punctuation">(</span>counterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                counter<span class="token operator">++</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">counter</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//sampleEnd      </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç è¿è¡Œå¾—éå¸¸ç¼“æ…¢ï¼Œå› ä¸ºå®ƒæ‰§è¡Œç»†ç²’åº¦çš„çº¿ç¨‹é™åˆ¶ã€‚æ¯ä¸ªå•ç‹¬çš„å¢å€¼æ“ä½œéƒ½ä½¿ç”¨ withContext(counterContext) ä»å¤šçº¿ç¨‹ Dispatchers.Default ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°å•çº¿ç¨‹ä¸Šä¸‹æ–‡</p><h1 id="äº”ã€ä»¥ç²—ç²’åº¦é™åˆ¶çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#äº”ã€ä»¥ç²—ç²’åº¦é™åˆ¶çº¿ç¨‹" aria-hidden="true">#</a> äº”ã€ä»¥ç²—ç²’åº¦é™åˆ¶çº¿ç¨‹</h1><p>åœ¨å®è·µä¸­ï¼Œçº¿ç¨‹é™åˆ¶æ˜¯åœ¨æ¯”è¾ƒå¤§çš„èŒƒå›´å†…æ‰§è¡Œçš„ï¼Œä¾‹å¦‚ï¼Œæ›´æ–°çŠ¶æ€çš„é€»è¾‘çš„èŒƒå›´è¢«é™åˆ¶åœ¨å•ä¸ªçº¿ç¨‹ä¸­ã€‚ä¸‹é¢çš„ç¤ºä¾‹å°±æ˜¯è¿™æ ·åšçš„ï¼Œé¦–å…ˆåœ¨å•çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­è¿è¡Œæ¯ä¸ªåç¨‹</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>

<span class="token comment">//sampleStart</span>
<span class="token keyword">val</span> counterContext <span class="token operator">=</span> <span class="token function">newSingleThreadContext</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;CounterContext&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token comment">// confine everything to a single-threaded context</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>counterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        massiveRun <span class="token punctuation">{</span>
            counter<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">counter</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//sampleEnd     </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨è¿™æ®µä»£ç çš„è¿è¡Œé€Ÿåº¦ä¼šå¿«å¾—å¤šï¼Œå¹¶äº§ç”Ÿäº†æ­£ç¡®çš„ç»“æœ</p><h1 id="å…­ã€äº’æ–¥" tabindex="-1"><a class="header-anchor" href="#å…­ã€äº’æ–¥" aria-hidden="true">#</a> å…­ã€äº’æ–¥</h1><p>äº’æ–¥é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¿æŠ¤å…±äº«çŠ¶æ€çš„æ‰€æœ‰ä¿®æ”¹æ“ä½œï¼Œå…¶ä¸­çš„å…³é”®ä»£ç æ°¸è¿œä¸ä¼šåŒæ—¶æ‰§è¡Œã€‚åœ¨ä¸€ä¸ªé˜»å¡çš„ä¸–ç•Œä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨ <code>synchronized</code> æˆ– <code>ReentrantLock</code>ã€‚åç¨‹çš„æ›¿æ¢æ–¹æ¡ˆç§°ä¸ºäº’æ–¥(Mutex)ã€‚å®ƒå…·æœ‰ <code>lock</code> å’Œ <code>unlock</code> å‡½æ•°ä»¥åˆ’å®šä¸€ä¸ªå…³é”®ä½ç½®ã€‚å…³é”®çš„åŒºåˆ«åœ¨äº <code>Mutex.lock()</code> æ˜¯ä¸€ä¸ªæŒ‚èµ·å‡½æ•°ã€‚å®ƒä¸ä¼šé˜»å¡çº¿ç¨‹</p><p>è¿˜æœ‰ä¸€ä¸ªæ‰©å±•å‡½æ•° withLock å¯ä»¥æ–¹ä¾¿åœ°æ¥å®ç° <code>mutex.lock(); try {...} finally { mutex.unlock() } </code></p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>

<span class="token comment">//sampleStart</span>
<span class="token keyword">val</span> mutex <span class="token operator">=</span> <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        massiveRun <span class="token punctuation">{</span>
            <span class="token comment">// protect each increment with lock</span>
            mutex<span class="token punctuation">.</span><span class="token function">withLock</span> <span class="token punctuation">{</span>
                counter<span class="token operator">++</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">counter</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//sampleEnd</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ¬ä¾‹ä¸­çš„é”æ˜¯ç»†ç²’åº¦çš„ï¼Œå› æ­¤å®ƒä¹Ÿä»˜å‡ºäº†æŸäº›ä»£ä»·ï¼ˆæ¶ˆè€—ï¼‰ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œæ¯”å¦‚ä½ å¿…é¡»å®šæœŸä¿®æ”¹æŸäº›å…±äº«çŠ¶æ€ï¼Œä½†ä¸å…·å¤‡ä¿®æ”¹å…±äº«çŠ¶æ€æ‰€éœ€çš„åŸç”Ÿçº¿ç¨‹</p><h1 id="ä¸ƒã€actors" tabindex="-1"><a class="header-anchor" href="#ä¸ƒã€actors" aria-hidden="true">#</a> ä¸ƒã€Actors</h1><p>actor æ˜¯ä¸€ä¸ªå®ä½“ï¼Œç”±ä¸€ä¸ªåç¨‹ã€è¢«é™åˆ¶å¹¶å°è£…åˆ°è¿™ä¸ªåç¨‹ä¸­çš„çŠ¶æ€ä»¥åŠä¸€ä¸ªä¸å…¶å®ƒåç¨‹é€šä¿¡çš„é€šé“ç»„æˆã€‚ç®€å•çš„ actor å¯ä»¥å†™æˆå‡½æ•°ï¼Œä½†å…·æœ‰å¤æ‚çŠ¶æ€çš„ actor æ›´é€‚åˆç±»</p><p>æœ‰ä¸€ä¸ª actor åç¨‹æ„é€ å™¨ï¼Œå®ƒå¯ä»¥æ–¹ä¾¿åœ°å°† actor çš„ mailbox channel åˆå¹¶åˆ°å…¶æ¥æ”¶çš„æ¶ˆæ¯çš„ä½œç”¨åŸŸä¸­ï¼Œå¹¶å°† send channel åˆå¹¶åˆ°ç”Ÿæˆçš„ job å¯¹è±¡ä¸­ï¼Œä»¥ä¾¿å¯ä»¥å°†å¯¹ actor çš„å•ä¸ªå¼•ç”¨ä½œä¸ºå…¶å¥æŸ„å¼•æœ‰</p><p>ä½¿ç”¨ actor çš„ç¬¬ä¸€æ­¥æ˜¯å®šä¹‰ä¸€ç±» actor å°†è¦å¤„ç†çš„æ¶ˆæ¯ã€‚kotlin çš„å¯†å°ç±»éå¸¸é€‚åˆè¿™ä¸ªç›®çš„ã€‚åœ¨ CounterMsg å¯†å°ç±»ä¸­ï¼Œæˆ‘ä»¬ç”¨ IncCounter æ¶ˆæ¯æ¥å®šä¹‰é€’å¢è®¡æ•°å™¨ï¼Œç”¨ GetCounter æ¶ˆæ¯æ¥è·å–å…¶å€¼ï¼Œåè€…éœ€è¦è¿”å›å€¼ã€‚ä¸ºæ­¤ï¼Œè¿™é‡Œä½¿ç”¨ CompletableDeferred communication primitiveï¼Œå®ƒè¡¨ç¤ºå°†æ¥å·²çŸ¥ï¼ˆé€šä¿¡ï¼‰çš„å•ä¸ªå€¼</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">// Message types for counterActor</span>
<span class="token keyword">sealed</span> <span class="token keyword">class</span> CounterMsg
<span class="token keyword">object</span> IncCounter <span class="token operator">:</span> <span class="token function">CounterMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// one-way message to increment counter</span>
<span class="token keyword">class</span> <span class="token function">GetCounter</span><span class="token punctuation">(</span><span class="token keyword">val</span> response<span class="token operator">:</span> CompletableDeferred<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">CounterMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// a request with reply</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä½¿ç”¨ actor åç¨‹æ„é€ å™¨æ¥å¯åŠ¨ actorï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">// This function launches a new counter actor</span>
<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">counterActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> actor<span class="token operator">&lt;</span>CounterMsg<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// actor state</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>msg <span class="token keyword">in</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// iterate over incoming messages</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">is</span> IncCounter <span class="token operator">-&gt;</span> counter<span class="token operator">++</span>
            <span class="token keyword">is</span> GetCounter <span class="token operator">-&gt;</span> msg<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç å¾ˆç®€å•ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>channels<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">massiveRun</span><span class="token punctuation">(</span>action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> n <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// number of coroutines to launch</span>
    <span class="token keyword">val</span> k <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// times an action is repeated by each coroutine</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> measureTimeMillis <span class="token punctuation">{</span>
        coroutineScope <span class="token punctuation">{</span> <span class="token comment">// scope for coroutines </span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                launch <span class="token punctuation">{</span>
                    <span class="token function">repeat</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Completed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">n <span class="token operator">*</span> k</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> actions in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>

<span class="token comment">// Message types for counterActor</span>
<span class="token keyword">sealed</span> <span class="token keyword">class</span> CounterMsg
<span class="token keyword">object</span> IncCounter <span class="token operator">:</span> <span class="token function">CounterMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// one-way message to increment counter</span>
<span class="token keyword">class</span> <span class="token function">GetCounter</span><span class="token punctuation">(</span><span class="token keyword">val</span> response<span class="token operator">:</span> CompletableDeferred<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">CounterMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// a request with reply</span>

<span class="token comment">// This function launches a new counter actor</span>
<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">counterActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> actor<span class="token operator">&lt;</span>CounterMsg<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// actor state</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>msg <span class="token keyword">in</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// iterate over incoming messages</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">is</span> IncCounter <span class="token operator">-&gt;</span> counter<span class="token operator">++</span>
            <span class="token keyword">is</span> GetCounter <span class="token operator">-&gt;</span> msg<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//sampleStart</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> counter <span class="token operator">=</span> <span class="token function">counterActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// create the actor</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        massiveRun <span class="token punctuation">{</span>
            counter<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>IncCounter<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// send a message to get a counter value from an actor</span>
    <span class="token keyword">val</span> response <span class="token operator">=</span> CompletableDeferred<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    counter<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">GetCounter</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    counter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// shutdown the actor</span>
<span class="token punctuation">}</span>
<span class="token comment">//sampleEnd    </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä»€ä¹ˆä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ actor æœ¬èº«å¹¶ä¸é‡è¦ï¼ˆä¸ºäº†æ­£ç¡®ï¼‰ã€‚actor æ˜¯ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸”åç¨‹æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œå› æ­¤å°†çŠ¶æ€é™åˆ¶åˆ°ç‰¹å®šçš„åç¨‹å¯ä»¥è§£å†³å…±äº«å¯å˜çŠ¶æ€çš„é—®é¢˜ã€‚å®é™…ä¸Šï¼Œactors å¯ä»¥ä¿®æ”¹è‡ªå·±çš„ç§æœ‰çŠ¶æ€ï¼Œä½†åªèƒ½é€šè¿‡æ¶ˆæ¯ç›¸äº’å½±å“ï¼ˆé¿å…éœ€è¦ä»»ä½•é”ï¼‰</p><p>actor æ¯”ä½¿ç”¨é”æ›´ä¸ºæœ‰æ•ˆï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ€»æ˜¯æœ‰å·¥ä½œè¦åšï¼Œæ ¹æœ¬ä¸éœ€è¦åˆ‡æ¢åˆ°ä¸åŒçš„ä¸Šä¸‹æ–‡</p><blockquote><p>æ³¨æ„ï¼Œactor åç¨‹æ„é€ å™¨æ˜¯ä¸€ä¸ªåŒé‡çš„ product åç¨‹æ„é€ å™¨ ã€‚actor ä¸å®ƒæ¥æ”¶æ¶ˆæ¯çš„é€šé“ç›¸å…³è”ï¼Œè€Œ producer ä¸å‘å…¶å‘é€å…ƒç´ çš„é€šé“ç›¸å…³è”</p></blockquote>`,40);function m(b,g){const a=e("ExternalLinkIcon");return o(),c("div",null,[n("blockquote",null,[n("p",null,[s("å…¬ä¼—å·ï¼š"),n("a",u,[s("å­—èŠ‚æ•°ç»„"),t(a)])]),r]),n("blockquote",null,[k,n("p",null,[s("åç¨‹å®˜æ–¹æ–‡æ¡£ï¼š"),n("a",d,[s("coroutines-guide"),t(a)])])]),v])}const y=p(l,[["render",m],["__file","Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ8ï¼‰å…±äº«å¯å˜çŠ¶æ€å’Œå¹¶å‘æ€§.html.vue"]]);export{y as default};
