import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as l,a as n,d as s,e,f as t}from"./app-6847d3e4.js";const i={},u=t(`<div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>                         \\\\           <span class="token comment">//</span>
                          \\\\  <span class="token punctuation">.</span>ooo<span class="token punctuation">.</span>  <span class="token comment">//</span>
                           <span class="token punctuation">.</span>@@@@@@@@@<span class="token punctuation">.</span>
                         <span class="token operator">:</span>@@@@@@@@@@@@@<span class="token operator">:</span>
                        <span class="token operator">:</span>@@<span class="token punctuation">.</span> &#39;@@@@@&#39; <span class="token punctuation">.</span>@@<span class="token operator">:</span>
                        @@@@@@@@@@@@@@@@@
                        @@@@@@@@@@@@@@@@@

                   <span class="token operator">:</span>@@ <span class="token operator">:</span>@@@@@@@@@@@@@@@@@<span class="token punctuation">.</span> @@<span class="token operator">:</span>
                   @@@ &#39;@@@@@@@@@@@@@@@@@<span class="token punctuation">,</span> @@@
                   @@@ &#39;@@@@@@@@@@@@@@@@@<span class="token punctuation">,</span> @@@
                   @@@ &#39;@@@@@@@@@@@@@@@@@<span class="token punctuation">,</span> @@@
                   @@@ &#39;@@@@@@@@@@@@@@@@@<span class="token punctuation">,</span> @@@
                   @@@ &#39;@@@@@@@@@@@@@@@@@<span class="token punctuation">,</span> @@@
                   @@@ &#39;@@@@@@@@@@@@@@@@@<span class="token punctuation">,</span> @@@
                        @@@@@@@@@@@@@@@@@
                        &#39;@@@@@@@@@@@@@@@&#39;
                           @@@@   @@@@
                           @@@@   @@@@
                           @@@@   @@@@
                           &#39;@@&#39;   &#39;@@&#39;

     <span class="token operator">:</span>@@@<span class="token punctuation">.</span>
   <span class="token punctuation">.</span>@@@@@@@<span class="token operator">:</span>   <span class="token operator">+</span>@@       \`@@      @@\`   @@     @@
  <span class="token punctuation">.</span>@@@@&#39;@@@@<span class="token operator">:</span>  <span class="token operator">+</span>@@       \`@@      @@\`   @@     @@
  @@@     @@@  <span class="token operator">+</span>@@       \`@@      @@\`   @@     @@
 <span class="token punctuation">.</span>@@       @@<span class="token operator">:</span> <span class="token operator">+</span>@@   @@@ \`@@      @@\` @@@@@@ @@@@@@  @@<span class="token punctuation">;</span>@@@@@
 @@@       @@@ <span class="token operator">+</span>@@  @@@  \`@@      @@\` @@@@@@ @@@@@@  @@@@@@@@@
 @@@       @@@ <span class="token operator">+</span>@@ @@@   \`@@@@@@@@@@\`   @@     @@    @@@   <span class="token operator">:</span>@@
 @@@       @@@ <span class="token operator">+</span>@@@@@    \`@@@@@@@@@@\`   @@     @@    @@#    @@<span class="token operator">+</span>
 @@@       @@@ <span class="token operator">+</span>@@@@@<span class="token operator">+</span>   \`@@      @@\`   @@     @@    @@<span class="token operator">:</span>    @@#
  @@<span class="token operator">:</span>     <span class="token punctuation">.</span>@@\` <span class="token operator">+</span>@@@<span class="token operator">+</span>@@   \`@@      @@\`   @@     @@    @@#    @@<span class="token operator">+</span>
  @@@<span class="token punctuation">.</span>   <span class="token punctuation">.</span>@@@  <span class="token operator">+</span>@@  @@@  \`@@      @@\`   @@     @@    @@@   <span class="token punctuation">,</span>@@
   @@@@@@@@@   <span class="token operator">+</span>@@   @@@ \`@@      @@\`   @@@@   @@@@  @@@@#@@@@
    @@@@@@@    <span class="token operator">+</span>@@   #@@ \`@@      @@\`   @@@@<span class="token operator">:</span>  @@@@<span class="token operator">:</span> @@&#39;@@@@@
                                                     @@<span class="token operator">:</span>
                                                     @@<span class="token operator">:</span>
                                                     @@<span class="token operator">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),r={href:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image",target:"_blank",rel:"noopener noreferrer"},k=n("p",null,"å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£",-1),d=n("blockquote",null,[n("p",null,[s("å¯¹äº Android Developer æ¥è¯´ï¼Œå¾ˆå¤šå¼€æºåº“éƒ½æ˜¯å±äº"),n("strong",null,"å¼€å‘å¿…å¤‡"),s("çš„çŸ¥è¯†ç‚¹ï¼Œä»ä½¿ç”¨æ–¹å¼åˆ°å®ç°åŸç†å†åˆ°æºç è§£æï¼Œè¿™äº›éƒ½éœ€è¦æˆ‘ä»¬æœ‰ä¸€å®šç¨‹åº¦çš„äº†è§£å’Œè¿ç”¨èƒ½åŠ›ã€‚æ‰€ä»¥æˆ‘æ‰“ç®—æ¥å†™ä¸€ç³»åˆ—å…³äºå¼€æºåº“"),n("strong",null,"æºç è§£æ"),s("å’Œ"),n("strong",null,"å®æˆ˜æ¼”ç»ƒ"),s("çš„æ–‡ç« ï¼Œåˆå®šçš„ç›®æ ‡æ˜¯ "),n("strong",null,"EventBusã€ARouterã€LeakCanaryã€Retrofitã€Glideã€OkHttpã€Coil"),s(" ç­‰ä¸ƒä¸ªçŸ¥åå¼€æºåº“ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£")])],-1),v={href:"https://juejin.im/post/6880602489297895438",target:"_blank",rel:"noopener noreferrer"},m=t(`<div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code>dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">&#39;com.squareup.okhttp3:okhttp:4.9.0&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…ˆæ¥çœ‹ä¸€ä¸ªå°ä¾‹å­ï¼Œåé¢çš„è®²è§£éƒ½ä¼šåŸºäºè¿™ä¸ªä¾‹å­æ¶‰åŠåˆ°çš„æ¨¡å—æ¥å±•å¼€</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */</span>
<span class="token keyword">const</span> <span class="token keyword">val</span> URL <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;https://publicobject.com/helloworld.txt&quot;</span></span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> okHttClient <span class="token operator">=</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retryOnConnectionFailure</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> request <span class="token operator">=</span> Request<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>URL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> call <span class="token operator">=</span> okHttClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token keyword">val</span> response <span class="token operator">=</span> call<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç å°±å®Œæˆäº†ä¸€æ¬¡ Get è¯·æ±‚ï¼Œå…¶åŒ…å«çš„æ“ä½œæœ‰ï¼š</p><ol><li>é€šè¿‡ Builder æ¨¡å¼å¾—åˆ° OkHttpClientï¼ŒOkHttpClient åŒ…å«äº†å¯¹ç½‘ç»œè¯·æ±‚çš„å…¨å±€é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ <strong>é“¾æ¥è¶…æ—¶æ—¶é—´ã€è¯»å†™è¶…æ—¶æ—¶é—´ã€é“¾æ¥å¤±è´¥é‡è¯•</strong> ç­‰å„ç§é…ç½®</li><li>é€šè¿‡ Builder æ¨¡å¼å¾—åˆ° Requestï¼ŒRequest åŒ…å«äº†æœ¬æ¬¡ç½‘ç»œè¯·æ±‚çš„æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼ŒåŒ…æ‹¬ <strong>urlã€methodã€headersã€body</strong> ç­‰</li><li>é€šè¿‡ newCall æ–¹æ³•å¾—åˆ° Callï¼ŒCall å°±ç”¨äºå‘èµ·è¯·æ±‚ï¼Œå¯ç”¨äºæ‰§è¡Œ <strong>åŒæ­¥è¯·æ±‚ï¼ˆexecuteï¼‰ã€å¼‚æ­¥è¯·æ±‚ï¼ˆenqueueï¼‰ã€å–æ¶ˆè¯·æ±‚ï¼ˆcancelï¼‰</strong> ç­‰å„ç§æ“ä½œ</li><li>è°ƒç”¨ execute æ–¹æ³•å‘èµ·åŒæ­¥è¯·æ±‚å¹¶è¿”å›ä¸€ä¸ª Response å¯¹è±¡ï¼ŒResponse å°±åŒ…å«äº†æ­¤æ¬¡ç½‘ç»œè¯·æ±‚çš„æ‰€æœ‰è¿”å›ä¿¡æ¯ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥çš„è¯æ­¤æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸</li><li>æ‹¿åˆ° Response å¯¹è±¡çš„ body å¹¶ä»¥å­—ç¬¦ä¸²æµçš„æ–¹å¼è¿›è¡Œè¯»å–ï¼Œæ‰“å°ç»“æœå³æ–‡ç« å¼€å¤´çš„ Android æœºå™¨äººå½©è›‹</li></ol><h1 id="ä¸€ã€okhttpclient" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€okhttpclient" aria-hidden="true">#</a> ä¸€ã€OkHttpClient</h1><p>OkHttpClient ä½¿ç”¨äº† Builder æ¨¡å¼æ¥å®Œæˆåˆå§‹åŒ–ï¼Œå…¶æä¾›äº†å¾ˆå¤šçš„é…ç½®å‚æ•°ï¼Œæ¯ä¸ªé€‰é¡¹éƒ½æœ‰é»˜è®¤å€¼ï¼Œä½†å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ¥è¿›è¡Œè‡ªå®šä¹‰ï¼Œæ‰€ä»¥ä¹Ÿæœ‰å¿…è¦æ¥äº†è§£ä¸‹å…¶åŒ…å«çš„æ‰€æœ‰å‚æ•°</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> Builder <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//è°ƒåº¦å™¨</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> dispatcher<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token function">Dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//è¿æ¥æ± </span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> connectionPool<span class="token operator">:</span> ConnectionPool <span class="token operator">=</span> <span class="token function">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//æ‹¦æˆªå™¨åˆ—è¡¨</span>
    <span class="token keyword">internal</span> <span class="token keyword">val</span> interceptors<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//ç½‘ç»œæ‹¦æˆªå™¨åˆ—è¡¨</span>
    <span class="token keyword">internal</span> <span class="token keyword">val</span> networkInterceptors<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//äº‹ä»¶ç›‘å¬</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> eventListenerFactory<span class="token operator">:</span> EventListener<span class="token punctuation">.</span>Factory <span class="token operator">=</span> EventListener<span class="token punctuation">.</span>NONE<span class="token punctuation">.</span><span class="token function">asFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//è¿æ¥å¤±è´¥çš„æ—¶å€™æ˜¯å¦é‡è¯•</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> retryOnConnectionFailure <span class="token operator">=</span> <span class="token boolean">true</span> 
    <span class="token comment">//æºæœåŠ¡å™¨èº«ä»½éªŒè¯</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> authenticator<span class="token operator">:</span> Authenticator <span class="token operator">=</span> Authenticator<span class="token punctuation">.</span>NONE
    <span class="token comment">//æ˜¯å¦å…è®¸é‡å®šå‘</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> followRedirects <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">//æ˜¯å¦å…è®¸sslé‡å®šå‘</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> followSslRedirects <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">//Cookie</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> cookieJar<span class="token operator">:</span> CookieJar <span class="token operator">=</span> CookieJar<span class="token punctuation">.</span>NO_COOKIES
    <span class="token comment">//ç¼“å­˜</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> cache<span class="token operator">:</span> Cache<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">//DNS</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> dns<span class="token operator">:</span> Dns <span class="token operator">=</span> Dns<span class="token punctuation">.</span>SYSTEM
    <span class="token comment">//ä»£ç†</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> proxy<span class="token operator">:</span> Proxy<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">//ä»£ç†é€‰æ‹©å™¨</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> proxySelector<span class="token operator">:</span> ProxySelector<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">//ä»£ç†èº«ä»½éªŒè¯</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> proxyAuthenticator<span class="token operator">:</span> Authenticator <span class="token operator">=</span> Authenticator<span class="token punctuation">.</span>NONE
    <span class="token comment">//Socketå·¥å‚</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> socketFactory<span class="token operator">:</span> SocketFactory <span class="token operator">=</span> SocketFactory<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//å®‰å…¨å¥—æ¥å±‚</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> sslSocketFactoryOrNull<span class="token operator">:</span> SSLSocketFactory<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> x509TrustManagerOrNull<span class="token operator">:</span> X509TrustManager<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> connectionSpecs<span class="token operator">:</span> List<span class="token operator">&lt;</span>ConnectionSpec<span class="token operator">&gt;</span> <span class="token operator">=</span> DEFAULT_CONNECTION_SPECS
    <span class="token comment">//HTTP åè®®</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> protocols<span class="token operator">:</span> List<span class="token operator">&lt;</span>Protocol<span class="token operator">&gt;</span> <span class="token operator">=</span> DEFAULT_PROTOCOLS
    <span class="token comment">//ä¸»æœºåå­—ç¡®è®¤</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> hostnameVerifier<span class="token operator">:</span> HostnameVerifier <span class="token operator">=</span> OkHostnameVerifier
    <span class="token comment">//è¯ä¹¦é“¾</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> certificatePinner<span class="token operator">:</span> CertificatePinner <span class="token operator">=</span> CertificatePinner<span class="token punctuation">.</span>DEFAULT
    <span class="token keyword">internal</span> <span class="token keyword">var</span> certificateChainCleaner<span class="token operator">:</span> CertificateChainCleaner<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> callTimeout <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> connectTimeout <span class="token operator">=</span> <span class="token number">10_000</span>
    <span class="token comment">//è¯»è¶…æ—¶</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> readTimeout <span class="token operator">=</span> <span class="token number">10_000</span>
    <span class="token comment">//å†™è¶…æ—¶</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> writeTimeout <span class="token operator">=</span> <span class="token number">10_000</span>
    <span class="token comment">//ping ä¹‹é—´çš„æ—¶é—´é—´éš”</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> pingInterval <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> minWebSocketMessageToCompress <span class="token operator">=</span> RealWebSocket<span class="token punctuation">.</span>DEFAULT_MINIMUM_DEFLATE_SIZE
    <span class="token keyword">internal</span> <span class="token keyword">var</span> routeDatabase<span class="token operator">:</span> RouteDatabase<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="äºŒã€request" tabindex="-1"><a class="header-anchor" href="#äºŒã€request" aria-hidden="true">#</a> äºŒã€Request</h1><p>Request åŒ…å«äº†ç½‘ç»œè¯·æ±‚æ—¶çš„æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼Œä¸€å…±åŒ…å«ä»¥ä¸‹äº”ä¸ªï¼š</p><ol><li>urlã€‚å³æœ¬æ¬¡çš„ç½‘ç»œè¯·æ±‚åœ°å€ä»¥åŠå¯èƒ½åŒ…å«çš„ query é”®å€¼å¯¹</li><li>methodã€‚å³è¯·æ±‚æ–¹å¼ï¼Œå¯é€‰å‚æ•°æœ‰ GETã€HEADã€POSTã€DELETEã€PUTã€PATCH</li><li>headersã€‚å³è¯·æ±‚å¤´ï¼Œå¯ç”¨æ¥å­˜ tokenã€æ—¶é—´æˆ³ç­‰</li><li>bodyã€‚å³è¯·æ±‚ä½“</li><li>tagsã€‚å¯ç”¨æ¥å”¯ä¸€æ ‡è¯†æœ¬æ¬¡è¯·æ±‚</li></ol><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">internal</span> <span class="token keyword">var</span> url<span class="token operator">:</span> HttpUrl<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">internal</span> <span class="token keyword">var</span> method<span class="token operator">:</span> String
<span class="token keyword">internal</span> <span class="token keyword">var</span> headers<span class="token operator">:</span> Headers<span class="token punctuation">.</span>Builder
<span class="token keyword">internal</span> <span class="token keyword">var</span> body<span class="token operator">:</span> RequestBody<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token comment">/** A mutable map of tags, or an immutable empty map if we don&#39;t have any. */</span>
<span class="token keyword">internal</span> <span class="token keyword">var</span> tags<span class="token operator">:</span> MutableMap<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> Any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableMapOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="ä¸‰ã€call" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€call" aria-hidden="true">#</a> ä¸‰ã€Call</h1><p>å½“è°ƒç”¨ <code>okHttClient.newCall(request)</code>æ—¶å°±ä¼šå¾—åˆ°ä¸€ä¸ª Call å¯¹è±¡</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">/** Prepares the [request] to be executed at some point in the future. */</span>
<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Call <span class="token operator">=</span> <span class="token function">RealCall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> forWebSocket <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>Call æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶çœ‹åšæ˜¯ç½‘ç»œè¯·æ±‚çš„å¯åŠ¨å™¨ï¼Œå¯ç”¨äºå‘èµ·åŒæ­¥è¯·æ±‚æˆ–å¼‚æ­¥è¯·æ±‚ï¼Œ<strong>ä½†é‡å¤å‘èµ·å¤šæ¬¡è¯·æ±‚çš„è¯ä¼šæŠ›å‡ºå¼‚å¸¸</strong></p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">interface</span> Call <span class="token operator">:</span> Cloneable <span class="token punctuation">{</span>
    
  <span class="token comment">//è¿”å›æœ¬æ¬¡ç½‘ç»œè¯·æ±‚çš„ Request å¯¹è±¡</span>
  <span class="token keyword">fun</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Request
    
  <span class="token comment">//å‘èµ·åŒæ­¥è¯·æ±‚ï¼Œå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</span>
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response
    
  <span class="token comment">//å‘èµ·å¼‚æ­¥è¯·æ±‚ï¼Œé€šè¿‡ Callback æ¥å›è°ƒæœ€ç»ˆç»“æœ </span>
  <span class="token keyword">fun</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>responseCallback<span class="token operator">:</span> Callback<span class="token punctuation">)</span>

  <span class="token comment">//å–æ¶ˆç½‘ç»œè¯·æ±‚</span>
  <span class="token keyword">fun</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">//æ˜¯å¦å·²ç»å‘èµ·è¿‡è¯·æ±‚</span>
  <span class="token keyword">fun</span> <span class="token function">isExecuted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean

  <span class="token comment">//æ˜¯å¦å·²ç»å–æ¶ˆè¯·æ±‚</span>
  <span class="token keyword">fun</span> <span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean
  
  <span class="token comment">//è¶…æ—¶è®¡ç®—</span>
  <span class="token keyword">fun</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Timeout

  <span class="token comment">//åŒä¸ª Call ä¸å…è®¸é‡å¤å‘èµ·è¯·æ±‚ï¼Œæƒ³è¦å†æ¬¡å‘èµ·è¯·æ±‚å¯ä»¥é€šè¿‡æ­¤æ–¹æ³•å¾—åˆ°ä¸€ä¸ªæ–°çš„ Call å¯¹è±¡</span>
  <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Call

  <span class="token keyword">fun</span> <span class="token keyword">interface</span> Factory <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Call
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>newCall</code> æ–¹æ³•è¿”å›çš„å®é™…ç±»å‹æ˜¯ RealCallï¼Œå®ƒæ˜¯ Call æ¥å£çš„å”¯ä¸€å®ç°ç±»</p><p>å½“æˆ‘ä»¬è°ƒç”¨ <code>execute</code> æ–¹æ³•å‘èµ·åŒæ­¥è¯·æ±‚æ—¶ï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼š</p><ol><li>åˆ¤è¯»æ˜¯å¦é‡å¤è¯·æ±‚</li><li>äº‹ä»¶è®°å½•</li><li>å°†è‡ªèº«åŠ å…¥åˆ° dispatcher ä¸­ï¼Œå¹¶åœ¨è¯·æ±‚ç»“æŸæ—¶ä» dispatcher ä¸­ç§»é™¤è‡ªèº«</li><li>é€šè¿‡ <code>getResponseWithInterceptorChain</code> æ–¹æ³•å¾—åˆ° Response å¯¹è±¡</li></ol><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">RealCall</span><span class="token punctuation">(</span>
  <span class="token keyword">val</span> client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">,</span>
  <span class="token comment">/** The application&#39;s original request unadulterated by redirects or auth headers. */</span>
  <span class="token keyword">val</span> originalRequest<span class="token operator">:</span> Request<span class="token punctuation">,</span>
  <span class="token keyword">val</span> forWebSocket<span class="token operator">:</span> Boolean
<span class="token punctuation">)</span> <span class="token operator">:</span> Call <span class="token punctuation">{</span>
    
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
    <span class="token function">check</span><span class="token punctuation">(</span>executed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">&quot;Already Executed&quot;</span></span> <span class="token punctuation">}</span>
    timeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">callStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">executed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å››ã€dispatcher" tabindex="-1"><a class="header-anchor" href="#å››ã€dispatcher" aria-hidden="true">#</a> å››ã€Dispatcher</h1><p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>getResponseWithInterceptorChain</code> æ–¹æ³•å°±æ˜¯é‡å¤´æˆäº†ï¼Œå…¶è¿”å›äº†æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„ Responseã€‚ä½†è¿™é‡Œå…ˆä¸ä»‹ç»è¯¥æ–¹æ³•ï¼Œå…ˆæ¥çœ‹çœ‹ Dispatcher çš„é€»è¾‘</p><p>Dispatcher æ˜¯ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œç”¨äºå¯¹å…¨å±€çš„ç½‘ç»œè¯·æ±‚è¿›è¡Œç¼“å­˜è°ƒåº¦ï¼Œå…¶åŒ…å«ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">var</span> maxRequests <span class="token operator">=</span> <span class="token number">64</span>

<span class="token keyword">var</span> maxRequestsPerHost <span class="token operator">=</span> <span class="token number">5</span>

<span class="token comment">/** Ready async calls in the order they&#39;ll be run. */</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> readyAsyncCalls <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>AsyncCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/** Running asynchronous calls. Includes canceled calls that haven&#39;t finished yet. */</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> runningAsyncCalls <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>AsyncCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/** Running synchronous calls. Includes canceled calls that haven&#39;t finished yet. */</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> runningSyncCalls <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>RealCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>maxRequestsã€‚åŒä¸€æ—¶é—´å…è®¸å¹¶å‘æ‰§è¡Œç½‘ç»œè¯·æ±‚çš„æœ€å¤§çº¿ç¨‹æ•°</li><li>maxRequestsPerHostã€‚åŒä¸€ host ä¸‹çš„æœ€å¤§åŒæ—¶è¯·æ±‚æ•°</li><li>readyAsyncCallsã€‚ä¿å­˜å½“å‰ç­‰å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡</li><li>runningAsyncCallsã€‚ä¿å­˜å½“å‰æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡</li><li>runningSyncCallsã€‚ä¿å­˜å½“å‰æ­£åœ¨æ‰§è¡Œçš„åŒæ­¥ä»»åŠ¡</li></ul><p>å®¢æˆ·ç«¯ä¸åº”è¯¥æ— é™åˆ¶åœ°åŒæ—¶å‘èµ·å¤šä¸ªç½‘ç»œè¯·æ±‚ï¼Œå› ä¸ºé™¤äº†ç½‘ç»œèµ„æºæ‰€é™å¤–ï¼Œç³»ç»Ÿèµ„æºä¹Ÿæ˜¯æœ‰é™çš„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ç”±ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œï¼Œè€Œç³»ç»Ÿæ”¯æŒå¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥ OkHttp å†…éƒ¨å°±ä½¿ç”¨ maxRequests æ¥æ§åˆ¶åŒæ—¶æ‰§è¡Œå¼‚æ­¥è¯·æ±‚çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚æ­¤å¤–ï¼ŒOkHttp ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå…è®¸å¤šä¸ªæŒ‡å‘åŒä¸€ host çš„ç½‘ç»œè¯·æ±‚å…±äº«åŒä¸€ä¸ª Socketï¼Œè€Œæœ€å¤§å…±äº«æ•°é‡å³ maxRequestsPerHost</p><p>ä¸ºäº†ç»Ÿè®¡ä»¥ä¸Šä¸¤ä¸ªè¿è¡Œå‚æ•°ï¼Œå°±éœ€è¦ä½¿ç”¨ readyAsyncCallsã€runningAsyncCalls å’Œ runningSyncCalls æ¥ä¿å­˜å½“å‰æ­£åœ¨æ‰§è¡Œæˆ–è€…å‡†å¤‡æ‰§è¡Œçš„ç½‘ç»œè¯·æ±‚ã€‚runningSyncCalls ç”¨äºä¿å­˜<strong>å½“å‰æ­£åœ¨æ‰§è¡Œçš„åŒæ­¥ä»»åŠ¡</strong>ï¼Œå…¶å­˜å‚¨çš„æ˜¯ RealCallã€‚readyAsyncCalls å’Œ runningAsyncCalls ç”¨äºä¿å­˜<strong>å¼‚æ­¥ä»»åŠ¡</strong>ï¼Œå…¶å­˜å‚¨çš„æ˜¯ AsyncCall</p><h2 id="_1ã€åŒæ­¥è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#_1ã€åŒæ­¥è¯·æ±‚" aria-hidden="true">#</a> 1ã€åŒæ­¥è¯·æ±‚</h2><p>RealCall çš„ <code>execute()</code> æ–¹æ³•åœ¨å¼€å§‹è¯·æ±‚å‰ï¼Œä¼šå…ˆå°†è‡ªèº«ä¼ ç»™ dispatcherï¼Œåœ¨è¯·æ±‚ç»“æŸååˆä¼šä» dispatcher ä¸­ç§»é™¤</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">RealCall</span><span class="token punctuation">(</span>
  <span class="token keyword">val</span> client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">,</span>
  <span class="token comment">/** The application&#39;s original request unadulterated by redirects or auth headers. */</span>
  <span class="token keyword">val</span> originalRequest<span class="token operator">:</span> Request<span class="token punctuation">,</span>
  <span class="token keyword">val</span> forWebSocket<span class="token operator">:</span> Boolean
<span class="token punctuation">)</span> <span class="token operator">:</span> Call <span class="token punctuation">{</span>
 
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
    <span class="token function">check</span><span class="token punctuation">(</span>executed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">&quot;Already Executed&quot;</span></span> <span class="token punctuation">}</span>
    timeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">callStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ·»åŠ åˆ° dispatcher</span>
      client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">executed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//ä» dispatcher ä¸­ç§»é™¤</span>
      client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Dispatcher å†…éƒ¨ä¹Ÿåªæ˜¯ç›¸åº”çš„å°† RealCall æ·»åŠ åˆ° runningSyncCalls ä¸­æˆ–è€…æ˜¯å°†å…¶ä» runningSyncCalls ä¸­ç§»é™¤ï¼Œä¿å­˜åˆ° runningSyncCalls çš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿<strong>ç»Ÿè®¡å½“å‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚æ€»æ•°</strong>ä»¥åŠ<strong>èƒ½å¤Ÿå–æ¶ˆæ‰€æœ‰è¯·æ±‚</strong>ã€‚æ­¤å¤–ï¼Œç”±äºåŒæ­¥è¯·æ±‚ä¼šç›´æ¥è¿è¡Œåœ¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹ä¸Šï¼Œæ‰€ä»¥åŒæ­¥è¯·æ±‚å¹¶ä¸ä¼šå— maxRequests çš„é™åˆ¶</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> Dispatcher <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
      <span class="token comment">/** Used by [Call.execute] to signal it is in-flight. */</span>
  	  <span class="token annotation builtin">@Synchronized</span> 
      <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">executed</span><span class="token punctuation">(</span>call<span class="token operator">:</span> RealCall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	runningSyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    
      <span class="token comment">/** Used by [Call.execute] to signal completion. */</span>
  	  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">finished</span><span class="token punctuation">(</span>call<span class="token operator">:</span> RealCall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token function">finished</span><span class="token punctuation">(</span>runningSyncCalls<span class="token punctuation">,</span> call<span class="token punctuation">)</span>
  	  <span class="token punctuation">}</span>

  	  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">finished</span><span class="token punctuation">(</span>calls<span class="token operator">:</span> Deque<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> call<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">val</span> idleCallback<span class="token operator">:</span> Runnable<span class="token operator">?</span>
    	<span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>calls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Call wasn&#39;t in-flight!&quot;</span></span><span class="token punctuation">)</span>
      		idleCallback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idleCallback
    	<span class="token punctuation">}</span>
        <span class="token comment">//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„ç½‘ç»œè¯·æ±‚</span>
    	<span class="token keyword">val</span> isRunning <span class="token operator">=</span> <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunning <span class="token operator">&amp;&amp;</span> idleCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      		idleCallback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2ã€å¼‚æ­¥è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#_2ã€å¼‚æ­¥è¯·æ±‚" aria-hidden="true">#</a> 2ã€å¼‚æ­¥è¯·æ±‚</h2><p>RealCall çš„ <code>enqueue</code>æ–¹æ³•ä¼šå°†å¤–éƒ¨ä¼ å…¥çš„ Callback åŒ…è£…ä¸ºä¸€ä¸ª AsyncCall å¯¹è±¡åä¼ ç»™ dispatcher</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">RealCall</span><span class="token punctuation">(</span>
  <span class="token keyword">val</span> client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">,</span>
  <span class="token comment">/** The application&#39;s original request unadulterated by redirects or auth headers. */</span>
  <span class="token keyword">val</span> originalRequest<span class="token operator">:</span> Request<span class="token punctuation">,</span>
  <span class="token keyword">val</span> forWebSocket<span class="token operator">:</span> Boolean
<span class="token punctuation">)</span> <span class="token operator">:</span> Call <span class="token punctuation">{</span>
    
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>responseCallback<span class="token operator">:</span> Callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">check</span><span class="token punctuation">(</span>executed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">&quot;Already Executed&quot;</span></span> <span class="token punctuation">}</span>
    <span class="token function">callStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token function">AsyncCall</span><span class="token punctuation">(</span>responseCallback<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äº <code>enqueue</code>å¯¹åº”çš„æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ‰€ä»¥ OkHttp å†…éƒ¨å°±éœ€è¦è‡ªå·±æ„é€ ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¯·æ±‚ï¼Œåœ¨è¯·æ±‚ç»“æŸåå†é€šè¿‡ Callback æ¥å°†ç»“æœå€¼å›è°ƒç»™å¤–éƒ¨ï¼Œå¼‚æ­¥è¯·æ±‚é€»è¾‘å¯¹åº”çš„è½½ä½“å°±æ˜¯ AsyncCall è¿™ä¸ªç±»</p><p>AsyncCall æ˜¯ RealCall çš„éé™æ€å†…éƒ¨ç±»ï¼Œæ‰€ä»¥ AsyncCall å¯ä»¥è®¿é—®åˆ° RealCall çš„æ‰€æœ‰å˜é‡å’Œæ–¹æ³•ã€‚æ­¤å¤–ï¼ŒAsyncCall ç»§æ‰¿äº† Runnable æ¥å£ï¼Œå…¶ <code>executeOn</code> æ–¹æ³•å°±ç”¨äºä¼ å…¥ä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡æ¥æ‰§è¡Œ<code>run</code> æ–¹æ³•ã€‚<code>run</code> æ–¹æ³•å†…è¿˜æ˜¯è°ƒç”¨äº† <code>getResponseWithInterceptorChain()</code>æ–¹æ³•æ¥è·å– responseï¼Œå¹¶é€šè¿‡ Callback æ¥å°†æ‰§è¡Œç»“æœï¼ˆä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰å›è°ƒå‡ºå»ï¼Œåœ¨è¯·æ±‚ç»“æŸåä¹Ÿä¼šå°†è‡ªèº«ä» dispatcher ä¸­ç§»é™¤</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">internal</span> <span class="token keyword">inner</span> <span class="token keyword">class</span> <span class="token function">AsyncCall</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> responseCallback<span class="token operator">:</span> Callback<span class="token punctuation">)</span> <span class="token operator">:</span> Runnable <span class="token punctuation">{</span>
	
    <span class="token annotation builtin">@Volatile</span> <span class="token keyword">var</span> callsPerHost <span class="token operator">=</span> <span class="token function">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  		<span class="token keyword">private</span> <span class="token keyword">set</span>

	<span class="token keyword">fun</span> <span class="token function">reuseCallsPerHostFrom</span><span class="token punctuation">(</span>other<span class="token operator">:</span> AsyncCall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  		<span class="token keyword">this</span><span class="token punctuation">.</span>callsPerHost <span class="token operator">=</span> other<span class="token punctuation">.</span>callsPerHost
	<span class="token punctuation">}</span>

	<span class="token keyword">fun</span> <span class="token function">executeOn</span><span class="token punctuation">(</span>executorService<span class="token operator">:</span> ExecutorService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            success <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> RejectedExecutionException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> ioException <span class="token operator">=</span> <span class="token function">InterruptedIOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;executor rejected&quot;</span></span><span class="token punctuation">)</span>
            ioException<span class="token punctuation">.</span><span class="token function">initCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token function">noMoreExchanges</span><span class="token punctuation">(</span>ioException<span class="token punctuation">)</span>
            responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> ioException<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// This call is no longer running!</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">threadName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;OkHttp </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression"><span class="token function">redactedUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> signalledCallback <span class="token operator">=</span> <span class="token boolean">false</span>
            timeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> response <span class="token operator">=</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                signalledCallback <span class="token operator">=</span> <span class="token boolean">true</span>
                responseCallback<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>signalledCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Do not signal the callback twice!</span>
                    Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Callback failure for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression"><span class="token function">toLoggableString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> Platform<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>t<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>signalledCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">val</span> canceledException <span class="token operator">=</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;canceled due to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">t</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
                    canceledException<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
                    responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> canceledException<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> t
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Dispatcher åœ¨æ‹¿åˆ° AsyncCall å¯¹è±¡åï¼Œä¼šå…ˆå°†å…¶å­˜åˆ° readyAsyncCalls ä¸­ï¼Œç„¶åé€šè¿‡ <code>findExistingCallWithHost</code>æ–¹æ³•æ¥æŸ¥æ‰¾å½“å‰æ˜¯å¦æœ‰æŒ‡å‘åŒä¸€ Host çš„å¼‚æ­¥è¯·æ±‚ï¼Œæœ‰çš„è¯åˆ™äº¤æ¢ callsPerHost å˜é‡ï¼Œè¯¥å˜é‡å°±ç”¨äºæ ‡è®°å½“å‰æŒ‡å‘åŒä¸€ Host çš„è¯·æ±‚æ•°é‡ï¼Œæœ€åè°ƒç”¨ <code>promoteAndExecute</code> æ–¹æ³•æ¥åˆ¤æ–­å½“å‰æ˜¯å¦å…è®¸å‘èµ·è¯·æ±‚</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> Dispatcher <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
   <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>call<span class="token operator">:</span> AsyncCall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      readyAsyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>

      <span class="token comment">// Mutate the AsyncCall so that it shares the AtomicInteger of an existing running call to</span>
      <span class="token comment">// the same host.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>call<span class="token punctuation">.</span>call<span class="token punctuation">.</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//æŸ¥æ‰¾å½“å‰æ˜¯å¦æœ‰æŒ‡å‘åŒä¸€ Host çš„å¼‚æ­¥è¯·æ±‚</span>
        <span class="token keyword">val</span> existingCall <span class="token operator">=</span> <span class="token function">findExistingCallWithHost</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span>host<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCall <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> call<span class="token punctuation">.</span><span class="token function">reuseCallsPerHostFrom</span><span class="token punctuation">(</span>existingCall<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">findExistingCallWithHost</span><span class="token punctuation">(</span>host<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> AsyncCall<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>existingCall <span class="token keyword">in</span> runningAsyncCalls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCall<span class="token punctuation">.</span>host <span class="token operator">==</span> host<span class="token punctuation">)</span> <span class="token keyword">return</span> existingCall
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>existingCall <span class="token keyword">in</span> readyAsyncCalls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCall<span class="token punctuation">.</span>host <span class="token operator">==</span> host<span class="token punctuation">)</span> <span class="token keyword">return</span> existingCall
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ç½‘ç»œè¯·æ±‚æ€»æ•°å¯èƒ½å·²ç»è¾¾åˆ°é™åˆ¶ï¼Œæˆ–è€…æ˜¯æŒ‡å‘åŒä¸€ Host çš„è¯·æ±‚ä¹Ÿè¾¾åˆ°é™åˆ¶äº†ï¼Œæ‰€ä»¥ <code>promoteAndExecute()</code>æ–¹æ³•å°±ç”¨äºä»å¾…æ‰§è¡Œåˆ—è¡¨ readyAsyncCalls ä¸­è·å–å½“å‰ç¬¦åˆè¿è¡Œæ¡ä»¶çš„æ‰€æœ‰è¯·æ±‚ï¼Œå°†è¯·æ±‚å­˜åˆ° runningAsyncCalls ä¸­ï¼Œå¹¶è°ƒç”¨çº¿ç¨‹æ± æ¥æ‰§è¡Œ</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> executableCalls <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>AsyncCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> isRunning<span class="token operator">:</span> Boolean
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> i <span class="token operator">=</span> readyAsyncCalls<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> asyncCall <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    <span class="token comment">//å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚æ€»æ•°å·²ç»è¶…å‡ºé™åˆ¶ï¼Œåˆ™ç›´æ¥è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>runningAsyncCalls<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequests<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token comment">// Max capacity.</span>
        <span class="token comment">//å¦‚æœæŒ‡å‘åŒä¸ª Host çš„è¯·æ±‚æ€»æ•°å·²ç»è¶…å‡ºé™åˆ¶ï¼Œåˆ™å–ä¸‹ä¸€ä¸ªè¯·æ±‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncCall<span class="token punctuation">.</span>callsPerHost<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequestsPerHost<span class="token punctuation">)</span> <span class="token keyword">continue</span> <span class="token comment">// Host max capacity.</span>

        i<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//å°† callsPerHost é€’å¢åŠ ä¸€ï¼Œè¡¨ç¤ºæŒ‡å‘è¯¥ Host çš„é“¾æ¥æ•°åŠ ä¸€äº†</span>
        asyncCall<span class="token punctuation">.</span>callsPerHost<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//å°† asyncCall å­˜åˆ°å¯æ‰§è¡Œåˆ—è¡¨ä¸­</span>
        executableCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asyncCall<span class="token punctuation">)</span>
        <span class="token comment">//å°† asyncCall å­˜åˆ°æ­£åœ¨æ‰§è¡Œåˆ—è¡¨ä¸­</span>
        runningAsyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asyncCall<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      isRunning <span class="token operator">=</span> <span class="token function">runningCallsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//æ‰§è¡Œæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until executableCalls<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> asyncCall <span class="token operator">=</span> executableCalls<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      asyncCall<span class="token punctuation">.</span><span class="token function">executeOn</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> isRunning
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3ã€arraydeque" tabindex="-1"><a class="header-anchor" href="#_3ã€arraydeque" aria-hidden="true">#</a> 3ã€ArrayDeque</h2><p>ä¸Šé¢æœ‰è®²åˆ°ï¼Œä¸‰ç§è¯·æ±‚çš„å­˜å‚¨å®¹å™¨æ˜¯ ArrayDequeã€‚ArrayDeque å±äºéçº¿ç¨‹å®‰å…¨çš„åŒç«¯é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ¶‰åŠåˆ°å¤šçº¿ç¨‹æ“ä½œæ—¶éƒ½éœ€è¦å¤–éƒ¨ä¸»åŠ¨çº¿ç¨‹åŒæ­¥ã€‚é‚£ä¹ˆè®©æˆ‘ä»¬æƒ³ä¸€æƒ³ï¼ŒOkHttp é€‰æ‹© ArrayDeque ä½œä¸ºä»»åŠ¡å®¹å™¨çš„ç†ç”±æ˜¯ä»€ä¹ˆï¼Ÿä»¥æˆ‘ç²—æµ…çš„çœ¼å…‰æ¥çœ‹ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>ArrayDeque å†…éƒ¨ä½¿ç”¨æ•°ç»„ç»“æ„æ¥å­˜å‚¨æ•°æ®ï¼Œå…ƒç´ å…·æœ‰æ˜ç¡®çš„å…ˆåé¡ºåºï¼Œè¿™ç¬¦åˆæˆ‘ä»¬å¯¹ç½‘ç»œè¯·æ±‚<strong>å…ˆåˆ°å…ˆæ‰§è¡Œ</strong>çš„åŸºæœ¬é¢„æœŸ</li><li>åœ¨é€‰æ‹©ç¬¦åˆè¿è¡Œæ¡ä»¶çš„å¼‚æ­¥è¯·æ±‚æ—¶ï¼Œéœ€è¦å¯¹ readyAsyncCalls è¿›è¡Œéå†ï¼Œæ•°ç»„åœ¨éå†æ•ˆç‡ä¸Šä¼šæ¯”è¾ƒé«˜</li><li>åœ¨éå†åˆ°ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚åï¼Œéœ€è¦å°†è¯·æ±‚ä» readyAsyncCalls ä¸­ç§»é™¤å¹¶è½¬ç§»åˆ° runningAsyncCalls ä¸­ï¼Œè€Œ ArrayDeque ä½œä¸ºåŒç«¯é˜Ÿåˆ—ï¼Œåœ¨å†…å­˜ç©ºé—´åˆ©ç”¨ç‡ä¸Šæ¯”è¾ƒé«˜</li><li>Dispatcher é¢å¯¹çš„å°±æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒï¼Œæœ¬èº«å°±éœ€è¦è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼Œé€‰æ‹© ArrayDeque è¿™ä¸ªéçº¿ç¨‹å®‰å…¨çš„å®¹å™¨å¯ä»¥çœå»å¤šä½™çš„çº¿ç¨‹åŒæ­¥æ¶ˆè€—</li></ul><h2 id="_4ã€çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#_4ã€çº¿ç¨‹æ± " aria-hidden="true">#</a> 4ã€çº¿ç¨‹æ± </h2><p>OkHttp çš„å¼‚æ­¥è¯·æ±‚æ˜¯äº¤ç”±å…¶å†…éƒ¨çš„çº¿ç¨‹æ± æ¥å®Œæˆçš„ï¼Œè¯¥çº¿ç¨‹æ± å°±é•¿è¿™æ ·ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">private</span> <span class="token keyword">var</span> executorServiceOrNull<span class="token operator">:</span> ExecutorService<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token annotation builtin">@get:Synchronized</span>
<span class="token annotation builtin">@get:JvmName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;executorService&quot;</span></span><span class="token punctuation">)</span> <span class="token keyword">val</span> executorService<span class="token operator">:</span> ExecutorService
<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>executorServiceOrNull <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    executorServiceOrNull <span class="token operator">=</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Int<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
        <span class="token function">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">threadFactory</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">okHttpName</span></span><span class="token string"> Dispatcher&quot;</span></span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> executorServiceOrNull<span class="token operator">!!</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥çº¿ç¨‹æ± çš„å‚æ•°è®¾ç½®æœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿä»¥æˆ‘ç²—æµ…çš„çœ¼å…‰æ¥çœ‹ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ol><li>æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 0ï¼Œçº¿ç¨‹è¶…æ—¶æ—¶é—´æ˜¯ 60 ç§’ã€‚è¯´æ˜åœ¨æ²¡æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœçº¿ç¨‹é—²ç½®äº† 60 ç§’ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±ä¼šè¢«å›æ”¶ï¼Œè¿™å¯ä»¥é¿å…ç©ºé—²çº¿ç¨‹ç™½ç™½æµªè´¹ç³»ç»Ÿèµ„æºï¼Œé€‚åˆäºç§»åŠ¨è®¾å¤‡èµ„æºç´§ç¼ºçš„æƒ…æ™¯</li><li>å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ä¸º Int.MAX_VALUEï¼Œå¯ä»¥çœ‹åšæ˜¯å®Œå…¨æ²¡æœ‰é™åˆ¶çš„ï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—æ˜¯ SynchronousQueueã€‚SynchronousQueue çš„ç‰¹ç‚¹æ˜¯å½“æœ‰ä»»åŠ¡å…¥é˜Ÿæ—¶ï¼Œå¿…é¡»ç­‰å¾…è¯¥ä»»åŠ¡è¢«æ¶ˆè´¹å¦åˆ™å…¥é˜Ÿæ“ä½œå°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œè€Œç”±äºçº¿ç¨‹æ± å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°é‡æ˜¯æ— é™çš„ï¼Œæ‰€ä»¥æ¯ä¸ªå…¥é˜Ÿçš„ä»»åŠ¡éƒ½èƒ½é©¬ä¸Šäº¤ç”±çº¿ç¨‹å¤„ç†ï¼ˆäº¤ä»˜ç»™ç©ºé—²çº¿ç¨‹æˆ–è€…æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼‰ï¼Œè¿™å°±ä¿è¯äº†ä»»åŠ¡çš„å¤„ç†åŠæ—¶æ€§ï¼Œç¬¦åˆæˆ‘ä»¬å¯¹ç½‘ç»œè¯·æ±‚åº”è¯¥å°½å¿«å‘èµ·å¹¶å®Œæˆçš„æœŸæœ›</li></ol><p>è™½ç„¶çº¿ç¨‹æ± æœ¬èº«å¯¹äºæœ€å¤§çº¿ç¨‹æ•°å‡ ä¹æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯ç”±äºæäº¤ä»»åŠ¡çš„æ“ä½œè¿˜å— maxRequests çš„æ§åˆ¶ï¼Œæ‰€ä»¥å®é™…ä¸Šè¯¥çº¿ç¨‹æ± æœ€å¤šåŒæ—¶è¿è¡Œ maxRequests ä¸ªçº¿ç¨‹</p><h2 id="_5ã€æ¨åŠ¨è¯·æ±‚æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#_5ã€æ¨åŠ¨è¯·æ±‚æ‰§è¡Œ" aria-hidden="true">#</a> 5ã€æ¨åŠ¨è¯·æ±‚æ‰§è¡Œ</h2><p>æ—¢ç„¶ OkHttp å†…éƒ¨çš„çº¿ç¨‹æ± æ˜¯ä¸å¯èƒ½æ— é™åˆ¶åœ°æ–°å»ºçº¿ç¨‹æ¥æ‰§è¡Œè¯·æ±‚çš„ï¼Œé‚£ä¹ˆå½“è¯·æ±‚æ€»æ•°å·²è¾¾åˆ° maxRequests åï¼Œåç»­çš„è¯·æ±‚åªèƒ½æ˜¯å…ˆå¤„äºç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™äº›ç­‰å¾…çŠ¶æ€çš„è¯·æ±‚ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¢«å¯åŠ¨å‘¢ï¼Ÿ</p><p>åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ç»“æŸåéƒ½ä¼šè°ƒç”¨åˆ° Dispatcher çš„ä¸¤ä¸ª <code>finished</code> æ–¹æ³•ï¼Œåœ¨è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œåˆä¼šè§¦å‘åˆ° <code>promoteAndExecute()</code>æ–¹æ³•å»éå†ä»»åŠ¡åˆ—è¡¨æ¥æ‰§è¡Œï¼Œæ­¤æ—¶å°±æ¨åŠ¨äº†å¾…å¤„ç†åˆ—è¡¨çš„ä»»åŠ¡æ‰§è¡Œæ“ä½œã€‚æ‰€ä»¥è¯´ï¼ŒDispatcher ä¸­çš„è¯·æ±‚éƒ½å¯ä»¥çœ‹åšæ˜¯åœ¨è‡ªå‘æ€§åœ°å¯åŠ¨ï¼Œæ¯ä¸ªè¯·æ±‚ç»“æŸéƒ½ä¼šè‡ªåŠ¨è§¦å‘ä¸‹ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œçœå»äº†å¤šä½™çš„å®šæ—¶æ£€æŸ¥è¿™ç±»æ“ä½œ</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">/** Used by [AsyncCall.run] to signal completion. */</span>
<span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">finished</span><span class="token punctuation">(</span>call<span class="token operator">:</span> AsyncCall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	call<span class="token punctuation">.</span>callsPerHost<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">finished</span><span class="token punctuation">(</span>runningAsyncCalls<span class="token punctuation">,</span> call<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/** Used by [Call.execute] to signal completion. */</span>
<span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">finished</span><span class="token punctuation">(</span>call<span class="token operator">:</span> RealCall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">finished</span><span class="token punctuation">(</span>runningSyncCalls<span class="token punctuation">,</span> call<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">finished</span><span class="token punctuation">(</span>calls<span class="token operator">:</span> Deque<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> call<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">val</span> idleCallback<span class="token operator">:</span> Runnable<span class="token operator">?</span>
	<span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>calls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Call wasn&#39;t in-flight!&quot;</span></span><span class="token punctuation">)</span>
  		idleCallback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idleCallback
	<span class="token punctuation">}</span>
	<span class="token comment">//åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å¯ä»¥å¯åŠ¨çš„å¾…æ‰§è¡Œä»»åŠ¡ï¼Œæœ‰çš„è¯åˆ™å¯åŠ¨</span>
	<span class="token keyword">val</span> isRunning <span class="token operator">=</span> <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunning <span class="token operator">&amp;&amp;</span> idleCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  		idleCallback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_6ã€æ€»ç»“" aria-hidden="true">#</a> 6ã€æ€»ç»“</h2><ul><li>å¦‚æœæ˜¯åŒæ­¥è¯·æ±‚ï¼Œé‚£ä¹ˆç½‘ç»œè¯·æ±‚è¿‡ç¨‹å°±ä¼šç›´æ¥åœ¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹ä¸Šå®Œæˆï¼Œä¸å— Dispatcher çš„æ§åˆ¶</li><li>å¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¼šå…ˆå­˜åˆ°å¾…æ‰§è¡Œåˆ—è¡¨ readyAsyncCalls ä¸­ï¼Œè¯¥è¯·æ±‚æ˜¯å¦å¯ä»¥ç«‹å³å‘èµ·å— maxRequests å’Œ maxRequestsPerHost ä¸¤ä¸ªæ¡ä»¶çš„é™åˆ¶ã€‚å¦‚æœç¬¦åˆæ¡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šä» readyAsyncCalls å–å‡ºå¹¶å­˜åˆ° runningAsyncCalls ä¸­ï¼Œç„¶åäº¤ç”± OkHttp å†…éƒ¨çš„çº¿ç¨‹æ± æ¥æ‰§è¡Œ</li><li>ä¸ç®¡å¤–éƒ¨æ˜¯åŒæ­¥è¯·æ±‚è¿˜æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡è°ƒç”¨<code>getResponseWithInterceptorChain()</code>æ–¹æ³•æ¥æ‹¿åˆ° Response çš„</li><li>Dispatcher å†…éƒ¨çš„çº¿ç¨‹æ± æœ¬èº«å…è®¸åŒæ—¶è¿è¡Œ Int.MAX_VALUE ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å®é™…ä¸Šçš„çº¿ç¨‹æ•°é‡è¿˜æ˜¯å— maxRequests çš„æ§åˆ¶</li></ul><h1 id="äº”ã€realinterceptorchain" tabindex="-1"><a class="header-anchor" href="#äº”ã€realinterceptorchain" aria-hidden="true">#</a> äº”ã€RealInterceptorChain</h1><p>é‡ç‚¹å†æ¥çœ‹ <code>getResponseWithInterceptorChain()</code>æ–¹æ³•ï¼Œå…¶ä¸»è¦é€»è¾‘å°±æ˜¯é€šè¿‡æ‹¦æˆªå™¨æ¥å®Œæˆæ•´ä¸ªç½‘ç»œè¯·æ±‚è¿‡ç¨‹ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œé™¤äº†ä¼šè·å–å¤–éƒ¨ä¸»åŠ¨è®¾ç½®çš„æ‹¦æˆªå™¨å¤–ï¼Œä¹Ÿä¼šé»˜è®¤æ·»åŠ ä»¥ä¸‹å‡ ä¸ªæ‹¦æˆªå™¨</p><ol><li>RetryAndFollowUpInterceptorã€‚è´Ÿè´£å¤±è´¥é‡è¯•ä»¥åŠé‡å®šå‘</li><li>BridgeInterceptorã€‚è´Ÿè´£å¯¹ç”¨æˆ·æ„é€ çš„ Request è¿›è¡Œè½¬æ¢ï¼Œæ·»åŠ å¿…è¦çš„ header å’Œ cookieï¼Œåœ¨å¾—åˆ° response åå¦‚æœæœ‰éœ€è¦çš„ä¼šè¿›è¡Œ gzip è§£å‹</li><li>CacheInterceptorã€‚ç”¨äºå¤„ç†ç¼“å­˜</li><li>ConnectInterceptorã€‚è´Ÿè´£å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥</li><li>CallServerInterceptorã€‚è´Ÿè´£å‘æœåŠ¡å™¨å‘é€è¯·æ±‚å’Œä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®</li></ol><p>æœ€åï¼Œrequest å’Œ interceptors ä¼šç”¨æ¥ç”Ÿæˆä¸€ä¸ª RealInterceptorChain å¯¹è±¡ï¼Œç”±å…¶æ¥æœ€ç»ˆè¿”å› response</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
    <span class="token comment">// Build a full stack of interceptors.</span>
    <span class="token keyword">val</span> interceptors <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//æ·»åŠ å¼€å‘è€…è®¾ç½®çš„æ‹¦æˆªå™¨</span>
    interceptors <span class="token operator">+=</span> client<span class="token punctuation">.</span>interceptors
    
    <span class="token comment">//æ·»åŠ é»˜è®¤çš„æ‹¦æˆªå™¨</span>
    interceptors <span class="token operator">+=</span> <span class="token function">RetryAndFollowUpInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    interceptors <span class="token operator">+=</span> <span class="token function">BridgeInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>cookieJar<span class="token punctuation">)</span>
    interceptors <span class="token operator">+=</span> <span class="token function">CacheInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>cache<span class="token punctuation">)</span>
    interceptors <span class="token operator">+=</span> ConnectInterceptor
      
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//å¦‚æœä¸æ˜¯ WebSocket çš„è¯ï¼Œé‚£å°±å†æ·»åŠ å¼€å‘è€…è®¾ç½®çš„ NetworkInterceptors</span>
      interceptors <span class="token operator">+=</span> client<span class="token punctuation">.</span>networkInterceptors
    <span class="token punctuation">}</span>
      
    <span class="token comment">//CallServerInterceptor æ˜¯å®é™…ä¸Šå‘èµ·ç½‘ç»œè¯·æ±‚çš„åœ°æ–¹</span>
    interceptors <span class="token operator">+=</span> <span class="token function">CallServerInterceptor</span><span class="token punctuation">(</span>forWebSocket<span class="token punctuation">)</span>

    <span class="token keyword">val</span> chain <span class="token operator">=</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>
        call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
        interceptors <span class="token operator">=</span> interceptors<span class="token punctuation">,</span>
        index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        exchange <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        request <span class="token operator">=</span> originalRequest<span class="token punctuation">,</span>
        connectTimeoutMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>connectTimeoutMillis<span class="token punctuation">,</span>
        readTimeoutMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">,</span>
        writeTimeoutMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>writeTimeoutMillis
    <span class="token punctuation">)</span>

    <span class="token keyword">var</span> calledNoMoreExchanges <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> response <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>originalRequest<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Canceled&quot;</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> response
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      calledNoMoreExchanges <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">throw</span> <span class="token function">noMoreExchanges</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">as</span> Throwable
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>calledNoMoreExchanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">noMoreExchanges</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Interceptor æ˜¯ OkHttp é‡Œå¾ˆé‡è¦çš„ä¸€ç¯ï¼ŒOkHttp ä¹Ÿæ˜¯é æ­¤ä¸ºå¼€å‘è€…æä¾›äº†å¾ˆé«˜çš„è‡ªç”±åº¦</strong>ã€‚Interceptor æ¥å£æœ¬èº«åªåŒ…å«ä¸€ä¸ª <code>intercept</code> æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•å†…å¯æ‹¿åˆ°åŸå§‹çš„ Request å¯¹è±¡ä»¥åŠæœ€ç»ˆçš„ Response</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> <span class="token keyword">interface</span> Interceptor <span class="token punctuation">{</span>
   <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
   <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response   
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª LogInterceptor æ¥æ‰“å°ç½‘ç»œè¯·æ±‚çš„è¯·æ±‚å‚æ•°ä»¥åŠæœ€ç»ˆçš„è¿”å›å€¼</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> LogInterceptor <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token keyword">val</span> request <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token keyword">val</span> response <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Interceptor çš„å®ç°åˆè¡·æ˜¯ä¸ºäº†ç»™å¼€å‘è€…æä¾›ä¸€ä¸ªå¯ä»¥æ§åˆ¶ç½‘ç»œè¯·æ±‚çš„<strong>å‘èµ·è¿‡ç¨‹</strong>åŠ<strong>æ”¶å°¾å·¥ä½œ</strong>çš„å…¥å£ï¼Œä¾‹å¦‚**æ·»åŠ  headerã€æ—¥å¿—è®°å½•ã€è¯·æ±‚æ‹¦æˆªã€ResponseBodyä¿®æ”¹ **ç­‰ï¼Œæ¯ä¸ª Interceptor åªè´Ÿè´£è‡ªå·±å…³å¿ƒçš„æ“ä½œï¼Œé‚£ä¹ˆåŠ¿å¿…å°±ä¼šæœ‰æ·»åŠ å¤šä¸ª Interceptor çš„éœ€æ±‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œåªæœ‰è®©æ¯ä¸ª Interceptor éƒ½ä¾æ¬¡å¤„ç†å®Œ request ä¹‹åï¼ŒOkHttp æ‰èƒ½æ ¹æ®æœ€ç»ˆçš„ request å¯¹è±¡å»è”ç½‘è¯·æ±‚å¾—åˆ° responseï¼Œæ‰€ä»¥æ¯ä¸ª Interceptor éœ€è¦ä¾æ¬¡æ‹¿åˆ° request è¿›è¡Œè‡ªå®šä¹‰å¤„ç†ã€‚è¯·æ±‚åˆ° response åï¼ŒInterceptor å¯èƒ½è¿˜éœ€è¦å¯¹ response è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå°±è¿˜éœ€è¦å°† response å†ä¾æ¬¡ä¼ é€’ç»™æ¯ä¸ª Interceptorã€‚é‚£ä¹ˆï¼Œæ€ä¹ˆå®ç°å°†å¤šä¸ª Interceptor ç»™ä¸²è”èµ·æ¥å‘¢ï¼Ÿ</p><p><strong>è¿™é‡Œæ¥çœ‹ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„ Interceptor å®ç°æ€è·¯</strong></p><p>å‡è®¾æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ Interceptor å®ç°ç±»æœ‰ä¸¤ä¸ªï¼šLogInterceptor å’Œ HeaderInterceptorï¼Œè¿™é‡Œåªæ˜¯ç®€å•åœ°å°†è·å–åˆ° request å’Œ response çš„æ—¶æœºç»™æ‰“å°å‡ºæ¥ï¼Œé‡ç‚¹æ˜¯è¦çœ‹æ¯ä¸ª Interceptor çš„å…ˆåè°ƒç”¨é¡ºåºã€‚ä¸ºäº†å°†ä¸¤ä¸ª Interceptor ç»™ä¸²è”èµ·æ¥ï¼ŒRealInterceptorChain ä¼šå¾ªç¯è·å– index æŒ‡å‘çš„ä¸‹ä¸€ä¸ª Interceptor å¯¹è±¡ï¼Œæ¯æ¬¡æ„å»ºä¸€ä¸ªæ–°çš„ RealInterceptorChain å¯¹è±¡ä½œä¸ºå‚æ•°æ¥è°ƒç”¨ <code>intercept</code> æ–¹æ³•ï¼Œè¿™æ ·å¤–éƒ¨åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ <code>realInterceptorChain.proceed</code> å°±å¯ä»¥æ‹¿åˆ°æœ€ç»ˆçš„ response å¯¹è±¡</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> Request

<span class="token keyword">class</span> Response

<span class="token keyword">interface</span> Chain <span class="token punctuation">{</span>

    <span class="token keyword">fun</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Request

    <span class="token keyword">fun</span> <span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Response

<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> request<span class="token operator">:</span> Request<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> interceptors<span class="token operator">:</span> List<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> index<span class="token operator">:</span> Int
<span class="token punctuation">)</span> <span class="token operator">:</span> Chain <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">copy</span><span class="token punctuation">(</span>index<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> RealInterceptorChain <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> interceptors<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Request <span class="token punctuation">{</span>
        <span class="token keyword">return</span> request
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token keyword">val</span> next <span class="token operator">=</span> <span class="token function">copy</span><span class="token punctuation">(</span>index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> interceptor <span class="token operator">=</span> interceptors<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">val</span> response <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> LogInterceptor <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token keyword">val</span> request <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;LogInterceptor -- getRequest&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> response <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;LogInterceptor ---- getResponse&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> HeaderInterceptor <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token keyword">val</span> request <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;HeaderInterceptor -- getRequest&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> response <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;HeaderInterceptor ---- getResponse&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> interceptorList <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    interceptorList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">LogInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    interceptorList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">HeaderInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> request <span class="token operator">=</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> realInterceptorChain <span class="token operator">=</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> interceptorList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> response <span class="token operator">=</span> realInterceptorChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;main response&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç çœ‹ç€æ€è·¯è¿˜å¯ä»¥ï¼Œå¯æ˜¯å½“è¿è¡Œåå°±ä¼šå‘ç°æŠ›å‡ºäº† IndexOutOfBoundsExceptionï¼Œå› ä¸ºä»£ç é‡Œå¹¶æ²¡æœ‰å¯¹ index è¿›è¡Œè¶Šç•Œåˆ¤æ–­ã€‚è€Œä¸”ï¼Œä¸Šé¢çš„ä»£ç ä¹Ÿç¼ºå°‘äº†ä¸€ä¸ªçœŸæ­£çš„ç”Ÿæˆ Response å¯¹è±¡çš„åœ°æ–¹ï¼Œæ¯ä¸ª Interceptor åªæ˜¯åœ¨è¿›è¡Œä¸­è½¬è°ƒç”¨è€Œå·²ï¼Œå› æ­¤è¿˜éœ€è¦ä¸€ä¸ªæ¥çœŸæ­£åœ°å®Œæˆç½‘ç»œè¯·æ±‚å¹¶è¿”å› Response å¯¹è±¡çš„åœ°æ–¹ï¼Œå³ CallServerInterceptor</p><p>æ‰€ä»¥ï¼ŒCallServerInterceptor çš„<code>intercept</code> æ–¹æ³•å°±ç”¨æ¥çœŸæ­£åœ°æ‰§è¡Œç½‘ç»œè¯·æ±‚å¹¶ç”Ÿæˆ Response å¯¹è±¡ï¼Œåœ¨è¿™é‡Œå°±ä¸èƒ½å†è°ƒç”¨ <code>proceed</code> æ–¹æ³•äº†ï¼Œä¸” CallServerInterceptor éœ€è¦æ”¾åœ¨ interceptorList çš„æœ€åä¸€ä½</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> CallServerInterceptor <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token keyword">val</span> request <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;CallServerInterceptor -- getRequest&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> response <span class="token operator">=</span> <span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;CallServerInterceptor ---- getResponse&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> interceptorList <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    interceptorList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">LogInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    interceptorList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">HeaderInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    interceptorList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">CallServerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> request <span class="token operator">=</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> realInterceptorChain <span class="token operator">=</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> interceptorList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> response <span class="token operator">=</span> realInterceptorChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;main response&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€ç»ˆçš„è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>intercept</code> æ–¹æ³•æ˜¯æ ¹æ®æ·»åŠ é¡ºåºæ¥è°ƒç”¨ï¼Œè€Œ response æ˜¯æŒ‰ç…§åæ–¹å‘æ¥ä¼ é€’</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>LogInterceptor <span class="token operator">--</span> getRequest
HeaderInterceptor <span class="token operator">--</span> getRequest
CallServerInterceptor <span class="token operator">--</span> getRequest
CallServerInterceptor <span class="token operator">--</span><span class="token operator">--</span> getResponse
HeaderInterceptor <span class="token operator">--</span><span class="token operator">--</span> getResponse
LogInterceptor <span class="token operator">--</span><span class="token operator">--</span> getResponse
main response
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç æˆ‘ç®€åŒ–äº† OkHttp åœ¨å®ç° RealInterceptorChain æ—¶çš„æ€è·¯ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡å°†å¤šä¸ªæ‹¦æˆªå™¨ä»¥è´£ä»»é“¾çš„æ–¹å¼æ¥ä¸€å±‚å±‚è°ƒç”¨ï¼Œä¸Šä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†å®Œåå°†å°±å°†ç»“æœä¼ ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼ˆå³ CallServerInterceptor ï¼‰å¤„ç†å®Œåå°† Response å†ä¸€å±‚å±‚å¾€ä¸Šä¼ é€’</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>
  <span class="token keyword">internal</span> <span class="token keyword">val</span> call<span class="token operator">:</span> RealCall<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> interceptors<span class="token operator">:</span> List<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> index<span class="token operator">:</span> Int<span class="token punctuation">,</span>
  <span class="token keyword">internal</span> <span class="token keyword">val</span> exchange<span class="token operator">:</span> Exchange<span class="token operator">?</span><span class="token punctuation">,</span>
  <span class="token keyword">internal</span> <span class="token keyword">val</span> request<span class="token operator">:</span> Request<span class="token punctuation">,</span>
  <span class="token keyword">internal</span> <span class="token keyword">val</span> connectTimeoutMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
  <span class="token keyword">internal</span> <span class="token keyword">val</span> readTimeoutMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
  <span class="token keyword">internal</span> <span class="token keyword">val</span> writeTimeoutMillis<span class="token operator">:</span> Int
<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor<span class="token punctuation">.</span><span class="token function">Chain</span> <span class="token punctuation">{</span>
    
  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">copy</span><span class="token punctuation">(</span>
    index<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span>
    exchange<span class="token operator">:</span> Exchange<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exchange<span class="token punctuation">,</span>
    request<span class="token operator">:</span> Request <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">,</span>
    connectTimeoutMillis<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectTimeoutMillis<span class="token punctuation">,</span>
    readTimeoutMillis<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">,</span>
    writeTimeoutMillis<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>writeTimeoutMillis
  <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> interceptors<span class="token punctuation">,</span> index<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> request<span class="token punctuation">,</span> connectTimeoutMillis<span class="token punctuation">,</span>
      readTimeoutMillis<span class="token punctuation">,</span> writeTimeoutMillis<span class="token punctuation">)</span>
    
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
    Â·Â·Â·
    <span class="token keyword">val</span> next <span class="token operator">=</span> <span class="token function">copy</span><span class="token punctuation">(</span>index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> request <span class="token operator">=</span> request<span class="token punctuation">)</span>
    <span class="token keyword">val</span> interceptor <span class="token operator">=</span> interceptors<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;USELESS_ELVIS&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> response <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">NullPointerException</span><span class="token punctuation">(</span>
        <span class="token string-literal singleline"><span class="token string">&quot;interceptor </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">interceptor</span></span><span class="token string"> returned null&quot;</span></span><span class="token punctuation">)</span>
    Â·Â·Â·
    <span class="token keyword">return</span> response
  <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å…­ã€interceptor" tabindex="-1"><a class="header-anchor" href="#å…­ã€interceptor" aria-hidden="true">#</a> å…­ã€Interceptor</h1><p>æˆ‘ä»¬åœ¨æ„å»º OkHttpClient çš„æ—¶å€™ï¼Œæ·»åŠ æ‹¦æˆªå™¨çš„æ–¹æ³•åˆ†ä¸ºä¸¤ç±»ï¼š<code>addInterceptor</code>å’Œ<code>addNetworkInterceptor</code></p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">val</span> okHttClient <span class="token operator">=</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addInterceptor</span> <span class="token punctuation">{</span> chain <span class="token operator">-&gt;</span>
        chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">addNetworkInterceptor</span> <span class="token punctuation">{</span> chain <span class="token operator">-&gt;</span>
        chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Interceptor å’Œ NetworkInterceptor åˆ†åˆ«è¢«ç§°ä¸º<strong>åº”ç”¨æ‹¦æˆªå™¨</strong>å’Œ<strong>ç½‘ç»œæ‹¦æˆªå™¨</strong>ï¼Œé‚£ä¹ˆå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p>å‰é¢æœ‰è®²åˆ°ï¼ŒOkHttp åœ¨æ‰§è¡Œæ‹¦æˆªå™¨çš„æ—¶å€™ï¼Œæ˜¯æŒ‰ç…§å¦‚ä¸‹é¡ºåºçš„ï¼Œè¿™ä¸ªé¡ºåºå°±å·²ç»å†³å®šäº†ä¸åŒæ‹¦æˆªå™¨çš„è°ƒç”¨æ—¶æœºå·®å¼‚</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">val</span> interceptors <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
interceptors <span class="token operator">+=</span> client<span class="token punctuation">.</span>interceptors
interceptors <span class="token operator">+=</span> <span class="token function">RetryAndFollowUpInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
interceptors <span class="token operator">+=</span> <span class="token function">BridgeInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>cookieJar<span class="token punctuation">)</span>
interceptors <span class="token operator">+=</span> <span class="token function">CacheInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>cache<span class="token punctuation">)</span>
interceptors <span class="token operator">+=</span> ConnectInterceptor
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	interceptors <span class="token operator">+=</span> client<span class="token punctuation">.</span>networkInterceptors
<span class="token punctuation">}</span>
interceptors <span class="token operator">+=</span> <span class="token function">CallServerInterceptor</span><span class="token punctuation">(</span>forWebSocket<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ç”±äºåº”ç”¨æ‹¦æˆªå™¨å¤„äºåˆ—è¡¨å¤´éƒ¨ï¼Œæ‰€ä»¥åœ¨æ•´ä¸ªè´£ä»»é“¾è·¯ä¸­åº”ç”¨æ‹¦æˆªå™¨ä¼šé¦–å…ˆè¢«æ‰§è¡Œï¼Œå³ä½¿ä¹‹ååœ¨ RetryAndFollowUpInterceptor ä¸­å‘ç”Ÿäº†<strong>è¯·æ±‚å¤±è´¥é‡è¯•æˆ–è€…ç½‘ç»œé‡å®šå‘</strong>ç­‰æƒ…å†µï¼Œåº”ç”¨æ‹¦æˆªå™¨ä¹Ÿåªä¼šè¢«è§¦å‘ä¸€æ¬¡ï¼Œä½†ç½‘ç»œæ‹¦æˆªå™¨ä¼šè¢«è°ƒç”¨å¤šæ¬¡</li><li>ç½‘ç»œæ‹¦æˆªå™¨ä½äº CacheInterceptor ä¹‹åï¼Œé‚£ä¹ˆå½“ CacheInterceptor å‘½ä¸­ç¼“å­˜çš„æ—¶å€™å°±ä¸ä¼šå»æ‰§è¡Œç½‘ç»œè¯·æ±‚äº†ï¼Œæ­¤æ—¶ç½‘ç»œæ‹¦æˆªå™¨å°±ä¸ä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤ç½‘ç»œæ‹¦æˆªå™¨æ˜¯å­˜åœ¨çŸ­è·¯çš„å¯èƒ½ã€‚æ­¤å¤–ï¼Œç½‘ç»œæ‹¦æˆªå™¨ä½äº ConnectInterceptor ä¹‹åï¼Œåœ¨è°ƒç”¨ç½‘ç»œæ‹¦æˆªå™¨ä¹‹å‰å°±å·²ç»å‡†å¤‡å¥½ç½‘ç»œé“¾æ¥äº†ï¼Œè¯´æ˜ç½‘ç»œæ‹¦æˆªå™¨æœ¬èº«å°±å…³è”ç€å®é™…çš„ç½‘ç»œè¯·æ±‚é€»è¾‘</li><li>ä»å•æ¬¡è¯·æ±‚æµç¨‹ä¸Šæ¥çœ‹ï¼Œåº”ç”¨æ‹¦æˆªå™¨è¢«è°ƒç”¨å¹¶ä¸æ„å‘³ç€çœŸæ­£æœ‰å‘èµ·äº†ç½‘ç»œè¯·æ±‚ï¼Œè€Œç½‘ç»œæ‹¦æˆªå™¨è¢«è°ƒç”¨å°±è¯´æ˜çš„ç¡®å‘èµ·äº†ä¸€æ¬¡ç½‘ç»œè¯·æ±‚ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬å¸Œæœ›é€šè¿‡æ‹¦æˆªå™¨æ¥è®°å½•ç½‘ç»œè¯·æ±‚è¯¦æƒ…çš„è¯ï¼Œå°±éœ€è¦è€ƒè™‘ä¸¤è€…çš„è°ƒç”¨æ—¶æœºå·®å¼‚ï¼šåº”ç”¨æ‹¦æˆªå™¨æ— æ³•æ„ŸçŸ¥åˆ° OkHttp è‡ªåŠ¨æ·»åŠ çš„ä¸€äº› headerï¼Œä½†æ˜¯ç½‘ç»œæ‹¦æˆªå™¨å¯ä»¥ï¼›åº”ç”¨æ‹¦æˆªå™¨é™¤éä¸»åŠ¨ä¸­æ–­è¯·æ±‚ï¼Œå¦åˆ™æ¯æ¬¡è¯·æ±‚ä¸€å®šéƒ½ä¼šè¢«æ‰§è¡Œï¼Œä½†ç½‘ç»œæ‹¦æˆªå™¨å¯èƒ½å­˜åœ¨è¢«çŸ­è·¯çš„å¯èƒ½</li></ul><p>å€Ÿç”¨å®˜æ–¹çš„ä¸€å¼ å›¾ç‰‡æ¥è¡¨ç¤º</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46eebdde38824c5491cdb54450dadc7e~tplv-k3u1fbpfcp-zoom-1.image" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,88),b={href:"https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/Progress.java",target:"_blank",rel:"noopener noreferrer"},y=t(`<p>å®ç°æ€è·¯å°±æ˜¯å¯¹åŸå§‹çš„ ResponseBody è¿›è¡Œå¤šä¸€å±‚ä»£ç†ï¼Œè®¡ç®—å·²ç»ä»ç½‘ç»œä¸­è¯»å–åˆ°çš„å­—èŠ‚æ•°å’Œèµ„æºçš„ contentLength ä¹‹é—´çš„ç™¾åˆ†æ¯”ï¼Œä»è€Œå¾—åˆ°ä¸‹è½½è¿›åº¦ã€‚æ­¤å¤–ï¼Œå› ä¸ºè¯¥æ‹¦æˆªå™¨æ˜¯å’Œç¡®åˆ‡çš„ç½‘ç»œè¯·æ±‚ç›¸å…³ï¼Œæ‰€ä»¥åº”è¯¥è¦è®¾ä¸ºç½‘ç»œæ‹¦æˆªå™¨æ‰æ¯”è¾ƒåˆç†</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> ProgressListener <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>bytesRead<span class="token operator">:</span> Long<span class="token punctuation">,</span> contentLength<span class="token operator">:</span> Long<span class="token punctuation">,</span> done<span class="token operator">:</span> Boolean<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> request <span class="token operator">=</span> Request<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;https://images.pexels.com/photos/5177790/pexels-photo-5177790.jpeg&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> progressListener<span class="token operator">:</span> ProgressListener <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ProgressListener <span class="token punctuation">{</span>
        <span class="token keyword">var</span> firstUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>bytesRead<span class="token operator">:</span> Long<span class="token punctuation">,</span> contentLength<span class="token operator">:</span> Long<span class="token punctuation">,</span> done<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;completed&quot;</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    firstUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;content-length: unknown&quot;</span></span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;content-length: %d\\n&quot;</span></span><span class="token punctuation">,</span> contentLength<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">println</span><span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;%d%% done\\n&quot;</span></span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> bytesRead <span class="token operator">/</span> contentLength<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> client <span class="token operator">=</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addNetworkInterceptor</span> <span class="token punctuation">{</span> chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain <span class="token operator">-&gt;</span>
            <span class="token keyword">val</span> originalResponse <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            originalResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token function">ProgressResponseBody</span><span class="token punctuation">(</span>originalResponse<span class="token punctuation">.</span>body<span class="token operator">!!</span><span class="token punctuation">,</span> progressListener<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span> response <span class="token operator">-&gt;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Unexpected code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">response</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> desktopDir <span class="token operator">=</span> FileSystemView<span class="token punctuation">.</span><span class="token function">getFileSystemView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>homeDirectory
        <span class="token keyword">val</span> imageFile <span class="token operator">=</span> <span class="token function">File</span><span class="token punctuation">(</span>desktopDir<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.jpeg&quot;</span></span><span class="token punctuation">)</span>
        imageFile<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//è¯»å– InputStream å†™å…¥åˆ°å›¾ç‰‡æ–‡ä»¶ä¸­</span>
        response<span class="token punctuation">.</span>body<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">byteStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>imageFile<span class="token punctuation">.</span><span class="token function">outputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> ProgressResponseBody <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> responseBody<span class="token operator">:</span> ResponseBody<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> progressListener<span class="token operator">:</span> ProgressListener
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> bufferedSource<span class="token operator">:</span> BufferedSource<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> MediaType<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> responseBody<span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
        <span class="token keyword">return</span> responseBody<span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> BufferedSource <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferedSource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bufferedSource <span class="token operator">=</span> <span class="token function">source</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> bufferedSource<span class="token operator">!!</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">source</span><span class="token punctuation">(</span>source<span class="token operator">:</span> Source<span class="token punctuation">)</span><span class="token operator">:</span> Source <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">ForwardingSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">var</span> totalBytesRead <span class="token operator">=</span> <span class="token number">0L</span>

            <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">read</span><span class="token punctuation">(</span>sink<span class="token operator">:</span> Buffer<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
                <span class="token keyword">val</span> bytesRead <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
                <span class="token comment">// read() returns the number of bytes read, or -1 if this source is exhausted.</span>
                totalBytesRead <span class="token operator">+=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> bytesRead <span class="token keyword">else</span> <span class="token number">0</span>
                progressListener<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>totalBytesRead<span class="token punctuation">,</span> responseBody<span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytesRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> bytesRead
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿›åº¦è¾“å‡ºå°±ç±»ä¼¼äºï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>content<span class="token operator">-</span>length<span class="token operator">:</span> <span class="token number">11448857</span>
<span class="token number">467</span>
<span class="token number">0</span><span class="token operator">%</span> done
<span class="token number">1836</span>
<span class="token number">0</span><span class="token operator">%</span> done
<span class="token number">3205</span>

Â·Â·Â·

<span class="token number">99</span><span class="token operator">%</span> done
<span class="token number">11442570</span>
<span class="token number">99</span><span class="token operator">%</span> done
<span class="token number">11448857</span>
<span class="token number">100</span><span class="token operator">%</span> done
completed
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="ä¸ƒã€ç»“å°¾" tabindex="-1"><a class="header-anchor" href="#ä¸ƒã€ç»“å°¾" aria-hidden="true">#</a> ä¸ƒã€ç»“å°¾</h1><p>å…³äº OkHttp çš„æºç è®²è§£åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä½†æœ¬æ–‡è¿˜ç¼ºå°‘äº†å¯¹ ConnectInterceptor å’Œ CallServerInterceptor çš„è®²è§£ï¼Œè¿™ä¸¤è€…æ˜¯ OkHttp å®Œæˆå®é™…ç½‘ç»œè¯·æ±‚çš„åœ°æ–¹ï¼Œæ¶‰åŠåˆ°äº† Connection å’Œ Socket è¿™äº›æ¯”è¾ƒåº•å±‚çš„é¢†åŸŸï¼Œæˆ‘æ²¡æ³•è®²å¾—å¤šæ¸…æ™°ï¼Œå°±ç›´æ¥ç•¥è¿‡è¿™å—å†…å®¹äº†~~</p>`,6),f={href:"https://juejin.im/post/6886121327845965838",target:"_blank",rel:"noopener noreferrer"},w=n("p",null,"ä¸‹ç¯‡æ–‡ç« å°±æ¥å†™å…³äº OkHttp æ‹¦æˆªå™¨çš„å®æˆ˜å†…å®¹å§",-1);function g(h,C){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,n("blockquote",null,[n("p",null,[s("å…¬ä¼—å·ï¼š"),n("a",r,[s("å­—èŠ‚æ•°ç»„"),e(a)])]),k]),d,n("p",null,[s("æœ¬æ–‡åŸºäº OkHttp çš„ä»¥ä¸‹ç‰ˆæœ¬è¿›è¡Œè®²è§£ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒOkHttp å’Œ OkIO ç›®å‰å·²ç»è¢«å®˜æ–¹ç”¨ Kotlin è¯­è¨€é‡å†™äº†ä¸€éï¼Œæ‰€ä»¥è¿˜æ²¡å­¦ Kotlin çš„åŒå­¦å¯èƒ½è¿æºç éƒ½æ¯”è¾ƒéš¾çœ‹æ‡‚äº†ï¼ŒKotlin å…¥é—¨å¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š"),n("a",v,[s("ä¸¤ä¸‡å…­åƒå­—å¸¦ä½  Kotlin å…¥é—¨"),e(a)])]),m,n("p",null,[s("è¿™é‡Œå¯ä»¥æ ¹æ® "),n("a",b,[s("square"),e(a)]),s(" å®˜æ–¹æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼Œæ¥å®ç°åœ¨ä¸‹è½½ä¸€å¼  10 MB å›¾ç‰‡çš„æ—¶å€™é€šè¿‡æ‹¦æˆªå™¨å¯¹ä¸‹è½½è¿›åº¦è¿›è¡Œç›‘å¬ï¼Œå¹¶åŒæ—¶æŠŠå›¾ç‰‡ä¸‹è½½åˆ°ç³»ç»Ÿçš„æ¡Œé¢")]),y,n("p",null,[s("OkHttp çš„è¿è¡Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†åœ¨ä½¿ç”¨ä¸Šè¿˜æ˜¯æ¯”è¾ƒåŸå§‹ï¼Œä¸€èˆ¬æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åœ¨ OkHttp ä¹‹ä¸Šè¿›è¡Œä¸€å±‚å°è£…ï¼ŒRetrofit å°±æ˜¯ä¸€ä¸ªå¯¹ OkHttp çš„ä¼˜ç§€å°è£…åº“ï¼Œå¯¹ Retrofit çš„æºç è®²è§£å¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š"),n("a",f,[s("ä¸‰æ–¹åº“æºç ç¬”è®°ï¼ˆ7ï¼‰-Retrofit æºç è¯¦è§£"),e(a)])]),w])}const R=p(i,[["render",g],["__file","ä¸»æµå¼€æºåº“æºç åˆ†æï¼ˆ11ï¼‰OkHttp æºç è¯¦è§£.html.vue"]]);export{R as default};
