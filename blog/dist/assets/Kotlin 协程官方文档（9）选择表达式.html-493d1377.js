import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o,c,a as n,d as s,e as t,f as l}from"./app-6847d3e4.js";const i={},u={href:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image",target:"_blank",rel:"noopener noreferrer"},r=n("p",null,"å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£",-1),k=n("p",null,[s("æœ€è¿‘ä¸€ç›´åœ¨äº†è§£å…³äº "),n("strong",null,"Kotlinåç¨‹"),s(" çš„çŸ¥è¯†ï¼Œé‚£æœ€å¥½çš„å­¦ä¹ èµ„æ–™è‡ªç„¶æ˜¯å®˜æ–¹æä¾›çš„å­¦ä¹ æ–‡æ¡£äº†ï¼Œçœ‹äº†çœ‹åæˆ‘å°±èŒç”Ÿäº†ç¿»è¯‘å®˜æ–¹æ–‡æ¡£çš„æƒ³æ³•ã€‚å‰åèŠ±äº†è¦æ¥è¿‘ä¸€ä¸ªæœˆæ—¶é—´ï¼Œä¸€å…±ä¹ç¯‡æ–‡ç« ï¼Œåœ¨è¿™é‡Œä¹Ÿåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ä¸ªäººçŸ¥è¯†æ‰€é™ï¼Œæœ‰äº›ç¿»è¯‘å¾—ä¸æ˜¯å¤ªé¡ºç•…ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½æå‡ºæ„è§")],-1),d={href:"https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md",target:"_blank",rel:"noopener noreferrer"},v=l(`<p>select è¡¨è¾¾å¼å¯ä»¥åŒæ—¶ç­‰å¾…å¤šä¸ªæŒ‚èµ·å‡½æ•°ï¼Œå¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„å‡½æ•°æ¥æ‰§è¡Œ</p><blockquote><p>é€‰æ‹©è¡¨è¾¾å¼æ˜¯ <code>kotlinx.coroutines</code> çš„ä¸€ä¸ªå®éªŒæ€§çš„ç‰¹æ€§ï¼Œè¿™äº› API é¢„è®¡å°†åœ¨ <code>kotlinx.coroutines</code> åº“çš„å³å°†åˆ°æ¥çš„æ›´æ–°ä¸­è¡åŒ–ï¼Œå¹¶å¯èƒ½ä¼šæœ‰çªç ´æ€§çš„å˜åŒ–</p></blockquote><h1 id="ä¸€ã€selecting-from-channels" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€selecting-from-channels" aria-hidden="true">#</a> ä¸€ã€Selecting from channels</h1><p>æˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ä¸ªå­—ç¬¦ä¸²ç”Ÿäº§è€…ï¼š<code>fizz</code> å’Œ <code>buzz</code> ã€‚å…¶ä¸­ <code>fizz</code> æ¯ 300 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²â€œFizzâ€ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">fizz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// sends &quot;Fizz&quot; every 300 ms</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
        <span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Fizz&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€ <code>buzz</code> æ¯ 500 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²â€œBuzz!â€ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">buzz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// sends &quot;Buzz!&quot; every 500 ms</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Buzz!&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨æŒ‚èµ·å‡½æ•° receiveï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªé€šé“æ¥æ”¶å…¶ä¸­ä¸€ä¸ªçš„æ•°æ®ã€‚ä½†æ˜¯ select è¡¨è¾¾å¼å…è®¸æˆ‘ä»¬ä½¿ç”¨å…¶ onReceive å­å¥åŒæ—¶ä»ä¸¤è€…æ¥æ”¶ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">selectFizzBuzz</span><span class="token punctuation">(</span>fizz<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> buzz<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    select<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;Unit&gt; means that this select expression does not produce any result </span>
        fizz<span class="token punctuation">.</span><span class="token function">onReceive</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span>  <span class="token comment">// this is the first select clause</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;fizz -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        buzz<span class="token punctuation">.</span><span class="token function">onReceive</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span>  <span class="token comment">// this is the second select clause</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;buzz -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®©æˆ‘ä»¬è¿è¡Œä»£ç  7 æ¬¡ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>channels<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>selects<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">fizz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// sends &quot;Fizz&quot; every 300 ms</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
        <span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Fizz&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">buzz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// sends &quot;Buzz!&quot; every 500 ms</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Buzz!&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">selectFizzBuzz</span><span class="token punctuation">(</span>fizz<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> buzz<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    select<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;Unit&gt; means that this select expression does not produce any result </span>
        fizz<span class="token punctuation">.</span><span class="token function">onReceive</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span>  <span class="token comment">// this is the first select clause</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;fizz -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        buzz<span class="token punctuation">.</span><span class="token function">onReceive</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span>  <span class="token comment">// this is the second select clause</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;buzz -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//sampleStart</span>
    <span class="token keyword">val</span> fizz <span class="token operator">=</span> <span class="token function">fizz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> buzz <span class="token operator">=</span> <span class="token function">buzz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">selectFizzBuzz</span><span class="token punctuation">(</span>fizz<span class="token punctuation">,</span> buzz<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    coroutineContext<span class="token punctuation">.</span><span class="token function">cancelChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// cancel fizz &amp; buzz coroutines</span>
<span class="token comment">//sampleEnd        </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡Œç»“æœï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>fizz <span class="token operator">-&gt;</span> &#39;Fizz&#39;
buzz <span class="token operator">-&gt;</span> &#39;Buzz<span class="token operator">!</span>&#39;
fizz <span class="token operator">-&gt;</span> &#39;Fizz&#39;
fizz <span class="token operator">-&gt;</span> &#39;Fizz&#39;
buzz <span class="token operator">-&gt;</span> &#39;Buzz<span class="token operator">!</span>&#39;
fizz <span class="token operator">-&gt;</span> &#39;Fizz&#39;
buzz <span class="token operator">-&gt;</span> &#39;Buzz<span class="token operator">!</span>&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="äºŒã€selecting-on-close" tabindex="-1"><a class="header-anchor" href="#äºŒã€selecting-on-close" aria-hidden="true">#</a> äºŒã€Selecting on close</h1><p>å½“é€šé“å…³é—­æ—¶ï¼Œselect ä¸­çš„ onReceive å­å¥ä¼šå¤±è´¥å¹¶å¯¼è‡´ç›¸åº”çš„ select å¼•å‘å¼‚å¸¸ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ onReceiveOrNull å­å¥åœ¨é€šé“å…³é—­æ—¶æ‰§è¡Œç‰¹å®šæ“ä½œã€‚ä¸‹é¢çš„ç¤ºä¾‹è¿˜æ˜¾ç¤ºäº† select æ˜¯ä¸€ä¸ªè¿”å›å…¶æŸ¥è¯¢æ–¹æ³•ç»“æœçš„è¡¨è¾¾å¼ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">selectAorB</span><span class="token punctuation">(</span>a<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> b<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span>
    select<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        a<span class="token punctuation">.</span><span class="token function">onReceiveOrNull</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                <span class="token string-literal singleline"><span class="token string">&quot;Channel &#39;a&#39; is closed&quot;</span></span> 
            <span class="token keyword">else</span> 
                <span class="token string-literal singleline"><span class="token string">&quot;a -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span>
        <span class="token punctuation">}</span>
        b<span class="token punctuation">.</span><span class="token function">onReceiveOrNull</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                <span class="token string-literal singleline"><span class="token string">&quot;Channel &#39;b&#39; is closed&quot;</span></span>
            <span class="token keyword">else</span>    
                <span class="token string-literal singleline"><span class="token string">&quot;b -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼ŒonReceiveOrNull æ˜¯ä¸€ä¸ªæ‰©å±•å‡½æ•°ï¼Œä»…å¯ç”¨äºå…·æœ‰ä¸å¯ä¸ºç©ºå…ƒç´ çš„é€šé“ï¼Œè¿™æ ·å°±ä¸ä¼šæ„å¤–æ··æ·†<strong>é€šé“æ˜¯å·²å…³é—­</strong>è¿˜æ˜¯<strong>è¿”å›äº†ç©ºå€¼</strong>è¿™ä¸¤ç§æƒ…å†µ</p><p>è®©æˆ‘ä»¬å°†å…¶ä¸ç”Ÿæˆå››æ¬¡â€œHelloâ€å­—ç¬¦ä¸²çš„é€šé“ <code>a</code> å’Œç”Ÿæˆå››æ¬¡â€œWorldâ€å­—ç¬¦ä¸²çš„é€šé“ <code>b</code> ä¸€èµ·ä½¿ç”¨ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>channels<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>selects<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">selectAorB</span><span class="token punctuation">(</span>a<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> b<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span>
    select<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        a<span class="token punctuation">.</span><span class="token function">onReceiveOrNull</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                <span class="token string-literal singleline"><span class="token string">&quot;Channel &#39;a&#39; is closed&quot;</span></span> 
            <span class="token keyword">else</span> 
                <span class="token string-literal singleline"><span class="token string">&quot;a -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span>
        <span class="token punctuation">}</span>
        b<span class="token punctuation">.</span><span class="token function">onReceiveOrNull</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                <span class="token string-literal singleline"><span class="token string">&quot;Channel &#39;b&#39; is closed&quot;</span></span>
            <span class="token keyword">else</span>    
                <span class="token string-literal singleline"><span class="token string">&quot;b -&gt; &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">&#39;&quot;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//sampleStart</span>
    <span class="token keyword">val</span> a <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">it</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> b <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;World </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">it</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// print first eight results</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">selectAorB</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    coroutineContext<span class="token punctuation">.</span><span class="token function">cancelChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token comment">//sampleEnd      </span>
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç çš„ç»“æœéå¸¸æœ‰è¶£ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨ç»†èŠ‚ä¸­åˆ†æå®ƒï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>a <span class="token operator">-&gt;</span> &#39;Hello <span class="token number">0</span>&#39;
a <span class="token operator">-&gt;</span> &#39;Hello <span class="token number">1</span>&#39;
b <span class="token operator">-&gt;</span> &#39;World <span class="token number">0</span>&#39;
a <span class="token operator">-&gt;</span> &#39;Hello <span class="token number">2</span>&#39;
a <span class="token operator">-&gt;</span> &#39;Hello <span class="token number">3</span>&#39;
b <span class="token operator">-&gt;</span> &#39;World <span class="token number">1</span>&#39;
Channel <span class="token char">&#39;a&#39;</span> <span class="token keyword">is</span> closed
Channel <span class="token char">&#39;a&#39;</span> <span class="token keyword">is</span> closed
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸­å¯ä»¥è§‚å¯Ÿåˆ°å‡ ç‚¹</p><p>é¦–å…ˆï¼Œselect åå‘äºç¬¬ä¸€ä¸ªå­å¥ã€‚å½“åŒæ—¶å¯ä»¥é€‰æ‹©å¤šä¸ªå­å¥æ—¶ï¼Œå°†é€‰æ‹©å…¶ä¸­çš„ç¬¬ä¸€ä¸ªå­å¥ã€‚åœ¨è¿™é‡Œï¼Œä¸¤ä¸ªé€šé“éƒ½åœ¨ä¸æ–­åœ°äº§ç”Ÿå­—ç¬¦ä¸²ï¼Œå› æ­¤ä½œä¸º select ä¸­çš„ç¬¬ä¸€ä¸ªå­å¥çš„é€šé“è·èƒœã€‚ä½†æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ— ç¼“å†²é€šé“ï¼Œæ‰€ä»¥ a åœ¨å…¶å‘é€è°ƒç”¨æ—¶ä¼šä¸æ—¶åœ°è¢«æŒ‚èµ·ï¼Œä»è€Œç»™äº† b å‘é€çš„æœºä¼š</p><p>ç¬¬äºŒä¸ªè§‚å¯Ÿç»“æœæ˜¯ï¼Œå½“é€šé“å·²ç»å…³é—­æ—¶ï¼ŒonReceiveOrNull å°†ç«‹å³è¢«é€‰ä¸­</p><h1 id="ä¸‰ã€selecting-to-send" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€selecting-to-send" aria-hidden="true">#</a> ä¸‰ã€Selecting to send</h1><p>select è¡¨è¾¾å¼æœ‰ onSend å­å¥ï¼Œå¯ä»¥ä¸ selection çš„åå‘æ€§è´¨ç»“åˆä½¿ç”¨ã€‚ è®©æˆ‘ä»¬å†™ä¸€ä¸ªæ•´æ•°ç”Ÿäº§è€…çš„ä¾‹å­ï¼Œå½“ä¸»é€šé“ä¸Šçš„æ¶ˆè´¹è€…è·Ÿä¸ä¸Šæ—¶ï¼Œå®ƒä¼šå°†å…¶å€¼å‘é€åˆ° <code>side</code> é€šé“ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">produceNumbers</span><span class="token punctuation">(</span>side<span class="token operator">:</span> SendChannel<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>num <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// produce 10 numbers from 1 to 10</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// every 100 ms</span>
        select<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">onSend</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// Send to the primary channel</span>
            side<span class="token punctuation">.</span><span class="token function">onSend</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// or to the side channel     </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¶ˆè´¹è€…å°†ä¼šéå¸¸ç¼“æ…¢ï¼Œæ¯ä¸ªæ•°å€¼å¤„ç†éœ€è¦ 250 æ¯«ç§’ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>channels<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>selects<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">produceNumbers</span><span class="token punctuation">(</span>side<span class="token operator">:</span> SendChannel<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>num <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// produce 10 numbers from 1 to 10</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// every 100 ms</span>
        select<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">onSend</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// Send to the primary channel</span>
            side<span class="token punctuation">.</span><span class="token function">onSend</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// or to the side channel     </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//sampleStart</span>
    <span class="token keyword">val</span> side <span class="token operator">=</span> Channel<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// allocate side channel</span>
    launch <span class="token punctuation">{</span> <span class="token comment">// this is a very fast consumer for the side channel</span>
        side<span class="token punctuation">.</span><span class="token function">consumeEach</span> <span class="token punctuation">{</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Side channel has </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">it</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">produceNumbers</span><span class="token punctuation">(</span>side<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">consumeEach</span> <span class="token punctuation">{</span> 
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Consuming </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">it</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token comment">// let us digest the consumed number properly, do not hurry</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Done consuming&quot;</span></span><span class="token punctuation">)</span>
    coroutineContext<span class="token punctuation">.</span><span class="token function">cancelChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token comment">//sampleEnd      </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®©æˆ‘ä»¬çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>Consuming <span class="token number">1</span>
Side channel has <span class="token number">2</span>
Side channel has <span class="token number">3</span>
Consuming <span class="token number">4</span>
Side channel has <span class="token number">5</span>
Side channel has <span class="token number">6</span>
Consuming <span class="token number">7</span>
Side channel has <span class="token number">8</span>
Side channel has <span class="token number">9</span>
Consuming <span class="token number">10</span>
Done consuming
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å››ã€selecting-deferred-values" tabindex="-1"><a class="header-anchor" href="#å››ã€selecting-deferred-values" aria-hidden="true">#</a> å››ã€Selecting deferred values</h1><p>å»¶è¿Ÿå€¼å¯ä»¥ä½¿ç”¨ onAwait å­å¥æ¥æŸ¥è¯¢ã€‚è®©æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå®ƒåœ¨éšæœºçš„å»¶è¿Ÿåä¼šå»¶è¿Ÿè¿”å›å­—ç¬¦ä¸²ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">asyncString</span><span class="token punctuation">(</span>time<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> async <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token string-literal singleline"><span class="token string">&quot;Waited for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®©æˆ‘ä»¬éšæœºå¯åŠ¨åä½™ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œæ¯ä¸ªéƒ½å»¶è¿Ÿéšæœºçš„æ—¶é—´</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">asyncStringsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> random <span class="token operator">=</span> <span class="token function">Random</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">asyncString</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œmain å‡½æ•°ç­‰å¾…å®ƒä»¬ä¸­çš„ç¬¬ä¸€ä¸ªå®Œæˆï¼Œå¹¶ç»Ÿè®¡ä»å¤„äºæ´»åŠ¨çŠ¶æ€çš„å»¶è¿Ÿå€¼çš„æ•°é‡ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ <code>select</code> è¡¨è¾¾å¼äº‹å®ä¸Šæ˜¯ä¸€ç§ Kotlin DSLï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»æ„ä»£ç ä¸ºå®ƒæä¾›å­å¥ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬éå†ä¸€ä¸ªå»¶è¿Ÿå€¼åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªå»¶è¿Ÿå€¼æä¾› <code>onAwait</code> å­å¥ã€‚</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>selects<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token operator">*</span>
    
<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">asyncString</span><span class="token punctuation">(</span>time<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> async <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token string-literal singleline"><span class="token string">&quot;Waited for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">time</span></span><span class="token string"> ms&quot;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">asyncStringsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> random <span class="token operator">=</span> <span class="token function">Random</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">asyncString</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//sampleStart</span>
    <span class="token keyword">val</span> list <span class="token operator">=</span> <span class="token function">asyncStringsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> select<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">withIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
            deferred<span class="token punctuation">.</span><span class="token function">onAwait</span> <span class="token punctuation">{</span> answer <span class="token operator">-&gt;</span>
                <span class="token string-literal singleline"><span class="token string">&quot;Deferred </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">index</span></span><span class="token string"> produced answer &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">answer</span></span><span class="token string">&#39;&quot;</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">val</span> countActive <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">count</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span>isActive <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">countActive</span></span><span class="token string"> coroutines are still active&quot;</span></span><span class="token punctuation">)</span>
<span class="token comment">//sampleEnd</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¾“å‡ºç»“æœï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>Deferred <span class="token number">4</span> produced answer &#39;Waited <span class="token keyword">for</span> <span class="token number">128</span> ms&#39;
<span class="token number">11</span> coroutines are still active
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="äº”ã€switch-over-a-channel-of-deferred-values" tabindex="-1"><a class="header-anchor" href="#äº”ã€switch-over-a-channel-of-deferred-values" aria-hidden="true">#</a> äº”ã€Switch over a channel of deferred values</h1><p>ç°åœ¨æˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªé€šé“ç”Ÿäº§è€…å‡½æ•°ï¼Œå®ƒæ¶ˆè´¹ä¸€ä¸ªäº§ç”Ÿå»¶è¿Ÿå­—ç¬¦ä¸²çš„é€šé“ï¼Œå¹¶ç­‰å¾…æ¯ä¸ªæ¥æ”¶çš„å»¶è¿Ÿå€¼ï¼Œä½†å®ƒåªåœ¨ä¸‹ä¸€ä¸ªå»¶è¿Ÿå€¼åˆ°è¾¾æˆ–è€…é€šé“å…³é—­ä¹‹å‰å¤„äºè¿è¡ŒçŠ¶æ€ã€‚æ­¤ç¤ºä¾‹å°† onReceiveOrNull å’Œ onAwait å­å¥æ”¾åœ¨åŒä¸€ä¸ª <code>select</code> ä¸­ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">switchMapDeferreds</span><span class="token punctuation">(</span>input<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> current <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// start with first received deferred value</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// loop while not cancelled/closed</span>
        <span class="token keyword">val</span> next <span class="token operator">=</span> select<span class="token operator">&lt;</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// return next deferred value from this select or null</span>
            input<span class="token punctuation">.</span><span class="token function">onReceiveOrNull</span> <span class="token punctuation">{</span> update <span class="token operator">-&gt;</span>
                update <span class="token comment">// replaces next value to wait</span>
            <span class="token punctuation">}</span>
            current<span class="token punctuation">.</span><span class="token function">onAwait</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span>  
                <span class="token function">send</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// send value that current deferred has produced</span>
                input<span class="token punctuation">.</span><span class="token function">receiveOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// and use the next deferred from the input channel</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Channel was closed&quot;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">break</span> <span class="token comment">// out of loop</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            current <span class="token operator">=</span> next
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†æµ‹è¯•å®ƒï¼Œæˆ‘ä»¬å°†ç”¨ä¸€ä¸ªç®€å•çš„å¼‚æ­¥å‡½æ•°ï¼Œå®ƒåœ¨ç‰¹å®šçš„å»¶è¿Ÿåè¿”å›ç‰¹å®šçš„å­—ç¬¦ä¸²ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">asyncString</span><span class="token punctuation">(</span>str<span class="token operator">:</span> String<span class="token punctuation">,</span> time<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token operator">=</span> async <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span>
    str
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>main å‡½æ•°åªæ˜¯å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥æ‰“å° <code>switchMapDeferreds</code> çš„ç»“æœå¹¶å‘å®ƒå‘é€ä¸€äº›æµ‹è¯•æ•°æ®ï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>channels<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>selects<span class="token punctuation">.</span><span class="token operator">*</span>
    
<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">switchMapDeferreds</span><span class="token punctuation">(</span>input<span class="token operator">:</span> ReceiveChannel<span class="token operator">&lt;</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> produce<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> current <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// start with first received deferred value</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// loop while not cancelled/closed</span>
        <span class="token keyword">val</span> next <span class="token operator">=</span> select<span class="token operator">&lt;</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// return next deferred value from this select or null</span>
            input<span class="token punctuation">.</span><span class="token function">onReceiveOrNull</span> <span class="token punctuation">{</span> update <span class="token operator">-&gt;</span>
                update <span class="token comment">// replaces next value to wait</span>
            <span class="token punctuation">}</span>
            current<span class="token punctuation">.</span><span class="token function">onAwait</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span>  
                <span class="token function">send</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// send value that current deferred has produced</span>
                input<span class="token punctuation">.</span><span class="token function">receiveOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// and use the next deferred from the input channel</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Channel was closed&quot;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">break</span> <span class="token comment">// out of loop</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            current <span class="token operator">=</span> next
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">asyncString</span><span class="token punctuation">(</span>str<span class="token operator">:</span> String<span class="token punctuation">,</span> time<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token operator">=</span> async <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span>
    str
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//sampleStart</span>
    <span class="token keyword">val</span> chan <span class="token operator">=</span> Channel<span class="token operator">&lt;</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// the channel for test</span>
    launch <span class="token punctuation">{</span> <span class="token comment">// launch printing coroutine</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>s <span class="token keyword">in</span> <span class="token function">switchMapDeferreds</span><span class="token punctuation">(</span>chan<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// print each received string</span>
    <span class="token punctuation">}</span>
    chan<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">asyncString</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;BEGIN&quot;</span></span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token comment">// enough time for &quot;BEGIN&quot; to be produced</span>
    chan<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">asyncString</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Slow&quot;</span></span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// not enough time to produce slow</span>
    chan<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">asyncString</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Replace&quot;</span></span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token comment">// give it time before the last one</span>
    chan<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">asyncString</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;END&quot;</span></span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// give it time to process</span>
    chan<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// close the channel ... </span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token comment">// and wait some time to let it finish</span>
<span class="token comment">//sampleEnd</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç çš„æ‰§è¡Œç»“æœï¼š</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>BEGIN
Replace
END
Channel was closed
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,49);function m(b,g){const a=p("ExternalLinkIcon");return o(),c("div",null,[n("blockquote",null,[n("p",null,[s("å…¬ä¼—å·ï¼š"),n("a",u,[s("å­—èŠ‚æ•°ç»„"),t(a)])]),r]),n("blockquote",null,[k,n("p",null,[s("åç¨‹å®˜æ–¹æ–‡æ¡£ï¼š"),n("a",d,[s("coroutines-guide"),t(a)])])]),v])}const y=e(i,[["render",m],["__file","Kotlin åç¨‹å®˜æ–¹æ–‡æ¡£ï¼ˆ9ï¼‰é€‰æ‹©è¡¨è¾¾å¼.html.vue"]]);export{y as default};
